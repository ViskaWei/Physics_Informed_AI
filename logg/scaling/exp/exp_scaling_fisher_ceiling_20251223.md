# 📘 Experiment Report: Fisher/CRLB 理论上限
> **Name:** TODO | **ID:** `SCALING-20251223-fisher-ceiling-01`  
> **Topic:** `scaling` | **MVP:** MVP-16T | **Project:** `VIT`  
> **Author:** Viska Wei | **Date:** 2025-12-23 | **Status:** ❌ Failed (方法论缺陷)
```
💡 实验目的  
决定：影响的决策
```

---

---

## 🔗 Upstream Links

| Type | Link | Description |
|------|------|-------------|
| 🧠 Hub | [`scaling_hub_20251222.md`](../scaling_hub_20251222.md) | H3.1, H-16T.1~3 |
| 🗺️ Roadmap | [`scaling_roadmap_20251222.md`](../scaling_roadmap_20251222.md) | MVP-16T 规格 |
| 📋 Kanban | `status/kanban.md` | Phase 16 P0 三件套 |

---

# ⚠️ 实验失败总结

## 失败结论

> ❌ **实验失败**：偏导数估计方法存在根本性缺陷，R²_max = 0.97 的结果**不可靠**。

## 失败原因分析

### 1. 核心问题：BOSZ 数据不是规则网格

| 发现 | 详情 |
|------|------|
| T_eff 唯一值 | 39,982 个（几乎每个样本都不同） |
| log_g 唯一值 | 40,015 个 |
| [M/H] 唯一值 | 39,995 个 |
| **结论** | 数据在**连续参数空间随机采样**，不是规则网格 |

### 2. 邻近点差分法的缺陷

| 问题 | 说明 |
|------|------|
| 近邻方向不正交 | 找到的近邻可能同时改变了多个参数（ΔTeff 和 Δlog_g 同时变化） |
| 差分步长不一致 | 不同样本的近邻距离差异极大 |
| 无法保证方向正确 | 差分结果混合了多个参数的偏导数 |

### 3. 数值结果的异常

| 指标 | 观察值 | 问题 |
|------|--------|------|
| CRLB 范围 | 2.77e-10 到 1.00e+10 | **跨越 20 个数量级**，明显异常 |
| CRLB mean vs median | median=0.047, mean=5e+7 | 极端不一致 |
| Fisher 条件数 | 7 到 5.18e+16 | 矩阵严重病态 |
| R²_max 分布 | 55.8% > 0.95, 16.3% < 0.5 | 双峰分布，不合理 |

### 4. 虽然理论框架正确，但实现失败

**理论上 Fisher/CRLB 计算不需要 noisy spectra**：
- 偏导数 ∂μ/∂θ 应该在 clean spectra（理论模型）上计算
- 噪声的影响通过 Σ = diag(error² × noise_level²) 进入 Fisher 矩阵

**但实现问题在于**：
- 用数据点之间的差分估计偏导数，而不是解析/数值微分
- 当数据不在规则网格上时，这种方法完全失效

---

# 📊 原始输出（仅供参考，结果不可靠）

| 指标 | 值 | 可靠性 |
|------|-----|--------|
| R²_max (median) | 0.9661 | ❌ 不可靠 |
| R²_max (90%) | 0.9995 | ❌ 不可靠 |
| Schur decay (median) | 0.2366 | ⚠️ 待验证 |
| Fisher 条件数 (median) | 8.65×10⁵ | ⚠️ 待验证 |
| 成功样本 | 8,579 / 10,000 (86%) | - |

---

# 🔧 正确的解决方案

## 方案 A：数值微分（需要 BOSZ 前向模型）
- 直接在参数空间做小步扰动 (ΔTeff=10K, Δlog_g=0.1, Δ[M/H]=0.05)
- 用 BOSZ 代码重新生成光谱
- 计算精确的偏导数

**优点**：最精确  
**缺点**：需要访问 BOSZ 生成代码

## 方案 B：局部多项式回归
- 对每个样本，在参数空间找 k 个近邻
- 拟合局部线性模型：μ(θ) ≈ a + b^⊤θ
- 用系数 b 作为偏导数估计

**优点**：可在现有数据上实现  
**缺点**：仍有近邻选择问题

## 方案 C：简化 CRLB 估计
- 假设 log_g 主要影响某些特定谱线（如 Mg I b, Ca II H&K）
- 估计这些谱线的 SNR
- 用谱线 SNR 近似 Fisher 信息

**优点**：物理直观  
**缺点**：可能遗漏某些信息

## 方案 D：经验上限估计
- 不用 Fisher/CRLB，改用 Oracle 上限
- 例如：无噪声条件下最好的模型能达到多少？
- 或：用 ensemble 方法估计可减误差

**优点**：实践可行  
**缺点**：不是严格的理论上限

---

# 📝 假设验证状态

| 验证问题 | 原计划 | 实际结果 |
|---------|--------|---------|
| H-16T.1: R²_max ≥ 0.75? | 验证 headroom | ❌ **无法验证**（方法失败） |
| H-16T.2: degeneracy 显著? | 验证 Schur decay | ❌ **无法验证**（方法失败） |

---

# 📁 实验产物

| 类型 | 路径 | 状态 |
|------|------|------|
| 脚本 | `~/VIT/scripts/scaling_fisher_ceiling.py` | ⚠️ 需重写 |
| 结果 JSON | `~/VIT/results/SCALING-20251223-fisher-ceiling-01/summary.json` | ❌ 不可靠 |
| 结果 CSV | `~/VIT/results/SCALING-20251223-fisher-ceiling-01/fisher_results.csv` | ❌ 不可靠 |
| 图表 | `logg/scaling/img/fisher_ceiling_*.png` | ❌ 不可靠 |

---

# 💡 经验教训

1. **数据结构检查**：在设计算法前，应先验证数据是否满足算法假设（规则网格 vs 随机采样）

2. **数值稳定性**：CRLB 跨越 20 个数量级是明显的红旗，应该在运行时检测并报警

3. **Fisher 计算的正确方法**：
   - 对于规则网格：可用差分法
   - 对于连续采样：需要解析微分或局部回归
   - 对于黑盒模型：需要自动微分

4. **Sanity check**：R²_max = 0.97 vs 实际 R² = 0.50-0.57 的巨大差距本身就值得怀疑

---

# 🔄 下一步行动

| 行动 | 优先级 | 说明 |
|------|--------|------|
| **暂停 MVP-16T** | 🔴 | 等待方法论改进 |
| 调研 BOSZ 前向模型 | 🟡 | 是否可以做数值微分 |
| 尝试方案 B（局部回归） | 🟡 | 在现有数据上验证 |
| 考虑方案 D（经验上限） | 🟢 | 用 noise=0 Oracle 替代 |

---

# 📎 附录

## 诊断代码输出

```
=== BOSZ 网格参数分布 ===

T_eff 唯一值:
  Count: 39982
  Range: 3750 - 6000 K

log_g 唯一值:
  Count: 40015
  Range: 1.00 - 5.00

[M/H] 唯一值:
  Count: 39995
  Range: -2.50 - 0.75

网格点组合:
  理论组合数: 63987189801350
  实际样本数: 200000
  每个网格点样本数 ≈ 0.0

=== 诊断 Fisher 矩阵数值问题 ===

CRLB 分布:
  Min:    2.77e-10
  10%:    0.000708
  50%:    0.046877
  90%:    1.573216
  Max:    1.00e+10

R²_max 分布:
  Min:    0.0000
  10%:    0.0000
  50%:    0.9661
  90%:    0.9995
  Max:    1.0000

Fisher 条件数分布:
  Min:    7.38e+00
  50%:    8.65e+05
  Max:    5.18e+16

R²_max 分区域分析:
  R²_max < 0.5 的样本数: 1398 (16.3%)
  R²_max > 0.95 的样本数: 4788 (55.8%)
```

---

> **实验状态**: ❌ Failed  
> **失败时间**: 2025-12-23 14:41 UTC  
> **失败原因**: 偏导数估计方法存在根本性缺陷，BOSZ 数据为连续采样而非规则网格

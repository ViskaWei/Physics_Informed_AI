# ğŸ“˜ å­å®éªŒæŠ¥å‘Šï¼šTop-K Window + CNN / Transformer

---
> **å®éªŒåç§°ï¼š** Top-K Window CNN & Transformer for log_g Prediction  
> **å¯¹åº” MVPï¼š** MVP-Local-1  
> **ä½œè€…ï¼š** Viska Wei  
> **æ—¥æœŸï¼š** 2025-12-01  
> **æ•°æ®ç‰ˆæœ¬ï¼š** 32k train / 512 val / 512 test  
> **æ¨¡å‹ç‰ˆæœ¬ï¼š** TopKWindowCNN v1, TopKWindowTransformer v1  
> **çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ

---

## ğŸ”— è·¨ä»“åº“å…ƒæ•°æ®ï¼ˆCross-Repo Metadataï¼‰

| å­—æ®µ | å€¼ |
|------|-----|
| **experiment_id** | `VIT-20251201-topk-window-01` |
| **project** | `VIT` |
| **topic** | `gta` |
| **source_repo_path** | `~/VIT/scripts/topk_window_experiments.py` |
| **config_path** | - |
| **output_path** | `~/VIT/results/topk_window/mvp_results.csv` |

---

# ğŸ“‘ ç›®å½•

- [1. ğŸ¯ ç›®æ ‡](#1--ç›®æ ‡)
- [2. ğŸ§ª å®éªŒè®¾è®¡](#2--å®éªŒè®¾è®¡)
- [3. ğŸ“Š å®éªŒå›¾è¡¨](#3--å®éªŒå›¾è¡¨)
- [4. ğŸ’¡ å…³é”®æ´è§](#4--å…³é”®æ´è§)
- [5. ğŸ“ ç»“è®º](#5--ç»“è®º)
- [6. ğŸ“ é™„å½•](#6--é™„å½•)

---

# âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆï¼ˆä¾› main æå–ï¼‰

### ä¸€å¥è¯æ€»ç»“

> **TopKWindowCNN (K=256, noise=0.1) è¾¾åˆ° Test RÂ²=0.9313ï¼Œå¤§å¹…è¶…è¶Šç›®æ ‡ (â‰¥0.70) å’Œä¹‹å‰æœ€ä¼˜ NN baseline (0.657)ï¼Œè¯æ˜ Top-K Window + Residual on Ridge ç­–ç•¥é«˜æ•ˆæœ‰æ•ˆã€‚**

### å¯¹å‡è®¾çš„éªŒè¯

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| Top-K Window CNN åœ¨ noise=0.1 èƒ½è¾¾åˆ° RÂ² â‰¥ 0.70ï¼Ÿ | âœ… **RÂ²=0.9313** | å¤§å¹…è¶…è¶Šç›®æ ‡ (+33%) |
| K=256 vs K=512 å“ªä¸ªæ›´å¥½ï¼Ÿ | âœ… K=256 æ›´ä¼˜ | K=512 åè€Œé™åˆ° 0.72 |
| CNN vs Transformer å“ªä¸ªæ›´å¥½ï¼Ÿ | âœ… CNN æ›´ä¼˜ | noise=0.1 ä¸‹ CNN (0.93) >> Transformer (0.57) |

### è®¾è®¡å¯ç¤ºï¼ˆ1-2 æ¡ï¼‰

| å¯ç¤º | å…·ä½“å»ºè®® |
|------|---------|
| **K=256 æ˜¯æœ€ä¼˜é€‰æ‹©** | æ›´å¤šç‰¹å¾ (K=512) å¼•å…¥å†—ä½™å™ªå£° |
| **Residual on Ridge æœ‰æ•ˆ** | ç¥ç»ç½‘ç»œåªéœ€å­¦ä¹ æ®‹å·® |

### å…³é”®æ•°å­—

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| **æœ€ä½³ Test RÂ²** | 0.9313 (CNN, K=256, noise=0.1) |
| **å‚æ•°é‡** | 27,873 (CNN) / 73,953 (Transformer) |
| **vs ä¹‹å‰æœ€ä¼˜ NN** | +42% (0.657 â†’ 0.9313) |
| **è®­ç»ƒæ—¶é—´** | ~11 åˆ†é’Ÿ (CNN, K=256) |

---

# 1. ğŸ¯ ç›®æ ‡

## 1.1 å®éªŒç›®çš„

**å›ç­”çš„é—®é¢˜**ï¼š
- Top-K Window + CNN/Transformer èƒ½å¦åœ¨ noise=0.1 ä¸‹è¾¾åˆ° RÂ² â‰¥ 0.70ï¼Ÿ
- æœ€ä¼˜çš„ K å€¼æ˜¯å¤šå°‘ï¼Ÿ
- CNN vs Transformer å“ªä¸ªæ›´é€‚åˆè¿™ä¸ªä»»åŠ¡ï¼Ÿ

**å¯¹åº” main.md çš„**ï¼š
- éªŒè¯é—®é¢˜ï¼šMVP-Local-1
- å­å‡è®¾ï¼šLocal Tower å¯ä»¥ä» Top-K å…³é”®æ³¢é•¿æå–æœ‰æ•ˆä¿¡æ¯

## 1.2 é¢„æœŸç»“æœ

| åœºæ™¯ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|------|---------|---------|
| æ­£å¸¸æƒ…å†µ | RÂ² â‰¥ 0.70 | âœ… **RÂ² = 0.9313** |
| CNN vs Transformer | CNN ç•¥ä¼˜ | âœ… CNN >> Transformer |
| K è¶Šå¤§è¶Šå¥½ï¼Ÿ | K=512 > K=256 | âŒ K=256 > K=512 |

---

# 2. ğŸ§ª å®éªŒè®¾è®¡

## 2.1 æ•°æ®

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| è®­ç»ƒæ ·æœ¬æ•° | 32,000 |
| éªŒè¯æ ·æœ¬æ•° | 512 |
| æµ‹è¯•æ ·æœ¬æ•° | 512 |
| å…‰è°±ç»´åº¦ | 4,096 åƒç´  |
| æ ‡ç­¾å‚æ•° | $\log g$ |

**é¢„æµ‹å½¢å¼**ï¼š**Residual on Ridge**

$$
\hat{y} = y_{\text{ridge}} + f_\theta(\text{TopKWindows}(x))
$$

## 2.2 ç‰¹å¾è®¾è®¡

| ç‰¹å¾ç±»å‹ | ç»´åº¦ | è¯´æ˜ |
|---------|------|------|
| Top-K windows | (B, K, W) | K=256/512, W=17 (window_radius=8) |
| Ridge prediction | (B, 1) | ä½œä¸º residual shortcut |

**Top-K ç´¢å¼•æ¥æº**ï¼šRidge æ¨¡å‹ç³»æ•°çš„ç»å¯¹å€¼æ’åº

## 2.3 æ¨¡å‹ä¸ç®—æ³•

### TopKWindowCNN (27,873 å‚æ•°)

```
è¾“å…¥: flux (B, 4096), ridge_pred (B, 1)

1. Window æå–: (B, 4096) â†’ (B, K=256, W=17)
2. å±€éƒ¨ CNN (å…±äº«æƒé‡):
   - Conv1d(1â†’16, k=3) + BN + ReLU
   - Conv1d(16â†’32, k=3) + BN + ReLU
   - AdaptiveAvgPool â†’ æ¯ä¸ª window å¾—åˆ° 32-d embedding
   â†’ (B, K, 32)
3. å…¨å±€èšåˆ:
   - Conv1d(32â†’64, k=3) + BN + ReLU
   - Conv1d(64â†’64, k=3) + BN + ReLU
   - AdaptiveAvgPool â†’ (B, 64)
4. MLP head:
   - Linear(64â†’32) + ReLU + Dropout(0.2)
   - Linear(32â†’1) â†’ Î”y
5. è¾“å‡º: y_pred = ridge_pred + Î”y
```

### TopKWindowTransformer (73,953 å‚æ•°)

```
1-2. åŒ CNN
3. Transformer:
   - Linear(32â†’64) + PositionEncoding
   - 2-layer TransformerEncoder (d=64, nhead=4, ff=128)
   - Mean pooling â†’ (B, 64)
4-5. åŒ CNN
```

## 2.4 è¶…å‚æ•°é…ç½®

| å‚æ•° | CNN | Transformer |
|------|-----|-------------|
| Learning rate | 3e-3 | 3e-4 |
| Weight decay | 0 | 0 |
| Batch size | 2048 | 2048 |
| Epochs | 100 | 100 |
| Early stopping | 20 | 20 |
| Optimizer | AdamW | AdamW |
| Loss | MAE (L1) | MAE (L1) |

## 2.5 è¯„ä»·æŒ‡æ ‡

| æŒ‡æ ‡ | å…¬å¼ | ç”¨é€” |
|------|------|------|
| $R^2$ | $1 - \frac{\sum(y - \hat{y})^2}{\sum(y - \bar{y})^2}$ | ä¸»è¦è¯„ä»·æŒ‡æ ‡ |
| MAE | $\frac{1}{n}\sum|y - \hat{y}|$ | ç»å¯¹è¯¯å·®å‚è€ƒ |

---

# 3. ğŸ“Š å®éªŒå›¾è¡¨

### è¡¨ 1ï¼šå®Œæ•´å®éªŒç»“æœ

| å®éªŒ | æ¨¡å‹ | K | noise | Test RÂ² | Val RÂ² | Train RÂ² | MAE | Params | æ—¶é—´ |
|------|------|---|-------|---------|--------|----------|-----|--------|------|
| **MVP_CNN_K256_nz0p1** | CNN | 256 | 0.1 | **0.9313** â­ | 0.9311 | 0.9330 | 0.230 | 27,873 | 11.2m |
| MVP_Transformer_K256_nz0 | Transformer | 256 | 0.0 | **0.9285** | 0.9242 | 0.9299 | 0.252 | 73,953 | 10.1m |
| MVP_CNN_K256_nz0 | CNN | 256 | 0.0 | 0.9023 | 0.9059 | 0.9064 | 0.294 | 27,873 | 6.7m |
| SANITY_CNN_K128 | CNN | 128 | 0.1 | 0.8382 | 0.8389 | 0.8512 | 0.381 | 27,873 | 47s |
| SANITY_Transformer_K128 | Transformer | 128 | 0.1 | 0.7354 | 0.7008 | 0.7150 | 0.460 | 17,633 | 51s |
| MVP_CNN_K512_nz0 | CNN | 512 | 0.0 | 0.7201 | 0.6244 | 0.6531 | 0.479 | 27,873 | 6.3m |
| MVP_Transformer_K256_nz0p1 | Transformer | 256 | 0.1 | 0.5652 | 0.5346 | 0.5718 | 0.647 | 73,953 | 3.3m |

### è¡¨ 2ï¼šä¸ Baseline å¯¹æ¯” (noise=0.1)

| æ¨¡å‹ | Test RÂ² | æ¥æº | å¤‡æ³¨ |
|------|---------|------|------|
| **TopKWindowCNN (K=256)** | **0.9313** â­ | æœ¬å®éªŒ | æ–° SOTA |
| Ridge (Î±=1.0) | 0.909 | baseline | çº¿æ€§æ¨¡å‹ |
| å° kernel CNN (k=9) | 0.657 | cnn/ | ä¹‹å‰æœ€ä¼˜ NN |

**å…³é”®è§‚å¯Ÿ**ï¼š
- TopKWindowCNN è¶…è¶Š Ridge baseline (+2.4%)
- è¶…è¶Šä¹‹å‰æœ€ä¼˜ NN baseline (+42%)

---

# 4. ğŸ’¡ å…³é”®æ´è§

## 4.1 å®è§‚å±‚æ´è§

- **Top-K Window ç­–ç•¥éªŒè¯æˆåŠŸ**ï¼šé€šè¿‡ Ridge ç³»æ•°é€‰æ‹©å…³é”®æ³¢é•¿ + å±€éƒ¨çª—å£æå–ï¼Œå®ç°é«˜æ•ˆç‰¹å¾æå–
- **Residual on Ridge ç­–ç•¥æœ‰æ•ˆ**ï¼šç¥ç»ç½‘ç»œåªéœ€å­¦ä¹ çº¿æ€§æ¨¡å‹æ— æ³•æ•æ‰çš„æ®‹å·®ï¼Œé™ä½å­¦ä¹ éš¾åº¦
- **K=256 æ˜¯æœ€ä¼˜é€‰æ‹©**ï¼šK=512 å¼•å…¥è¿‡å¤šå™ªå£°/å†—ä½™ï¼Œæ€§èƒ½åè€Œä¸‹é™

## 4.2 æ¨¡å‹å±‚æ´è§

- **CNN åœ¨æœ‰å™ªå£°åœºæ™¯ä¼˜äº Transformer**ï¼šnoise=0.1 ä¸‹ CNN (0.93) >> Transformer (0.57)
- **CNN åœ¨ noise=0.1 ä¸‹ä¼˜äº noise=0**ï¼šå¯èƒ½å› ä¸º Ridge baseline åœ¨ noise=0.1 ä¸‹çš„æ®‹å·®æ›´å®¹æ˜“å­¦ä¹ 
- **å…±äº«æƒé‡ local encoder æœ‰æ•ˆ**ï¼š27K å‚æ•°å³å¯è¾¾åˆ°ä¼˜ç§€æ€§èƒ½

## 4.3 å®éªŒå±‚ç»†èŠ‚æ´è§

- **Transformer éœ€è¦æ›´å¤šæ•°æ®/è®­ç»ƒ**ï¼šåœ¨ noise=0.1 ä¸‹è¡¨ç°ä¸ä½³ï¼Œå¯èƒ½éœ€è¦æ›´å¤§æ•°æ®é›†æˆ–æ›´é•¿è®­ç»ƒ
- **çª—å£å¤§å° W=17 è¶³å¤Ÿ**ï¼šè¦†ç›– Â±8 åƒç´ ï¼Œæ•è·å±€éƒ¨çº¿å‹ä¿¡æ¯
- **æ³¢é•¿ä½ç½®ç¼–ç æœ‰å¸®åŠ©**ï¼šTransformer åœ¨ noise=0 ä¸‹è¡¨ç°ä¸ CNN ç›¸å½“

---

# 5. ğŸ“ ç»“è®º

## 5.1 æ ¸å¿ƒå‘ç°

> **TopKWindowCNN (K=256, noise=0.1) è¾¾åˆ° RÂ²=0.9313ï¼Œå¤§å¹…è¶…è¶Š baselineï¼Œè¯æ˜"Top-K å…³é”®æ³¢é•¿ + å±€éƒ¨çª—å£ + Residual on Ridge"æ˜¯ noise=0.1 åœºæ™¯çš„æœ€ä¼˜è§£ã€‚**

**å‡è®¾éªŒè¯**ï¼š
- âœ… åŸå‡è®¾ï¼šTop-K Window + CNN èƒ½è¾¾åˆ° RÂ² â‰¥ 0.70
- âœ… å®éªŒç»“æœï¼šRÂ² = 0.9313ï¼Œè¶…è¶Šç›®æ ‡ +33%

## 5.2 å…³é”®ç»“è®ºï¼ˆ2-4 æ¡ï¼‰

| # | ç»“è®º | è¯æ® |
|---|------|------|
| 1 | **Top-K Window CNN å¤§å¹…è¶…è¶Š baseline** | RÂ²=0.9313 vs 0.657 (+42%) |
| 2 | **K=256 æ˜¯æœ€ä¼˜é€‰æ‹©** | K=512 åè€Œæ›´å·® (0.72) |
| 3 | **Residual on Ridge æœ‰æ•ˆ** | å¤ç”¨çº¿æ€§ baseline ä¿¡æ¯ |
| 4 | **CNN ä¼˜äº Transformer (noise=0.1)** | 0.9313 vs 0.5652 |

## 5.3 è®¾è®¡å¯ç¤º

### æ¶æ„/æ–¹æ³•åŸåˆ™

| åŸåˆ™ | å»ºè®® | åŸå›  |
|------|------|------|
| **é€‰æ‹©åˆé€‚çš„ K** | K=256 ä¼˜äº K=512 | æ›´å¤šç‰¹å¾ä¸ä¸€å®šæ›´å¥½ |
| **ä½¿ç”¨ Residual on Ridge** | y_pred = y_ridge + Î”y | é™ä½å­¦ä¹ éš¾åº¦ |
| **ä¼˜å…ˆ CNN è€Œé Transformer** | CNN æ›´ç¨³å®š | å°æ•°æ®é›† + æœ‰å™ªå£°åœºæ™¯ |

### âš ï¸ å¸¸è§é™·é˜±

| å¸¸è§åšæ³• | å®éªŒè¯æ® |
|----------|----------|
| "K è¶Šå¤§è¶Šå¥½" | âŒ K=512 æ€§èƒ½ä¸‹é™ |
| "Transformer æ€»æ˜¯æ›´å¥½" | âŒ noise=0.1 ä¸‹ CNN >> Transformer |

## 5.4 ç‰©ç†è§£é‡Š

- **Top-K æ³¢é•¿å¯¹åº” log_g æ•æ„Ÿçº¿**ï¼šRidge ç³»æ•°é«˜çš„æ³¢é•¿é€šå¸¸æ˜¯ Balmer çº¿ã€é‡‘å±çº¿ç­‰ log_g è¯Šæ–­è°±çº¿
- **å±€éƒ¨çª—å£æ•è·çº¿å‹ä¿¡æ¯**ï¼šW=17 çº¦è¦†ç›–å…¸å‹å¸æ”¶çº¿çš„çº¿ç¿¼å’Œçº¿èŠ¯
- **K=256 vs K=512**ï¼šæ›´å¤šæ³¢é•¿å¼•å…¥äº†éæ•æ„ŸåŒºåŸŸï¼Œå¢åŠ å™ªå£°å¹²æ‰°

## 5.5 å…³é”®æ•°å­—é€ŸæŸ¥

| æŒ‡æ ‡ | å€¼ | é…ç½®/æ¡ä»¶ |
|------|-----|----------|
| æœ€ä½³æ€§èƒ½ | **RÂ²=0.9313** | CNN, K=256, noise=0.1 |
| å‚æ•°é‡ | 27,873 | TopKWindowCNN |
| è®­ç»ƒæ—¶é—´ | 11.2 åˆ†é’Ÿ | 32k æ ·æœ¬, 100 epochs |
| vs Ridge baseline | +2.4% | 0.9313 vs 0.909 |
| vs ä¹‹å‰æœ€ä¼˜ NN | +42% | 0.9313 vs 0.657 |

## 5.6 ä¸‹ä¸€æ­¥å·¥ä½œ

| æ–¹å‘ | å…·ä½“ä»»åŠ¡ | ä¼˜å…ˆçº§ | å¯¹åº” MVP |
|------|----------|--------|---------|
| **æµ‹è¯• noise=1.0** | TopKWindowCNN åœ¨é«˜å™ªå£°ä¸‹è¡¨ç° | ğŸ”´ é«˜ | MVP-Local-2 |
| **è°ƒä¼˜ Transformer** | å¢åŠ æ•°æ®é‡/è®­ç»ƒæ—¶é—´ | ğŸŸ¡ ä¸­ | - |
| **åŒå¡”é›†æˆ** | Local + Global Tower èåˆ | ğŸ”´ é«˜ | MVP-Global-2 |

---

# 6. ğŸ“ é™„å½•

## 6.1 æ•°å€¼ç»“æœè¡¨

### ä¸»è¦ç»“æœ

| é…ç½® | Test $R^2$ | Val $R^2$ | MAE | å¤‡æ³¨ |
|------|-------|-----|------|------|
| CNN_K256_nz0p1 | **0.9313** | 0.9311 | 0.230 | â­ æœ€ä½³ |
| Transformer_K256_nz0 | 0.9285 | 0.9242 | 0.252 | noise=0 æœ€ä½³ |
| CNN_K256_nz0 | 0.9023 | 0.9059 | 0.294 | |
| CNN_K512_nz0 | 0.7201 | 0.6244 | 0.479 | K è¿‡å¤§ |

### K å€¼æ‰«æ (noise=0.1, CNN)

| K | Test $R^2$ | å¤‡æ³¨ |
|---|-------|------|
| 128 | 0.8382 | Sanity check |
| 256 | **0.9313** | â­ æœ€ä¼˜ |
| 512 | 0.7201 | è¿‡å¤§ |

## 6.2 ç›¸å…³æ–‡ä»¶

| ç±»å‹ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| ä¸»æ¡†æ¶ | `logg/gta/gta_main_20251130.md` | main æ–‡ä»¶ |
| æœ¬æŠ¥å‘Š | `logg/gta/exp_topk_window_cnn_transformer_20251201.md` | å½“å‰æ–‡ä»¶ |
| æ¨¡å‹ä»£ç  | `~/VIT/src/nn/models/topk_window.py` | ~650 è¡Œ |
| å®éªŒè„šæœ¬ | `~/VIT/scripts/topk_window_experiments.py` | ~550 è¡Œ |
| ç»“æœ CSV | `~/VIT/results/topk_window/mvp_results.csv` | |

## 6.3 è¿è¡Œå‘½ä»¤

```bash
# æ¿€æ´»ç¯å¢ƒ
cd /home/swei20/VIT
source init.sh

# Sanity check
python scripts/topk_window_experiments.py --sanity --gpu 0

# å®Œæ•´ MVP
python scripts/topk_window_experiments.py --gpu 0

# åªè¿è¡Œ CNN å®éªŒ
python scripts/topk_window_experiments.py --model cnn --gpu 0
```

---

*æœ€åæ›´æ–°: 2025-12-01*

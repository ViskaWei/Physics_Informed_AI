# ğŸ“˜ å­å®éªŒæŠ¥å‘Šï¼šGlobal Feature Tower + MLP

---
> **å®éªŒåç§°ï¼š** Global Feature Tower MLP for log_g Prediction  
> **å¯¹åº” MVPï¼š** MVP-Global-1  
> **ä½œè€…ï¼š** Viska Wei  
> **æ—¥æœŸï¼š** 2025-12-01  
> **æ•°æ®ç‰ˆæœ¬ï¼š** 32k train / 512 val / 512 test  
> **æ¨¡å‹ç‰ˆæœ¬ï¼š** GlobalFeatureMLP v1  
> **çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ

---

## ğŸ”— è·¨ä»“åº“å…ƒæ•°æ®ï¼ˆCross-Repo Metadataï¼‰

| å­—æ®µ | å€¼ |
|------|-----|
| **experiment_id** | `VIT-20251201-global-feature-01` |
| **project** | `VIT` |
| **topic** | `gta` |
| **source_repo_path** | `~/VIT/scripts/global_feature_experiments.py` |
| **config_path** | - |
| **output_path** | `~/VIT/results/global_features/mvp_results.csv` |

---

# ğŸ“‘ ç›®å½•

- [1. ğŸ¯ ç›®æ ‡](#1--ç›®æ ‡)
- [2. ğŸ§ª å®éªŒè®¾è®¡](#2--å®éªŒè®¾è®¡)
- [3. ğŸ“Š å®éªŒå›¾è¡¨](#3--å®éªŒå›¾è¡¨)
- [4. ğŸ’¡ å…³é”®æ´è§](#4--å…³é”®æ´è§)
- [5. ğŸ“ ç»“è®º](#5--ç»“è®º)
- [6. ğŸ“ é™„å½•](#6--é™„å½•)

---

# âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆï¼ˆä¾› main æå–ï¼‰

### ä¸€å¥è¯æ€»ç»“

> **GlobalFeatureMLP (PCA+Ridge+TopK+Error) åœ¨ noise=0.1 ä¸‹è¾¾åˆ° Test RÂ²=0.9588ï¼Œåœ¨ noise=1.0 ä¸‹è¾¾åˆ° RÂ²=0.4883ï¼Œæ¥è¿‘ä½†æœªå®Œå…¨è¾¾åˆ° â‰¥0.50 ç›®æ ‡ã€‚å‘ç°å¹¶ä¿®å¤äº†æ•°æ®æ³„éœ² Bugã€‚**

### å¯¹å‡è®¾çš„éªŒè¯

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| Global Feature MLP åœ¨ noise=1.0 èƒ½è¾¾åˆ° RÂ² â‰¥ 0.50ï¼Ÿ | âš ï¸ **RÂ²=0.4883** | æ¥è¿‘ç›®æ ‡ä½†æœªè¾¾åˆ° |
| Global Feature MLP åœ¨ noise=0.1 è¡¨ç°å¦‚ä½•ï¼Ÿ | âœ… **RÂ²=0.9588** | ä¼˜å¼‚ |
| TopK Segments æœ‰å¸®åŠ©å—ï¼Ÿ | âœ… +0.006 RÂ² | ç•¥æœ‰å¸®åŠ© |
| Error Summary æœ‰å¸®åŠ©å—ï¼Ÿ | âœ… +0.005 RÂ² | ç•¥æœ‰å¸®åŠ© |

### è®¾è®¡å¯ç¤ºï¼ˆ1-2 æ¡ï¼‰

| å¯ç¤º | å…·ä½“å»ºè®® |
|------|---------|
| **noise=0.1 è¡¨ç°ä¼˜å¼‚** | PCA èƒ½æœ‰æ•ˆæ•è·ä½å™ªå£°ä¸‹çš„å…‰è°±ç»“æ„ |
| **noise=1.0 éœ€è¦æ”¹è¿›** | é«˜å™ªå£°ä¸‹ PCA ç‰¹å¾è´¨é‡ä¸‹é™ï¼Œè€ƒè™‘åŠ å…¥ Latent Features |

### å…³é”®æ•°å­—

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| **æœ€ä½³ Test RÂ² (noise=0.1)** | 0.9588 |
| **Test RÂ² (noise=1.0)** | 0.4883 |
| **å‚æ•°é‡** | 49,025 |
| **ç‰¹å¾ç»´åº¦** | 126 (PCA 96 + Ridge 1 + TopK 24 + Error 5) |

---

# 1. ğŸ¯ ç›®æ ‡

## 1.1 å®éªŒç›®çš„

**å›ç­”çš„é—®é¢˜**ï¼š
- Global Feature Tower (PCA+Ridge+TopK+Error) èƒ½å¦åœ¨ noise=1.0 ä¸‹è¾¾åˆ° RÂ² â‰¥ 0.50ï¼Ÿ
- å„ Feature Family çš„è´¡çŒ®å¦‚ä½•ï¼Ÿ
- ä¸ baseline å¯¹æ¯”å¦‚ä½•ï¼Ÿ

**å¯¹åº” main.md çš„**ï¼š
- éªŒè¯é—®é¢˜ï¼šMVP-Global-1
- å­å‡è®¾ï¼šä¸­ç­‰ç»´åº¦å…¨å±€ç‰¹å¾å¯ä»¥æœ‰æ•ˆé¢„æµ‹ log_g

## 1.2 é¢„æœŸç»“æœ

| åœºæ™¯ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|------|---------|---------|
| noise=1.0 | RÂ² â‰¥ 0.50 | âš ï¸ RÂ²=0.4883 (æ¥è¿‘) |
| noise=0.1 | RÂ² â‰¥ 0.90 | âœ… RÂ²=0.9588 |

---

# 2. ğŸ§ª å®éªŒè®¾è®¡

## 2.1 æ•°æ®

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| è®­ç»ƒæ ·æœ¬æ•° | 32,000 |
| éªŒè¯æ ·æœ¬æ•° | 512 |
| æµ‹è¯•æ ·æœ¬æ•° | 512 |
| å…‰è°±ç»´åº¦ | 4,096 åƒç´  |
| æ ‡ç­¾å‚æ•° | $\log g$ |

**é¢„æµ‹å½¢å¼**ï¼š**Residual on Ridge**

$$
\hat{y} = y_{\text{ridge}} + g_\theta(\mathbf{g}(x))
$$

## 2.2 ç‰¹å¾è®¾è®¡ (Feature Families)

| Family | æè¿° | ç»´åº¦ | æ„å»ºæ–¹æ³• |
|--------|------|------|----------|
| **F1** | PCA Global Shape | 96 | å¯¹ noisy flux åš PCAï¼Œå–å‰ 96 ä¸ª PC |
| **F2** | Ridge View | 1 | Ridge é¢„æµ‹å€¼ï¼ŒåŒæ—¶ä½œä¸º residual shortcut |
| **F3** | Top-K Segments | 24 | Top-K=512 æ³¢é•¿åˆ† 24 æ®µï¼Œæ¯æ®µå– mean |
| **F4** | Error Summary | 5 | mean(Ïƒ), std(Ïƒ), max(Ïƒ), p25(Ïƒ), p75(Ïƒ) |
| **æ€»è®¡** | | **126** | |

**ç‰¹å¾æ„é€ ç»†èŠ‚**ï¼š
- **F1 (PCA)**: PCA åœ¨ train ä¸Š fitï¼Œå† transform val/test
- **F3 (TopK)**: æ¥è‡ª Ridge ç³»æ•°ç»å¯¹å€¼æ’åºçš„ Top-512 æ³¢é•¿
- **F4 (Error)**: ç»Ÿè®¡å™ªå£°æ°´å¹³ç›¸å…³ä¿¡æ¯

## 2.3 æ¨¡å‹ä¸ç®—æ³•

### GlobalFeatureMLP (49,025 å‚æ•°)

```
è¾“å…¥: features (B, 126), ridge_pred (B, 1)

1. MLP:
   - Linear(126 â†’ 256) + ReLU + Dropout(0.3)
   - Linear(256 â†’ 64) + ReLU + Dropout(0.3)
   - Linear(64 â†’ 1) â†’ Î”y

2. Residual:
   y_pred = ridge_pred + Î”y
```

## 2.4 è¶…å‚æ•°é…ç½®

| å‚æ•° | å€¼ |
|------|-----|
| Learning rate | 1e-3 |
| Weight decay | 0 |
| Batch size | 2048 |
| Epochs | 100 |
| Early stopping | 20 |
| Optimizer | Adam |
| Dropout | 0.3 |
| Loss | MAE (L1) |

## 2.5 è¯„ä»·æŒ‡æ ‡

| æŒ‡æ ‡ | å…¬å¼ | ç”¨é€” |
|------|------|------|
| $R^2$ | $1 - \frac{\sum(y - \hat{y})^2}{\sum(y - \bar{y})^2}$ | ä¸»è¦è¯„ä»·æŒ‡æ ‡ |
| MAE | $\frac{1}{n}\sum|y - \hat{y}|$ | ç»å¯¹è¯¯å·®å‚è€ƒ |

---

# 3. ğŸ“Š å®éªŒå›¾è¡¨

### è¡¨ 1ï¼šå®Œæ•´å®éªŒç»“æœï¼ˆä¿®å¤åï¼‰

| å®éªŒ | Features | noise | Test RÂ² | Val RÂ² | Train RÂ² | MAE | Dim | Params |
|------|----------|-------|---------|--------|----------|-----|-----|--------|
| **MVP_Full_nz0p1** | PCA+Ridge+TopK+Err | 0.1 | **0.9588** â­ | 0.9689 | 0.9742 | 0.162 | 126 | 49,025 |
| MVP_Full_nz1p0 | PCA+Ridge+TopK+Err | 1.0 | 0.4883 | 0.4976 | 0.6171 | 0.656 | 126 | 49,025 |
| MVP_F1F2F3_nz1p0 | PCA+Ridge+TopK | 1.0 | 0.4832 | 0.4548 | 0.5728 | 0.661 | 121 | 47,745 |
| MVP_F1F2_nz1p0 | PCA+Ridge | 1.0 | 0.4770 | 0.4479 | 0.5346 | 0.672 | 97 | 41,601 |

### è¡¨ 2ï¼šFeature Family Ablation (noise=1.0)

| é…ç½® | Features | Test RÂ² | å¢é‡è´¡çŒ® |
|------|----------|---------|----------|
| F1+F2 | PCA + Ridge | 0.4770 | baseline |
| F1+F2+F3 | + TopK Segments | 0.4832 | +0.0062 |
| F1+F2+F3+F4 | + Error Summary | 0.4883 | +0.0051 |

### è¡¨ 3ï¼šä¸ Baseline å¯¹æ¯” (noise=1.0)

| æ¨¡å‹ | Test RÂ² | æ¥æº | å¤‡æ³¨ |
|------|---------|------|------|
| LightGBM | 0.536 | lightgbm/ | 32k SOTA |
| Residual MLP | 0.498 | NN/ | - |
| **GlobalFeatureMLP (Full)** | **0.4883** | æœ¬å®éªŒ | æ¥è¿‘ MLP |
| Ridge (Î±=200) | 0.458 | ridge/ | çº¿æ€§ baseline |

---

# 4. ğŸ’¡ å…³é”®æ´è§

## 4.1 å®è§‚å±‚æ´è§

- **noise=0.1 ä¸‹ Global Feature è¡¨ç°ä¼˜å¼‚**ï¼šRÂ²=0.9588ï¼ŒPCA èƒ½æœ‰æ•ˆæ•è·ä½å™ªå£°ä¸‹çš„å…‰è°±ç»“æ„
- **noise=1.0 ä¸‹è¡¨ç°ä¸€èˆ¬**ï¼šRÂ²=0.4883ï¼Œæ¥è¿‘ç›®æ ‡ä½†æœªè¾¾åˆ°ï¼Œé«˜å™ªå£°ä¸‹ PCA ç‰¹å¾è´¨é‡ä¸‹é™
- **Feature Family è´¡çŒ®æœ‰é™**ï¼šTopK (+0.006) å’Œ Error (+0.005) å¯¹ noise=1.0 åœºæ™¯å¸®åŠ©æœ‰é™

## 4.2 æ¨¡å‹å±‚æ´è§

- **PCA 96 ç»´è¶³å¤Ÿ (noise=0.1)**ï¼šä½å™ªå£°ä¸‹å¯è¾¾ RÂ²=0.96
- **PCA åœ¨é«˜å™ªå£°ä¸‹å—é™**ï¼šnoise=1.0 æ—¶ PCA æ•è·çš„ä¸»è¦æ˜¯å™ªå£°æ¨¡å¼
- **TopK Segments ç•¥æœ‰å¸®åŠ©**ï¼šä¿ç•™å±€éƒ¨ä¿¡æ¯çš„ç²—ç²’åº¦æ‘˜è¦

## 4.3 å®éªŒå±‚ç»†èŠ‚æ´è§

- **Bug ä¿®å¤å…³é”®**ï¼šåŸå§‹ä»£ç ä½¿ç”¨å¹²å‡€ flux å¯¼è‡´æ•°æ®æ³„éœ² (RÂ²=0.99+ â†’ 0.48)
- **Train vs Test å·®è·**ï¼šnoise=1.0 ä¸‹ Train RÂ² (0.62) > Test RÂ² (0.49)ï¼Œå­˜åœ¨ä¸€å®šè¿‡æ‹Ÿåˆ

---

# 5. ğŸ“ ç»“è®º

## 5.1 æ ¸å¿ƒå‘ç°

> **GlobalFeatureMLP åœ¨ noise=0.1 è¡¨ç°ä¼˜å¼‚ (RÂ²=0.9588)ï¼Œä½†åœ¨ noise=1.0 ä¸‹ä»…è¾¾åˆ° RÂ²=0.4883ï¼Œæ¥è¿‘ä½†æœªè¾¾åˆ° â‰¥0.50 ç›®æ ‡ã€‚é«˜å™ªå£°åœºæ™¯éœ€è¦æ›´å¼ºç‰¹å¾ï¼ˆå¦‚ Latent Featuresï¼‰ã€‚**

**å‡è®¾éªŒè¯**ï¼š
- âœ… noise=0.1ï¼šå¤§å¹…è¶…è¶Šç›®æ ‡
- âš ï¸ noise=1.0ï¼šæ¥è¿‘ä½†æœªè¾¾åˆ°ç›®æ ‡ (0.4883 vs 0.50)

## 5.2 å…³é”®ç»“è®ºï¼ˆ2-4 æ¡ï¼‰

| # | ç»“è®º | è¯æ® |
|---|------|------|
| 1 | **noise=0.1 ä¸‹è¡¨ç°ä¼˜å¼‚** | RÂ²=0.9588 |
| 2 | **noise=1.0 ä¸‹æ¥è¿‘ç›®æ ‡ä½†æœªè¾¾åˆ°** | RÂ²=0.4883 vs 0.50 ç›®æ ‡ |
| 3 | **TopK/Error è´¡çŒ®æœ‰é™** | å…± +0.01 RÂ² |
| 4 | **é«˜å™ªå£°åœºæ™¯éœ€è¦æ›´å¼ºç‰¹å¾** | è€ƒè™‘åŠ å…¥ Latent (F5) |

## 5.3 è®¾è®¡å¯ç¤º

### æ¶æ„/æ–¹æ³•åŸåˆ™

| åŸåˆ™ | å»ºè®® | åŸå›  |
|------|------|------|
| **ä½å™ªå£°ç”¨ Global Feature** | 126 ç»´å³å¯è¾¾åˆ° RÂ²=0.96 | é«˜æ•ˆç®€å• |
| **é«˜å™ªå£°éœ€è¦å¢å¼º** | åŠ å…¥ Latent Features | PCA å—å™ªå£°å½±å“å¤§ |

### âš ï¸ å¸¸è§é™·é˜±

| å¸¸è§åšæ³• | å®éªŒè¯æ® |
|----------|----------|
| "ä½¿ç”¨å¹²å‡€ flux åšç‰¹å¾" | âŒ æ•°æ®æ³„éœ²ï¼ŒRÂ² è™šé«˜ (0.99+) |
| "PCA åœ¨ä»»ä½•å™ªå£°ä¸‹éƒ½æœ‰æ•ˆ" | âŒ é«˜å™ªå£°ä¸‹æ€§èƒ½ä¸‹é™ |

## 5.4 ç‰©ç†è§£é‡Š

- **PCA æ•è·å…‰è°±ä¸»æ¨¡æ€**ï¼šä½å™ªå£°ä¸‹ä¸»æ¨¡æ€å¯¹åº” Teff, log_g, [M/H] ç­‰ç‰©ç†ä¿¡æ¯
- **é«˜å™ªå£°ä¸‹ PCA å—é™**ï¼šå™ªå£°æˆä¸ºä¸»è¦æ–¹å·®æ¥æºï¼Œç‰©ç†ä¿¡æ¯è¢«æ©ç›–
- **TopK Segments ä¿ç•™å±€éƒ¨æ€§**ï¼š24 æ®µæ‘˜è¦æ¯”å…¨è°±å¹³å‡æ›´å¥½

## 5.5 å…³é”®æ•°å­—é€ŸæŸ¥

| æŒ‡æ ‡ | å€¼ | é…ç½®/æ¡ä»¶ |
|------|-----|----------|
| æœ€ä½³æ€§èƒ½ (noise=0.1) | **RÂ²=0.9588** | Full features |
| æ€§èƒ½ (noise=1.0) | **RÂ²=0.4883** | Full features |
| å‚æ•°é‡ | 49,025 | GlobalFeatureMLP |
| ç‰¹å¾ç»´åº¦ | 126 | PCA96 + Ridge1 + TopK24 + Err5 |
| vs LightGBM (noise=1.0) | -9% | 0.4883 vs 0.536 |

## 5.6 ä¸‹ä¸€æ­¥å·¥ä½œ

| æ–¹å‘ | å…·ä½“ä»»åŠ¡ | ä¼˜å…ˆçº§ | å¯¹åº” MVP |
|------|----------|--------|---------|
| **åŠ å…¥ Latent Features (F5)** | ä½¿ç”¨ BlindSpot encoder ç‰¹å¾ | ğŸ”´ é«˜ | MVP-Global-2 |
| **åŒå¡”é›†æˆ** | Local + Global Tower èåˆ | ğŸ”´ é«˜ | MVP-Global-2 |
| **æ‰©å±•åˆ° 100k æ•°æ®** | æµ‹è¯•æ›´å¤§æ•°æ®é›† | ğŸŸ¡ ä¸­ | - |

---

# 6. ğŸ“ é™„å½•

## 6.1 Bug ä¿®å¤è®°å½•

### Bug: Global Feature ä½¿ç”¨äº†å¹²å‡€æ•°æ®

**é—®é¢˜æè¿°**:
```python
# é”™è¯¯ä»£ç  (ä½¿ç”¨å¹²å‡€ flux)
train_flux = dm._train_dataset.flux.numpy()  # å¹²å‡€æ•°æ®ï¼
test_flux = dm._test_dataset.flux.numpy()    # å¹²å‡€æ•°æ®ï¼
```

**å½±å“**:
- æ¨¡å‹åœ¨æ— å™ªå£°æ•°æ®ä¸Šè®­ç»ƒå’Œæµ‹è¯•
- å¯¼è‡´è™šå‡çš„é«˜ RÂ² (0.99+)

**ä¿®å¤**:
```python
# ä¿®å¤å (ä½¿ç”¨ noisy flux)
# Test: ä½¿ç”¨é¢„è®¡ç®—çš„ noisy flux (å›ºå®š seed)
test_flux = dm._test_dataset.noisy.numpy()

# Train/Val: æ‰‹åŠ¨æ·»åŠ å™ªå£°
train_flux = train_flux_clean + np.random.randn(...) * error * noise_level
```

### ä¿®å¤å‰åå¯¹æ¯” (noise=1.0)

| ç‰ˆæœ¬ | Test RÂ² | è¯´æ˜ |
|------|---------|------|
| ä¿®å¤å‰ | 0.9981 | âŒ æ•°æ®æ³„éœ² |
| ä¿®å¤å | 0.4883 | âœ… æ­£ç¡®ç»“æœ |

## 6.2 å†å²æ•°æ®ï¼ˆæ•°æ®æ³„éœ²ï¼Œä»…ä¾›å‚è€ƒï¼‰

> âš ï¸ **ä»¥ä¸‹ä¸º Bug ä¿®å¤å‰çš„æ•°æ®æ³„éœ²ç»“æœï¼Œä¸åº”ä½œä¸ºæ­£ç¡®ç»“è®ºä½¿ç”¨ï¼æ­£ç¡®ç»“æœè§è¡¨ 1ã€‚**

| Experiment | Features | Noise | Dim | Test RÂ² | Val RÂ² | Time |
|------------|----------|-------|-----|---------|--------|------|
| MVP_F1F2F3_nz1p0 | PCA+Ridge+TopK | 1.0 | 121 | ~~0.9986~~ | ~~0.9987~~ | 32s |
| MVP_Full_nz1p0 | PCA+Ridge+TopK+Err | 1.0 | 126 | ~~0.9981~~ | ~~0.9981~~ | 30s |
| MVP_Full_nz0p1 | PCA+Ridge+TopK+Err | 0.1 | 126 | ~~0.9976~~ | ~~0.9976~~ | 31s |
| MVP_F1F2_nz1p0 | PCA+Ridge | 1.0 | 97 | ~~0.9972~~ | ~~0.9983~~ | 30s |

## 6.3 ç›¸å…³æ–‡ä»¶

| ç±»å‹ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| ä¸»æ¡†æ¶ | `logg/gta/gta_main_20251130.md` | main æ–‡ä»¶ |
| æœ¬æŠ¥å‘Š | `logg/gta/exp_global_feature_tower_mlp_20251201.md` | å½“å‰æ–‡ä»¶ |
| æ¨¡å‹ä»£ç  | `~/VIT/src/nn/global_features.py` | ~550 è¡Œ |
| å®éªŒè„šæœ¬ | `~/VIT/scripts/global_feature_experiments.py` | ~530 è¡Œ |
| ç»“æœ CSV | `~/VIT/results/global_features/mvp_results.csv` | |

## 6.4 è¿è¡Œå‘½ä»¤

```bash
# æ¿€æ´»ç¯å¢ƒ
cd /home/swei20/VIT
source init.sh

# Sanity check
python scripts/global_feature_experiments.py --sanity --gpu 0

# å®Œæ•´ MVP
python scripts/global_feature_experiments.py --gpu 0

# åªè¿è¡Œ ablation
python scripts/global_feature_experiments.py --ablation f1f2 --gpu 0
```

---

*æœ€åæ›´æ–°: 2025-12-01*

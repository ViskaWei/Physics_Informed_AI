# 📘 GTA (Global Tower Architecture) · 实验主框架

---
> **主题名称：** Global Feature Tower 在 $\log g$ 预测中的有效性验证  
> **作者：** Viska Wei  
> **创建日期：** 2025-11-30  
> **最后更新：** 2025-12-01  
> **状态：** 🔄 进行中（Phase 1-2 已完成）

---

# 📑 目录

- [0. 📋 问题重述与意义澄清](#0--问题重述与意义澄清)
- [1. 🎯 目标](#1--目标)
  - [1.1 背景与动机](#11-背景与动机)
  - [1.2 核心假设](#12-核心假设)
  - [1.3 验证问题](#13-验证问题)
  - [1.4 结论摘要](#14-结论摘要)
- [2. 🗺️ MVP 实验路线图](#2-️-mvp-实验路线图)
- [3. 📋 子实验追踪](#3--子实验追踪)
- [4. 🔗 跨实验分析](#4--跨实验分析)
- [5. 📝 总结与展望](#5--总结与展望)
- [6. 📎 附录](#6--附录)

---

# 0. 📋 问题重述与意义澄清

## 0.1 核心研究问题

> **在只喂给模型"中低维的全局性质特征"（Teff、[M/H]、PCA 分量、EW、统计量、noise level）时，$\log g$ 最多能被解释到什么程度？**

据此推断：

> **Global Feature Tower 应该怎么设计？它与 Local Tower（吃 full spectrum）应该如何分工？**

## 0.2 统计学定义

把 $\log g$ 看成随机变量 $Y$，把各种全局特征看成 $F$。用模型拟合 $Y \approx f(F)$，得到 test $R^2$：

$$
R^2 \approx 1 - \frac{\mathbb{E}[(Y - \mathbb{E}[Y|F])^2]}{\operatorname{Var}(Y)}
$$

**$R^2$ 越高，说明「只看 $F$，就能消掉多少 $\log g$ 的不确定性」。**

## 0.3 实验定位

| 价值 | 说明 |
|------|------|
| **信息上界** | 给出 Global 特征在 N 维时的大致上限 |
| **架构指导** | Global Tower 的输入/输出维度选择 |
| **分工策略** | Global vs Local Tower 的分工方式 |

| 局限 | 说明 |
|------|------|
| 合成数据 | Oracle [M/H]、理想 noise model，与真实观测有 domain gap |
| 简化设定 | 结论是参考指南，非生产 blueprint |

---

# 1. 🎯 目标

## 1.1 背景与动机

**已知结论**（来自 PCA/Ridge 实验）：
- 全谱 Ridge 在 noise=0 时 $R^2 \approx 1$
- PCA+Ridge 需要 ~100–200 个分量才能逼近 full-spectrum baseline
- → $\log g$ 信息在 **~100 维子空间**，非极低维

**核心目标**：
- [x] 验证 Global Feature Tower 在不同 noise 下的 $R^2$ 上界
- [x] 验证 Local Tower (Top-K Window CNN) 的有效性
- [x] 确定 Global vs Local 分工策略
- [ ] 测试双塔融合效果

## 1.2 核心假设

### 主假设

> **中等维度（~100-150 维）的全局特征可以有效预测 $\log g$，但在高噪声下需要与 Local Tower 配合。**

### 子假设验证状态

| 编号 | 子假设 | 对应 MVP | 状态 | 结果 |
|------|--------|---------|------|------|
| H1.1 | 元数据（Teff+[M/H]）无法预测 $\log g$ | MVP-1.0/2.0 | ✅ 已验证 | $R^2 \approx 0$ |
| H1.2 | Grid 采样设计正确（三参数独立） | MVP-1.0 | ✅ 已验证 | 无伪相关 |
| H1.3 | Global Feature MLP 在 noise=0.1 可达 $R^2 > 0.90$ | MVP-Global-1 | ✅ 已验证 | $R^2 = 0.9588$ |
| H1.4 | Global Feature MLP 在 noise=1.0 可达 $R^2 \geq 0.50$ | MVP-Global-1 | ⚠️ 接近 | $R^2 = 0.4883$ |
| H1.5 | Top-K Window CNN 可达 $R^2 > 0.70$ | MVP-Local-1 | ✅ 已验证 | $R^2 = 0.9313$ |
| H1.6 | K=256 优于 K=512 | MVP-Local-1 | ✅ 已验证 | K=256 最优 |

---

## 1.3 验证问题

| # | 问题 | 验证目标 | 预期结果 | 实际结果 |
|---|------|---------|---------|---------|
| Q1 | Teff-only 能达到多少 $R^2$？ | Grid 独立性 | $R^2 \approx 0$ | ✅ $R^2 \approx 0$ |
| Q2 | Teff + [M/H] 能达到多少 $R^2$？ | 元数据信息量 | $R^2 < 0.2$ | ✅ $R^2 \approx 0$ |
| Q3 | GlobalFeatureMLP (126维) 在 noise=0.1 能达到多少？ | Global 上界 (低噪) | $R^2 \geq 0.90$ | ✅ **$R^2 = 0.9588$** |
| Q4 | GlobalFeatureMLP (126维) 在 noise=1.0 能达到多少？ | Global 上界 (高噪) | $R^2 \geq 0.50$ | ⚠️ **$R^2 = 0.4883$** |
| Q5 | Top-K Window CNN (K=256) 能达到多少？ | Local Tower 有效性 | $R^2 \geq 0.70$ | ✅ **$R^2 = 0.9313$** |
| Q6 | CNN vs Transformer 哪个更好？ | 架构选择 | CNN 略优 | ✅ CNN >> Transformer |
| Q7 | 最佳 K 值是多少？ | 特征选择 | K=256 或 512 | ✅ **K=256 最优** |

---

## 1.4 结论摘要

### ⚡ 核心结论

> **1. 元数据完全无法预测 $\log g$（$R^2 \approx 0$），必须使用光谱 flux。**  
> **2. GlobalFeatureMLP (126维) 在 noise=0.1 下达到 $R^2=0.9588$，证明全局特征高效有效。**  
> **3. TopKWindowCNN (K=256) 在 noise=0.1 下达到 $R^2=0.9313$，超越之前所有 NN baseline。**  
> **4. 高噪声 (noise=1.0) 下 Global Feature 表现下降 ($R^2=0.4883$)，需要更强特征或双塔融合。**

### 关键数字速查

| 配置 | noise | Test $R^2$ | MAE | 来源 |
|------|-------|-----------|-----|------|
| **GlobalFeatureMLP (Full)** | 0.1 | **0.9588** ⭐ | 0.162 | MVP-Global-1 |
| **TopKWindowCNN (K=256)** | 0.1 | **0.9313** ⭐ | 0.230 | MVP-Local-1 |
| GlobalFeatureMLP (Full) | 1.0 | 0.4883 | 0.656 | MVP-Global-1 |
| Ridge (α=200) | 1.0 | 0.458 | - | baseline |
| LightGBM | 1.0 | 0.536 | - | baseline |

### 设计启示

| 场景 | 策略 | 依据 |
|------|------|------|
| **noise=0.1** | Global Feature Tower 即可达到 $R^2 \approx 0.96$ | Q3 结果 |
| **noise=0.1** | TopKWindowCNN 作为 Local Tower 补充 | Q5 结果 |
| **noise=1.0** | Global Feature 需增强（加入 Latent）或双塔融合 | Q4 结果 |
| **K 值选择** | K=256 优于 K=512，更多特征引入噪声 | Q7 结果 |
| **架构选择** | CNN 优于 Transformer（小数据+有噪声场景） | Q6 结果 |

---

# 2. 🗺️ MVP 实验路线图

## 2.1 整体规划

| Phase | 目标 | 状态 |
|-------|------|------|
| Phase 0 | 复现 full-spectrum baseline | ✅ 已完成 |
| Phase 1 | F0/F1 元数据验证 | ✅ 已完成 |
| Phase 2 | Global Feature Tower (MLP) | ✅ 已完成 |
| Phase 3 | Local Tower (Top-K Window CNN) | ✅ 已完成 |
| Phase 4 | 双塔融合 (Global + Local) | ⏳ 待做 |

## 2.2 MVP 详细设计

| MVP | 名称 | 特征配置 | 目标 | 优先级 | 状态 |
|-----|------|---------|------|--------|------|
| MVP-1.0 | F0 Teff-only | Teff 多项式 (3维) | 验证 Grid 独立性 | P0 | ✅ $R^2 \approx 0$ |
| MVP-2.0 | F1 + [M/H] | F0 + [M/H] (5-7维) | 元数据信息上界 | P0 | ✅ $R^2 \approx 0$ |
| MVP-Global-1 | Global Feature MLP | PCA+Ridge+TopK+Err (126维) | Global Tower 上界 | P0 | ✅ **$R^2=0.9588$** |
| MVP-Local-1 | Top-K Window CNN | K=256, W=17 | Local Tower 有效性 | P0 | ✅ **$R^2=0.9313$** |
| MVP-Global-2 | 双塔融合 | Global + Local concat | 融合效果 | P1 | ⏳ |

## 2.3 特征家族汇总

| 家族 | 包含特征 | 维度 | $R^2$ 结果 | 状态 |
|------|---------|------|-----------|------|
| **F0** | Teff 多项式 | 3 | $\approx 0$ | ✅ 已验证 |
| **F1** | F0 + [M/H]\_oracle | 5-7 | $\approx 0$ | ✅ 已验证 |
| **F2** | F1 + mean/std/颜色 | 10-15 | - | ⏳ TODO |
| **F3** | F2 + Top-K EW/depth | 30-60 | - | ⏳ TODO |
| **Full** | PCA96+Ridge1+TopK24+Err5 | 126 | **0.9588** (n=0.1) | ✅ 已验证 |

---

# 3. 📋 子实验追踪

## 3.1 实验总览

| 文件 | 日期 | MVP | 状态 | 核心结果 |
|------|------|-----|------|---------|
| [exp_gta_f0f1_metadata_baseline](exp_gta_f0f1_metadata_baseline_20251130.md) | 2025-11-30 | MVP-1.0/2.0 | ✅ | $R^2 \approx 0$ |
| [exp_global_feature_tower_mlp](exp_global_feature_tower_mlp_20251201.md) | 2025-12-01 | MVP-Global-1 | ✅ | $R^2=0.9588$ (n=0.1) |
| [exp_topk_window_cnn_transformer](exp_topk_window_cnn_transformer_20251201.md) | 2025-12-01 | MVP-Local-1 | ✅ | $R^2=0.9313$ |

## 3.2 进度看板

```
Phase 1 (元数据验证)    ████████████████████ 100%
Phase 2 (Global Tower)  ████████████████████ 100%
Phase 3 (Local Tower)   ████████████████████ 100%
Phase 4 (双塔融合)      ░░░░░░░░░░░░░░░░░░░░   0%
```

## 3.3 结论提取记录

| 日期 | 实验 | 提取的结论 | 同步到 main |
|------|------|-----------|-------------|
| 2025-11-30 | F0/F1 baseline | 元数据 $R^2 \approx 0$，Grid 设计正确 | ✅ §1.3 Q1-Q2 |
| 2025-12-01 | Global MLP | noise=0.1: $R^2=0.9588$; noise=1.0: $R^2=0.4883$ | ✅ §1.3 Q3-Q4 |
| 2025-12-01 | TopK CNN | K=256: $R^2=0.9313$; CNN >> Transformer | ✅ §1.3 Q5-Q7 |

---

# 4. 🔗 跨实验分析

## 4.1 结果对比矩阵

### noise=0.1 场景

| 模型 | 输入 | Test $R^2$ | 参数量 | 备注 |
|------|------|-----------|--------|------|
| **GlobalFeatureMLP** | 126维全局特征 | **0.9588** ⭐ | 49K | 最高 |
| **TopKWindowCNN** | K=256 窗口 | **0.9313** | 28K | 第二 |
| Ridge | 4096 全谱 | 0.909 | - | 线性 baseline |
| 小 kernel CNN | 4096 全谱 | 0.657 | ~30K | 之前最优 NN |

### noise=1.0 场景

| 模型 | 输入 | Test $R^2$ | 备注 |
|------|------|-----------|------|
| LightGBM | 4096 全谱 | 0.536 | SOTA |
| Residual MLP | 4096 全谱 | 0.498 | - |
| **GlobalFeatureMLP** | 126维全局特征 | 0.4883 | 本实验 |
| Ridge | 4096 全谱 | 0.458 | 线性 baseline |

## 4.2 假设验证进度

| 假设 | 状态 | 证据 |
|------|------|------|
| 元数据无法预测 $\log g$ | ✅ 已验证 | F0/F1 $R^2 \approx 0$ |
| Grid 采样设计正确 | ✅ 已验证 | Teff-$\log g$ 无相关 |
| 全局特征在低噪下有效 | ✅ 已验证 | $R^2=0.9588$ @ noise=0.1 |
| 全局特征在高噪下有效 | ⚠️ 部分验证 | $R^2=0.4883$ < 0.50 目标 |
| Top-K Window 策略有效 | ✅ 已验证 | $R^2=0.9313$，+42% vs baseline |
| K=256 优于 K=512 | ✅ 已验证 | K=512 反而降至 0.72 |

## 4.3 关键发现汇总

| 发现 | 来源 | 设计启示 |
|------|------|---------|
| **元数据 $R^2 \approx 0$** | MVP-1.0/2.0 | 必须使用光谱 flux |
| **126维全局特征达 $R^2=0.96$** | MVP-Global-1 | Global Tower 高效 |
| **K=256 最优** | MVP-Local-1 | 更多特征引入噪声 |
| **CNN >> Transformer** | MVP-Local-1 | 小数据+有噪声选 CNN |
| **Residual on Ridge 有效** | MVP-Local-1 | 降低学习难度 |
| **PCA 在高噪下受限** | MVP-Global-1 | 需要更鲁棒的特征 |

---

# 5. 📝 总结与展望

## 5.1 核心结论

> **Global Feature Tower (126维) 在 noise=0.1 下可达 $R^2=0.9588$，证明全局特征高效有效。TopKWindowCNN (K=256) 达到 $R^2=0.9313$，为 Local Tower 提供了有效方案。但 noise=1.0 下表现下降，需要双塔融合或更强特征。**

### 三句话总结

1. **元数据完全无用**：Teff + [M/H] 给 $R^2 \approx 0$，$\log g$ 信息必须从光谱 flux 提取
2. **全局特征高效**：126 维 (PCA+Ridge+TopK+Error) 即可达到 $R^2=0.96$ @ noise=0.1
3. **Top-K Window 有效**：K=256 + Residual on Ridge 达到 $R^2=0.93$，超越所有之前 NN

## 5.2 设计原则

| 原则 | 建议 | 依据 |
|------|------|------|
| **Global Tower 输入** | ~100-150 维 (PCA96 + stats + EW) | MVP-Global-1 |
| **Local Tower 选择** | TopKWindowCNN, K=256 | MVP-Local-1 |
| **预测方式** | Residual on Ridge | MVP-Local-1 |
| **架构选择** | CNN 优于 Transformer | MVP-Local-1 |
| **高噪声策略** | 需要双塔融合或加入 Latent | MVP-Global-1 |

## 5.3 遗留问题

| 问题 | 优先级 | 对应下一步 |
|------|--------|-----------|
| 双塔融合效果如何？ | 🔴 高 | MVP-Global-2 |
| 加入 Latent 特征能否提升 noise=1.0？ | 🔴 高 | MVP-Global-2 |
| F2/F3 (统计量/EW) 贡献多少？ | 🟡 中 | MVP-3.0/3.1 |
| noise=1.0 下如何达到 $R^2 \geq 0.50$？ | 🔴 高 | - |

## 5.4 下一步计划

| 方向 | 具体任务 | 优先级 |
|------|----------|--------|
| **双塔融合** | Global + Local concat/FiLM | 🔴 P0 |
| **Latent 特征** | 加入 BlindSpot encoder 特征 | 🔴 P0 |
| **F2/F3 验证** | 测试 mean/std/颜色、EW 贡献 | 🟡 P1 |
| **100k 数据** | 扩大数据集测试 | 🟢 P2 |

---

# 6. 📎 附录

## 6.1 决策树

```
Q: 只有元数据？
├─ Yes → R² ≈ 0，无法使用
└─ No (有光谱)
   ├─ noise ≤ 0.1 → GlobalFeatureMLP 即可 (R²=0.96)
   └─ noise ≥ 1.0
      ├─ Global only → R² ≈ 0.49
      └─ 需要：双塔融合 / Latent 特征
```

## 6.2 Global Feature Tower 结构

### 输入维度 (~126)

| 特征类型 | 维度 |
|----------|------|
| PCA 分量 | 96 |
| Ridge prediction | 1 |
| Top-K Segments (24段) | 24 |
| Error Summary | 5 |
| **总计** | **126** |

### 网络结构

```
Linear(126 → 256) + ReLU + Dropout(0.3)
Linear(256 → 64) + ReLU + Dropout(0.3)
Linear(64 → 1) → Δy
Output: y_pred = y_ridge + Δy
```

## 6.3 相关文件索引

| 类型 | 路径 |
|------|------|
| PCA 实验 | `logg/pca/` |
| Ridge 实验 | `logg/ridge/` |
| Top-K 实验 | `logg/noise/` |
| CNN 实验 | `logg/cnn/` |

## 6.4 变更日志

| 日期 | 变更 |
|------|------|
| 2025-11-30 | 创建文档，完成 F0/F1 验证 |
| 2025-12-01 | 完成 MVP-Global-1, MVP-Local-1，重构为实验追踪格式 |

---

*最后更新: 2025-12-01*  
*状态: Phase 1-3 已完成，待做 Phase 4 (双塔融合)*

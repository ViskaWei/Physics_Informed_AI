# 🧠 Diffusion Hub
> **Name:** Diffusion 1D 光谱降噪 | **ID:** `VIT-20251206-diffusion-hub`  
> **Topic:** `diffusion` | **Layer:** L2 (Topic Hub) | **Project:** `VIT`  
> **Author:** Viska Wei | **Date:** 2025-12-06 | **Status:** 🔄 Exploring
```
💡 Diffusion 能否用于 1D 恒星光谱降噪？  
决定：是否采用 diffusion 作为预处理/增强方法
```

---

## 🔗 相关文件

| 类型 | 文件 | 说明 |
|------|------|------|
| 📍 Roadmap | [`diffusion_roadmap_20251206.md`](./diffusion_roadmap_20251206.md) | 实验追踪与执行 |
| 📗 子实验 | `exp_diffusion_*.md` | 单实验详情 |
| 💬 会话 | [`sessions/session_20251203_diffusion_init.md`](./sessions/session_20251203_diffusion_init.md) | 立项讨论 |

---

# 📑 目录

- [1. 🌲 核心问题树](#1--核心问题树)
- [2. 🔺 假设金字塔](#2--假设金字塔)
- [3. 💡 洞见汇合站](#3--洞见汇合站)
- [4. 🧭 战略导航](#4--战略导航)
- [5. 📐 设计原则库](#5--设计原则库)
- [6. 📎 附录](#6--附录)

---

# 1. 🌲 核心问题树

> **用树状结构展示问题的从属关系，明确研究边界**

## 1.1 顶层问题

> **Diffusion 能否用于 1D 恒星光谱降噪并改善大气参数推断，同时提供可校准的不确定性估计？**

据此延伸：

> **如何设计 diffusion 管线，既能提升降噪效果，又能避免生成模型"幻觉式补线"引入参数偏差？**

## 1.2 问题分解

```
🎯 顶层问题: Diffusion 在恒星光谱降噪中的有效性与科学可信度
│
├── Q1: 基础可行性（Sanity Check）
│   ├── Q1.1: 1D U-Net 能否在光谱上训练 DDPM？ → ❌ MVP-0.0 失败
│   ├── Q1.2: 有限噪声 denoiser 是否更稳健？ → ✅ MVP-0.5 通过
│   └── Q1.3: Residual+wMAE 在弱噪声区间是否可控？ → ✅ MVP-0.6 通过
│
├── Q2: 降噪路线对比
│   ├── Q2.1: 监督式 DDPM 是否优于传统方法？ → ⏸️ 暂停（依赖 baseline）
│   ├── Q2.2: DPS 后验采样能否抑制幻觉？ → ⏳ 待验证 MVP-1.1
│   └── Q2.3: +ivar 条件化能否改善异方差场景？ → ⏳ 待验证 MVP-1.2
│
├── Q3: 参数推断与不确定性
│   ├── Q3.1: 降噪后参数偏置如何变化？ → ⏳ 待验证
│   ├── Q3.2: 后验样本 → 参数的覆盖率是否校准？ → ⏳ MVP-2.0
│   └── Q3.3: 摊销后验 p(θ|y) 是否可行？ → ⏳ MVP-2.1（低优先级）
│
└── Q4: 科学可信度评价
    ├── Q4.1: 关键谱线的物理量偏置如何？ → ⏳ MVP-3.0
    └── Q4.2: 不确定性估计是否校准？ → ⏳ MVP-3.1

状态图例:
✅ 已验证 | ❌ 已否定 | 🔄 进行中 | ⏳ 待验证 | ⏸️ 暂停 | 🚫 已关闭
```

## 1.3 问题边界

> **明确本研究「做什么」和「不做什么」**

| ✅ 本研究关注 | ❌ 本研究不关注 |
|-------------|---------------|
| 1D 恒星光谱降噪 | 2D 图像/数据立方 |
| BOSZ 合成光谱 → 真实 LAMOST | 跨仪器泛化（后续工作） |
| 参数偏置与覆盖率校准 | 纯视觉/美观指标 |
| 已知 σ 向量的异方差噪声 | Poisson + readout 复杂噪声（后续） |
| 简单 denoiser → DPS 后验采样 | 复杂的摊销后验 p(θ|y) |

---

# 2. 🔺 假设金字塔

> **从宏观战略假设 → 中观战术假设 → 微观可验证假设，层层递进**

## 2.1 L1 宏观假设（战略层）

> **决定整个研究方向的核心信念**

| # | 宏观假设 | 验证状态 | 如果成立 | 如果不成立 |
|---|---------|---------|---------|-----------|
| **H1** | Diffusion 能有效降噪 1D 光谱 | 🔄 部分成立 | 继续参数推断 | 转向判别式方法 |
| **H2** | DPS 后验采样能抑制幻觉 | ⏳ | 成为推荐管线 | 需要更强物理约束 |
| **H3** | 不确定性估计可校准 | ⏳ | 端到端不确定性传播 | 需要后校准 |

## 2.2 L2 中观假设（战术层）

> **宏观假设的具体实现路径**

| # | 中观假设 | 上层假设 | 验证状态 | 关键实验 |
|---|---------|---------|---------|---------|
| **H1.1** | 标准 DDPM 在光谱上可训练 | H1 | ❌ 失败 | MVP-0.0 |
| **H1.2** | 有限噪声 denoiser 更稳健 | H1 | ✅ 成立 | MVP-0.5 |
| **H1.3** | Residual+wMAE 在弱噪声可控 | H1 | ✅ 成立 | MVP-0.6 |
| **H1.4** | 监督式 DDPM 可能引入偏置 | H1 | ⏸️ 暂停 | MVP-1.0 |
| **H2.1** | DPS 显式 likelihood 约束有效 | H2 | ⏳ | MVP-1.1 |
| **H2.2** | +ivar 条件化改善异方差 | H2 | ⏳ | MVP-1.2 |
| **H3.1** | 采样传播不确定性有效 | H3 | ⏳ | MVP-2.0 |

## 2.3 L3 微观假设（可验证层）

> **每个假设对应一个具体实验，有明确的验收标准**

| # | 可验证假设 | 上层 | 验证标准 | 结果 | 来源 |
|---|-----------|------|---------|------|------|
| **H1.1.1** | DDPM loss 收敛且采样像光谱 | H1.1 | 视觉合理 | ❌ 采样是高斯噪声 | MVP-0.0 |
| **H1.2.1** | λ=0.5 时 MSE 降低 >30% | H1.2 | MSE↓>30% | ✅ 59.5% | MVP-0.5 |
| **H1.3.1** | s=0 时严格 identity | H1.3 | wMAE=0 | ✅ wMAE=0.0000 | MVP-0.6 |
| **H1.3.2** | s=0.2 时 wMAE 改善 ≥10-20% | H1.3 | wMAE↓≥10% | ✅ 46.5% | MVP-0.6 |
| **H1.3.3** | s=0.05/0.1 时不恶化 | H1.3 | 恶化<10% | ✅ 19.8%/33.9%改善 | MVP-0.6 |
| **H1.4.1** | 监督式 DDPM MSE < baseline | H1.4 | MSE↓ | ⏸️ 暂停 | MVP-1.0 |
| **H2.1.1** | DPS 偏置 < 监督式 DDPM | H2.1 | bias↓ | ⏳ | MVP-1.1 |
| **H3.1.1** | 68% CI 覆盖率在 60-75% | H3.1 | 覆盖率 | ⏳ | MVP-2.0 |

## 2.4 假设依赖图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            假设金字塔依赖图                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   L1: [H1 Diffusion降噪有效]      [H2 DPS抗幻觉]      [H3 不确定性校准]      │
│              │                        │                    │               │
│        ┌─────┼─────────┐              │                    │               │
│        │     │         │              │                    │               │
│   L2: H1.1  H1.2      H1.3          H2.1               H3.1              │
│        ❌    ✅        ✅          (⏳)                (⏳)               │
│        │     │         │              │                    │               │
│   L3: H1.1.1 H1.2.1  H1.3.1~3      H2.1.1              H3.1.1            │
│        ❌     ✅     ✅✅✅         (⏳)                (⏳)               │
│                                                                             │
│   图例: ✅ 已验证 | ❌ 已否定 | ⏳ 待验证 | ⏸️ 暂停                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 3. 💡 洞见汇合站

> **多个实验的单点发现 → 汇合成高层结论和设计原则**

## 3.1 汇合点列表

| # | 汇合主题 | 单点来源 | 汇合结论 | 置信度 |
|---|---------|---------|---------|--------|
| C1 | 标准 DDPM 在 1D 光谱上不可靠 | MVP-0.0 | loss 收敛≠采样成功，需要简化方案 | 🟢 高 |
| C2 | 有限噪声方案更稳健 | MVP-0.5, MVP-0.6 | 不走到纯噪声、bounded noise 是有效路径 | 🟢 高 |
| C3 | Residual 结构是关键 | MVP-0.6 | $\hat{x}_0 = y + s \cdot g_\theta$ 保证 identity 和保守修正 | 🟢 高 |
| C4 | wMAE 优于 MSE | MVP-0.6 | 1/σ 加权保护高 SNR 区域 | 🟡 中 |

## 3.2 汇合详情

### 汇合点 C1: 标准 DDPM 在 1D 光谱上不可靠

**单点发现汇总**：

| 来源实验 | 单点发现 | 关键数据 |
|---------|---------|---------|
| [MVP-0.0](./exp_diffusion_baseline_20251203.md) | Loss 收敛但采样生成高斯噪声 | loss=0.0072, 生成是 N(0,σ²) |
| [MVP-1.0](./exp_diffusion_supervised_20251203.md) | 监督式 DDPM 训练收敛，但依赖 baseline | loss=0.0025, SSIM≈0.001 |

**汇合结论**：
> **标准 DDPM 的 1000 步"走到纯噪声再回来"方案在 1D 光谱上容易出 bug（eps vs x0 不一致等），loss 收敛不代表采样正确。需要更简单、更可验证的方案。**

**设计启示**：
- 必须验证采样，不能只看 loss
- 训练/采样接口一致性是关键
- 考虑简化到"有限噪声"方案

---

### 汇合点 C2: 有限噪声方案更稳健

**单点发现汇总**：

| 来源实验 | 单点发现 | 关键数据 |
|---------|---------|---------|
| [MVP-0.5](./exp_diffusion_bounded_noise_denoiser_20251204.md) | λ=0.5 时降噪提升 59.5% | MSE: 0.0846→0.0342 |
| [MVP-0.6](./exp_diffusion_wmae_residual_denoiser_20251204.md) | s=0.2 时 wMAE 改善 46.5% | wMAE: 0.1596→0.0854 |

**汇合结论**：
> **不走到纯噪声的 bounded noise denoiser 是有效且稳健的降噪路径。在高噪声场景（λ≥0.4 或 s≥0.1）效果显著，低噪声场景需直接使用观测值。**

**设计启示**：
- 高噪声（SNR<10）使用 denoiser
- 低噪声（SNR>30）直接使用观测值
- 简单的单步推理即可，无需复杂多步采样

---

### 汇合点 C3: Residual 结构是关键

**单点发现汇总**：

| 来源实验 | 单点发现 | 关键数据 |
|---------|---------|---------|
| [MVP-0.6](./exp_diffusion_wmae_residual_denoiser_20251204.md) | s=0 时严格 identity | wMAE=0.0000 |
| [MVP-0.6](./exp_diffusion_wmae_residual_denoiser_20251204.md) | 所有 s>0 都有改善 | 19.8%~46.5% |

**汇合结论**：
> **Residual 公式 $\hat{x}_0 = y + s \cdot g_\theta(y, s, \sigma)$ 的数学结构是成功的关键：s 乘在 residual 前，天然保证 s=0 时 identity，且小 s 时修正量被压缩，实现保守策略。**

**设计启示**：
- 使用 $y + s \cdot g_\theta$ 而非 $y + g_\theta$
- s 作为"强度旋钮"，给予精确控制能力

---

### 汇合点 C4: wMAE 优于 MSE

**单点发现汇总**：

| 来源实验 | 单点发现 | 关键数据 |
|---------|---------|---------|
| [MVP-0.6](./exp_diffusion_wmae_residual_denoiser_20251204.md) | wMAE 损失保护高 SNR 区域 | MSE改善57.2% vs wMAE改善46.5% |

**汇合结论**：
> **wMAE（1/σ 加权）比 MSE 更适合光谱降噪：高 SNR 像素（小 σ）权重大，优先保护不破坏好的地方；低 SNR 像素（大 σ）权重小，不为脏区域拼命拟合。**

---

## 3.3 冲突性发现

> **不同实验得出矛盾结论时，记录并分析原因**

| 主题 | 实验 A 结论 | 实验 B 结论 | 可能原因 | 解决方案 |
|------|-----------|-----------|---------|---------|
| 高/低噪声效果 | MVP-0.5: λ<0.3 时负效果 | MVP-0.6: s=0.05 时 19.8% 改善 | wMAE 损失 vs MSE 损失；Residual 结构差异 | 推荐 Residual+wMAE 组合 |

---

# 4. 🧭 战略导航

> **基于已有洞见，推荐下一步研究方向**

## 4.1 方向状态总览

```
┌───────────────────────────────────────────────────────────────────────────┐
│                           研究方向状态图                                    │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   🟢 高信心方向（多实验支持）              🟡 待验证方向                     │
│   ├── Residual+wMAE denoiser ← 2实验     ├── DPS 后验采样 ← 需 MVP-1.1   │
│   └── 高噪声场景降噪 ← 2实验              └── 参数偏置评估 ← 需 MVP-2.0   │
│                                                                           │
│   🔴 风险方向（有反例）                    ⚫ 已关闭方向                    │
│   └── 低噪声场景直接降噪 ← MVP-0.5        └── ~~标准 DDPM~~ ← MVP-0.0    │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

## 4.2 高信心方向（🟢 多实验支持）

| 方向 | 支持证据 | 下一步行动 | 优先级 |
|------|---------|-----------|--------|
| **Residual+wMAE denoiser** | MVP-0.5, MVP-0.6 | 扩展噪声范围 s>0.2 | 🟡 P1 |
| **高噪声场景降噪** | MVP-0.5 (59.5%), MVP-0.6 (46.5%) | 接入参数估计评估偏置 | 🔴 P0 |

## 4.3 待验证方向（🟡 假设未验证）

| 方向 | 依赖假设 | 需要实验 | 预计收益 |
|------|---------|---------|---------|
| DPS 后验采样 | H2.1 | MVP-1.1 | 抑制幻觉、提供后验 |
| +ivar 条件化 | H2.2 | MVP-1.2 | 改善异方差场景 |
| 参数偏置评估 | H1.4, H3.1 | MVP-2.0 | 验证科学可信度 |
| 覆盖率测试 | H3.1 | MVP-3.1 | 验证不确定性校准 |

## 4.4 风险方向（🔴 有反例）

| 方向 | 反例证据 | 可能原因 | 是否继续 |
|------|---------|---------|---------|
| 低噪声直接降噪 | MVP-0.5: λ<0.3 负效果 | 模型过度平滑 | 🟡 谨慎：使用 Residual 结构 |

## 4.5 已关闭方向（⚫ 已否定）

| 方向 | 否定证据 | 关闭原因 | 教训 |
|------|---------|---------|------|
| ~~标准 DDPM 1000 步~~ | MVP-0.0 | 采样失败，调试成本高 | loss 收敛 ≠ 采样正确 |

---

# 5. 📐 设计原则库

> **从实验中提炼的、可复用的设计原则**

## 5.1 已确认原则

| # | 原则名称 | 具体建议 | 证据来源 | 适用范围 |
|---|---------|---------|---------|---------|
| P1 | **必须验证采样** | loss 小 ≠ 采样正确，必须画图确认 | MVP-0.0 失败 | 所有生成模型 |
| P2 | **接口一致性** | eps-pred vs x0-pred 必须在训练和采样对齐 | MVP-0.0 失败 | Diffusion 模型 |
| P3 | **Residual 公式 s 前置** | 使用 $y + s \cdot g_\theta$ 而非 $y + g_\theta$ | MVP-0.6 | 可控降噪 |
| P4 | **wMAE 作为光谱损失** | 用 1/σ 加权而非均匀权重 | MVP-0.6 | 光谱降噪 |
| P5 | **高噪声场景用 denoiser** | SNR<10 时 denoiser 有效 | MVP-0.5, MVP-0.6 | 观测谱预处理 |
| P6 | **低噪声场景直接用观测** | SNR>30 时直接使用观测值 | MVP-0.5 | 观测谱预处理 |

## 5.2 待验证原则

| # | 原则名称 | 初步建议 | 需要验证 |
|---|---------|---------|---------|
| P7 | DPS 优于监督式 | 后验采样偏置更小 | MVP-1.1 |
| P8 | +ivar 改善异方差 | 条件化噪声 map | MVP-1.2 |

## 5.3 关键数字速查

> **设计时常用的关键数值参考**

| 指标 | 值 | 条件 | 来源 |
|------|-----|------|------|
| **最佳降噪效果** | 59.5% MSE↓ | λ=0.5 bounded | MVP-0.5 |
| **wMAE 最佳改善** | 46.5% | s=0.2 residual | MVP-0.6 |
| **低噪声改善** | 19.8% | s=0.05 residual | MVP-0.6 |
| **Identity 验证** | wMAE=0.0000 | s=0 | MVP-0.6 |
| **模型大小** | 6-7.5M params | ConditionalUNet1D | MVP-0.5/0.6 |
| **训练时间** | ~25-38 min | 50 epochs, V100 | MVP-0.5/0.6 |

---

# 6. 📎 附录

## 6.1 物理/领域背景

> **帮助理解实验结论的领域知识**

### 6.1.1 恒星光谱特殊性

- **谱线是关键信息载体**：等效宽度、线深、线位决定大气参数
- **幻觉风险**：diffusion 可能把谱线"修得更像常见恒星"（向训练集均值回归），引入系统性偏差
- **异方差噪声**：每像素 ivar 不同，天空线残差，坏像素 mask
- **LSF/分辨率变化**：跨仪器（LAMOST/APOGEE/HARPS）甚至同仪器不同 fiber

### 6.1.2 噪声模型

**光谱加性噪声模型**：
$$y = x_0 + \lambda \cdot \sigma \odot \epsilon, \quad \epsilon \sim \mathcal{N}(0, I)$$

其中：
- $x_0$: 干净光谱
- $\sigma$: 已知的 per-pixel 误差向量
- $\lambda$ (或 $s$): 噪声强度因子
- $\epsilon$: 标准高斯噪声

---

## 6.2 术语表

| 术语 | 定义 | 备注 |
|------|------|------|
| DDPM | Denoising Diffusion Probabilistic Models | 标准扩散模型 |
| DPS | Diffusion Posterior Sampling | 后验采样框架 |
| wMAE | weighted Mean Absolute Error | 1/σ 加权的 MAE |
| SNR | Signal-to-Noise Ratio | 信噪比 |
| ivar | Inverse Variance | 每像素权重 1/σ² |
| EW | Equivalent Width | 等效宽度，谱线强度指标 |
| RV | Radial Velocity | 视向速度 |

---

## 6.3 变更日志

| 日期 | 变更内容 | 影响章节 |
|------|---------|---------|
| 2025-12-06 | 从 diffusion_main.md 拆分创建 Hub | - |
| 2025-12-06 | 整合 MVP-0.0/0.5/0.6 洞见 | §2, §3, §5 |
| 2025-12-06 | 建立假设金字塔 | §2 |
| 2025-12-06 | 建立设计原则库 | §5 |

---

> **Hub 使用说明**：
> 
> **Hub 的定位**：
> - ✅ **做**：问题梳理、假设管理、洞见汇合、战略导航、设计原则
> - ❌ **不做**：实验执行追踪（→ roadmap.md）、日常 backlog（→ kanban.md）
> 
> **更新时机**：
> - 完成一批实验后，汇合结论到 §3
> - 假设被验证/否定后，更新 §2
> - 发现新方向或关闭旧方向后，更新 §4
> - 提炼出设计原则后，更新 §5
> 
> **与 roadmap.md 的分工**：
> - Hub = 「我们知道了什么？下一步该往哪走？」
> - Roadmap = 「我们计划跑哪些实验？进度如何？」

---

*最后更新: 2025-12-06*


# 📘 Diffusion 1D 恒星光谱降噪与参数推断

---
> **主题名称：** Diffusion for 1D Stellar Spectra Denoising & Parameter Inference  
> **作者：** Viska Wei  
> **创建日期：** 2025-12-03  
> **最后更新：** 2025-12-03  
> **状态：** 🔄 进行中

---

## 🔗 跨仓库集成（Cross-Repo Integration）

### 相关实验索引

| experiment_id | project | 状态 | 对应 exp.md |
|---------------|---------|------|-------------|
| `SD-20251203-diff-baseline-01` | SpecDiffusion | ❌ 失败 | [exp_diffusion_baseline_20251203.md](./exp_diffusion_baseline_20251203.md) |
| `SD-20251203-diff-supervised-01` | SpecDiffusion | ⚠️ 待验证 | [exp_diffusion_supervised_20251203.md](./exp_diffusion_supervised_20251203.md) |
| `SD-20251204-diff-bounded-01` | SpecDiffusion | ✅ 完成 | [exp_diffusion_bounded_noise_denoiser_20251204.md](./exp_diffusion_bounded_noise_denoiser_20251204.md) |
| **`SD-20251204-diff-wmae-01`** | **SpecDiffusion** | **🔄 进行中** | **[exp_diffusion_wmae_residual_denoiser_20251204.md](./exp_diffusion_wmae_residual_denoiser_20251204.md)** |

### 仓库关联

| 仓库 | 相关目录 | 说明 |
|------|---------|------|
| **SpecDiffusion** | `~/SpecDiffusion/` | ⚠️ Diffusion 专用代码仓库 |
| 本仓库 | `logg/diffusion/` | 知识沉淀 |

> ⚠️ **重要**：所有 diffusion 实验必须在 `~/SpecDiffusion` 执行，Experiment ID 使用 `SD-` 前缀

---

# 📑 目录

- [0. 📋 问题重述与意义澄清](#0--问题重述与意义澄清)
- [1. 🎯 目标](#1--目标)
- [2. 🗺️ MVP 实验路线图](#2-️-mvp-实验路线图)
- [3. 📋 子实验追踪](#3--子实验追踪)
- [4. 🔗 跨实验分析](#4--跨实验分析)
- [5. 📝 总结与展望](#5--总结与展望)
- [6. 📎 附录](#6--附录)

---

# 0. 📋 问题重述与意义澄清

## 0.1 核心研究问题

> **Diffusion 能否用于 1D 恒星光谱降噪并改善大气参数推断，同时提供可校准的不确定性估计？**

据此推断：

> **如何设计 diffusion 管线，既能提升降噪效果，又能避免生成模型"幻觉式补线"引入参数偏差？**

### 0.1.1 统计学层面

从贝叶斯逆问题视角，光谱降噪可写成：

$$
y = A(x) + n
$$

其中：
- $y$：观测谱（低 SNR）
- $x$：干净谱
- $A$：forward operator（LSF 卷积、重采样、mask 等）
- $n$：噪声（异方差高斯或 Poisson+readout）

**目标**：从 $y$ 推断 $p(x|y)$（降噪）和 $p(\theta|y)$（参数推断，$\theta$ = Teff/logg/[Fe/H] 等）。

**diffusion 的角色**：
- 作为 $p(x)$ 或 $p(x|y)$ 的生成式先验
- 结合数据一致性（likelihood）约束，抑制"幻觉"

### 0.1.2 物理/领域层面

恒星光谱的特殊性：

- **谱线是关键信息载体**：等效宽度、线深、线位决定参数
- **幻觉风险**：diffusion 可能把谱线"修得更像常见恒星"（向训练集均值回归），引入系统性偏差
- **异方差噪声**：每像素 ivar 不同，天空线残差，坏像素 mask
- **LSF/分辨率变化**：跨仪器（LAMOST/APOGEE/HARPS）甚至同仪器不同 fiber

### 0.1.3 意义与启示

| 结果情况 | 含义 | 对设计的启示 |
|---------|------|-------------|
| 监督 DDPM 降噪 $R^2$ 提升但参数偏置增加 | 视觉改善 ≠ 科学有用 | 必须评估谱线-参数一致性，不能只看 MSE/SSIM |
| DPS 后验采样校准良好 | 数据一致性约束有效抑制幻觉 | 优先采用 DPS/DPnP 路线 |
| 覆盖率严重偏离 68% | 不确定性估计失准 | 需要后校准或改进采样策略 |

---

## 0.2 多维度分析

### 0.2.1 信息论角度

- **降噪即信息恢复**：从 $y$ 中提取关于 $x$ 的信息，diffusion 提供先验正则化
- **风险**：先验太强可能"补全"训练集没见过的信息（幻觉）
- **不确定性传播**：后验样本 $x^{(s)} \sim p(x|y)$ → $\theta^{(s)}$ 实现端到端不确定性传播

### 0.2.2 物理/领域知识角度

- **已有先验**：spec-DDPM (RAA 2025) 在 LAMOST DR10 已验证降噪可行
- **开放问题**：是否引入参数偏置？覆盖率是否校准？

### 0.2.3 模型设计角度

| 场景 | 监督式 DDPM | DPS 后验采样 |
|------|-----------|-------------|
| 有成对数据 | ✅ 直接训练 | 可用，但不必要 |
| 只有干净谱 | ❌ 需要合成噪声 | ✅ 训练先验即可 |
| 需要不确定性 | ⚠️ 点估计 | ✅ 天然输出后验样本 |
| 抗幻觉 | ⚠️ 依赖数据覆盖 | ✅ 显式 likelihood 约束 |

---

## 0.3 实验定位

### 价值

1. **验证 diffusion 在 1D 光谱的有效性**：不只是"跑得通"，而是"科学上可信"
2. **建立可校准的不确定性管线**：超越点估计，提供覆盖率可验证的后验
3. **为跨仪器泛化奠基**：函数空间 diffusion 思路

### 局限

1. **数据依赖**：需要高质量训练谱，跨巡天 domain shift 是挑战
2. **计算成本**：diffusion 采样慢于判别式模型
3. **评价复杂**：需要设计谱线级别的评价指标，不能只看全局 MSE

**定位声明**：
> **本实验系列旨在探索 diffusion 作为恒星光谱降噪与参数推断工具的可行性与局限性，重点关注"科学可信度"（参数无偏、不确定性校准）而非单纯的"视觉改善"。**

---

# 1. 🎯 目标

## 1.1 背景与动机

**研究背景**：
- 巡天数据量爆发（LAMOST DR10: 2229 万条谱），但大量低 SNR 谱利用不足
- 传统降噪（PCA、小波、DnCNN）缺乏物理约束，可能引入偏差
- Diffusion 在图像/2D 已展现强大生成能力，1D 谱的迁移研究刚起步

**已有工作**：
- **spec-DDPM (RAA 2025)**：在 LAMOST DR10 上用 28,500 对低/高 SNR 谱训练，报告降噪 + 参数估计改善
- **DPS (Chung et al. 2022)**：通用的后验采样框架，处理噪声/非线性逆问题
- **DPnP**：plug-and-play 的 likelihood/prior 交替采样

**核心目标**（勾选适用项）：
- [x] 验证 diffusion 降噪对恒星参数估计的影响（正面 or 引入偏置？）
- [x] 建立可校准的不确定性传播管线
- [x] 对比监督式 vs 后验采样两种范式
- [ ] 跨仪器泛化（后续工作）

**一句话概括**：
> 通过对比监督式 DDPM 与 DPS 后验采样，验证 diffusion 在恒星光谱降噪+参数推断中的科学可信度，重点报告**参数偏置**与**覆盖率校准**。

---

## 1.2 核心假设

### 主假设

> **H0：Diffusion 降噪能改善恒星参数估计精度，同时通过后验采样提供可校准的不确定性估计。**

**如果假设成立，意味着**：
1. Diffusion 可成为低 SNR 巡天谱的标准预处理步骤
2. 参数估计可配套端到端不确定性量化
3. 为 active learning / 观测策略优化提供 epistemic 信息

**如果假设不成立，则需要**：
1. 分析 diffusion 在哪些 SNR/参数区间引入偏置
2. 探索混合策略（低 SNR 用 diffusion，高 SNR 直接用）
3. 考虑更强的物理约束（谱线 mask、参数条件化）

### 子假设

| 编号 | 子假设 | 对应 MVP | 状态 |
|------|--------|---------|------|
| H1.1 | 监督式 DDPM 能降低 MSE 但可能引入参数偏置 | MVP-1.0 | ⏳ 待验证 |
| H1.2 | DPS 后验采样通过 likelihood 约束能抑制幻觉 | MVP-1.1 | ⏳ 待验证 |
| H1.3 | 后验样本 → 参数的覆盖率接近名义值 (68%/95%) | MVP-2.0 | ⏳ 待验证 |
| H1.4 | 条件化 noise map/ivar 能改善异方差场景 | MVP-1.2 | ⏳ 待验证 |

---

## 1.3 验证问题

| # | 问题 | 验证目标 | 预期结果 | 实际结果 |
|---|------|---------|---------|---------|
| Q1 | 监督 DDPM vs DnCNN/PCA 的 MSE/SSIM 差异？ | H1.1 视觉改善 | DDPM 更优 | ⏳ 待填写 |
| Q2 | 降噪后参数估计的 bias 是否显著增加？ | H1.1 参数偏置 | bias < 0.05 dex | ⏳ 待填写 |
| Q3 | DPS vs 监督 DDPM 在参数偏置上的差异？ | H1.2 抗幻觉 | DPS 偏置更小 | ⏳ 待填写 |
| Q4 | 后验参数样本的 68% 覆盖率是否接近 68%？ | H1.3 校准 | 60-75% | ⏳ 待填写 |
| Q5 | 条件化 ivar 是否改善低 SNR 区域？ | H1.4 异方差 | 低 SNR 提升显著 | ⏳ 待填写 |
| Q6 | 关键谱线窗（H$\alpha$, Ca II triplet）的等效宽度偏差？ | 科学可信度 | EW bias < 5% | ⏳ 待填写 |
| Q7 | RV（视向速度）估计的偏置？ | 线位准确性 | RV bias < 1 km/s | ⏳ 待填写 |

---

## 1.4 结论摘要（实验后填写）

> **✅ MVP-0.5 通过验收！有限噪声 denoiser 在 λ=0.5 时达到 59.5% 降噪提升，验证了"不走到纯噪声"方案的可行性。高噪声场景（λ≥0.4）效果显著，低噪声场景需直接使用观测值。**

### 1.4.1 已验证结论

| 结论 | 说明 | 来源 |
|------|------|------|
| ❌ **MVP-0.0 采样失败** | loss=0.0072 但生成是高斯噪声 | MVP-0.0 |
| ✅ **MVP-0.5 通过验收** | λ=0.5 时降噪提升 59.5% | **MVP-0.5** |
| ✅ **不需要走到纯噪声** | bounded noise 方案更简单稳健 | **MVP-0.5** |
| ⚠️ **低噪声场景需注意** | λ<0.3 时模型过度平滑 | **MVP-0.5** |

### 1.4.2 设计启示（已确认）

| 设计原则 | 具体建议 | 证据来源 |
|---------|---------|----------|
| **高噪声场景效果好** | 对于 SNR<10 的观测谱，bounded denoiser 有效 | **MVP-0.5 成功** |
| **低噪声场景需谨慎** | λ<0.3 时模型过度平滑，应直接使用观测值 | **MVP-0.5** |
| **必须验证采样** | loss 小 ≠ 采样正确，必须画图确认 | MVP-0.0 失败教训 |
| 内存优先 | 减少高分辨率层的 attention | MVP-0.0 OOM 调试 |

### 1.4.3 关键数字速查

| 指标 | 值 | 备注 |
|------|-----|------|
| **MVP-0.5 降噪提升 @ λ=0.5** | **59.5%** | ✅ **通过验收** |
| **MVP-0.5 降噪提升 @ λ=0.4** | 28.5% | 接近阈值 |
| MVP-0.5 Final Loss | 0.000432 | |
| MVP-0.5 Model Size | 6.3M params | ConditionalUNet1D |
| MVP-0.0 Final Loss | 0.0072 | ⚠️ **不代表采样成功** |

---

# 2. 🗺️ MVP 实验路线图

## 2.1 整体规划

### 实验分组

| Phase | 目的 | 包含 MVP | 状态 |
|-------|------|---------|------|
| **Phase 0: Sanity Check** | 确认 1D U-Net 能训练 diffusion | MVP-0.0 | ⏳ |
| **Phase 1: 降噪路线对比** | 监督式 vs DPS 后验采样 | MVP-1.0, MVP-1.1, MVP-1.2 | ⏳ |
| **Phase 2: 参数推断** | 从降噪谱推参数 + 不确定性传播 | MVP-2.0, MVP-2.1 | ⏳ |
| **Phase 3: 评价与校准** | 谱线级评价 + 覆盖率测试 | MVP-3.0, MVP-3.1 | ⏳ |

### 依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Diffusion 实验依赖图                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   [MVP-0.0: 1D U-Net DDPM Baseline]                                     │
│         │                                                               │
│         ├──────────────────────┬───────────────────────────────┐        │
│         ▼                      ▼                               ▼        │
│   [MVP-1.0: 监督式 DDPM]  [MVP-1.1: DPS 后验采样]     [MVP-1.2: +ivar]  │
│   (spec-DDPM 复现)        (先验+likelihood)          (异方差条件化)      │
│         │                      │                               │        │
│         └──────────────────────┼───────────────────────────────┘        │
│                                ▼                                        │
│                    [MVP-2.0: 采样谱 → 参数后验]                          │
│                    (样本传播不确定性)                                    │
│                                │                                        │
│                                ├───────────────┐                        │
│                                ▼               ▼                        │
│              [MVP-3.0: 谱线级评价]    [MVP-3.1: 覆盖率测试]              │
│              (EW/线深/RV 偏置)        (PIT/可信区间校准)                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2.2 MVP 详细设计

### Phase 0: Sanity Check

#### MVP-0.0: 1D U-Net DDPM Baseline ❌ 失败

| 项目 | 配置 |
|------|------|
| **目标** | 验证 1D U-Net 能在恒星光谱上训练 DDPM |
| **数据** | LAMOST DR10 高 SNR 谱 (~10,000) |
| **模型** | 1D U-Net (4 blocks, 64→256 channels), T=1000 steps |
| **训练** | Noise prediction (ε-prediction), 50 epochs |
| **验收标准** | 能生成视觉上像光谱的样本 |
| **结果** | ❌ **失败**：loss=0.0072 但采样生成高斯噪声 |
| **失败原因** | 可能是 eps vs x0 预测类型不一致 |

---

#### MVP-0.5: 有限噪声多级 Denoiser 🆕

> **核心思路**：不走到纯噪声，而是在物理合理的噪声范围内（λ ≤ 0.5）训练 denoiser，更贴合真实观测场景。

| 项目 | 配置 |
|------|------|
| **目标** | 验证 denoiser 能在已知噪声模型下降噪，不依赖全 diffusion |
| **噪声模型** | $y = x_0 + \lambda \cdot \sigma \odot \epsilon$，其中 $\sigma$ 是 per-pixel error vector |
| **噪声范围** | $\lambda \in \{0.1, 0.2, 0.3, 0.4, 0.5\}$ |
| **网络输入** | $[x_t, \sigma]$ 或 $[x_t, \sigma, \lambda_{embed}]$ |
| **训练目标** | eps-MSE 或 x0-MSE |
| **推理起点** | 观测谱 $y$，设 $\lambda_T = 0.5$，**不从纯噪声开始** |
| **反向步骤** | 10-20 步：$\hat{x}_0^{(t)} = x_t - \lambda_t \sigma \odot \hat{\epsilon}_t$ |
| **评价指标** | MSE(noisy, clean) vs MSE(denoised, clean)，wMSE = mean((Δx/σ)²) |
| **验收标准** | noise level=0.5 时，MSE 和 wMSE 明显优于直接观测 |

**物理优势**：
- 完全尊重真实噪声模型（σ 向量已知）
- 不要求走到"纯噪声"，更稳健
- 更接近后续 DPS/inverse-problem 设定
- 用 10-20 步即可做 sanity check

**数学形式**：

$$y = x_0 + \lambda \cdot \sigma \odot \epsilon, \quad \epsilon \sim \mathcal{N}(0, I), \quad \lambda \in [0, 0.5]$$

**推理公式**（从观测谱 $y$ 开始）：
$$\hat{\epsilon}_t = \epsilon_\theta(x_t, \lambda_t, \sigma)$$
$$\hat{x}_0^{(t)} = x_t - \lambda_t \cdot \sigma \odot \hat{\epsilon}_t$$
$$x_{t-1} = \hat{x}_0^{(t)} + \lambda_{t-1} \cdot \sigma \odot \hat{\epsilon}_t$$

---

### Phase 1: 降噪路线对比

#### MVP-1.0: 监督式条件 DDPM (spec-DDPM 复现)

| 项目 | 配置 |
|------|------|
| **目标** | 复现 spec-DDPM 思路，训练 $p(x_{clean} \| y_{noisy})$ |
| **数据** | 成对低/高 SNR 谱 (同目标多次观测 or 人工加噪) |
| **模型** | 条件 1D U-Net，$y_{noisy}$ 作为 conditioning |
| **指标** | MSE, SSIM-1D, 后续参数偏置 |
| **验收标准** | MSE 优于 DnCNN/PCA baseline |
| **风险** | 参数偏置可能增加 |

**→ 对假设的影响**：若参数偏置增加，则 H1.1 警告成立

---

#### MVP-1.1: DPS 后验采样

| 项目 | 配置 |
|------|------|
| **目标** | 训练无条件先验 $p(x)$，推理时用 DPS 做后验 |
| **数据** | 只需高 SNR 谱训练先验 |
| **模型** | 无条件 1D U-Net + DPS guidance |
| **Forward Operator** | $A(x) = x$ (或含 LSF/mask) |
| **噪声模型** | 异方差高斯，$\sigma(\lambda)$ from ivar |
| **验收标准** | 偏置 < 监督式 DDPM |

**→ 对假设的影响**：若偏置显著降低，则 H1.2 成立

---

#### MVP-1.2: 条件化 noise map / ivar

| 项目 | 配置 |
|------|------|
| **目标** | 测试将 per-pixel ivar 作为额外 conditioning 的效果 |
| **依赖** | MVP-1.0 or MVP-1.1 |
| **数据** | 同上，额外提供 ivar channel |
| **模型** | 2-channel input (spectrum + ivar) |
| **验收标准** | 低 SNR 区域改善 |

---

### Phase 2: 参数推断

#### MVP-2.0: 采样谱 → 参数后验（最稳方案）

| 项目 | 配置 |
|------|------|
| **目标** | 从后验谱样本传播不确定性到参数 |
| **方法** | $x^{(s)} \sim p(x\|y)$ → 参数估计器 → $\theta^{(s)}$ |
| **参数估计器** | Ridge/MLP/The Payne |
| **输出** | $\theta$ 后验样本集合 |
| **验收标准** | 覆盖率接近名义值 |

---

#### MVP-2.1: 直接训练摊销后验 $p(\theta|y)$（可选，更快）

| 项目 | 配置 |
|------|------|
| **目标** | 直接学习 $p(\theta\|y)$ 的条件 score |
| **优点** | 推理快，一次 forward 得参数分布 |
| **风险** | 标签噪声直接进后验，跨巡天 shift |
| **验收标准** | 推理速度 <1s，覆盖率可接受 |

---

### Phase 3: 评价与校准

#### MVP-3.0: 谱线级评价

| 项目 | 配置 |
|------|------|
| **目标** | 评估关键谱线的物理量偏置 |
| **指标** | 等效宽度 (EW) 偏差、线深偏差、RV 偏差、continuum 偏差 |
| **谱线窗** | H$\alpha$, H$\beta$, Ca II triplet, Mg b |
| **验收标准** | EW bias < 5%, RV bias < 1 km/s |

---

#### MVP-3.1: 覆盖率测试 (PIT / Calibration)

| 项目 | 配置 |
|------|------|
| **目标** | 验证后验不确定性是否校准 |
| **方法** | PIT histogram, 68%/95% 覆盖率统计 |
| **验收标准** | 覆盖率偏差 < 10% (e.g., 68% CI 实际覆盖 60-75%) |

---

## 2.3 实验配置总览

| MVP | 数据规模 | 模型 | 关键变量 | 验收标准 |
|-----|---------|------|---------|---------|
| MVP-0.0 | 10K 高 SNR | 1D U-Net | - | 能生成谱 |
| MVP-1.0 | 20K 成对 | 条件 DDPM | supervision | MSE < baseline |
| MVP-1.1 | 10K 高 SNR | DPS | guidance scale | 偏置 < MVP-1.0 |
| MVP-1.2 | 同上 | +ivar conditioning | ivar channel | 低 SNR 改善 |
| MVP-2.0 | - | 采样传播 | N_samples | 覆盖率 ~68% |
| MVP-3.0 | - | - | 谱线窗 | EW bias < 5% |
| MVP-3.1 | - | - | PIT | 覆盖率校准 |

---

# 3. 📋 子实验追踪

## 3.1 实验总览

| MVP | 实验名称 | 状态 | 报告链接 | 核心结论（一句话） |
|-----|---------|------|---------|------------------|
| MVP-0.0 | 1D U-Net DDPM Baseline | ❌ 失败 | [exp_diffusion_baseline_20251203.md](./exp_diffusion_baseline_20251203.md) | ❌ loss=0.0072 但采样生成高斯噪声，需排查 eps/x0 一致性 |
| **MVP-0.5** | **有限噪声多级 Denoiser** | ✅ **通过** | [exp_diffusion_bounded_noise_denoiser_20251204.md](./exp_diffusion_bounded_noise_denoiser_20251204.md) | **✅ 59.5% 降噪提升 @ λ=0.5，高噪声有效，低噪声过度平滑** |
| MVP-1.0 | 监督式 DDPM (spec-DDPM 复现) | ⏸️ 暂停 | [exp_diffusion_supervised_20251203.md](./exp_diffusion_supervised_20251203.md) | 训练收敛(loss=0.0025)，但依赖 baseline，暂停 |
| MVP-1.1 | DPS 后验采样 | ⏳ 计划中 | - | - |
| MVP-1.2 | +ivar 条件化 | ⏳ 计划中 | - | - |
| MVP-2.0 | 采样谱 → 参数后验 | ⏳ 计划中 | - | - |
| MVP-3.0 | 谱线级评价 | ⏳ 计划中 | - | - |
| MVP-3.1 | 覆盖率测试 | ⏳ 计划中 | - | - |

---

## 3.2 进度看板

```
┌──────────────┬──────────────┬──────────────┬──────────────┬──────────────┐
│   🆕 新增     │   ⏳ 计划中   │   ⏸️ 暂停    │   ✅ 已完成   │   ❌ 失败    │
├──────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│              │ MVP-1.1      │ MVP-1.0      │ MVP-0.5 ✅   │ MVP-0.0      │
│              │ MVP-1.2      │              │ (59.5%提升)  │ (采样失败)   │
│              │ MVP-2.0      │              │              │              │
│              │ MVP-3.0      │              │              │              │
│              │ MVP-3.1      │              │              │              │
└──────────────┴──────────────┴──────────────┴──────────────┴──────────────┘
```

---

## 3.3 结论提取记录

| 日期 | 来源实验 | 提取的核心结论 | 更新到 main 的位置 |
|------|---------|---------------|-------------------|
| 2025-12-03 | MVP-0.0 Baseline | ~~DDPM 在 1D 光谱上可行~~ | §1.4, §3.1, §4.1 |
| 2025-12-04 | MVP-0.0 Baseline（修正） | ❌ **失败**：loss=0.0072 但采样生成高斯噪声，需排查 eps/x0 一致性 | §1.4, §3.1, §3.2, §4.2 |
| 2025-12-03 | MVP-1.0 监督式 DDPM | 训练收敛良好(loss=0.0025)，但依赖 baseline，**暂停验证** | §3.1, §4.1, §4.2 |
| 2025-12-04 | MVP-0.5 立项 | 🆕 有限噪声多级 denoiser（λ≤0.5，已知σ）作为更稳健路径 | §2.2, §3.1, §4.2 |
| **2025-12-04** | **MVP-0.5 完成** | ✅ **通过验收**：59.5% 降噪提升 @ λ=0.5，高噪声有效，低噪声过度平滑 | §1.4, §3.1, §3.2, §4.2 |

---

# 4. 🔗 跨实验分析

## 4.1 结果对比矩阵

| MVP | MSE | SSIM-1D | 参数 Bias | 覆盖率 | 关键发现 |
|-----|-----|---------|----------|--------|---------|
| MVP-0.0 | 0.0072 (loss) | - | N/A | N/A | ❌ **失败**：loss 好但采样生成高斯噪声，需排查 eps/x0 一致性 |
| **MVP-0.5** | - | - | - | - | 🆕 有限噪声 denoiser（λ≤0.5），更稳健路径 |
| MVP-1.0 | ~0.48 | ~0.001 | 待测 | N/A | ⏸️ 暂停：依赖 baseline，待 MVP-0.0 或 MVP-0.5 通过 |
| MVP-1.1 | - | - | - | - | - |
| MVP-2.0 | - | - | - | - | - |

## 4.2 假设验证进度

| 子假设 | 验证 MVP | 结果 | 结论 |
|--------|---------|------|------|
| H0.1 DDPM 在 1D 数据上有效 | MVP-0.0 | ❌ **失败** | loss=0.0072 但采样生成高斯噪声，需排查 eps/x0 一致性 |
| **H0.2 有限噪声 denoiser 有效** | **MVP-0.5** | ✅ **通过** | **59.5% 降噪提升 @ λ=0.5，高噪声有效，低噪声过度平滑** |
| H1.1 监督 DDPM 可能引入偏置 | MVP-1.0 | ⏸️ 暂停 | 依赖 baseline，暂停验证 |
| H1.2 DPS 抑制幻觉 | MVP-1.1 | ⏳ | - |
| H1.3 覆盖率校准 | MVP-2.0 | ⏳ | - |
| H1.4 ivar 条件化有效 | MVP-1.2 | ⏳ | - |

## 4.3 发现汇总

### 失败教训（❌ 重要）

| 教训 | 说明 | 来源 |
|------|------|------|
| **loss 小 ≠ 采样成功** | MVP-0.0 loss=0.0072 但采样是高斯噪声 | MVP-0.0 失败 |
| **必须画图验证采样** | 不能只看 loss 就下结论 | MVP-0.0 失败 |
| **eps vs x0 一致性关键** | 训练和采样的预测类型必须对齐 | MVP-0.0 分析 |

### 一致性发现（多个实验支持）

| 发现 | 支持实验 | 置信度 |
|------|---------|--------|
| ~~Diffusion 适合 1D 光谱生成~~ | ~~MVP-0.0~~ | ❌ 待重新验证 |
| 内存优化：高分辨率层避免 attention | MVP-0.0 | ✅ 实践验证 |

---

# 5. 📝 总结与展望

## 5.1 核心结论

> *实验完成后填写*

## 5.2 设计原则提炼

| 原则 | 建议 | 依据 |
|------|------|------|
| *待填写* | - | - |

## 5.3 遗留问题

| 问题 | 优先级 | 建议后续实验 |
|------|--------|-------------|
| 跨仪器泛化（LAMOST → APOGEE） | 🔴 高 | 函数空间 diffusion (DDO) |
| 非高斯噪声（Poisson） | 🟡 中 | 修改 DPS likelihood |
| 计算效率（采样速度） | 🟡 中 | DDIM / consistency models |

## 5.4 下一步计划（❌ 修正后）

| 方向 | 具体任务 | 预计时间 | 优先级 |
|------|----------|---------|--------|
| **排查 Bug** | 确认 MVP-0.0 的 eps vs x0 预测类型一致性 | ~1h | 🔴 P0 |
| **MVP-0.5** | 有限噪声多级 Denoiser（λ≤0.5，已知σ） | ~2h | 🔴 P0 |
| **Toy 测试** | T=1 or 2 的极简 diffusion，单噪声级别验证 | ~1h | 🔴 P0 |
| ~~Phase 1~~ | ~~MVP-1.0 监督式 DDPM~~ | - | ⏸️ 暂停 |

---

# 6. 📎 附录

## 6.1 决策树：不同结果的解读与应对

### 情形 A: 监督 DDPM MSE 优但参数偏置增加

**诊断**：视觉改善 ≠ 科学有用，模型"补线"向训练集均值回归

**应对策略**：
1. 切换到 DPS 路线，显式加入 likelihood 约束
2. 分析哪些谱线/参数区间偏置最大

---

### 情形 B: DPS 偏置小但覆盖率严重偏离

**诊断**：后验采样过窄或过宽

**应对策略**：
1. 调整 guidance scale
2. 考虑后校准（recalibration）
3. 检查 noise model 是否准确

---

## 6.2 数值结果汇总表

*实验完成后填写*

---

## 6.3 相关文件索引

| 类型 | 文件路径 | 说明 |
|------|---------|------|
| 主框架 | `logg/diffusion/diffusion_main_20251203.md` | 当前文件 |
| GPT 会话 | `logg/diffusion/sessions/session_20251203_diffusion_init.md` | 立项讨论 |
| 图表目录 | `logg/diffusion/img/` | 实验图表 |

---

## 6.4 参考文献

| 文献 | 说明 |
|------|------|
| [spec-DDPM (RAA 2025)](https://www.raa-journal.org/issues/all/2025/v25n10/SpecialIssueArticles/202509/t20250915_773098.html) | LAMOST DR10 恒星谱降噪，监督式 DDPM |
| [DPS (arXiv 2209.14687)](https://arxiv.org/abs/2209.14687) | Diffusion Posterior Sampling，处理噪声逆问题 |
| [DPnP (arXiv 2403.17042)](https://arxiv.org/abs/2403.17042) | Provably Robust Score-Based Diffusion |
| [条件 Score (arXiv 2305.19147)](https://arxiv.org/abs/2305.19147) | 贝叶斯逆问题无限维理论 |
| [宇宙学 Diffusion (arXiv 2312.07534)](https://arxiv.org/html/2312.07534v1) | 场生成 + 参数推断 |
| [函数空间 Diffusion (arXiv 2302.07400)](https://arxiv.org/abs/2302.07400) | DDO，分辨率无关 |
| [条件生成光谱 (arXiv 2211.05556)](https://arxiv.org/abs/2211.05556) | 从测光生成星系光谱 |
| [LAMOST DR10](https://www.lamost.org/public/node/465?locale=en) | 2229 万条光谱 |

---

## 6.5 变更日志

| 日期 | 变更内容 | 影响 |
|------|---------|------|
| 2025-12-03 | 创建主实验框架 | - |
| 2025-12-03 | 更新 MVP-0.0 Baseline 实验结果 | §1.4, §3.1, §3.2, §3.3, §4.1, §4.2, §4.3 |
| 2025-12-03 | 更新 MVP-1.0 监督式 DDPM 实验结果 | §3.1, §3.2, §3.3, §4.1, §4.2 |
| 2025-12-04 | ❌ 修正 MVP-0.0 为失败：采样生成高斯噪声，需排查 eps/x0 一致性 | §1.4, §3.1, §3.2, §3.3, §4.1, §4.2, §4.3 |
| 2025-12-04 | 🆕 新增 MVP-0.5：有限噪声多级 Denoiser（λ≤0.5，已知σ） | §2.2, §3.1, §4.2 |
| 2025-12-04 | ⏸️ 暂停 MVP-1.0：依赖 baseline，待 MVP-0.0 或 MVP-0.5 通过 | §3.1, §3.2, §5.4 |
| **2025-12-04** | **✅ MVP-0.5 通过验收**：59.5% 降噪提升 @ λ=0.5，高噪声有效 | §1.4, §3.1, §3.2, §3.3, §4.2 |

---

*最后更新: 2025-12-04*


---

## 📢 更新 (2025-12-04 19:25)

### MVP-0.6 wMAE Residual Denoiser ✅ 已完成

**实验ID**: SD-20251204-diff-wmae-01

**结果摘要**:

| noise_level (s) | wMAE (noisy) | wMAE (denoised) | Improvement |
|-----------------|--------------|-----------------|-------------|
| 0.00 | 0.0000 | 0.0000 | 0.0% (Identity) |
| 0.05 | 0.0399 | 0.0320 | **19.8%** ↓ |
| 0.10 | 0.0798 | 0.0527 | **33.9%** ↓ |
| 0.20 | 0.1596 | 0.0854 | **46.5%** ↓ |

**成功判据验证**:
- ✅ s=0 identity: wMAE = 0.0000 (严格 identity)
- ✅ s=0.2 improvement ≥10-20%: 实际 46.5%
- ✅ s=0.05 no degradation: 实际 19.8% improvement
- ✅ s=0.1 no degradation: 实际 33.9% improvement

**关键发现**:
1. Residual 结构 x̂₀ = y + s·g_θ(y, s, σ) 有效保证 s=0 时的 identity
2. wMAE 损失对高 SNR 区域有更好的保护作用
3. 在所有测试噪声水平上都实现了显著改善

**详细报告**: [exp_diffusion_wmae_residual_denoiser_20251204.md](exp_diffusion_wmae_residual_denoiser_20251204.md)

**生成的图表**: 
- `img/diff_wmae_loss_curve.png`
- `img/diff_wmae_comparison.png`
- `img/diff_wmae_residual_dist.png`
- `img/diff_wmae_spectra_s0p00.png`
- `img/diff_wmae_spectra_s0p05.png`
- `img/diff_wmae_spectra_s0p10.png`
- `img/diff_wmae_spectra_s0p20.png`


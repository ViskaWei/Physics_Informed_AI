# 🧠 logg 1M Hub
> **ID:** `VIT-20251222-logg1m-hub` | **Status:** 🌱探索 |  
> **Date:** 2025-12-22 | **Update:** 2025-12-26  
> **Root:** [scaling_hub](../scaling/scaling_hub_20251222.md) | **Child:** - |
> **🎯 大方向:** 在 low-noise 条件下，log g 的预测精度还能提升多少？瓶颈在哪里？

| # | 💡 共识[抽象洞见] | 证据 | 决策 |
|---|----------------------------|----------------|------|
| K1 | **logg 信息远未被现有模型榨干，存在显著提升空间** | Fisher R²_max=0.89 vs ViT=0.71, gap=+18% | 继续投入模型改进值得 |
| K2 | **传统 ML 在 noise=1.0 下存在明确性能天花板** | Ridge=0.50, LightGBM=0.57, 1M数据增益<3% | 需要深度学习突破 |
| K3 | **ViT 在 1M 数据上已超越传统 ML，但距理论上限仍有差距** | ViT R²=0.71 > LightGBM=0.57, 但 < Fisher=0.89 | 继续优化架构/训练策略 |

**🦾 现阶段信念 [≤10条，写"所以呢"]**
- **理论上限高，模型有提升空间**：Fisher R²_max=0.89 证明信息仍可提取，ViT=0.71 距上限 +18%（So what：继续投入模型改进值得）
- **传统 ML 已到天花板**：Ridge/LightGBM 在 1M 数据下仅 R²=0.50-0.57，100k→1M 增益<3%（So what：必须用深度学习）
- **数据规模对 ViT 至关重要**：1M 数据使 ViT 达到 R²=0.71，小数据集无法充分发挥（So what：1M 数据集投资合理）

**👣 下一步最有价值 [≤2条，直接可进 Roadmap Gate]**
- 🔴 **P0**：完成 Fisher 理论上限分析 → If 误差/理论σ > 2 then 继续 Phase 1-2 else 转向物理先验
- 🟡 **P1**：验证敏感窗口 vs 全谱 → If 窗口≥全谱 then 做自适应 token else 继续全谱优化

> **权威数字（一行即可）**：Best=0.71 (ViT)；Baseline=0.57 (LightGBM)；Δ=+0.14；条件=1M数据, noise=1.0, R²  
> **理论上限**：Fisher R²_max=0.89 @ noise=1.0, mag=21.5

| 模型/方法 | 指标值 | 配置 | 备注 |
|-----------|--------|------|------|
| **ViT** | **0.713** | 1M, noise=1.0, L6-H256 | 🥇 当前最佳 |
| LightGBM | 0.5709 | 1M, noise=1.0 | Baseline |
| Ridge | 0.5017 | 1M, noise=1.0, α=1e5 | 线性 baseline |
| **Fisher ceiling** | **0.89** | noise=1.0, mag=21.5 | 理论上限 |

## 📑 Contents

- [1. 🌲 核心假设树](#1--核心假设树)
- [2. 口径冻结](#2-口径冻结唯一权威)
- [3. 当前答案 & 战略推荐](#3-当前答案--战略推荐对齐问题树)
- [4. 洞见汇合](#4-洞见汇合多实验--共识)
- [5. 决策空白](#5-决策空白decision-gaps)
- [6. 设计原则](#6-设计原则可复用规则)
- [7. 指针](#7-指针详细信息在哪)
- [8. 变更日志](#8-变更日志只记录知识改变)

---

## 1) 🌲 核心假设树
```
🌲 核心: 在 low-noise 条件下，log g 还能提升多少？瓶颈在哪里？
│
├── Q0: 地基问题 - 如何定义可复现的实验条件？
│   ├── Q0.1: 什么是"low-noise"？如何量化？ → ⏳ MVP-0.A
│   └── Q0.2: 当前模型距离上下限有多远？ → 🔆 ViT=0.71, Fisher=0.89, gap=+18%
│
├── Q1: 信息瓶颈 - logg 信息在谱中是否已被充分提取？
│   ├── Q1.1: Fisher 理论上限是多少？模型差距有多大？ → 🔆 Fisher=0.89, ViT=0.71, gap=+18%
│   ├── Q1.2: logg 敏感窗口 vs 全谱，哪个更准？ → ⏳ MVP-1.4
│   └── Q1.3: 无关波段是否在拖累优化？ → ⏳ MVP-1.4
│
├── Q2: 输入表示 - 模型是否知道哪些像素可信？
│   ├── Q2.1: 把 error/ivar 作为输入能否提升？ → ⏳ MVP-1.2
│   ├── Q2.2: 归一化方式是否压扁了 logg 信号？ → ⏳ MVP-1.3
│   └── Q2.3: 导数/高通通道是否放大线翼信息？ → ⏳ MVP-3.4
│
├── Q3: 训练目标 - logg 是否被 Teff/FeH 混淆？
│   ├── Q3.1: 多任务联合是否能拆分因素？ → ⏳ MVP-1.5
│   ├── Q3.2: 序回归/分箱是否比纯 MSE 更稳？ → ⏳ MVP-3.6
│   └── Q3.3: 异方差回归是否能处理可辨识性差异？ → ⏳ MVP-3.2
│
├── Q4: 表示学习 - 自监督预训练能否突破监督上限？
│   ├── Q4.1: Masked Spectrum Modeling 预训练有效吗？ → ⏳ MVP-2.1
│   └── Q4.2: 去噪预训练是否能提升线翼测量？ → ⏳ MVP-2.2
│
└── Q5: Token化与位置编码 - 架构设计是否匹配物理？
    ├── Q5.1: 物理波长位置编码 vs learnable PE？ → ⏳ MVP-3.1
    └── Q5.2: 多尺度 token 是否兼顾线翼细节和上下文？ → ⏳ MVP-2.3

Legend: ✅ 已验证 | ❌ 已否定 | 🔆 进行中 | ⏳ 待验证 | 🗑️ 已关闭
```

## 2) 口径冻结（唯一权威）
| 项目 | 规格 |
|---|---|
| Dataset / Version | mag205_225_lowT_1M (BOSZ→PFS MR) |
| Train / Val / Test | 1M / 1k / 10k (ViT) 或 1M / 500 (Ridge/LGB) |
| Noise / Regime | noise_level=1.0 (高噪声) 或 Top 20% SNR (low-noise) |
| Metric | R² (主要), MAE (辅助) |
| Seed / Repeats | seed=42 (ViT), 单次运行 (Ridge/LGB) |
> 规则：任何口径变更必须写入 §8 变更日志。
---

---

## 3) 当前答案 & 战略推荐（对齐问题树）
### 3.1 战略推荐（只保留"当前推荐"）
- **推荐路线：Route ViT+信息利用优化**（理由：ViT 已超越传统 ML，但距理论上限 +18%，重点在输入表示/窗口/归一化改进）
- 需要 Roadmap 关闭的 Gate：Gate-1（Fisher 上限验证）, Gate-2（敏感窗口验证）

| Route | 一句话定位 | 当前倾向 | 关键理由 | 需要的 Gate |
|---|---|---|---|---|
| Route A: 堆更大模型 | 更深/更宽 ViT | 🟡 | ViT=0.71 距上限 +18%，但需先验证信息利用 | Gate-1 |
| Route B: 信息利用优化 | 窗口/归一化/error输入 | 🟢 推荐 | Fisher=0.89 证明信息存在，需改进提取 | Gate-1, Gate-2 |
| Route C: 表示学习 | MSM/去噪预训练 | 🟡 | 可能突破监督上限，但需先验证基础改进 | Gate-1 |

### 3.2 分支答案表（每行必须回答"所以呢"）
| 分支 | 当前答案（1句话） | 置信度 | 决策含义（So what） | 证据（exp/MVP） |
|---|---|---|---|---|
| Q0.2: 当前模型距离上下限 | ViT=0.71, Fisher=0.89, gap=+18% | 🟢 | 继续投入模型改进值得 | ViT-1M, Fisher-ceiling |
| Q1.1: Fisher 理论上限 | R²_max=0.89 @ noise=1.0 | 🟢 | 信息远未被榨干，有提升空间 | Fisher-ceiling |
| Q1.2: 敏感窗口 vs 全谱 | 待验证 | ⏳ | If 窗口≥全谱 then 做自适应 token | MVP-1.4 |
| Q2.1: error 输入 | 待验证 | ⏳ | If 有效 then 加权 loss 成为标准 | MVP-1.2 |
| Q2.2: 归一化方式 | 待验证 | ⏳ | If 有效 then 分块归一化成为标准 | MVP-1.3 |
| Q3.1: 多任务联合 | 待验证 | ⏳ | If 有效 then 多任务成为必需 | MVP-1.5 |
| Q4.1: MSM 预训练 | 待验证 | ⏳ | If 有效 then 预训练成为标准流程 | MVP-2.1 |


---

## 4) 洞见汇合（多实验 → 共识）
> 只收录"会改变决策"的洞见，建议 5–8 条。
| # | 洞见（标题） | 观察（What） | 解释（Why） | 决策影响（So what） | 证据 |
|---|---|---|---|---|
| I1 | **理论上限高，模型有提升空间** | Fisher R²_max=0.89 vs ViT=0.71, gap=+18% | 信息远未被现有模型榨干 | 继续投入模型改进值得 | Fisher-ceiling, ViT-1M |
| I2 | **传统 ML 已到天花板** | Ridge=0.50, LightGBM=0.57, 1M数据增益<3% | 线性/浅层模型表达能力有限 | 必须用深度学习 | ML-ceiling |
| I3 | **ViT 超越传统 ML** | ViT=0.71 > LightGBM=0.57 (+0.14) | Transformer 架构能更好提取非线性特征 | ViT 是当前最佳选择 | ViT-1M, LGB-1M |
| I4 | **数据规模对 ViT 至关重要** | 1M 数据使 ViT 达到 R²=0.71 | 小数据集无法充分发挥 Transformer 优势 | 1M 数据集投资合理 | ViT-1M |
| I5 | **Ridge α 优化收益有限** | 优化 α 后 R² 仅提升 0-3% | Ridge 的 ceiling 确实存在 | 不应继续优化 Ridge | Ridge-alpha |
| I6 | **最优 α 随数据量增加** | 100k: α=3.16e4, 1M: α=1e5 | 更多数据需要更大正则化 | α 应与数据量匹配 | Ridge-alpha |

---

## 5) 决策空白（Decision Gaps）
> 写"要回答什么"，不写"怎么做实验"。建议 3–6 条。
| DG | 我们缺的答案 | 为什么重要（会改哪个决策） | 什么结果能关闭它 | 决策规则 |
|---|---|---|---|---|
| DG1 | 模型误差是否远大于 Fisher 理论上限？ | 决定是否继续投入模型改进 | 误差/理论σ 比值 | If > 2 → 继续 Phase 1-2；Else → 转向物理先验 |
| DG2 | 敏感窗口是否优于或等于全谱？ | 决定是否做自适应 token/窗口注意力 | 窗口 R² vs 全谱 R² | If 窗口≥全谱 → 做自适应 token；Else → 继续全谱优化 |
| DG3 | error/ivar 作为输入能否提升？ | 决定是否使用加权 loss | ΔMAE ≥ 5% | If 是 → 加权 loss 成为标准；Else → 结构是瓶颈 |
| DG4 | 归一化方式是否压扁了 logg 信号？ | 决定是否使用分块归一化 | R² 提升或 MAE 下降 | If 是 → 分块归一化成为标准；Else → 瓶颈在别处 |
| DG5 | 多任务联合能否减少 logg 的 Teff/FeH 混淆？ | 决定是否使用多任务 | logg bias 减少 | If 是 → 多任务成为必需；Else → 单任务足够 |

---

## 6) 设计原则（可复用规则）
### 6.1 已确认原则
| # | 原则 | 建议（做/不做） | 适用范围 | 证据 |
|---|---|---|---|---|
| P1 | **先验证信息上限** | ✅ 必须 | 任何参数回归任务 | Fisher-ceiling 证明上限存在 |
| P2 | **传统 ML 有天花板** | ❌ 不继续优化 | noise=1.0 高噪声场景 | Ridge=0.50, LGB=0.57, 1M增益<3% |
| P3 | **ViT 优于传统 ML** | ✅ 推荐 | 1M 数据规模 | ViT=0.71 > LGB=0.57 |
| P4 | **数据规模对 ViT 至关重要** | ✅ 必须 | Transformer 架构 | 1M 数据使 ViT 达到 R²=0.71 |
| P5 | **Ridge α 优化收益有限** | ❌ 不继续优化 | Ridge 模型 | 优化 α 后 R² 仅提升 0-3% |
| P6 | **最优 α 随数据量增加** | ✅ 匹配数据量 | Ridge 正则化 | 100k: α=3.16e4, 1M: α=1e5 |

### 6.2 待验证原则
| # | 原则 | 初步建议 | 需要验证（MVP/Gate） |
|---|---|---|---|
| P7 | Error 作为输入 | 让模型知道哪些像素可信 | MVP-1.2 |
| P8 | 分块归一化 | 保留局部线翼对比 | MVP-1.3 |
| P9 | 敏感窗口优先 | 减少无关波段干扰 | MVP-1.4 |
| P10 | 多任务联合 | 减少 logg 的 Teff/FeH 混淆 | MVP-1.5 |

### 6.3 关键数字速查（只留会反复用到的）
| 指标 | 值 | 条件 | 来源 |
|---|---|---|---|
| **Best R²** | **0.713** | 1M, noise=1.0 | ViT-1M |
| **Baseline R²** | 0.5709 | 1M, noise=1.0 | LightGBM-1M |
| **理论上限 R²** | **0.89** | noise=1.0, mag=21.5 | Fisher-ceiling |
| **Gap vs 上限** | **+18%** | ViT vs Fisher | ViT-1M, Fisher-ceiling |
| **Ridge 最佳 R²** | 0.5017 | 1M, noise=1.0, α=1e5 | Ridge-alpha |
| **LightGBM 最佳 R²** | 0.5709 | 1M, noise=1.0 | ML-ceiling |

### 6.4 已关闭方向（避免重复踩坑）
| 方向 | 否定证据 | 关闭原因 | 教训 |
|---|---|---|---|
| ~~继续优化 Ridge~~ | R²=0.50, 优化 α 仅提升 0-3% | 传统 ML 已到天花板 | 必须用深度学习 |
| ~~继续优化 LightGBM~~ | R²=0.57, 1M数据增益<3% | 浅层模型表达能力有限 | ViT 已超越 |

---

## 7) 指针（详细信息在哪）
| 类型 | 路径 | 说明 |
|---|---|---|
| 🗺️ Roadmap | `./logg_1m_roadmap_20251222.md` | Decision Gates + MVP 执行 |
| 📗 Experiments | `logg/logg_1m/exp/exp_*.md` | 单实验报告 |
| 📗 ViT 1M | `logg/vit/exp_vit_1m_scaling_20251226.md` | ViT 1M 实验结果 |
| 📗 Fisher Ceiling | `logg/scaling/exp/exp_scaling_fisher_upperbound_curves_20251225.md` | 理论上限曲线 |
| 📗 ML Ceiling | `logg/scaling/exp/exp_scaling_ml_ceiling_20251222.md` | 传统 ML 天花板 |
| 📗 Ridge Alpha | `logg/scaling/exp/exp_scaling_ridge_alpha_extended_20251222.md` | Ridge α 优化 |
| 🌳 Root Hub | `logg/scaling/scaling_hub_20251222.md` | 上层战略 |
| 🧠 Fisher Hub | `logg/scaling/fisher_hub_20251225.md` | Fisher 专题导航 |

## 8) 变更日志（只记录"知识改变"）
| 日期 | 变更 | 影响 |
|---|---|---|
| 2025-12-22 | 创建 Hub for logg 1M Breakthrough | - |
| 2025-12-26 | 按模板重构，整合最佳实验结果 | 结构规范化 |
| 2025-12-26 | 添加 ViT=0.71, Fisher=0.89, gap=+18% | §1, §3, §4 |
| 2025-12-26 | 添加传统 ML 天花板结论（Ridge=0.50, LGB=0.57） | §4, §6 |
| 2025-12-26 | 添加洞见汇合（I1-I6） | §4 |
| 2025-12-26 | 添加决策空白（DG1-DG5） | §5 |
| 2025-12-26 | 更新设计原则（P1-P6 已确认） | §6 |

---

# 📎 Appendix

## 6.1 Domain Background

> **Domain knowledge to help interpret conclusions**

### 6.1.1 log g 物理意义与谱特征

**log g（表面重力加速度对数）**是恒星大气的关键参数：
- 影响谱线的 **压力展宽**（尤其是线翼形状）
- 与 Teff、Fe/H 在谱上强耦合，难以独立辨识
- 在 PFS MR 波段 (6500-9500 Å) 主要通过 **Ca II triplet、H-α 线翼、分子带** 等体现

### 6.1.2 PFS MR 光谱特性

- **波长范围**: 6500-9500 Å（红端）
- **分辨率**: R ~ 5000 (MR = Medium Resolution)
- **主要噪声源**: 天空线（OH emission）、月光背景、探测器噪声
- **SNR 变化**: 随波长变化显著，天空线区域 SNR 可能局部很低

### 6.1.3 为什么 low-noise 仍可能卡住？

即使整体 SNR 很高：
1. **局部天空线污染** → 某些关键波段仍不可信
2. **归一化压扁信号** → 线翼形状被均一化
3. **Teff/FeH 混淆** → 谱变化被误归因
4. **信息分布不均** → 大量无关波段稀释有效信号

### 6.1.4 模拟数据的特点与局限

**优势**：
- 参数完全已知，可验证模型极限
- 参数随机采样 → logg 与 Teff/FeH 解耦（更干净）
- 大规模 (1M) → 可以探索 data scaling

**局限**：
- 模型未学到真实天体物理先验（如等时线约束）
- 无真实系统误差（wavelength calibration、stellar activity 等）
- 下一步突破可能来自 **真实先验/联合测光/多臂** 而非更大模型

---

## 6.2 Glossary

| Term | Definition | Notes |
|------|------------|-------|
| **log g** | $\log_{10}(g / \text{cm s}^{-2})$，恒星表面重力加速度对数 | 1-5 dex 范围 |
| **SNR** | Signal-to-Noise Ratio，信噪比 | $\|flux\| / \|error\|$ |
| **Fisher Information** | 参数估计理论下限的度量 | $I(\theta) = E[(\partial \ln L / \partial \theta)^2]$ |
| **MSM** | Masked Spectrum Modeling | 类似 BERT 的自监督预训练 |
| **PFS MR** | Prime Focus Spectrograph Medium Resolution | Subaru 望远镜仪器 |
| **BOSZ** | BOSZ stellar atmosphere models | 恒星模型光谱库 |
| **ivar** | Inverse variance | $1/\sigma^2$ |

---

## 6.3 Changelog

| Date | Change | Sections |
|------|--------|----------|
| 2025-12-22 | Created Hub for logg 1M Breakthrough | All |

---

> **Template Usage:**
> 
> **Hub Scope:**
> - ✅ **Do:** Question mapping, hypothesis management, insight synthesis, strategic navigation, design principles
> - ❌ **Don't:** Experiment tracking (→ roadmap.md), daily backlog (→ kanban.md)
> 
> **Update Triggers:**
> - After completing a batch of experiments → update §3
> - After hypothesis verification → update §2
> - After discovering/closing directions → update §4
> - After distilling principles → update §5
> 
> **Hub vs Roadmap:**
> - Hub = "What do we know? Where should we go?"
> - Roadmap = "What experiments are planned? What's the progress?"


# 📘 CNN · Dilated/Large Kernel 实验主框架

---
> **主题名称：** 1D CNN 在恒星光谱 log_g 预测的诊断与改进  
> **作者：** Viska Wei  
> **创建日期：** 2025-12-01  
> **最后更新：** 2025-12-01  
> **状态：** 🔄 进行中

---

# 📑 目录

- [0. 📋 问题重述与意义澄清](#0--问题重述与意义澄清)
  - [0.1 核心研究问题](#01-核心研究问题)
  - [0.2 多维度分析](#02-多维度分析)
  - [0.3 实验定位](#03-实验定位)
- [1. 🎯 目标](#1--目标)
  - [1.1 背景与动机](#11-背景与动机)
  - [1.2 核心假设](#12-核心假设)
  - [1.3 验证问题](#13-验证问题)
  - [1.4 结论摘要](#14-结论摘要实验后填写)
- [2. 🗺️ MVP 实验路线图](#2-️-mvp-实验路线图)
- [3. 📋 子实验追踪](#3--子实验追踪)
- [4. 🔗 跨实验分析](#4--跨实验分析)
- [5. 📝 总结与展望](#5--总结与展望)
- [6. 📎 附录](#6--附录)

---

# 0. 📋 问题重述与意义澄清

> **本章是整个实验系列的"灵魂"**：在动手做任何实验之前，先厘清核心问题、分析其多维度意义、明确实验的价值与局限。

## 0.1 核心研究问题

> **1D CNN 在全谱（4096）$\log g$ 任务上全面失败（Test $R^2 \approx 0$）——是实现有 bug？架构不匹配？还是 CNN 本质上不适合该任务？**

据此推断：

> **在证明 CNN 能正常工作之前，是否应该继续堆叠更复杂的 CNN 架构？大 kernel / 膨胀卷积（dilated CNN）能否帮助 CNN 捕获长程依赖？**

### 0.1.1 统计学层面

> 用统计学语言重新表述问题，明确要度量的量。

把 $\log g$ 看成随机变量 $Y$，把卷积层提取的特征看成 $F_{\text{CNN}}(X)$，其中 $X \in \mathbb{R}^{4096}$ 是光谱。
用 CNN 模型拟合 $Y \approx f(F_{\text{CNN}}(X))$，得到 test $R^2$：

$$
R^2 \approx 1 - \frac{\mathbb{E}[(Y - \hat{Y})^2]}{\operatorname{Var}(Y)}
$$

**当前所有 CNN 实验 $R^2 \approx 0$，意味着 CNN 的预测方差等于标签方差——模型完全无法学习。**

关键诊断量：
- **感受野（Receptive Field, RF）**：$\text{RF} = 1 + \sum_{l=1}^{L} (k_l - 1) \cdot \prod_{i=1}^{l-1} d_i$
- 当前 2 层 CNN (k=7, d=1) 的 RF ≈ 13 像素，远小于 4096 输入

### 0.1.2 物理/领域层面

> 从领域知识角度解释问题的物理/科学意义。

- **$\log g$ 信息分布稀疏**：信息主要集中在少数谱线（Ca II triplet @ 8542/8662 Å, Mg I @ 8809 Å），但这些谱线分布在光谱的不同位置
- **谱线宽度有限**：单个谱线宽度约 5-20 Å（~10-50 像素），小 kernel 理论上可以捕获
- **需要全局组合**：预测需要**组合多条谱线的信息**，而非局部特征

**可能的解释**：
- **(a) 感受野不足**：浅层小 kernel CNN 无法看到分布在不同位置的关键谱线，无法学习它们的组合
- **(b) 平移不变性假设不成立**：光谱特征与**绝对位置**（波长）强相关，CNN 的平移不变归纳偏置反而有害
- **(c) 实现问题**：CNN 代码有 bug，或超参数完全不对

### 0.1.3 意义与启示

> 用表格展示不同实验结果对设计/理解的启示。

| 结果情况 | 含义 | 对设计的启示 |
|---------|------|-------------|
| Sanity Check 成功，全谱失败 | CNN 实现正确，但架构不适合全谱任务 | 需要更大感受野或放弃 CNN |
| 大 kernel / dilated CNN 成功 | 感受野是瓶颈 | 推荐使用大 kernel / dilated 架构 |
| 窗口任务成功，全谱失败 | CNN 适合局部特征，全局组合需要其他机制 | CNN + Attention 混合架构 |
| 所有 CNN 均失败 | CNN 归纳偏置与 $\log g$ 任务不兼容 | 放弃 CNN，转向 MLP/Attention |

---

## 0.2 多维度分析

> 从多个角度论证研究问题的价值，帮助读者（和未来的自己）理解"为什么要做这个实验"。

### 0.2.1 信息论角度

- **CNN 的信息瓶颈**：浅层 CNN 的输出只能访问局部窗口的信息，若 $\log g$ 信息分散在全谱，则 early layers 会丢失信息
- **感受野与互信息**：$I(Y; F_{\text{CNN}}) \leq I(Y; X_{\text{RF}})$，其中 $X_{\text{RF}}$ 是感受野内的像素
- **膨胀卷积的优势**：指数级扩大感受野而不增加参数，理论上 $I(Y; F_{\text{dilated}}) > I(Y; F_{\text{standard}})$

### 0.2.2 物理/领域知识角度

- **谱线物理**：$\log g$ 主要通过压力致宽效应影响谱线，Ca II triplet 是最敏感的指示器
- **波长绝对性**：光谱特征与绝对波长强相关（如 Ca II @ 8542 Å），CNN 的平移不变性可能是错误假设
- **已有先验**：TopK 实验显示 K=50-100 个特征即可达到 $R^2 > 0.4$，但这些特征分布在全谱各处

### 0.2.3 模型设计角度

> 用表格展示不同场景下的设计策略。

| 场景 | 策略 A：大 kernel | 策略 B：Dilated CNN | 策略 C：放弃 CNN |
|------|------------------|---------------------|-----------------|
| 局部特征足够 | kernel=21-45 单层 | 不需要 | N/A |
| 需要全局组合 | 多层大 kernel，参数爆炸 | dilation=1,2,4 堆叠，参数可控 | MLP / Attention |
| 位置敏感 | 大 kernel + position encoding | Dilated + position encoding | MLP 天然位置敏感 |

---

## 0.3 实验定位

> **明确说明本实验系列的价值与局限，管理预期。**

### 价值

- **价值 1：诊断 CNN 失败原因**：是实现问题、超参问题，还是架构根本不适合？
- **价值 2：验证大 kernel / dilated CNN 的有效性**：为后续架构选择提供数据支撑
- **价值 3：建立 CNN baseline**：若成功，为 CNN + Attention 混合架构提供基础

### 局限

- **局限 1：简化设定**：Sanity check 使用简化任务（toy target / 短窗口），不代表全谱性能
- **局限 2：参数量受限**：为公平比较，参数量限制在 ~1e4-5e4，可能不是 CNN 最优配置
- **局限 3：单一目标**：仅针对 $\log g$，不同恒星参数可能有不同结论

**定位声明**：
> **本实验系列是诊断性分析，目的是确定 CNN 在 $\log g$ 任务上的可行性边界，而非追求 SOTA。结论应理解为"CNN 是否值得继续投入"的决策依据。**

---

# 1. 🎯 目标

## 1.1 背景与动机

**研究背景**：
- 当前所有 CNN 实验（Stage1, Stage2）在全谱 $\log g$ 任务上**全面失败**：Test $R^2 \approx 0$ 或为负
- Stage1：23K 参数，不同 lr/wd 组合，最佳 $R^2 = 0.016$
- Stage2：多层 CNN，kernel=7/15/21，有/无 BN，$R^2 \approx 0$ 或 NaN
- **不能在证明 CNN "work" 之前就继续往复杂方向堆**

**核心目标**（勾选适用项）：
- [x] 诊断 CNN 失败原因（实现 bug vs 架构不匹配）
- [x] 验证大 kernel / dilated CNN 能否提高 $R^2$
- [x] 为后续架构选择（CNN vs MLP vs Attention）提供决策依据
- [ ] ~~指导神经网络架构设计~~（需先通过 sanity check）
- [ ] ~~追求 SOTA~~（当前目标是"让 CNN 工作"）

**一句话概括**：
> 通过 **分层诊断实验（sanity check → 窗口 → 全谱）**，为 $\log g$ 预测确定 **CNN 是否可行**，以及**最佳感受野配置**。

---

## 1.2 核心假设

### 主假设

> **当前 CNN 失败的主要原因是感受野不足（RF ≈ 13 << 4096），大 kernel / dilated CNN 可以通过扩大感受野解决此问题。**

**如果假设成立，意味着**：
- **含义 1**：CNN 可以用于光谱任务，但需要特殊配置（大 kernel / dilation）
- **含义 2**：后续可以设计 CNN + Attention 混合架构
- **含义 3**：感受野是 CNN 在序列任务上的关键瓶颈

**如果假设不成立，则需要**：
- **替代理解 1**：CNN 的平移不变归纳偏置本身不适合位置敏感的光谱任务
- **替代方向 2**：放弃 CNN，专注于 MLP / Attention 架构

### 子假设

| 编号 | 子假设 | 对应 MVP | 状态 |
|------|--------|---------|------|
| H1.1 | CNN 实现正确，能在简化任务上达到 $R^2 > 0.9$ | MVP-0.x | ✅ 已验证 ($R^2=0.996$) |
| H1.2 | 局部窗口（256-512）任务上，CNN 可以学习 $\log g$ | MVP-0.x | ❌ 否定 ($R^2 \approx 0$) |
| H1.3 | 大 kernel（21-45）优于小 kernel（7-9）在相同参数量下 | MVP-1.x | ❌ 否定（小 kernel 更优） |
| H1.4 | Dilated CNN（d=1,2,4）优于标准 CNN 在相同参数量下 | MVP-1.x | ⏳ 待验证 (需 lr=3e-3 重测) |
| H1.5 | 全谱任务上，CNN 可以达到 $R^2 > 0.3$ | MVP-1.x | ✅ 已验证 (k=9 达 $R^2=0.657$) |

---

## 1.3 验证问题

> 用表格列出 3-7 个具体问题，每个问题对应一个验证目标，实验后填入结果。

| # | 问题 | 验证目标 | 预期结果 | 实际结果 |
|---|------|---------|---------|---------|
| Q1 | CNN 能否在合成目标（$y = 0.3 \cdot f_{100} + 0.7 \cdot f_{500}$）上达到 $R^2 \geq 0.9$？ | 验证 H1.1：实现正确性 | $R^2 > 0.9$ | ✅ $R^2 = 0.996$ |
| Q2 | CNN 能否在短窗口（256）+ noise=0 的 $\log g$ 任务上达到 $R^2 \geq 0.5$？ | 验证 H1.2：局部任务可行性 | $R^2 \in [0.3, 0.7]$ | ❌ $R^2 \approx 0$（窗口信息不足） |
| Q3 | kernel=45 vs kernel=7 在相同参数量下，$R^2$ 差距是否 > 0.1？ | 验证 H1.3：大 kernel 有效性 | $\Delta R^2 > 0.1$ | ❌ **反向**：k=7 ($0.60$) > k=45 ($0.08$) |
| Q4 | dilation=4 vs dilation=1 在 kernel=7 时，$R^2$ 差距是否 > 0.1？ | 验证 H1.4：Dilated CNN 有效性 | $\Delta R^2 > 0.1$ | ⏳ 需用 lr=3e-3 重测 |
| Q5 | 全谱 dilated CNN 能否达到 $R^2 \geq 0.3$（超过 MLP 失败线）？ | 验证 H1.5：全谱可行性 | $R^2 \in [0.2, 0.5]$ | ✅ k=9, lr=3e-3 达 $R^2 = 0.657$ |
| Q6 | 最佳感受野是多少？是否存在"最优 RF"拐点？ | 指导架构设计 | RF ∈ [100, 500] | ✅ **RF=25 (k=9) 最优**，RF 增加反而更差 |

---

## 1.4 结论摘要（实验后填写）

> 实验完成后在此给出结论预览，方便读者快速了解结果。随着 MVP 实验推进持续更新。

### 1.4.1 已验证结论

| 结论 | 说明 | 来源 |
|------|------|------|
| **CNN 实现正确** | 合成任务 $R^2 = 0.996$，证明无 bug | [exp_cnn_dilated_kernel_sweep](./exp_cnn_dilated_kernel_sweep_20251201.md) |
| **小 kernel 最优** | k=9 ($R^2=0.657$) 远优于 k=63 ($R^2=0.02$) | [exp_cnn_dilated_kernel_sweep](./exp_cnn_dilated_kernel_sweep_20251201.md) |
| **感受野假设被推翻** | RF 增加 → 性能下降（与预期相反） | [exp_cnn_dilated_kernel_sweep](./exp_cnn_dilated_kernel_sweep_20251201.md) |
| **局部窗口信息不足** | window=256 任务 $R^2 \approx 0$ | [exp_cnn_dilated_kernel_sweep](./exp_cnn_dilated_kernel_sweep_20251201.md) |

### 1.4.2 设计启示（已确认）

| 设计原则 | 具体建议 | 证据来源 |
|---------|---------|----------|
| **使用小 kernel** | k ∈ {7, 9, 11}，避免 k > 15 | k=9 ($R^2=0.66$) vs k=63 ($R^2=0.02$) |
| **学习率按 kernel 调整** | 小 kernel (k≤9) 用 lr=3e-3；大 kernel 用 lr=1e-3 | 同架构 lr 差异导致性能差 50x |
| **用池化聚合全局信息** | AdaptiveAvgPool 比大感受野更有效 | 大 kernel 参数爆炸且性能更差 |

### 1.4.3 关键数字速查

| 指标 | 值 | 备注 |
|------|-----|------|
| Sanity Check 最佳 $R^2$ | **0.996** | 合成目标，k=7 |
| 窗口任务最佳 $R^2$ | **≈0** | window=256，信息不足 |
| 全谱最佳 $R^2$ | **0.657** | k=9, lr=3e-3, 27K params |
| 最佳感受野 | **RF=25** | k=9, 2层 CNN |

> **一句话总结**：小 kernel CNN (k=9) + 高学习率 (lr=3e-3) 达到 $R^2=0.657$；大 kernel / 大感受野反而严重损害性能，推翻原感受野假设。

---

# 2. 🗺️ MVP 实验路线图

> MVP（Minimum Viable Product）实验：最小可验证实验，快速验证假设的核心要素。

## 2.1 整体规划

### 实验分组

| Phase | 目的 | 包含 MVP | 状态 |
|-------|------|---------|------|
| **Phase 0: Sanity Check** | 证明 CNN 实现正确，能在简化任务上工作 | MVP-0.1, MVP-0.2 | ⏳ |
| **Phase 1: 窗口 + Kernel/Dilation** | 在短窗口任务上比较不同 kernel / dilation | MVP-1.1, MVP-1.2, MVP-1.3 | ⏳ |
| **Phase 2: 全谱验证** | 用最佳配置尝试全谱任务 | MVP-2.1 | ⏳ |

### 依赖关系图

```
┌─────────────────────────────────────────────────────────────┐
│                      MVP 实验依赖图                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [MVP-0.1: 合成目标]    [MVP-0.2: 短窗口 log_g]            │
│         │                      │                            │
│         └──────────┬───────────┘                            │
│                    │                                        │
│                    ▼                                        │
│   ┌────────────────────────────────────────┐                │
│   │        Phase 1: 窗口实验                │                │
│   │  ┌─────────┬─────────┬─────────┐       │                │
│   │  │MVP-1.1  │MVP-1.2  │MVP-1.3  │       │                │
│   │  │小kernel │大kernel │dilated  │       │                │
│   │  └─────────┴─────────┴─────────┘       │                │
│   └────────────────────────────────────────┘                │
│                    │                                        │
│                    ▼                                        │
│          [MVP-2.1: 全谱 Dilated CNN]                        │
│                    │                                        │
│                    ▼                                        │
│            [结论：CNN 是否可行？]                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**关键约束**：
- ⚠️ **只有 MVP-0.x 通过后（$R^2 > 0.9$），才能继续 Phase 1**
- ⚠️ **只有 Phase 1 有成功案例，才能继续 Phase 2**

---

## 2.2 MVP 详细设计

### Phase 0: Sanity Check

> **目标：证明 CNN 实现正确，是"正常的函数逼近器"**

#### MVP-0.1: 合成目标 Sanity Check

| 项目 | 配置 |
|------|------|
| **目标** | CNN 能否拟合简单的线性组合目标 $y = 0.3 \cdot f_{100} + 0.7 \cdot f_{500}$ |
| **数据** | 4096 全谱输入，noise=0，合成标签 |
| **模型** | 2 层 CNN，channels=[32, 64]，kernel=7，~23K 参数 |
| **验收标准** | Test $R^2 \geq 0.9$ |
| **早停条件** | $R^2 < 0.5$ 且 loss 不下降 → 排查实现 |

**排查清单**（若未达验收标准）：
- [ ] 检查数据加载：合成标签是否正确计算
- [ ] 检查模型输出：是否有 NaN / Inf
- [ ] 检查梯度：是否存在梯度消失/爆炸
- [ ] 检查学习率：lr=0.001 是否合理

---

#### MVP-0.2: 短窗口真实目标 Sanity Check

| 项目 | 配置 |
|------|------|
| **目标** | CNN 能否在简化的短窗口 $\log g$ 任务上学习 |
| **数据** | 从 4096 截取 **window=256 或 512**，noise=0，真实 $\log g$ 标签 |
| **窗口选择** | 方案 A：固定位置（如 Ca II triplet 区域 8500-8700 Å）<br>方案 B：基于 TopK 重要性选择窗口起点 |
| **模型** | 2 层 CNN，channels=[32, 64]，kernel=7，~5-10K 参数 |
| **验收标准** | Test $R^2 \geq 0.3$（低于全谱 Ridge baseline 可接受） |
| **早停条件** | $R^2 < 0.1$ 或 NaN → 排查架构/超参 |

**→ 对假设的影响**：
- 若 $R^2 > 0.3$：H1.1 成立，CNN 实现正确，可继续 Phase 1
- 若 $R^2 < 0.1$：需要进一步诊断，可能是窗口选择问题或超参问题

---

### Phase 1: 窗口 + Kernel/Dilation 对比

> **目标：在短窗口任务上比较不同感受野配置，找出最佳 kernel / dilation**

#### MVP-1.1: Baseline 小 Kernel CNN

| 项目 | 配置 |
|------|------|
| **目标** | 建立小 kernel baseline，作为对比基准 |
| **数据** | window=256 或 512，noise=0.1，真实 $\log g$ |
| **模型** | 2 层 CNN，kernel=7 或 9，dilation=1 |
| **参数量** | ~10-20K，与其他配置保持可比 |
| **验收标准** | 记录 $R^2$ 作为 baseline |

---

#### MVP-1.2: 大 Kernel CNN

| 项目 | 配置 |
|------|------|
| **目标** | 验证大 kernel 是否优于小 kernel |
| **依赖** | MVP-0.2 通过 |
| **数据** | 同 MVP-1.1 |
| **模型** | kernel ∈ {21, 45}，dilation=1，调整 channels 使参数量与 MVP-1.1 相近 |
| **验收标准** | $R^2_{\text{large}} - R^2_{\text{small}} > 0.05$ 表示大 kernel 有效 |

**→ 对假设的影响**：若大 kernel 显著优于小 kernel，则 H1.3 成立

---

#### MVP-1.3: Dilated CNN

| 项目 | 配置 |
|------|------|
| **目标** | 验证 dilated CNN 是否优于标准 CNN |
| **依赖** | MVP-0.2 通过 |
| **数据** | 同 MVP-1.1 |
| **模型** | kernel=7 或 15，dilation ∈ {1, 2, 4}，多层堆叠 |
| **感受野计算** | d=[1,2,4], k=7 → RF = 1 + 6×1 + 6×2 + 6×4 = 43<br>d=[1,2,4,8], k=7 → RF = 1 + 6×(1+2+4+8) = 91 |
| **验收标准** | $R^2_{\text{dilated}} - R^2_{\text{standard}} > 0.05$ 表示 dilation 有效 |

**→ 对假设的影响**：若 dilated 显著优于标准，则 H1.4 成立

---

### Phase 2: 全谱验证

> **目标：用 Phase 1 的最佳配置尝试全谱任务**

#### MVP-2.1: 全谱 Dilated CNN

| 项目 | 配置 |
|------|------|
| **目标** | 验证 dilated CNN 能否在全谱任务上学习 |
| **依赖** | Phase 1 有成功案例（$R^2 > 0.4$） |
| **数据** | 完整 4096 光谱，noise=0.1 |
| **模型** | 从 Phase 1 选最佳 2 个配置，扩展到全谱 |
| **参数量** | ~50-100K |
| **验收标准** | $R^2 \geq 0.3$（超过随机猜测，接近 Ridge） |
| **异常处理** | 若 $R^2 \approx 0$，记录训练曲线，分析失败原因 |

**→ 对假设的影响**：
- 若 $R^2 > 0.3$：H1.5 成立，CNN 在全谱任务上可行
- 若 $R^2 \approx 0$：H1.5 不成立，CNN 不适合全谱任务，应转向 MLP/Attention

---

## 2.3 实验配置总览

> 汇总所有 MVP 实验的关键配置，便于一览和对比。

| MVP | 数据模式 | 输入维度 | Noise | 模型 | Kernel | Dilation | 参数量 | 验收标准 |
|-----|---------|---------|-------|------|--------|----------|--------|---------|
| MVP-0.1 | toy (合成) | 4096 | 0 | 2L CNN | 7 | 1 | ~23K | $R^2 > 0.9$ |
| MVP-0.2 | window | 256/512 | 0 | 2L CNN | 7 | 1 | ~10K | $R^2 > 0.3$ |
| MVP-1.1 | window | 256/512 | 0.1 | 2L CNN | 7, 9 | 1 | ~15K | baseline |
| MVP-1.2 | window | 256/512 | 0.1 | 2L CNN | 21, 45 | 1 | ~15K | $\Delta R^2 > 0.05$ |
| MVP-1.3 | window | 256/512 | 0.1 | 3-4L CNN | 7, 15 | 1,2,4 | ~15K | $\Delta R^2 > 0.05$ |
| MVP-2.1 | full | 4096 | 0.1 | best from P1 | best | best | ~50-100K | $R^2 > 0.3$ |

**超参数建议**：
- lr ∈ {1e-3, 3e-3}
- weight_decay ∈ {0, 1e-5}
- batch_size: 2048
- epochs: 足够收敛（建议 50-100）
- optimizer: AdamW
- early_stopping_patience: 20

---

# 3. 📋 子实验追踪

> 追踪每个子实验（exp.md）的进度、结果和关键发现。

## 3.1 实验总览

| MVP | 实验名称 | 状态 | 报告链接 | 核心结论（一句话） |
|-----|---------|------|---------|------------------|
| MVP-0.1 | Sanity Check - 合成目标 | ✅ 已完成 | [exp_cnn_dilated_kernel_sweep](./exp_cnn_dilated_kernel_sweep_20251201.md) | CNN 实现正确 ($R^2=0.996$) |
| MVP-0.2 | Sanity Check - 短窗口 log_g | ✅ 已完成 | [exp_cnn_dilated_kernel_sweep](./exp_cnn_dilated_kernel_sweep_20251201.md) | 局部窗口信息不足 ($R^2 \approx 0$) |
| MVP-1.1 | 全谱 - 小 Kernel Baseline | ✅ 已完成 | [exp_cnn_dilated_kernel_sweep](./exp_cnn_dilated_kernel_sweep_20251201.md) | k=9, lr=3e-3 达 $R^2=0.657$ 🏆 |
| MVP-1.2 | 全谱 - 大 Kernel | ✅ 已完成 | [exp_cnn_dilated_kernel_sweep](./exp_cnn_dilated_kernel_sweep_20251201.md) | 大 kernel 更差 (k=63 仅 $R^2=0.02$) |
| MVP-1.3 | 全谱 - Dilated CNN | 🔄 进行中 | [exp_cnn_dilated_kernel_sweep](./exp_cnn_dilated_kernel_sweep_20251201.md) | d=2 + lr=1e-3 效果差，需 lr=3e-3 重测 |
| MVP-2.1 | 综合验证 | ⏳ 待定 | - | 根据 MVP-1.3 结果决定 |

**状态图例**：
- ⏳ 计划中（Planned）
- 🔄 进行中（In Progress）
- ✅ 已完成（Completed）
- ❌ 已取消（Cancelled）
- ⏸️ 暂停（Paused）

---

## 3.2 进度看板

```
┌──────────────┬──────────────┬──────────────┬──────────────┐
│   ⏳ 计划中   │   🔄 进行中   │   ✅ 已完成   │   ❌ 已取消   │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ MVP-2.1      │ MVP-1.3      │ MVP-0.1      │              │
│              │              │ MVP-0.2      │              │
│              │              │ MVP-1.1      │              │
│              │              │ MVP-1.2      │              │
└──────────────┴──────────────┴──────────────┴──────────────┘
```

---

## 3.3 结论提取记录

> 从每个完成的 exp.md 提取核心结论到 main。

| 日期 | 来源实验 | 提取的核心结论 | 更新到 main 的位置 |
|------|---------|---------------|-------------------|
| 2025-12-01 | exp_cnn_dilated_kernel_sweep | CNN 实现正确 ($R^2=0.996$ 合成任务) | §1.4.1 |
| 2025-12-01 | exp_cnn_dilated_kernel_sweep | 小 kernel k=9 最优 ($R^2=0.657$) | §1.4.1, §1.4.3 |
| 2025-12-01 | exp_cnn_dilated_kernel_sweep | 大 kernel 反而更差（推翻感受野假设） | §1.4.1 |
| 2025-12-01 | exp_cnn_dilated_kernel_sweep | lr 与 kernel size 有强交互效应 | §1.4.2 |

---

# 4. 🔗 跨实验分析

> 综合多个子实验的结果，进行跨实验对比和分析。

## 4.1 结果对比矩阵

| MVP | 配置 | 感受野 | 最佳 $R^2$ | vs Baseline | 关键发现 |
|-----|------|--------|-----------|-------------|---------|
| MVP-0.1 | toy_synthetic, k=7 | 19 | **0.996** | N/A | ✅ CNN 实现正确 |
| MVP-0.2 | toy_window, k=7 | 19 | **≈0** | N/A | ❌ 局部窗口信息不足 |
| MVP-1.1 | full, k=9, lr=3e-3 | 25 | **0.657** 🏆 | baseline | 小 kernel + 高 lr 最优 |
| MVP-1.2 | full, k=21/45/63 | 61-187 | 0.02-0.39 | -0.27 ~ -0.64 | ❌ 大 kernel 更差 |
| MVP-1.3 | full, k=7, d=2 | 37 | 0.016 | -0.59 | ⏳ 需 lr=3e-3 重测 |

## 4.2 假设验证进度

| 子假设 | 验证 MVP | 结果 | 结论 |
|--------|---------|------|------|
| H1.1 | MVP-0.1 | ✅ 支持 | 合成任务 $R^2=0.996$，CNN 实现正确 |
| H1.2 | MVP-0.2 | ❌ 否定 | window=256 任务 $R^2 \approx 0$，局部信息不足 |
| H1.3 | MVP-1.2 | ❌ 否定 | **小 kernel 更优**：k=9 ($0.66$) >> k=63 ($0.02$) |
| H1.4 | MVP-1.3 | ⏳ 待验证 | d=2 + lr=1e-3 效果差，需用 lr=3e-3 重测 |
| H1.5 | MVP-1.1 | ✅ 支持 | k=9, lr=3e-3 达 $R^2=0.657$ > 0.3 |

## 4.3 发现汇总

### 一致性发现（多个实验支持）

| 发现 | 支持实验 | 置信度 |
|------|---------|--------|
| **小 kernel 优于大 kernel** | MVP-1.1, MVP-1.2 | ⭐⭐⭐ 高 |
| **学习率与 kernel 有强交互** | MVP-1.1, MVP-1.2 | ⭐⭐⭐ 高 |
| **局部窗口信息不足** | MVP-0.2 | ⭐⭐ 中 |

### 冲突性发现（需要进一步验证）

| 发现 | 原假设 | 实验结论 | 可能原因 |
|------|--------|---------|---------|
| 感受野与性能关系 | 大感受野 → 高 $R^2$ | **反向**：大 RF → 低 $R^2$ | 大 kernel 参数爆炸、过拟合；池化层已能聚合全局信息 |

---

# 5. 📝 总结与展望

## 5.1 核心结论

> 用 3-5 点总结整个实验系列的核心发现。

1. **CNN 实现正确**：合成任务 $R^2=0.996$ 证明 CNN 能正常学习，之前的全面失败不是 bug。

2. **小 kernel 最优**：k=9 ($R^2=0.657$) 远优于 k=63 ($R^2=0.02$)。感受野从 25→187 增加 7x，性能反而下降 30x。

3. **感受野假设被推翻**：原假设"大感受野能更好捕获长程依赖"不成立。$\log g$ 信息通过局部特征 + 全局池化组合，不需要卷积本身有大感受野。

4. **学习率是关键超参**：小 kernel 必须用 lr=3e-3，大 kernel 用 lr=1e-3。同架构不同 lr 导致性能差 50x。

5. **局部窗口信息不足**：window=256 任务 $R^2 \approx 0$，与 TopK 实验一致（需 K=100+ 分散特征）。

## 5.2 设计原则提炼

> 将实验发现转化为可操作的设计原则。

| 原则 | 建议 | 依据 |
|------|------|------|
| **使用小 kernel** | k ∈ {7, 9, 11}，避免 k > 15 | k=9 ($0.66$) vs k=63 ($0.02$) |
| **lr 按 kernel 调整** | 小 kernel: lr=3e-3；大 kernel: lr=1e-3 | 同架构 lr 差异导致 50x 性能差 |
| **用池化聚合全局信息** | AdaptiveAvgPool 比大感受野更高效 | 大 kernel 参数爆炸且更差 |
| **优先优化 lr** | lr 比架构更重要 | 对同一架构影响最大 |

## 5.3 遗留问题

| 问题 | 优先级 | 建议后续实验 |
|------|--------|-------------|
| CNN 是否需要 position encoding？ | 🟡 中 | 添加可学习位置编码 |
| CNN + Attention 混合架构？ | 🟡 中 | 在 CNN 成功后尝试 |
| 更深的 dilated CNN（WaveNet 风格）？ | 🟢 低 | 若 Phase 2 成功 |

## 5.4 下一步计划

| 方向 | 具体任务 | 预计时间 | 优先级 |
|------|----------|---------|--------|
| ~~**执行 MVP-0.1**~~ | ~~合成目标 sanity check~~ | ~~1h~~ | ✅ 已完成 |
| ~~**执行 MVP-0.2**~~ | ~~短窗口 log_g sanity check~~ | ~~1h~~ | ✅ 已完成 |
| ~~**执行 MVP-1.1/1.2**~~ | ~~kernel size 对比~~ | ~~2h~~ | ✅ 已完成 |
| **Dilated + lr=3e-3** | 用 lr=3e-3 重测 dilated CNN | 1h | 🔴 高 |
| **更深网络** | 尝试 3-4 层 CNN | 1-2h | 🟡 中 |
| **Position Encoding** | 添加位置编码测试 | 1h | 🟡 中 |

---

# 6. 📎 附录

## 6.1 决策树：不同实验结果的解读与应对

### 情形 A: MVP-0 全部失败（$R^2 < 0.5$）

**诊断**：CNN 实现有严重问题

**应对策略**：
- 逐行检查数据加载、模型前向传播、损失计算
- 打印中间激活值，检查 NaN/Inf
- 对比 PyTorch 官方 CNN 示例

---

### 情形 B: MVP-0 成功，MVP-1 失败

**诊断**：CNN 能学习简单任务，但光谱 $\log g$ 特征提取有问题

**物理/领域含义**：
- $\log g$ 信息分布可能超出感受野覆盖范围
- 可能需要更大感受野或不同窗口选择

**设计启示**：
- 尝试更大 kernel / 更深 dilation
- 考虑多窗口 + 聚合策略

---

### 情形 C: MVP-1 成功，MVP-2 失败

**诊断**：CNN 适合局部特征，但无法处理全局任务

**物理/领域含义**：
- $\log g$ 需要组合全谱多处信息
- CNN 的局部归纳偏置与任务不匹配

**设计启示**：
- 放弃纯 CNN 架构
- 推荐 CNN（局部特征）+ MLP/Attention（全局组合）混合架构
- 或者使用 TopK + CNN 策略

---

### 情形 D: 全部成功（$R^2 > 0.3$ 在全谱）

**诊断**：Dilated CNN 可以用于 $\log g$ 预测

**设计启示**：
- 记录最佳配置，作为 CNN baseline
- 可进一步优化（更深、残差连接等）
- 可与 MLP/Attention 进行公平比较

---

## 6.2 感受野计算公式

对于 $L$ 层卷积，kernel size $k_l$，dilation $d_l$，stride $s_l=1$：

$$
\text{RF} = 1 + \sum_{l=1}^{L} (k_l - 1) \cdot d_l \cdot \prod_{i=1}^{l-1} s_i
$$

当所有 stride=1 时简化为：
$$
\text{RF} = 1 + \sum_{l=1}^{L} (k_l - 1) \cdot d_l
$$

**配置示例**：

| 配置 | Kernel | Dilation | 感受野 |
|------|--------|----------|--------|
| 2L, k=7, d=1 | [7, 7] | [1, 1] | 1 + 6 + 6 = 13 |
| 2L, k=21, d=1 | [21, 21] | [1, 1] | 1 + 20 + 20 = 41 |
| 2L, k=45, d=1 | [45, 45] | [1, 1] | 1 + 44 + 44 = 89 |
| 3L, k=7, d=[1,2,4] | [7, 7, 7] | [1, 2, 4] | 1 + 6 + 12 + 24 = 43 |
| 4L, k=7, d=[1,2,4,8] | [7,7,7,7] | [1,2,4,8] | 1 + 6 + 12 + 24 + 48 = 91 |
| 5L, k=7, d=[1,2,4,8,16] | [7,7,7,7,7] | [1,2,4,8,16] | 1 + 6×(1+2+4+8+16) = 187 |

---

## 6.3 历史 CNN 实验结果（失败记录）

> 记录之前失败的实验，避免重复

### Stage 1 (23K 参数, kernel=7)

| 实验 | lr | wd | Test $R^2$ | 结论 |
|------|-----|-----|-----------|------|
| CNN_S1_lr3en03_wd5en04 | 3e-3 | 5e-4 | **0.016** 🏆 | 最佳但仍失败 |
| CNN_S1_lr1en03_* | 1e-3 | * | ≈0 | 学习率太低 |
| CNN_S1_lr3en04_* | 3e-4 | * | ≈0 | 学习率太低 |

### Stage 2 (多架构)

| 实验 | 架构 | Kernel | Test $R^2$ | 结论 |
|------|------|--------|-----------|------|
| CNN_S2_2L_k15_bn | 2L [32,64] | 15 | -0.0003 | BN 无帮助 |
| CNN_S2_2L_k21 | 2L [32,64] | 21 | -0.0005 | 大 kernel 无帮助 |
| CNN_S2_3L_k15 | 3L [32,64,128] | 15 | NaN | 训练崩溃 |

**失败原因分析**：
1. 感受野太小（最大 ~50 像素 vs 4096 输入）
2. 未尝试 dilated convolution
3. 可能是全谱任务本身不适合 CNN（需要 sanity check 验证）

---

## 6.4 数值结果汇总表

> 汇总所有 MVP 实验的核心数值结果。

### 主要指标对比

| MVP | 配置 | Test $R^2$ | 参数量 | 训练时间 | 备注 |
|-----|------|-------|-----|------|------|
| MVP-0.1 | toy_synthetic, k=7 | **0.996** | 18.9K | 38s | ✅ sanity check 通过 |
| MVP-0.2 | toy_window, k=7 | **≈0** | 18.9K | 32s | ❌ 窗口信息不足 |
| MVP-1.1 | full, k=9, lr=3e-3 | **0.657** 🏆 | 27K | 1.3m | 最佳配置 |
| MVP-1.2 | full, k=63, lr=1e-3 | 0.020 | 140K | 4.5m | 大 kernel 差 |
| MVP-1.3 | full, k=7, d=2, lr=1e-3 | 0.016 | 23K | 15m | 需重测 lr=3e-3 |

### Kernel Size 扫描结果 (lr=3e-3)

| Kernel | Dilation | RF | Test $R^2$ | 参数量 | 备注 |
|--------|----------|-----|-------|------|------|
| 7 | [1,1] | 19 | **0.603** | 23K | baseline |
| 9 | [1,1] | 25 | **0.657** 🏆 | 27K | 最佳 |
| 21 | [1,1] | 61 | 0.035 | 52K | |
| 45 | [1,1] | 133 | 0.008 | 102K | |
| 63 | [1,1] | 187 | -0.002 | 140K | |

### Kernel Size 扫描结果 (lr=1e-3)

| Kernel | Dilation | RF | Test $R^2$ | 参数量 | 备注 |
|--------|----------|-----|-------|------|------|
| 7 | [1,1] | 19 | 0.011 | 23K | |
| 9 | [1,1] | 25 | 0.036 | 27K | |
| 21 | [1,1] | 61 | **0.391** | 52K | 大 kernel 最佳 |
| 45 | [1,1] | 133 | 0.082 | 102K | |
| 63 | [1,1] | 187 | 0.020 | 140K | |

---

## 6.5 相关文件索引

| 类型 | 文件路径 | 说明 |
|------|---------|------|
| 主框架 | `logg/cnn/cnn_main_20251201.md` | 当前文件 |
| Kernel 实验报告 | `logg/cnn/exp_cnn_dilated_kernel_sweep_20251201.md` | Kernel/Dilation 系统性对比 |
| 图表目录 | `logg/cnn/img/` | 实验图表 |
| 原始数据 | `raw_vit/cnn_sanity_check.csv` | Level 0 原始结果 |
| 原始数据 | `raw_vit/cnn_dilated_window_experiments.csv` | Level 1 原始结果 |
| 原始报告 | `raw_vit/CNN_DILATED_EXPERIMENTS_FULL_REPORT.md` | 原始实验报告 |
| NN 主框架 | `logg/NN/NN_main_20251130.md` | 相关 NN 实验 |

---

## 6.6 输出规范

### CSV 输出字段

所有实验结果写入 CSV，包含以下字段：

```
exp_name, data_mode, window_len, window_start, noise_level, 
kernel_sizes, dilations, num_layers, channels, num_params, receptive_field,
lr, weight_decay, batch_size, epochs_trained,
train_R2, val_R2, test_R2, train_loss_final, test_MAE, test_RMSE,
notes
```

### CSV 文件命名

| Phase | CSV 文件名 |
|-------|-----------|
| Phase 0 | `cnn_sanity_check_results.csv` |
| Phase 1 | `cnn_dilated_window_results.csv` |
| Phase 2 | `cnn_dilated_fullspec_results.csv` |

### Markdown 总结文件

| Phase | Markdown 文件名 |
|-------|----------------|
| Phase 0 | `exp_cnn_sanity_check_20251201.md` |
| Phase 1 | `exp_cnn_dilated_window_20251201.md` |
| Phase 2 | `exp_cnn_dilated_fullspec_20251201.md` |

---

## 6.7 变更日志

| 日期 | 变更内容 | 影响 |
|------|---------|------|
| 2025-12-01 | 创建主实验框架 | - |
| 2025-12-01 | 完成 MVP-0.x Sanity Check | §1.3 Q1-Q2, §3.1, §4.2 H1.1-H1.2 |
| 2025-12-01 | 完成 MVP-1.1/1.2 Kernel 对比 | §1.3 Q3-Q6, §1.4, §4, §5, §6.4 |
| 2025-12-01 | 添加子实验报告 | exp_cnn_dilated_kernel_sweep_20251201.md |

---

> **模板使用说明**：
> 
> **工作流程**：
> 1. **执行 Phase 0**：先跑 MVP-0.1 和 MVP-0.2，确保 CNN 能在简化任务上工作
> 2. **更新结论**：将 sanity check 结果填入 §1.4、§3、§4
> 3. **执行 Phase 1**：比较 kernel/dilation 配置
> 4. **执行 Phase 2**：用最佳配置尝试全谱（仅在 Phase 1 成功后）
> 5. **撰写子报告**：为每个 Phase 创建对应的 exp_*.md
> 
> **更新频率**：
> - §0, §1, §2：已填写，较少更新
> - §1.4, §3, §4：每完成一个 MVP 后更新
> - §5, §6：项目完成时填写

---

*创建时间: 2025-12-01*  
*核心目标: 诊断 CNN 失败原因，验证大 kernel / dilated CNN 的有效性*


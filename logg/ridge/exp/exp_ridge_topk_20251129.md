# 🍃 Top-K 特征选择噪声适配性
> **Name:** Ridge Top-K Feature Selection  
> **ID:** `VIT-20251129-ridge-topk-01`  
> **Topic:** `ridge` | **MVP:** MVP-1.3 | **Project:** `VIT`  
> **Author:** Viska Wei | **Date:** 2025-11-29 | **Status:** ✅  
> **Root:** `Ridge` | **Parent:** `TopK` | **Child**: |

> 🎯 **Target:** 验证干净数据选的 Top-K 特征在噪声下是否仍最优，噪声匹配选择策略效果  
> 🦾 **Decide:** 特征选择器噪声应匹配测试噪声；特征选择无法替代噪声增强训练

---


## 🔗 Upstream Links
| Type | Link |
|------|------|
| 🧠 Hub | `logg/ridge/ridge_hub.md` |
| 🗺️ Roadmap | `logg/ridge/ridge_roadmap.md` |

---

---

# ⚡ 核心结论速览（供 main 提取）

### 一句话总结

> **干净数据上选的 Top-K 特征在噪声下失效：nz0 selector 在 noise=1.0 测试时比 nz1.0 selector 差 ~10%，且 Top-K 无法缓解高噪声灾难性失败。**

### 对假设的验证

| 验证问题 | 结果 | 结论 |
|---------|------|------|
| nz0 selector 在噪声下最优？ | ❌ 否，nz1.0 更优 (0.49 vs 0.44) | 需匹配训练噪声 |
| Top-K 能缓解噪声灾难？ | ❌ 否，$R^2$ 仍为负 | 特征选择无法替代噪声训练 |
| K 对不同 selector 影响一致？ | ✅ 是，K≥50 时收敛 | K<50 时 selector 影响大 |

### 设计启示（1-2 条）

| 启示 | 具体建议 |
|------|---------|
| **Selector 需匹配测试噪声** | 避免在 noise=0 上做特征选择 |
| **噪声训练 > TopK** | 特征选择不能替代噪声增强训练 |

### 关键数字

| 指标 | 值 |
|------|-----|
| nz0 vs nz1.0 (test noise=1.0) | **0.44 vs 0.49** |
| 最小有效 K | **≥50** |
| 干净测试时 nz0.0 $R^2$ | **0.9990** |

---

# 📑 目录

- [1. 🎯 目标](#1--目标)
- [2. 🧪 实验设计](#2--实验设计experiment-design)
- [3. 📊 实验图表](#3--实验图表)
- [4. 💡 关键洞见](#4--关键洞见key-insights)
- [5. 📝 结论](#5--结论conclusion)
- [6. 📎 附录](#6--附录)

---

# 1. 🎯 目标

## 1.1 背景与动机

在光谱数据分析中，特征选择是降维和提高模型鲁棒性的关键步骤。本实验探索基于 Ridge 回归系数重要性 $|w_i|$ 的 Top-K 特征选择策略，核心问题是：

- **特征选择器的训练噪声水平**如何影响所选特征的泛化能力？
- 在**干净数据**上选出的"重要"波长点，是否在**噪声数据**上依然有效？
- 是否存在一个**噪声-鲁棒的特征子集**，能够在多种测试条件下表现稳定？

这些问题对于设计实际观测条件下的恒星参数估计系统至关重要。

## 1.2 核心假设

> **在干净数据（$\sigma=0$）上基于 Ridge 系数选出的 Top-K 特征，在有噪声的测试数据上同样能保持最优性能。**

如果假设成立，意味着：
- 特征选择只需在干净数据上进行一次
- 重要波长点的物理意义与噪声水平无关
- 神经网络可以直接使用干净数据选出的特征子集

如果假设不成立，则需要：
- 根据预期噪声水平选择不同的特征子集
- 考虑噪声感知的特征选择策略
- 重新理解"重要特征"在不同信噪比下的含义

## 1.3 验证问题

| # | 问题 | 验证目标 | 结果 |
|---|------|---------|------|
| Q1 | 在 test\_noise=0.0 时，nz0.0 vs nz1.0 selector 哪个更优？ | 验证干净数据上 nz0 selector 的最优性 | ✅ nz0.0 更优，$R^2=0.9990$ vs $0.9989$ |
| Q2 | 在 test\_noise=1.0 时，nz0.0 vs nz1.0 selector 哪个更优？ | 验证噪声数据上特征选择器的适配性 | ❌ nz1.0 更优，$R^2=0.4901$ vs $0.4426$ |
| Q3 | Top-K 能否缓解全谱在高噪声测试时的灾难性失败？ | 评估特征选择的噪声鲁棒性 | ❌ 无法缓解，$R^2$ 仍为负值 |
| Q4 | K 值对不同 selector 的影响是否一致？ | 理解 K 与 selector 的交互效应 | ✅ K≥50 时差异收敛，K<50 时 selector 影响显著 |

## 1.4 结论摘要（实验后填写）

### 1.4.1 实验结论

| 结论 | 说明 |
|------|------|
| **噪声适配选择器** | 高噪声测试时，应使用高噪声训练数据选出的特征 |
| **K 值交叉点** | K≥50 时 nz1.0 selector 开始超越 nz0.0 selector（在 test\_noise≥0.5 时） |
| **全谱过拟合** | train\_noise=0 的全谱模型在噪声测试下完全失效（$R^2 < -100$） |
| **最优 K=2000** | 所有配置下 K=2000 都达到最佳性能 |

### 1.4.2 设计启示

| 设计原则 | 具体建议 |
|---------|---------|
| **噪声匹配** | 特征选择器的噪声水平应与预期测试噪声匹配 |
| **保守选择 K** | 优先选择较大的 K（≥500），牺牲稀疏性换取鲁棒性 |
| **避免 clean-only** | 不要仅在干净数据上进行特征选择后直接用于噪声场景 |

> **一句话总结**：特征选择器的训练噪声水平决定了所选特征的噪声适应性——在噪声测试场景下，使用噪声训练数据选出的特征比干净数据选出的特征更优。

---

# 2. 🧪 实验设计（Experiment Design）

## 2.1 数据（Data）

- 训练样本数：TODO
- 测试样本数：TODO
- 特征维度：全谱（假设 4096 维）
- 标签参数：$\log g$
- 噪声模型：

$$
\text{noisy\_flux} = \text{flux} + \mathcal{N}(0, \sigma^2)
$$

## 2.2 使用的特征类型

- **基础特征**：flux（全谱）
- **特征选择**：Top-K based on Ridge coefficient importance $|w_i|$
- **K 值范围**：[10, 20, 50, 100, 200, 500, 1000, 2000]

## 2.3 模型与算法（Model & Algorithm）

### Ridge 回归

$$
\hat{y} = X w + b
$$

$$
w = (X^\top X + \alpha I)^{-1} X^\top y
$$

### 特征重要性计算

$$
\text{importance}_i = |w_i|
$$

选取重要性最高的 K 个波长点作为特征子集。

### 特征选择器（Selector）

在不同噪声水平的训练数据上训练 Ridge 模型，基于其系数绝对值排序选择 Top-K 特征：
- Selector nz0.0：在 $\sigma=0.0$ 数据上训练
- Selector nz0.5：在 $\sigma=0.5$ 数据上训练
- Selector nz1.0：在 $\sigma=1.0$ 数据上训练
- Selector nz2.0：在 $\sigma=2.0$ 数据上训练

## 2.4 超参数（Hyperparameters）

### 最优 $\alpha$ 与噪声水平的关系

| 噪声水平 $\sigma$ | 最优 $\alpha$ |
|------------------|---------------|
| 0.0 | 0.001 |
| 0.1 | 1.0 |
| 0.2 | 10.0 |
| 0.5 | 50.0 |
| 1.0 | 200.0 |
| 1.2 | 200.0 |
| 2.0 | 1000.0 |

**观察**：最优 $\alpha$ 随噪声水平单调增加，符合 bias-variance tradeoff 预期。

### 实验变量

- **训练噪声水平**：[0.0, 0.5, 1.0, 1.2]
- **测试噪声水平**：[0.0, 0.1, 0.2, 0.5, 1.0, 2.0]
- **K 值**：[10, 20, 50, 100, 200, 500, 1000, 2000]

---

# 3. 📊 实验图表

> TODO: 添加实验生成的图表

### 图 1：Top-K 性能对比（nz0.0 vs nz1.0 selector）

**Figure 1. 不同 K 值下两种 selector 在各测试噪声水平的 $R^2$ 对比**

**关键观察**：
- test\_noise=0.0 时：nz0.0 selector 全面领先，尤其在 K=10 时差距最大（+0.2667）
- test\_noise≥0.5 时：K≥50 后 nz1.0 selector 开始反超
- 交叉点出现在 K≈50，此时两种 selector 性能接近

### 图 2：全谱 vs Top-K 性能对比

**Figure 2. train\_noise=0.0 时全谱与 Top-K 最佳配置的泛化性能**

**关键观察**：
- 全谱模型在 test\_noise>0 时出现灾难性失败（$R^2 \ll 0$）
- Top-K 无法有效缓解此问题，K=2000 时 $R^2$ 改善幅度仅约 1.5%
- 根本原因是 train\_noise=0 导致的模型过拟合，而非特征数量问题

---

# 4. 💡 关键洞见（Key Insights）

### 4.1 宏观层洞见（用于指导 Neural Network 架构设计）

- **噪声感知特征选择**：特征的"重要性"依赖于数据的信噪比，干净数据选出的特征不一定是噪声鲁棒的
- **特征数量 vs 鲁棒性**：在噪声场景下，更多特征（K=2000）比稀疏特征（K=10）更稳定
- **训练-测试噪声匹配**：模型（包括特征选择器）的训练噪声应与预期测试噪声匹配

### 4.2 模型层洞见（用于优化模型）

- **$\alpha$ 自适应**：最优 $\alpha$ 从 0.001（无噪声）增加到 1000（$\sigma=2.0$），跨越 6 个数量级
- **过拟合机制**：train\_noise=0.0 + 全谱 → 模型学习到噪声敏感的高频特征 → 测试时灾难性失败
- **K 值敏感性**：K<50 时 selector 选择影响显著，K≥500 时差异可忽略

### 4.3 实验层细节洞见

- **nz0.0 vs nz1.0 交叉点**：
  - test\_noise=0.5：K=50 时 nz1.0 开始超越 nz0.0（$\Delta R^2 = -0.0676$）
  - test\_noise=1.0：K=50 时 nz1.0 开始超越 nz0.0（$\Delta R^2 = -0.0480$）
- **小 K 值异常**：K=10 时 nz0.0 显著优于 nz1.0，即使在高噪声测试下
- **全谱失败不可修复**：Top-K 对 train\_noise=0 的全谱模型帮助甚微（$\Delta R^2 < 10$）

---

# 5. 📝 结论（Conclusion）

## 5.1 核心发现

> **特征选择器的训练噪声水平决定了所选特征的噪声适应性——干净数据选出的"最优"特征在噪声测试下并非最优。**

- ❌ 原假设：nz0.0 selector 选出的 Top-K 特征在所有测试条件下最优
- ✅ 实验结果：高噪声测试（$\sigma \geq 0.5$）时，nz1.0 selector 的特征更优（$\Delta R^2$ 最高达 +0.09）

## 5.2 关键结论（2-4 条）

| # | 结论 | 证据 |
|---|------|------|
| 1 | **噪声适配效应** | test\_noise=1.0 时，nz1.0 selector $R^2=0.4901$ vs nz0.0 selector $R^2=0.4426$（+10.7%） |
| 2 | **K 值交叉现象** | K≥50 时噪声 selector 开始反超；K<50 时干净 selector 仍占优 |
| 3 | **特征选择无法修复过拟合** | train\_noise=0 全谱 $R^2=-606$，Top-K(2000) 仍为 $R^2=-597$（改善 <2%） |
| 4 | **最优 $\alpha$ 随噪声指数增长** | $\sigma: 0 \to 2.0$ 时，$\alpha: 0.001 \to 1000$（6 个数量级） |

## 5.3 设计启示

### 架构原则

| 原则 | 建议 | 原因 |
|------|------|------|
| **噪声匹配训练** | 特征选择在与测试噪声相近的数据上进行 | 高噪声 selector 选出的特征在噪声下更稳定 |
| **保守特征数量** | 优先 K≥500，除非有强稀疏性需求 | K<50 时性能对 selector 选择高度敏感 |
| **分离训练与选择** | 特征选择可用更高噪声数据，最终模型用目标噪声训练 | 获得鲁棒特征子集同时保持模型精度 |

### ⚠️ 常见陷阱

| 常见做法 | 实验证据 |
|----------|----------|
| "在干净数据上选特征更准确" | ❌ 仅在 test\_noise=0 时成立；噪声测试下性能下降 5-10% |
| "Top-K 能防止过拟合" | ❌ train\_noise=0 的过拟合问题无法通过减少特征解决 |
| "K=10 足够捕获主要信息" | ❌ K=10 时性能高度依赖 selector，且鲁棒性差 |

## 5.4 物理解释

- **噪声改变特征重要性**：在干净数据上，模型可以利用微弱但信息丰富的谱线特征；噪声会淹没这些特征，使得只有强特征（如 Balmer 线翼、CaT）保持可用
- **高噪声 selector 的优势**：在噪声训练数据上，Ridge 系数自然偏向噪声鲁棒的强特征，避免选择噪声敏感的弱特征
- **小 K 异常**：K=10 时，nz0.0 可能恰好选中物理上最重要的几个点（如 H$\alpha$, H$\beta$ 核心），这些特征在任何条件下都有效

## 5.5 关键数字速查

| 指标 | 值 |
|------|-----|
| 最佳 clean-clean 性能 | $R^2=0.9990$（K=2000, nz0.0 selector） |
| 最佳 noisy-noisy 性能 | $R^2=0.4901$（K=2000, nz1.0 selector, test=1.0） |
| 交叉点 K 值 | K≈50（test\_noise≥0.5 时 nz1.0 开始超越） |
| 最大 selector 差异 | K=10, test=0.0: $\Delta R^2=+0.267$（nz0.0 领先） |
| 最优 $\alpha$ 范围 | 0.001（$\sigma=0$）→ 1000（$\sigma=2.0$） |

## 5.6 下一步工作

| 方向 | 具体任务 |
|------|----------|
| **混合 selector 策略** | 测试 ensemble 多个噪声水平 selector 的特征并集 |
| **稳定性分析** | 分析不同 selector 选出的 Top-K 波长重叠度 |
| **物理验证** | 将 Top-K 波长点映射回物理谱线，验证物理合理性 |
| **自适应特征选择** | 基于输入 SNR 动态选择不同的特征子集 |

---

# 6. 📎 附录

## 6.1 数值结果表（Results）

### 全谱基线（Full Spectrum Baseline）

| train\_noise | test=0.0 | test=0.1 | test=0.2 | test=0.5 | test=1.0 | test=2.0 |
|--------------|----------|----------|----------|----------|----------|----------|
| 0.0 | 0.9990 | -5.0737 | -23.2929 | -150.8291 | -606.3182 | -2428.2794 |
| 0.5 | 0.7714 | 0.7675 | 0.7544 | 0.6607 | 0.3231 | -1.0328 |
| 1.0 | 0.6007 | 0.6000 | 0.5964 | 0.5686 | 0.4650 | 0.0435 |
| 1.2 | 0.5653 | 0.5647 | 0.5617 | 0.5384 | 0.4521 | 0.1015 |

### nz0.0 vs nz1.0 Selector 对比（test\_noise=0.0）

| K | nz0.0 $R^2$ | nz1.0 $R^2$ | $\Delta$ (nz0 - nz1) |
|---|-------------|-------------|----------------------|
| 10 | 0.8816 | 0.6149 | +0.2667 |
| 20 | 0.9583 | 0.9032 | +0.0551 |
| 50 | 0.9900 | 0.9848 | +0.0052 |
| 100 | 0.9956 | 0.9948 | +0.0009 |
| 200 | 0.9977 | 0.9971 | +0.0006 |
| 500 | 0.9987 | 0.9983 | +0.0004 |
| 1000 | 0.9988 | 0.9986 | +0.0001 |
| 2000 | 0.9990 | 0.9989 | +0.0001 |

### nz0.0 vs nz1.0 Selector 对比（test\_noise=0.5）

| K | nz0.0 $R^2$ | nz1.0 $R^2$ | $\Delta$ (nz0 - nz1) |
|---|-------------|-------------|----------------------|
| 10 | 0.2286 | 0.0731 | +0.1555 |
| 20 | 0.2939 | 0.2767 | +0.0172 |
| 50 | 0.3708 | 0.4384 | **-0.0676** |
| 100 | 0.4889 | 0.5282 | -0.0393 |
| 200 | 0.5404 | 0.6092 | -0.0688 |
| 500 | 0.6021 | 0.6528 | -0.0507 |
| 1000 | 0.6431 | 0.6674 | -0.0243 |
| 2000 | 0.6533 | 0.6737 | -0.0204 |

### nz0.0 vs nz1.0 Selector 对比（test\_noise=1.0）

| K | nz0.0 $R^2$ | nz1.0 $R^2$ | $\Delta$ (nz0 - nz1) |
|---|-------------|-------------|----------------------|
| 10 | 0.1069 | 0.0224 | +0.0845 |
| 20 | 0.1735 | 0.1130 | +0.0605 |
| 50 | 0.1849 | 0.2329 | **-0.0480** |
| 100 | 0.2598 | 0.3212 | -0.0614 |
| 200 | 0.3082 | 0.4003 | -0.0922 |
| 500 | 0.3790 | 0.4457 | -0.0668 |
| 1000 | 0.4290 | 0.4752 | -0.0462 |
| 2000 | 0.4426 | 0.4901 | -0.0476 |

### nz0.0 vs nz1.0 Selector 对比（test\_noise=2.0）

| K | nz0.0 $R^2$ | nz1.0 $R^2$ | $\Delta$ (nz0 - nz1) |
|---|-------------|-------------|----------------------|
| 10 | 0.0547 | -0.0269 | +0.0815 |
| 20 | 0.1000 | 0.0247 | +0.0752 |
| 50 | 0.0908 | 0.0680 | +0.0228 |
| 100 | 0.1070 | 0.1413 | -0.0344 |
| 200 | 0.1082 | 0.1644 | -0.0562 |
| 500 | 0.1260 | 0.1796 | -0.0535 |
| 1000 | 0.1625 | 0.1954 | -0.0330 |
| 2000 | 0.1309 | 0.2043 | **-0.0734** |

## 6.2 建议绘图（Plot Suggestions）

### 6.2.1 Selector 对比热力图

- **目的**：展示不同 (K, test\_noise) 组合下 nz0.0 与 nz1.0 selector 的性能差异
- **X 轴**：K 值（对数刻度）
- **Y 轴**：test\_noise 水平
- **图上标注**：$\Delta R^2$ 数值，正值（nz0.0 优）用蓝色，负值（nz1.0 优）用红色

### 6.2.2 K-性能曲线族

- **目的**：展示不同 selector 在各测试噪声下的 K-$R^2$ 曲线
- **X 轴**：K（对数刻度）
- **Y 轴**：$R^2$
- **图上标注**：4 条子图（test\_noise=0.0, 0.5, 1.0, 2.0），每图含 nz0.0 和 nz1.0 两条曲线

### 6.2.3 最优 $\alpha$ vs 噪声水平

- **目的**：展示正则化强度与噪声的关系
- **X 轴**：噪声水平 $\sigma$
- **Y 轴**：最优 $\alpha$（对数刻度）
- **图上标注**：标记各点的具体数值

## 6.3 相关文件

| 类型 | 路径 |
|------|------|
| 原始摘要 | `/home/swei20/Physics_Informed_AI/raw/ridge_topk_summary.md` |
| 全结果表 | `ridge_topk_all_selectors.csv` |
| nz0.0 selector 结果 | `ridge_topk_selector_nz0p0.csv` |
| nz1.0 selector 结果 | `ridge_topk_selector_nz1p0.csv` |
| Top-K 特征索引 | `topk_indices_K*.npy` |


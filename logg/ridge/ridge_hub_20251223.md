# 🧠 Ridge Hub
> **Name:** Ridge Regression for log_g | **ID:** `VIT-20251127-ridge-hub`  
> **Topic:** `ridge` | **Layer:** L2 (Topic Hub) | **Project:** `VIT`  
> **Author:** Viska Wei | **Date:** 2025-11-27 | **Status:** ✅ Stable
```
💡 log_g-flux 映射是否本质线性？正则化扮演什么角色？  
决定：NN 架构选择、正则化策略、Linear shortcut 必要性
```

## 🔗 Related Files
| Type | File |
|------|------|
| 📍 Roadmap | `ridge_roadmap_20251223.md` |
| 📗 Experiments | `exp/*.md` |
| 📗 1M Scaling | `../scaling/exp/exp_scaling_ml_ceiling_20251222.md` |

## 🔗 Hub Dependencies

| Parent Hub | 引用数据 | 同步章节 |
|------------|---------|---------|
| `moe_hub` | Ridge baseline, Oracle R² | §5.3 |
| `scaling_hub` | α sweep, 1M ceiling | §5.3 |
| `benchmark_hub` | R² @ all noise | §5.3 |

---

# 1. 🌲 问题树

## 1.1 核心问题
> **log_g-flux 映射是否本质线性？正则化扮演什么角色？**

决定：NN 架构选择、正则化策略、Linear shortcut 必要性

## 1.2 问题分解

```
🎯 核心: log_g-flux 是否线性？正则化作用？
│
├── A) Learning Curve
│   ├── A.1: 100k vs 32k 增益 → ✅ +2.71%
│   ├── A.2: 1M vs 100k 增益 → ✅ +2.44%
│   └── A.3: 高噪声数据量影响 → ✅ 增益有限
│
├── B) α 规律
│   ├── B.1: 最优α随噪声变化 → ✅ 跨6数量级
│   ├── B.2: 固定α可行? → ❌ 不可行
│   └── B.3: 大样本最优α → ✅ α∝数据量
│
├── C) 迁移稳定性
│   ├── C.1: 特征对α敏感? → ❌ 不敏感(ρ>0.85)
│   ├── C.2: noise=0能迁移? → ❌ 是"孤岛"
│   └── C.3: 高噪声间稳定? → ✅ 高度稳定(ρ>0.95)
│
├── D) σ通道
│   ├── D.1: σ能预测log_g? → ✅ LightGBM R²=0.91
│   ├── D.2: 线性还是非线性? → ✅ 非线性
│   └── D.3: 物理还是捷径? → 🔄 待审计
│
└── E) 性能天花板
    ├── E.1: noise=0 R² → ✅ 0.999
    ├── E.2: noise=1 天花板 → ✅ ~0.50
    └── E.3: 信息论上限 → 🔄 待验证

✅ 验证 | ❌ 否定 | 🔄 进行中
```

## 1.3 边界

| ✅ 范围内 | ❌ 范围外 |
|----------|----------|
| Ridge baseline | 非线性模型详细分析 |
| α与噪声关系 | 其他恒星参数 |
| 特征稳定性 | 复杂特征工程 |
| 32k-1M数据量 | >1M数据 |

---

# 2. 🎯 答案 + 战略路线

> Hub回答"知道什么、往哪走"，验证计划见 Roadmap §1

## 2.0 战略推荐

**推荐: Route M (Representation/Model)**

| Route | 名称 | 倾向 | 理由 |
|-------|------|------|------|
| I | 信息上限 | 🟡 | 需Fisher确认 |
| **M** | 表征/模型 | 🟢 **推荐** | 斜率≈0说明非data-limited；α规律说明盲过滤不够 |
| S | σ通道 | 🟡 | 强但可能是捷径，需审计 |

## 2.1 问题回答

### A) Learning Curve

| 项 | 内容 |
|----|------|
| 答案 | 曲线已变平；32k→100k +2.71%，100k→1M +2.44%。1M+noise=1 仍卡在R²≈0.50 |
| 影响 | **非data-limited** → Route M |
| 置信 | 🟢 |
| 证据 | exp_100k, exp_ml_ceiling |

### B) α规律

| 项 | 内容 |
|----|------|
| 答案 | α_opt 随噪声跨**6数量级**(0.001→1000)；大样本α更大 |
| 影响 | Ridge"盲收缩"不够聪明 → 需选择性过滤 → Route M |
| 置信 | 🟢 |
| 证据 | exp_alpha_sweep, exp_scaling |

### C) 迁移稳定性

| 项 | 内容 |
|----|------|
| 答案 | noise=0与有噪声ρ<0.1；高噪声间ρ>0.95 |
| 影响 | **不要用noise=0训练** |
| 置信 | 🟢 |
| 证据 | exp_stability, exp_topk |

### D) σ通道

| 项 | 内容 |
|----|------|
| 答案 | error-only LightGBM R²=0.91，线性几乎无效 → 强非线性 |
| 影响 | 高收益高风险，需审计 → Route S 待验证 |
| 置信 | 🟡 |
| 证据 | exp_error |

### E) 性能天花板

| 项 | 内容 |
|----|------|
| 答案 | noise=0: R²=0.999；noise=1: R²≈0.50；1M无法突破 |
| 影响 | Ridge有明确上限，需更强模型。先确认信息论上限 |
| 置信 | 🟢(Ridge) / 🟡(信息上限) |
| 证据 | exp_alpha_sweep, exp_ml_ceiling |

## 2.2 决策汇总

```
A: 斜率≈0 → 非data-limited
B: α跨6数量级 → 盲过滤不够
C: noise=0孤岛 → 训练贴目标噪声
D: σ R²=0.91 → 高收益需审计
E: Ridge天花板0.50 → 有提升空间

综合: Route M
待验证: Gate-1信息上限, Gate-3 σ非捷径
```

---

# 3. 💡 洞见汇合

## 3.1 汇合索引

| # | 主题 | 来源 | 结论 | 置信 |
|---|------|------|------|------|
| C1 | 映射本质线性 | exp_alpha,100k | noise=0时R²=0.999，NN任务是信息过滤 | 🟢 |
| C2 | α规律 | exp_alpha,scaling | 最优α随噪声单调增，跨6数量级 | 🟢 |
| C3 | noise=0孤岛 | exp_stability | 无噪声训练不能迁移 | 🟢 |
| C4 | Error物理信息 | exp_error | σ可独立预测log_g(R²=0.91)，非线性 | 🟢 |
| C5 | 数据量增益有限 | exp_100k,ml_ceiling | 100k→1M仅+2.44% | 🟢 |
| C6 | Ridge天花板 | exp_ml_ceiling | 1M+noise=1下R²=0.50 | 🟢 |

## 3.2 详情

### C1: 映射本质线性

| 来源 | 发现 | 数据 |
|------|------|------|
| exp_alpha_sweep | noise=0 Ridge接近完美 | R²=0.999 |
| exp_alpha_sweep | 无噪声也需正则化 | α=0.001优于OLS +3.1% |
| exp_100k | 更多数据仅微小改进 | +2.71% |

**综合**: log_g信息几乎完全在线性子空间。NN主要任务是"学会忽略无关像素"——信息过滤问题。

**启示**:
- NN含Linear shortcut: $\hat{y} = w^\top x + g_\theta(x)$
- 容量分配给去噪/过滤机制(Attention, Sparse)

### C2: α规律

**综合**: α必须与噪声匹配：噪声↑ → 需"扔掉"的像素↑ → α↑。数据量↑时α也需↑(约3x per 10x data)。

**启示**: Weight decay不能固定，需与噪声挂钩

### C3: noise=0孤岛

**综合**: 无噪声学到的特征/参数与有噪声完全不同。高噪声(≥0.5)间可安全迁移。

**启示**: 训练噪声应≥目标测试噪声

### C4: Error物理信息

**综合**: σ通过光子统计与恒星亮度(→log_g)物理关联。需非线性模型才能提取。

**启示**: NN输入双通道[flux,σ]或SNR=flux/error

### C5+C6: 数据量增益有限 + 天花板

**综合**: Ridge在高噪声下天花板R²≈0.50，1M vs 100k仅+2.44%。瓶颈是模型表达力非数据量。

**启示**: 资源投模型改进而非堆数据；R²=0.50是baseline，目标>0.70

---

# 4. 📐 设计原则

## 4.1 已确认原则

| # | 原则 | 建议 | 证据 |
|---|------|------|------|
| P1 | **Linear Shortcut** | $\hat{y} = w^\top x + g_\theta(x)$ | exp_alpha |
| P2 | **信息过滤优先** | Attention/Sparse/Denoising | exp_alpha,stability |
| P3 | **WD与噪声挂钩** | 噪声↑ → 正则化↑ | exp_alpha |
| P4 | **避免noise=0训练** | 训练噪声≥目标噪声 | exp_stability,topk |
| P5 | **双通道输入** | [flux,σ]或flux/σ | exp_error |
| P6 | **高噪声训练更鲁棒** | noise≥0.5时特征稳定 | exp_stability |
| P7 | **Ridge天花板~0.50** | 高噪声需深度学习 | exp_ml_ceiling |

## 4.2 关键数字

| 指标 | 值 | 条件 | 来源 |
|------|-----|------|------|
| 无噪声R² | **0.999** | α=0.001, 32k | exp_alpha |
| 高噪声R²(32k) | **0.458** | α=200, σ=1 | exp_alpha |
| 高噪声R²(100k) | **0.486** | α=3e4, σ=1 | exp_scaling |
| 高噪声R²(1M) | **0.4997** | α=5000, σ=1 | exp_ml_ceiling |
| 标准基准(1M,1k test) | **0.4551** | α=1e5, σ=1 | 2025-12-24 |
| Oracle MoE | **0.6249** | 9 bins | moe exp |
| 正则化最大收益 | **+68.4%** | σ=2 | exp_alpha |
| α范围(32k) | **0.001→1000** | σ:0→2 | exp_alpha |
| α(1M,σ=1) | **100,000** | 1M | 2025-12-24 |
| Error-only R² | **0.91** | LightGBM | exp_error |
| 100k vs 32k | **+2.71%** | 平均 | exp_100k |
| 1M vs 100k | **+2.44%** | σ=1 | exp_ml_ceiling |
| 高噪声特征相关 | **>0.95** | σ≥0.5 | exp_stability |

## 4.3 已关闭方向

| 方向 | 证据 | 原因 |
|------|------|------|
| ~~固定α~~ | exp_alpha | α跨6数量级 |
| ~~noise=0迁移~~ | exp_stability | 是"孤岛" |
| ~~堆数据突破Ridge~~ | exp_ml_ceiling | 1M仅+2.44%，瓶颈在representation |

---

# 5. 📎 附录

## 5.0 假设存档

<details>
<summary><b>战略假设 (H1–H4)</b></summary>

| # | 假设 | 状态 | 若真 | 若假 |
|---|------|------|------|------|
| H1 | 已从data-limited转为model-limited | ✅ | 改representation | 继续堆数据 |
| H2 | α是"有效自由度"观测量 | ✅ | 需选择性过滤 | α只是调参细节 |
| H3 | noise=0是孤岛 | ✅ | 训练贴目标噪声 | 可用noise=0预训练 |
| H4 | σ可能是shortcut | 🔄 | 需审计 | 可直接使用 |

</details>

<details>
<summary><b>机制假设 (M1–M4)</b></summary>

| # | 假设 | 验证 | 状态 |
|---|------|------|------|
| M1 | Ridge天花板来自线性无法表达形状 | E2形状特征 | 🔄 |
| M2 | 高噪声难点是去退化 | E4 MoE | 🔄 |
| M3 | Ridge是盲过滤 | E3 SNR-aware | 🔄 |
| M4 | σ-log_g相关可能是捷径 | E5审计 | 🔄 |

</details>

## 5.1 领域背景

**log_g与光谱关系**:
- 压力敏感谱线宽度：高log_g(矮星)→高压→谱线增宽
- 电离平衡：影响不同电离态离子相对丰度
- 连续谱斜率：通过温度-光度关系间接影响

**噪声模型**: $\text{noisy} = \text{flux} + \mathcal{N}(0,1) \times \text{error} \times \sigma$

## 5.2 术语表

| 术语 | 定义 |
|------|------|
| Ridge α | L2正则化强度 |
| R² | 决定系数，1完美0均值 |
| OLS | α=0的Ridge |
| SNR | flux/error |
| Selector nzX.X | 在noise=X.X上训练的特征选择器 |

## 5.3 更新日志

| 日期 | 变更 |
|------|------|
| 2025-12-24 | 精简重构，添加标准基准(1M,1k test) |
| 2025-12-23 | 重构§2为Answer Key + Strategic Route |
| 2025-12-22 | 1M Ridge results |
| 2025-12-05 | 100k实验完成 |
| 2025-11-30 | 原ridge_main创建 |

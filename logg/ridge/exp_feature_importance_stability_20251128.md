# 📘 Ridge 回归特征重要性稳定性分析报告

---
> **实验名称：** Ridge Feature Importance Stability vs Alpha & Noise  
> **作者：** Viska Wei  
> **日期：** 2025-11-28  
> **数据版本：** linear_alpha_search (42 configurations)  
> **模型版本：** Ridge Regression (sklearn)

---

# 1. 🎯 目标

## 1.1 背景与动机

在使用线性模型进行天文参数估计时，**特征重要性（Feature Importance）** 是理解模型行为和指导神经网络设计的关键。然而，特征重要性是否稳定、是否依赖于正则化强度 $\alpha$ 和噪声水平，直接影响：

- 模型的可解释性
- Top-K 特征选择策略的可靠性
- 跨噪声环境的迁移学习策略
- 神经网络 Attention 机制的设计

本实验系统分析 Ridge 回归系数排序在不同 $\alpha$ 和 noise level 下的稳定性，为后续 NN/ViT 设计提供理论依据。

## 1.2 核心假设

> **Ridge 回归的特征重要性排序对正则化强度 $\alpha$ 高度敏感，不同 $\alpha$ 会导致完全不同的系数排序。**

如果假设成立，意味着：
- 特征选择必须与正则化强度联合优化
- 不能简单复用某一配置下的重要特征
- 神经网络的 Attention 权重可能也不稳定

如果假设不成立，则意味着：
- 存在"本质重要"的特征子集，与 $\alpha$ 无关
- 可以安全地进行特征预选择
- Attention 机制应收敛到稳定 pattern

## 1.3 验证问题

| # | 问题 | 验证目标 | 结果 |
|---|------|---------|------|
| Q1 | 固定 noise，不同 $\alpha$ 的系数排序相关性如何？ | 验证 $\alpha$ 敏感性假设 | ✅ **依赖 noise level**：低噪声敏感，高噪声稳定 |
| Q2 | 使用最优 $\alpha$，跨 noise level 的系数排序相关性如何？ | 验证跨噪声迁移可行性 | ❌ Noise=0 与其他完全不相关 ($\rho \approx 0$) |
| Q3 | 高噪声区域的特征重要性是否形成"稳定区"？ | 验证 N=0.5~2.0 的一致性 | ✅ 高度一致 ($\rho > 0.85$) |
| Q4 | $\alpha$ 选择对高噪声场景是否重要？ | 指导超参数调优策略 | ✅ N=2.0 时任意 $\alpha$ 都有 $\rho > 0.93$ |

## 1.4 结论摘要（实验后填写）

### 1.4.1 实验结论

| 结论 | 说明 |
|------|------|
| **噪声决定稳定性** | 噪声水平是特征重要性稳定性的主要决定因素，而非 $\alpha$ |
| **N=0 是"孤岛"** | 无噪声环境学到的特征重要性与有噪声环境完全不同 |
| **高噪声形成稳定区** | N=0.5~2.0 之间特征重要性高度一致 ($\rho > 0.85$) |

### 1.4.2 设计启示

| 设计原则 | 具体建议 |
|---------|---------|
| **噪声感知训练** | 低噪声和高噪声应使用不同的正则化/训练策略 |
| **避免 N=0 迁移** | 不应从无噪声数据训练后期望泛化到有噪声场景 |
| **Top-K 选择在高噪声可靠** | 高噪声下重要特征排序稳定，特征选择是安全的 |

> **一句话总结**：噪声是特征重要性稳定性的决定性因素——低噪声下对 $\alpha$ 敏感，高噪声下高度稳定；Noise=0 是"孤岛"，与其他噪声水平完全不相关。

---

# 2. 🧪 实验设计（Experiment Design）

## 2.1 数据（Data）

| 参数 | 值 |
|-----|---|
| **训练样本数** | 32,000 |
| **测试样本数** | 512 |
| **特征维度** | 4096 (full spectrum) |
| **标签参数** | $\log g$ (表面重力) |
| **标签归一化** | MinMax, 范围 $[1.0, 5.0]$ |

噪声模型：

$$
\text{noisy\_flux} = \text{flux} + \mathcal{N}(0, \sigma^2)
$$

## 2.2 使用的特征类型

- **Full Flux Spectrum**: 4096 维原始光谱
- 无 PCA 降维
- 无 Top-K 选择
- 直接使用 Ridge 系数绝对值作为 Feature Importance

## 2.3 模型与算法（Model & Algorithm）

### Ridge 回归

$$
\hat{y} = X w + b
$$

$$
w = (X^\top X + \alpha I)^{-1} X^\top y
$$

**Feature Importance 定义**：

$$
\text{FI}_i = |w_i|
$$

系数绝对值越大，对应特征越重要。

### 相关性指标

**Spearman 秩相关系数**：衡量两个系数排序的单调相关性

$$
\rho = 1 - \frac{6 \sum d_i^2}{n(n^2-1)}
$$

**Jaccard Top-K 相似度**：衡量两组 Top-K 重要特征的重叠度

$$
J(A, B) = \frac{|A \cap B|}{|A \cup B|}
$$

## 2.4 超参数（Hyperparameters）

### 正则化参数 $\alpha$

| $\alpha$ 值 | 正则化强度 |
|------------|-----------|
| 0.001 | 极弱 |
| 0.01 | 很弱 |
| 0.1 | 弱 |
| 1.0 | 中等 |
| 10.0 | 较强 |
| 100.0 | 强 |
| 1000.0 | 极强 |

### 噪声水平

| Noise Level | 描述 |
|-------------|-----|
| 0.0 | 无噪声（理想情况） |
| 0.1 | 低噪声 |
| 0.2 | 低-中噪声 |
| 0.5 | 中噪声 |
| 1.0 | 高噪声 |
| 2.0 | 极高噪声 |

### 最优 $\alpha$ 配置

| Noise Level | 最优 $\alpha$ | 最佳 Test $R^2$ | OLS $R^2$ | $\Delta R^2$ |
|-------------|--------------|----------------|----------|-------------|
| 0.0 | 0.001 | 0.999 | 0.969 | +3.0% |
| 0.1 | 1.0 | 0.909 | 0.901 | +0.9% |
| 0.2 | 10.0 | 0.826 | 0.811 | +1.9% |
| 0.5 | 100.0 | 0.649 | 0.608 | +6.9% |
| 1.0 | 100.0 | 0.451 | 0.385 | +17.0% |
| 2.0 | 1000.0 | 0.221 | 0.131 | +68.4% |

---

# 3. 📊 实验结果表（Results）

## 3.1 固定 Noise，不同 $\alpha$ 的 Feature Importance 相关性

### Spearman 秩相关系数（与 $\alpha=0.001$ 基线比较）

| Noise | $\alpha=0.001$ | $\alpha=0.01$ | $\alpha=0.1$ | $\alpha=1.0$ | $\alpha=10.0$ | $\alpha=100.0$ | $\alpha=1000.0$ |
|-------|----------------|---------------|--------------|--------------|---------------|----------------|-----------------|
| **0.0** | 1.0000 | 0.7388 | 0.2188 | -0.0562 | -0.1132 | -0.0137 | 0.0077 |
| **0.1** | 1.0000 | 1.0000 | 0.9993 | 0.9632 | 0.6457 | 0.1435 | -0.0048 |
| **0.2** | 1.0000 | 1.0000 | 0.9999 | 0.9957 | 0.8772 | 0.4110 | 0.1539 |
| **0.5** | 1.0000 | 1.0000 | 1.0000 | 0.9999 | 0.9901 | 0.8272 | 0.5317 |
| **1.0** | 1.0000 | 1.0000 | 1.0000 | 1.0000 | 0.9993 | 0.9708 | 0.7887 |
| **2.0** | 1.0000 | 1.0000 | 1.0000 | 1.0000 | 1.0000 | 0.9971 | 0.9355 |

### Jaccard Top-500 相似度（与 $\alpha=0.001$ 基线比较）

| Noise | $\alpha=0.001$ | $\alpha=0.01$ | $\alpha=0.1$ | $\alpha=1.0$ | $\alpha=10.0$ | $\alpha=100.0$ | $\alpha=1000.0$ |
|-------|----------------|---------------|--------------|--------------|---------------|----------------|-----------------|
| **0.0** | 1.0000 | 0.4388 | 0.2594 | 0.2594 | 0.2755 | 0.2870 | 0.2626 |
| **0.1** | 1.0000 | 0.9841 | 0.9380 | 0.6949 | 0.3228 | 0.2034 | 0.1905 |
| **0.2** | 1.0000 | 1.0000 | 0.9841 | 0.8939 | 0.5480 | 0.2438 | 0.2063 |
| **0.5** | 1.0000 | 1.0000 | 0.9920 | 0.9646 | 0.8149 | 0.4535 | 0.2674 |
| **1.0** | 1.0000 | 1.0000 | 1.0000 | 0.9881 | 0.9646 | 0.7301 | 0.4327 |
| **2.0** | 1.0000 | 1.0000 | 1.0000 | 1.0000 | 0.9881 | 0.9048 | 0.6129 |

## 3.2 使用最优 $\alpha$ 的跨 Noise 相似度

### Spearman 相关矩阵

| Noise | 0.0 ($\alpha$=0.001) | 0.1 ($\alpha$=1.0) | 0.2 ($\alpha$=10) | 0.5 ($\alpha$=100) | 1.0 ($\alpha$=100) | 2.0 ($\alpha$=1000) |
|-------|----------------------|--------------------|--------------------|---------------------|---------------------|----------------------|
| **0.0** | 1.0000 | -0.0429 | -0.0556 | -0.0166 | -0.0132 | -0.0074 |
| **0.1** | -0.0429 | 1.0000 | 0.7762 | 0.3380 | 0.3190 | 0.2195 |
| **0.2** | -0.0556 | 0.7762 | 1.0000 | 0.7212 | 0.6483 | 0.5071 |
| **0.5** | -0.0166 | 0.3380 | 0.7212 | 1.0000 | 0.9507 | 0.8511 |
| **1.0** | -0.0132 | 0.3190 | 0.6483 | 0.9507 | 1.0000 | 0.9259 |
| **2.0** | -0.0074 | 0.2195 | 0.5071 | 0.8511 | 0.9259 | 1.0000 |

### Jaccard Top-500 矩阵

| Noise | 0.0 ($\alpha$=0.001) | 0.1 ($\alpha$=1.0) | 0.2 ($\alpha$=10) | 0.5 ($\alpha$=100) | 1.0 ($\alpha$=100) | 2.0 ($\alpha$=1000) |
|-------|----------------------|--------------------|--------------------|---------------------|---------------------|----------------------|
| **0.0** | 1.0000 | 0.2005 | 0.2270 | 0.2092 | 0.1905 | 0.2005 |
| **0.1** | 0.2005 | 1.0000 | 0.4620 | 0.2531 | 0.2330 | 0.2107 |
| **0.2** | 0.2270 | 0.4620 | 1.0000 | 0.4085 | 0.3333 | 0.2771 |
| **0.5** | 0.2092 | 0.2531 | 0.4085 | 1.0000 | 0.6892 | 0.5106 |
| **1.0** | 0.1905 | 0.2330 | 0.3333 | 0.6892 | 1.0000 | 0.6207 |
| **2.0** | 0.2005 | 0.2107 | 0.2771 | 0.5106 | 0.6207 | 1.0000 |

## 3.3 相邻 Noise Level 相似度

| 比较 | Spearman $\rho$ | Jaccard Top-500 |
|-----|-----------------|-----------------|
| N=0.0 ↔ N=0.1 | **-0.04** | 0.20 |
| N=0.1 ↔ N=0.2 | **0.78** | 0.46 |
| N=0.2 ↔ N=0.5 | **0.72** | 0.41 |
| N=0.5 ↔ N=1.0 | **0.95** | 0.69 |
| N=1.0 ↔ N=2.0 | **0.93** | 0.62 |

## 3.4 $\alpha$ 敏感性分析

| Noise | 最优 $\alpha$ | Spearman $\rho > 0.9$ 的 $\alpha$ 范围 | 范围跨度 |
|-------|--------------|---------------------------------------|---------|
| 0.0 | 0.001 | [0.001] | 1× |
| 0.1 | 1.0 | [0.001, 0.01, 0.1, 1.0] | 1,000× |
| 0.2 | 10.0 | [1.0, 10.0] | 10× |
| 0.5 | 100.0 | [100.0] | 1× |
| **1.0** | **100.0** | **[0.001, 0.01, 0.1, 1.0, 10.0, 100.0]** | **100,000×** |
| **2.0** | **1000.0** | **[0.001, 0.01, 0.1, 1.0, 10.0, 100.0, 1000.0]** | **1,000,000×** |

---

# 4. 💡 关键洞见（Key Insights）

## 4.1 宏观层洞见（用于指导 Neural Network 架构设计）

### 🔥 洞见 1: 噪声越高，Feature Importance 对 $\alpha$ 越稳定

| Noise | $\alpha$ 从 0.001 变到 1000 时的 Spearman 变化 |
|-------|---------------------------------------------|
| 0.0 | 1.00 → 0.01 (变化 0.99) |
| 0.1 | 1.00 → -0.00 (变化 1.00) |
| 0.5 | 1.00 → 0.53 (变化 0.47) |
| 1.0 | 1.00 → 0.79 (变化 0.21) |
| **2.0** | **1.00 → 0.94 (变化仅 0.06)** |

**物理解释**：高噪声下只有最强信号能穿透噪声，无论 $\alpha$ 大小都只能"看到"相同的强信号特征。

### 🔥 洞见 2: Noise=0 是"孤岛"

- N=0.0 与所有其他 noise 的 Spearman $\rho \approx 0$
- 完全不相关，甚至出现负相关
- 无噪声训练的模型不能泛化到有噪声场景

### 🔥 洞见 3: 高噪声区域形成"稳定区"

- N=0.5~2.0 之间 Spearman $\rho > 0.85$
- 在此区间内的噪声增强是安全的
- 可以在不同高噪声水平间迁移

## 4.2 模型层洞见（用于优化模型）

| 洞见 | 说明 |
|------|------|
| **最优 $\alpha$ 随噪声单调增加** | 从 0.001 (N=0) 到 1000 (N=2.0)，跨越 6 个数量级 |
| **正则化在高噪声下不重要** | N=2.0 时任意 $\alpha \in [0.001, 1000]$ 都有 $\rho > 0.93$ |
| **Top-K 选择在高噪声下可靠** | Jaccard 相似度在高噪声下显著更高 |

## 4.3 实验层细节洞见

```
低噪声 (N < 0.1):
├── 信噪比高，模型能看到所有光谱细节
├── 不同 α 会选择完全不同的"最优解"
├── 小 α: 可能过拟合微小噪声波动
├── 大 α: 强制均匀收缩，丢失有用信息
└── 结果: 特征重要性对 α 极其敏感

高噪声 (N ≥ 0.5):
├── 信噪比低，只有最强信号能穿透噪声
├── 无论 α 大小，都只能"看到"相同的强信号特征
├── 正则化的主要作用是稳定解，而非选择特征
└── 结果: 特征重要性对 α 不敏感，高度稳定
```

---

# 5. 📉 建议绘图（Plot Suggestions）

## 5.1 Feature Importance Correlation vs $\alpha$ (已生成)

**文件**: `figs/feature_importance_correlation_vs_alpha.png`

- **左图**: Spearman 相关 vs $\alpha$（每条线一个 noise level）
- **右图**: Jaccard Top-500 vs $\alpha$
- **颜色**: Viridis 色带（黄色=低噪声，紫色=高噪声）
- **关键观察**: 高噪声线条平坦（对 $\alpha$ 不敏感），低噪声线条陡降

## 5.2 最优 $\alpha$ 的跨 Noise 相似度热力图 (已生成)

**文件**: `figs/feature_importance_optimal_alpha_analysis.png`

- **左上**: 跨 noise 的 Spearman 热力图
- **右上**: 跨 noise 的 Jaccard 热力图
- **左下**: 各 noise 的 Spearman vs $\alpha$
- **右下**: 各 noise 的 Jaccard vs $\alpha$
- **关键观察**: N=0.0 与其他 noise 相关性接近 0（深蓝色方块）

## 5.3 Ridge 性能 vs $\alpha$ by Noise (已生成)

**文件**: `figs/ridge_metrics_vs_alpha_by_noise.png`

- 三行子图：$R^2$, MAE, RMSE vs $\log_{10}(\alpha)$
- OLS 基线用星号标记
- 展示最优 $\alpha$ 随噪声增加而右移

## 5.4 建议新增图表

| 图表 | 目的 |
|------|------|
| Feature Importance Spectrum Overlay | 展示不同 $\alpha$ 下系数分布的差异 |
| $\alpha$ Sensitivity Heatmap | 热力图展示 $\alpha$-noise 组合的稳定性 |
| Top-K Feature Position Consistency | 可视化 Top-K 特征在波长轴上的位置稳定性 |

---

# 6. 📝 结论（Conclusion）

## 6.1 核心发现

> **噪声是特征重要性稳定性的决定性因素，而非正则化强度 $\alpha$。低噪声下特征重要性对 $\alpha$ 极其敏感，高噪声下高度稳定；Noise=0 是"孤岛"，与所有有噪声场景完全不相关。**

假设验证：
- ❌ 原假设：特征重要性对 $\alpha$ 普遍敏感
- ✅ 实验结果：敏感性取决于噪声水平——高噪声下任意 $\alpha$ 都给出一致的排序

## 6.2 关键结论（2-4 条）

| # | 结论 | 证据 |
|---|------|------|
| 1 | **噪声决定稳定性** | N=2.0 时 $\alpha$ 变化 $10^6$ 倍，Spearman 仅从 1.00 降到 0.94 |
| 2 | **N=0 是孤岛** | N=0.0 与其他所有 noise 的跨配置 Spearman $\rho \approx 0$ |
| 3 | **高噪声稳定区** | N=0.5~2.0 之间 Spearman $\rho > 0.85$，形成稳定的特征重要性区域 |
| 4 | **最优 $\alpha$ 随噪声单调增加** | 从 0.001 (N=0) 到 1000 (N=2.0)，跨越 6 个数量级 |

## 6.3 设计启示

### 架构原则

| 原则 | 建议 | 原因 |
|------|------|------|
| **噪声感知架构** | 低噪声和高噪声应使用不同的模型/训练策略 | 低噪声对超参敏感，高噪声稳定 |
| **Attention 可复现性** | 高噪声下，不同初始化应收敛到类似的 attention pattern | Ridge 系数表明高噪声下只有少数强特征重要 |
| **Top-K 特征选择** | 在高噪声下更可靠 | 重要特征排序稳定，Jaccard 相似度高 |

### 训练策略

| 场景 | 推荐策略 | 原因 |
|-----|---------|------|
| **低噪声 (N<0.1)** | 小 weight decay，精细调参 | 特征重要性敏感，需要保留信息 |
| **高噪声 (N≥0.5)** | weight decay 选择不关键 | 特征重要性本身稳定 |
| **跨噪声迁移** | 避免从 N=0 迁移到有噪声 | 特征重要性完全不同 |

### ⚠️ 常见陷阱

| 常见做法 | 实验证据 |
|----------|----------|
| "在无噪声数据上训练，期望泛化到有噪声" | N=0.0 与 N≥0.1 的 Spearman $\rho \approx 0$，完全不相关 |
| "用同一个 $\alpha$ 适配所有噪声水平" | 最优 $\alpha$ 随噪声变化 6 个数量级 |
| "认为特征重要性是模型固有属性" | 低噪声下完全依赖 $\alpha$ 选择 |

## 6.4 物理解释

**低噪声 (N < 0.1)**：
- 信噪比高，模型能看到所有光谱细节
- 不同 $\alpha$ 选择不同的"最优解"路径
- 小 $\alpha$ 可能过拟合微小波动，大 $\alpha$ 强制均匀收缩

**高噪声 (N ≥ 0.5)**：
- 信噪比低，只有最强信号（如 Balmer 线、Ca II triplet）能穿透噪声
- 无论 $\alpha$ 大小，都只能"看到"相同的强信号特征
- 正则化的主要作用是稳定数值解，而非选择特征

**Noise=0 为何是"孤岛"？**
- 模型学到的是"完美拟合"的系数，包含很多只在无噪声下才重要的微小特征
- 这些特征在有噪声时完全被淹没
- 有噪声模型被迫学习"鲁棒"的系数，只保留真正强的信号

## 6.5 关键数字速查

| 指标 | 值 |
|------|-----|
| 最佳性能 (N=0) | $R^2 = 0.999$, $\alpha = 0.001$ |
| 高噪声最佳性能 (N=2.0) | $R^2 = 0.221$, $\alpha = 1000$ |
| N=2.0 的 $\alpha$ 稳定范围 | $[0.001, 1000]$，跨度 $10^6$，Spearman 变化仅 0.06 |
| 高噪声稳定区 | N=0.5~2.0, Spearman $\rho > 0.85$ |
| N=0 与其他 noise 的相关性 | Spearman $\rho \approx 0$（完全不相关） |

## 6.6 下一步工作

| 方向 | 具体任务 |
|------|----------|
| **验证 NN Attention 稳定性** | 检验 ViT attention 权重是否在高噪声下也收敛到稳定 pattern |
| **噪声自适应正则化** | 开发根据估计 SNR 动态调整 weight decay 的训练策略 |
| **Top-K 迁移实验** | 用高噪声选出的 Top-K 特征在低噪声场景测试性能 |

## 6.7 相关文件

| 类型 | 路径 |
|------|------|
| **分析脚本** | `scripts/plot_feature_importance_vs_alpha.py` |
| **分析脚本** | `scripts/plot_feature_importance_optimal_alpha.py` |
| **主图 1** | `figs/feature_importance_correlation_vs_alpha.png` |
| **主图 2** | `figs/feature_importance_optimal_alpha_analysis.png` |
| **性能图** | `figs/ridge_metrics_vs_alpha_by_noise.png` |
| **原始数据** | `results/linear_alpha_search/linear_alpha_sweep.csv` |
| **模型文件** | `results/linear_alpha_search/lnreg_l2_ridge_*.pkl` |

---

*报告生成时间: 2025-11-28*  
*数据覆盖: 42 个独立实验配置 (7 $\alpha$ × 6 noise levels)*  
*核心发现: 噪声是特征重要性稳定性的决定性因素，N=0 是"孤岛"*


# ğŸ“˜ Experiment Report: MoE-1 Piecewise Ridge

> âš ï¸ **æ•°å€¼ä¿®æ­£è¯´æ˜ (2025-12-03)**
> 
> æœ¬æŠ¥å‘Šä¸­çš„ **Î”RÂ²=0.078 å·²è¢« MVP-1.1 ä¿®æ­£ä¸º Î”RÂ²=0.050**ã€‚
> 
> **åŸå› **: æœ¬æŠ¥å‘Šä½¿ç”¨äº†ä¸å…¬å¹³æ¯”è¾ƒï¼ˆMoE è¯„ä¼° 81.6% æ ·æœ¬ vs Global è¯„ä¼° 100% æ ·æœ¬ï¼‰ã€‚
> 
> **æƒå¨ç»“è®ºè¯·å‚è§**: [`exp_moe_rigorous_validation_20251203.md`](./exp_moe_rigorous_validation_20251203.md)

> **Name:** Piecewise Ridge | **ID:** `VIT-20251203-moe-piecewise-01`  
> **Topic:** `moe` | **MVP:** MVP-1.0 | **Project:** `VIT`  
> **Author:** Viska Wei | **Date:** 2025-12-03 | **Status:** âš ï¸ Superseded by MVP-1.1
```
ğŸ’¡ å®éªŒç›®çš„  
å†³å®šï¼šMoE æ˜¯å¦å€¼å¾—æŠ•å…¥
```

---

---
## ğŸ”— Upstream Links

| ç±»å‹ | ğŸ”— link | è¯´æ˜ |
|------|------|------|
| ğŸ§  Hub | `logg/moe/moe_hub_20251203.md` | å‡è®¾é‡‘å­—å¡” |
| ğŸ—ºï¸ Roadmap | `logg/moe/moe_roadmap_20251203.md` | MVP è¯¦ç»†è®¾è®¡ |
| ğŸ“‹ Kanban | `status/kanban.md` | å®éªŒé˜Ÿåˆ— |
| ğŸ’¬ æ¥æºä¼šè¯ | ç”¨æˆ· MoE ç«‹é¡¹è®¨è®º (2025-12-03) | - |

---

# ğŸ“‘ Table of Contents

- [âš¡ Key Findings](#-æ ¸å¿ƒç»“è®ºé€Ÿè§ˆä¾›-main-æå–)
- [1. ğŸ¯ Objective](#1--ç›®æ ‡)
- [2. ğŸ§ª Experiment Design](#2--å®éªŒè®¾è®¡)
- [3. ğŸ“Š Figures & Results](#3--å®éªŒå›¾è¡¨)
- [4. ğŸ’¡ Insights](#4--å…³é”®æ´è§)
- [5. ğŸ“ Conclusions](#5--ç»“è®º)
- [6. ğŸ“ Appendix](#6--é™„å½•)

---

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆï¼ˆä¾› main æå–ï¼‰

> **æœ¬èŠ‚æ˜¯ç»™ main.md æå–ç”¨çš„æ‘˜è¦**

### ä¸€å¥è¯æ€»ç»“

> **MoE åœ¨ä¸­ç­‰å™ªå£°ä¸‹ï¼ˆnoise=0.1~0.5ï¼‰æœ‰æ˜¾è‘—ä»·å€¼ï¼ŒÎ”RÂ² è¾¾ +0.05~0.08ï¼›åœ¨ noise=0.2 æ—¶ï¼Œåˆ†åŒº Ridge RÂ²=0.9123ï¼Œå…¨å±€ Ridge RÂ²=0.8341ï¼Œæå‡ 7.8 ä¸ªç™¾åˆ†ç‚¹ã€‚**

### å¯¹å‡è®¾çš„éªŒè¯

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| Q1: åˆ†åŒº Ridge $\Delta R^2$ â‰¥0.03? | âœ… noise=0.2 æ—¶ $\Delta R^2$=+0.0781 | **MoE æœ‰ä»·å€¼** |
| Q2: å“ªäº› bin å±€éƒ¨ $R^2$ æ˜¾è‘—æ›´é«˜? | Bin3,6,9ï¼ˆé«˜é‡‘å±ä¸°åº¦ï¼‰å±€éƒ¨ RÂ²>0.97 | é«˜é‡‘å±ä¸°åº¦åŒºé—´é¢„æµ‹æœ€å¥½ |
| Q3: æ¯ä¸ª bin æ ·æœ¬é‡æ˜¯å¦è¶³å¤Ÿ? | âœ… æ‰€æœ‰ bin â‰¥ 2000 train, â‰¥ 59 test | æ ·æœ¬å……è¶³ |

### è®¾è®¡å¯ç¤ºï¼ˆ1-2 æ¡ï¼‰

| å¯ç¤º | å…·ä½“å»ºè®® |
|------|---------|
| MoE åœ¨ä¸­å™ªå£°æœ‰æ•ˆ | å½“ noise âˆˆ [0.1, 0.5] æ—¶ï¼Œåˆ†åŒºå»ºæ¨¡ä¼˜äºå…¨å±€æ¨¡å‹ |
| æŒ‰é‡‘å±ä¸°åº¦åˆ†ä¸“å®¶æ›´æœ‰æ•ˆ | é«˜/ä½ $[\text{M/H}]$ çš„ log g ç‰¹å¾å·®å¼‚å¤§ï¼Œåº”åˆ†åˆ«å»ºæ¨¡ |

### å…³é”®æ•°å­—

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| å…¨å±€ Ridge $R^2$ (baseline, noise=0.2) | **0.8341** |
| åˆ†åŒº Ridge $R^2$ (MoE-1, noise=0.2) | **0.9123** |
| $\Delta R^2$ (åˆ†åŒº - å…¨å±€, noise=0.2) | **+0.0781** |
| æœ€ä¼˜ bin (noise=0.2) | Bin3 (ä½æ¸©+é«˜é‡‘å±), RÂ²=0.9803 |
| æœ€å·® bin (noise=0.2) | Bin4 (ä¸­æ¸©+ä½é‡‘å±), RÂ²=0.7726 |

---

# 1. ğŸ¯ ç›®æ ‡

## 1.1 å®éªŒç›®çš„

**æ ¸å¿ƒé—®é¢˜**ï¼šMoE æ˜¯å¦èƒ½æå‡ $\log g$ é¢„æµ‹ï¼Ÿä»€ä¹ˆæ¡ä»¶ä¸‹æœ‰ç”¨ï¼Ÿ

**é¢„é˜²é’ˆ**ï¼šMoE **ä¸èƒ½çªç ´ä¿¡æ¯è®ºä¸Šé™**ï¼Œåªèƒ½åœ¨è¿˜æ²¡æ‘¸åˆ°å¤©èŠ±æ¿çš„æ—¶å€™ï¼Œå¸®ä½ æ›´å¿«ã€æ›´ç¨³ã€æ›´é«˜æ•ˆåœ°æ¥è¿‘ä¸Šé™ã€‚

**æœ¬å®éªŒçš„æ€è·¯**ï¼šåœ¨ä¸Šå¤æ‚ NN-MoE ä¹‹å‰ï¼Œå…ˆç”¨åˆ†æ®µ Ridge æ¥æ¨¡æ‹Ÿ MoEï¼Œçœ‹çœ‹æ˜¯å¦çœŸçš„"åˆ†åŒºé—´æ›´å¥½"ã€‚

**å›ç­”çš„é—®é¢˜**ï¼š
1. æŒ‰ $(T_{\text{eff}}, [\text{M/H}])$ åˆ† bin åï¼Œåˆ†åŒº Ridge æ˜¯å¦æ¯”å…¨å±€ Ridge æ›´å¥½ï¼Ÿ
2. æå‡å¹…åº¦æ˜¯å¦æ˜¾è‘—ï¼ˆ$\Delta R^2 \geq 0.03$ï¼‰ï¼Ÿ
3. å“ªäº›å‚æ•°åŒºé—´çš„æå‡æœ€æ˜æ˜¾ï¼Ÿ

**å¯¹åº” main.md çš„**ï¼š
- éªŒè¯é—®é¢˜ï¼šQ1, Q2, Q3
- å­å‡è®¾ï¼šH1.1, H1.2

## 1.2 é¢„æœŸç»“æœ

| åœºæ™¯ | é¢„æœŸç»“æœ | åˆ¤æ–­æ ‡å‡† |
|------|---------|---------|
| æ­£å¸¸æƒ…å†µ | åˆ†åŒº Ridge å…¨å±€ $R^2$ ç•¥é«˜äºå…¨å±€ Ridge | $\Delta R^2$ åœ¨ 0.01-0.05 èŒƒå›´ |
| MoE æœ‰ä»·å€¼ | $\Delta R^2 \geq 0.03$ | ç»§ç»­æ‰§è¡Œ MoE-2, MoE-3 |
| MoE ä»·å€¼æœ‰é™ | $\Delta R^2 < 0.03$ | æ”¾å¼ƒ MoEï¼Œèšç„¦å•æ¨¡å‹ä¼˜åŒ– |
| å¼‚å¸¸ï¼šæŸ bin æ ·æœ¬è¿‡å°‘ | bin å†… $R^2$ ä¸ç¨³å®š | åˆå¹¶ç›¸é‚» bin |

---

# 2. ğŸ§ª å®éªŒè®¾è®¡

## 2.1 æ•°æ®

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| è®­ç»ƒæ ·æœ¬æ•° | 32,000 |
| æµ‹è¯•æ ·æœ¬æ•° | 1,000 |
| ç‰¹å¾ç»´åº¦ | 4,096 (APOGEE-like è°±) |
| æ ‡ç­¾å‚æ•° | $\log g$ |
| è¾…åŠ©å‚æ•° | $T_{\text{eff}}$, $[\text{M/H}]$ (ç”¨äºåˆ† bin) |

**æ•°æ®èŒƒå›´**ï¼š
- $T_{\text{eff}}$: [3750, 6000] K
- $[\text{M/H}]$: [-2.50, 0.75] dexï¼ˆè¶…å‡º bin è¾¹ç•Œçš„æ ·æœ¬æœªè¦†ç›–ï¼‰
- $\log g$: [1.0, 5.0] dex

**å™ªå£°æ¨¡å‹**ï¼š

$$
\text{noisy\_flux} = \text{flux} + \mathcal{N}(0, \sigma^2)
$$

**Noise levels**: $\sigma \in \{0.0, 0.1, 0.2, 0.5, 1.0\}$ (ä¸»è¦æµ‹è¯• noise=0.2)

## 2.2 åˆ† Bin æ–¹æ¡ˆ

### æ ¸å¿ƒè®¾è®¡ï¼šæŒ‰ $(T_{\text{eff}}, [\text{M/H}])$ åˆ† 3Ã—3 = 9 ä¸ª bin

**ç‰©ç†åŠ¨æœº**ï¼š
- ä½ $T_{\text{eff}}$ / é«˜ $T_{\text{eff}}$ ä¸‹ï¼Œè°±çº¿å½¢çŠ¶â€“$\log g$ çš„å…³ç³»ä¸ä¸€æ ·
- é‡‘å±ä¸°åº¦æä½/æé«˜çš„æ˜Ÿï¼Œ$\log g$ ç‰¹å¾è½åœ¨å®Œå…¨ä¸åŒçš„æ³¢æ®µ

**åˆ† bin è¾¹ç•Œ**ï¼š

| ç»´åº¦ | Bin 1 | Bin 2 | Bin 3 |
|------|-------|-------|-------|
| $T_{\text{eff}}$ (K) | [3750, 4500) | [4500, 5250) | [5250, 6000] |
| $[\text{M/H}]$ (dex) | [-2, -1) | [-1, 0.0] | (0.0, 0.5] |

**Bin ç¼–å·ä¸ç‰©ç†ç‰¹æ€§**ï¼š

| Bin ID | $T_{\text{eff}}$ | $[\text{M/H}]$ | ç‰©ç†ç‰¹æ€§ |
|--------|------------------|----------------|---------|
| 1 | ä½æ¸© | ä½é‡‘å± | å†·å·¨æ˜Ÿ + è´«é‡‘å± |
| 2 | ä½æ¸© | ä¸­é‡‘å± | å†·å·¨æ˜Ÿ + å¤ªé˜³é‡‘å± |
| 3 | ä½æ¸© | é«˜é‡‘å± | å†·å·¨æ˜Ÿ + å¯Œé‡‘å± |
| 4 | ä¸­æ¸© | ä½é‡‘å± | ä¸­æ¸© + è´«é‡‘å± |
| 5 | ä¸­æ¸© | ä¸­é‡‘å± | ä¸­æ¸© + å¤ªé˜³é‡‘å± (ä¸»åºå±…å¤š) |
| 6 | ä¸­æ¸© | é«˜é‡‘å± | ä¸­æ¸© + å¯Œé‡‘å± |
| 7 | é«˜æ¸© | ä½é‡‘å± | çƒ­æ˜Ÿ + è´«é‡‘å± |
| 8 | é«˜æ¸© | ä¸­é‡‘å± | çƒ­æ˜Ÿ + å¤ªé˜³é‡‘å± |
| 9 | é«˜æ¸© | é«˜é‡‘å± | çƒ­æ˜Ÿ + å¯Œé‡‘å± |

## 2.3 æ¨¡å‹ä¸ç®—æ³•

### å…¨å±€ Ridge (Baseline)

$$
\hat{y} = X w, \quad w = \arg\min_w \|y - Xw\|^2 + \alpha \|w\|^2
$$

åœ¨å…¨é‡æ•°æ®ä¸Šè®­ç»ƒï¼Œæ‰«æ $\alpha$ æ‰¾æœ€ä¼˜ã€‚

### åˆ†åŒº Ridge (MoE-1)

å¯¹äºæ¯ä¸ª bin $k \in \{1, ..., 9\}$ï¼š

$$
\hat{y}_k = X_k w_k, \quad w_k = \arg\min_{w_k} \|y_k - X_k w_k\|^2 + \alpha_k \|w_k\|^2
$$

- æ¯ä¸ª bin å•ç‹¬è®­ç»ƒ Ridge
- æ¯ä¸ª bin å•ç‹¬æ‰«æ $\alpha_k$ æ‰¾æœ€ä¼˜
- é¢„æµ‹æ—¶ï¼Œæ ¹æ®æ ·æœ¬çš„ $(T_{\text{eff}}, [\text{M/H}])$ é€‰æ‹©å¯¹åº” bin çš„æ¨¡å‹

### Gating æœºåˆ¶ï¼ˆç¡¬åˆ†é…ï¼‰

$$
\text{gate}(x) = k \quad \text{where } (T_{\text{eff}}(x), [\text{M/H}](x)) \in \text{Bin}_k
$$

è¿™æ˜¯æœ€ç®€å•çš„"ç¡¬ MoE"ï¼šæ¯ä¸ªæ ·æœ¬åªä½¿ç”¨ä¸€ä¸ªä¸“å®¶ã€‚

## 2.4 è¶…å‚æ•°é…ç½®

| å‚æ•° | èŒƒå›´/å€¼ | è¯´æ˜ |
|------|--------|------|
| $\alpha$ (å…¨å±€ Ridge) | $\{0.001, 0.01, 0.1, 1, 10, 100\}$ | æ‰«ææ‰¾æœ€ä¼˜ |
| $\alpha_k$ (æ¯ä¸ª bin) | $\{0.001, 0.01, 0.1, 1, 10, 100\}$ | æ¯ä¸ª bin ç‹¬ç«‹æ‰«æ |
| æœ€å° bin æ ·æœ¬æ•° | 100 | ä½äºæ­¤å€¼è€ƒè™‘åˆå¹¶ bin |

## 2.5 è¯„ä»·æŒ‡æ ‡

| æŒ‡æ ‡ | å…¬å¼ | ç”¨é€” |
|------|------|------|
| $R^2$ | $1 - \frac{\sum(y - \hat{y})^2}{\sum(y - \bar{y})^2}$ | ä¸»è¦è¯„ä»·æŒ‡æ ‡ |
| MAE | $\frac{1}{n}\sum\|y - \hat{y}\|$ | ç»å¯¹è¯¯å·®å‚è€ƒ |
| RMSE | $\sqrt{\frac{1}{n}\sum(y - \hat{y})^2}$ | ä¸ $R^2$ é…åˆ |
| $\Delta R^2$ | $R^2_{\text{MoE}} - R^2_{\text{global}}$ | **åˆ¤æ–­ MoE ä»·å€¼çš„æ ¸å¿ƒæŒ‡æ ‡** |

---

# 3. ğŸ“Š å®éªŒå›¾è¡¨

### å›¾ 1ï¼šæ¯ä¸ª Bin çš„æ ·æœ¬åˆ†å¸ƒ

![Bin Distribution](../img/moe1_bin_distribution.png)

**Figure 1. å‚æ•°ç©ºé—´åˆ† bin åŠæ ·æœ¬åˆ†å¸ƒ**

**å…³é”®è§‚å¯Ÿ**ï¼š
- æ‰€æœ‰ 9 ä¸ª bin çš„è®­ç»ƒæ ·æœ¬éƒ½åœ¨ 2000-4000 ä¹‹é—´ï¼Œåˆ†å¸ƒç›¸å¯¹å‡åŒ€
- æ•°æ®çš„ $[\text{M/H}]$ èŒƒå›´ [-2.5, 0.75] è¶…å‡º bin å®šä¹‰çš„ [-2, 0.5]ï¼Œå¯¼è‡´è¦†ç›–ç‡ 81.6%
- ä½æ¸©+é«˜é‡‘å±åŒºåŸŸ (Bin3) æ ·æœ¬è¾ƒå°‘ (2064 train)

---

### å›¾ 2ï¼šå„ Bin å±€éƒ¨ RÂ² vs å…¨å±€ Ridge RÂ²

![RÂ² Comparison](../img/moe1_r2_comparison.png)

**Figure 2. åˆ†åŒº Ridge å„ bin æ€§èƒ½å¯¹æ¯” (noise=0.2)**

**å…³é”®è§‚å¯Ÿ**ï¼š
- é«˜é‡‘å±ä¸°åº¦ bin (Bin3, 6, 9) å±€éƒ¨ RÂ² > 0.96ï¼Œè¿œè¶…å…¨å±€ baseline (0.834)
- ä½é‡‘å±ä¸°åº¦ bin (Bin4, 7) å±€éƒ¨ RÂ² < 0.80ï¼Œä½äºå…¨å±€ baseline
- MoE å…¨å±€ RÂ² = 0.9123ï¼Œæ¯”å…¨å±€ Ridge é«˜ 7.8 ä¸ªç™¾åˆ†ç‚¹

---

### å›¾ 3ï¼šåˆ†åŒº Ridge vs å…¨å±€ Ridge æ•£ç‚¹å›¾

![Prediction Scatter](../img/moe1_prediction_scatter.png)

**Figure 3. é¢„æµ‹ vs çœŸå®å€¼å¯¹æ¯” (noise=0.2)**

**å…³é”®è§‚å¯Ÿ**ï¼š
- å…¨å±€ Ridgeï¼šå­˜åœ¨æ˜æ˜¾çš„ heteroscedastic è¯¯å·®ï¼Œæç«¯å€¼é¢„æµ‹è¾ƒå·®
- MoE Ridgeï¼šæ•£ç‚¹æ›´ç´§å¯†ï¼Œå°¤å…¶åœ¨ log g âˆˆ [2, 4] åŒºé—´æ˜¾è‘—æ”¹å–„

---

# 4. ğŸ’¡ å…³é”®æ´è§

## 4.1 å®è§‚å±‚æ´è§

**MoE çš„ä»·å€¼ä¸å™ªå£°æ°´å¹³ç›¸å…³**ï¼š

| Noise | å…¨å±€ RÂ² | MoE RÂ² | Î”RÂ² | MoE ä»·å€¼ |
|-------|---------|--------|-----|----------|
| 0.0 | 0.9991 | 0.9997 | +0.0006 | âŒ æ—  |
| 0.1 | 0.9130 | 0.9604 | +0.0474 | âœ… æœ‰ |
| 0.2 | 0.8341 | 0.9123 | +0.0781 | âœ… æœ‰ |
| 0.5 | 0.6552 | 0.7341 | +0.0789 | âœ… æœ‰ |
| 1.0 | 0.4601 | 0.4436 | -0.0165 | âŒ æ—  |

**è§£é‡Š**ï¼š
1. **æ— å™ªå£°**ï¼šå…¨å±€ Ridge å·²æ¥è¿‘å®Œç¾ (RÂ²=0.999)ï¼ŒMoE æ— æå‡ç©ºé—´
2. **ä¸­å™ªå£° (0.1-0.5)**ï¼šMoE æ˜¾è‘—æå‡ï¼Œå› ä¸ºåˆ†åŒºå»ºæ¨¡èƒ½æ›´å¥½åœ°æ‹Ÿåˆå±€éƒ¨ç‰¹å¾
3. **é«˜å™ªå£° (1.0)**ï¼šä¿¡å™ªæ¯”å¤ªä½ï¼Œæ‰€æœ‰æ¨¡å‹éƒ½é€€åŒ–ï¼ŒMoE ç”šè‡³ç•¥å·®

## 4.2 æ¨¡å‹å±‚æ´è§

**æŒ‰é‡‘å±ä¸°åº¦åˆ’åˆ†çš„ä¸“å®¶æ•ˆæœå·®å¼‚æ˜¾è‘—**ï¼š

| $[\text{M/H}]$ åŒºé—´ | å¹³å‡ bin RÂ² | è¯´æ˜ |
|---------------------|-------------|------|
| é«˜é‡‘å± (0.0, 0.5] | **0.9761** | é‡‘å±çº¿ä¸°å¯Œï¼Œç‰¹å¾æ˜æ˜¾ |
| ä¸­é‡‘å± [-1, 0.0] | 0.9335 | é€‚ä¸­ |
| ä½é‡‘å± [-2, -1) | **0.8189** | é‡‘å±çº¿å¼±ï¼Œç‰¹å¾éš¾æå– |

**ç‰©ç†è§£é‡Š**ï¼š
- é«˜é‡‘å±ä¸°åº¦æ˜Ÿçš„å…‰è°±ä¸­é‡‘å±å¸æ”¶çº¿å¯†é›†ã€å¼ºåº¦å¤§ï¼ŒRidge å®¹æ˜“å­¦åˆ° log g ä¸è°±çº¿çš„å…³ç³»
- ä½é‡‘å±ä¸°åº¦æ˜Ÿé‡‘å±çº¿å¾ˆå¼±ï¼Œlog g ä¿¡æ¯ä¸»è¦åœ¨æ°¢çº¿å’Œè¿ç»­è°±ï¼Œéœ€è¦æ›´é«˜ SNR

## 4.3 å®éªŒå±‚ç»†èŠ‚æ´è§

**å„ bin æœ€ä¼˜ alpha å·®å¼‚**ï¼š

| Noise | å…¨å±€æœ€ä¼˜ Î± | Bin3 æœ€ä¼˜ Î± | Bin4 æœ€ä¼˜ Î± |
|-------|-----------|-------------|-------------|
| 0.2 | 10.0 | 0.1 | 1.0 |
| 0.5 | 100.0 | 1.0 | 10.0 |

- é«˜é‡‘å±ä¸°åº¦ bin éœ€è¦æ›´å°çš„æ­£åˆ™åŒ–ï¼ˆä¿¡å·å¼ºï¼Œä¸éœ€è¦è¿‡åº¦çº¦æŸï¼‰
- ä½é‡‘å±ä¸°åº¦ bin éœ€è¦æ›´å¼ºçš„æ­£åˆ™åŒ–ï¼ˆä¿¡å·å¼±ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆå™ªå£°ï¼‰

---

# 5. ğŸ“ ç»“è®º

## 5.1 æ ¸å¿ƒå‘ç°

**MoEï¼ˆåˆ†åŒºå»ºæ¨¡ï¼‰åœ¨ log g é¢„æµ‹ä¸­æœ‰æ˜¾è‘—ä»·å€¼ï¼Œå°¤å…¶åœ¨ä¸­ç­‰å™ªå£°æ°´å¹³ä¸‹ã€‚**

åœ¨ noise=0.2 çš„å®éªŒä¸­ï¼š
- å…¨å±€ Ridge RÂ² = 0.8341
- åˆ†åŒº Ridge RÂ² = 0.9123  
- **Î”RÂ² = +0.0781 >> 0.03 é˜ˆå€¼**

è¿™è¯´æ˜ **log g ä¸å…‰è°±çš„æ˜ å°„å…³ç³»åœ¨ $(T_{\text{eff}}, [\text{M/H}])$ ç©ºé—´ç¡®å®æ˜¯"åˆ†æ®µç®€å•"çš„**ï¼Œä¸åŒæ’æ˜Ÿç±»å‹éœ€è¦ä¸åŒçš„ä¸“å®¶æ¨¡å‹ã€‚

## 5.2 å…³é”®ç»“è®ºï¼ˆ2-4 æ¡ï¼‰

| # | ç»“è®º | è¯æ® |
|---|------|------|
| 1 | **MoE åœ¨ä¸­å™ªå£°ä¸‹æœ‰æ˜¾è‘—ä»·å€¼** | noise âˆˆ [0.1, 0.5] æ—¶ Î”RÂ² > 0.03 |
| 2 | **é«˜é‡‘å±ä¸°åº¦æ˜Ÿæ›´å®¹æ˜“é¢„æµ‹** | Bin3,6,9 çš„ RÂ² > 0.96ï¼Œè€Œ Bin4,7 < 0.80 |
| 3 | **MoE ä¸èƒ½æ•‘é«˜å™ªå£°åœºæ™¯** | noise=1.0 æ—¶ MoE ç”šè‡³ç•¥å·®äºå…¨å±€æ¨¡å‹ |
| 4 | **åˆ†åŒºæ¨¡å‹éœ€è¦ä¸åŒçš„æ­£åˆ™åŒ–å¼ºåº¦** | é«˜é‡‘å± bin ç”¨å° Î±ï¼Œä½é‡‘å± bin ç”¨å¤§ Î± |

## 5.3 è®¾è®¡å¯ç¤º

### æ¶æ„/æ–¹æ³•åŸåˆ™

| åŸåˆ™ | å»ºè®® | åŸå›  |
|------|------|------|
| MoE åˆ†ä¸“å®¶ | æŒ‰ $[\text{M/H}]$ åˆ†ä¸“å®¶æ¯”æŒ‰ $T_{\text{eff}}$ æ›´æœ‰æ•ˆ | é‡‘å±ä¸°åº¦å½±å“è°±çº¿å¼ºåº¦ï¼Œç›´æ¥å†³å®š log g ç‰¹å¾çš„å¯æå–æ€§ |
| æ­£åˆ™åŒ–ç­–ç•¥ | ä¸åŒä¸“å®¶ç”¨ä¸åŒ Î± | é«˜ SNR åŒºé—´å‡å°‘æ­£åˆ™åŒ–ï¼Œä½ SNR åŒºé—´å¢åŠ æ­£åˆ™åŒ– |
| é€‚ç”¨åœºæ™¯ | MoE é€‚åˆä¸­ç­‰å™ªå£°åœºæ™¯ | æ— å™ªå£°æ—¶å•æ¨¡å‹è¶³å¤Ÿï¼Œé«˜å™ªå£°æ—¶ MoE ä¹Ÿæ•‘ä¸äº† |

## 5.4 ç‰©ç†è§£é‡Š

**ä¸ºä»€ä¹ˆ MoE æœ‰æ•ˆï¼Ÿ**

1. **é‡‘å±çº¿ä¸ log g çš„å…³ç³»**ï¼š
   - log g å½±å“æ’æ˜Ÿå¤§æ°”å‹å¼ºï¼Œè¿›è€Œå½±å“è°±çº¿åŠ å®½ï¼ˆå‹åŠ›å±•å®½ï¼‰
   - é«˜é‡‘å±ä¸°åº¦æ˜Ÿæœ‰æ›´å¤šé‡‘å±çº¿ï¼Œè¿™äº›è°±çº¿çš„å‹åŠ›å±•å®½æ•ˆåº”æ›´å®¹æ˜“è¢«æ£€æµ‹
   - ä½é‡‘å±ä¸°åº¦æ˜Ÿé‡‘å±çº¿å¾ˆå¼±ï¼Œä¸»è¦ä¾èµ– H çº¿å’Œè¿ç»­è°±ï¼Œä¿¡æ¯å«é‡è¾ƒä½

2. **åˆ†åŒºå»ºæ¨¡çš„ä¼˜åŠ¿**ï¼š
   - å…¨å±€æ¨¡å‹éœ€è¦åŒæ—¶å­¦ä¹ æ‰€æœ‰æ’æ˜Ÿç±»å‹çš„ç‰¹å¾ï¼Œå®¹æ˜“"æŠ˜ä¸­"
   - åˆ†åŒºæ¨¡å‹åªéœ€å­¦ä¹ å±€éƒ¨ç‰¹å¾ï¼Œå¯ä»¥æ›´ç²¾å‡†åœ°æ•æ‰å±€éƒ¨ log g-å…‰è°±å…³ç³»

## 5.5 å…³é”®æ•°å­—é€ŸæŸ¥

| æŒ‡æ ‡ | å€¼ | é…ç½®/æ¡ä»¶ |
|------|-----|----------|
| å…¨å±€ Ridge $R^2$ | **0.8341** | noise=0.2 |
| åˆ†åŒº Ridge $R^2$ | **0.9123** | noise=0.2 |
| $\Delta R^2$ | **+0.0781** | **âœ… MoE æœ‰ä»·å€¼** |
| æœ€ä¼˜ bin | Bin3 (ä½æ¸©+é«˜é‡‘å±) | RÂ²=0.9803, noise=0.2 |
| æœ€å·® bin | Bin4 (ä¸­æ¸©+ä½é‡‘å±) | RÂ²=0.7726, noise=0.2 |
| è¦†ç›–ç‡ | 81.6% | éƒ¨åˆ†æ ·æœ¬è¶…å‡º bin è¾¹ç•Œ |

## 5.6 ä¸‹ä¸€æ­¥å·¥ä½œ

| æ–¹å‘ | å…·ä½“ä»»åŠ¡ | ä¼˜å…ˆçº§ | å¯¹åº” MVP |
|------|----------|--------|---------|
| âœ… MoE-2 | æŒ‰ SNR/noise level åˆ†ä¸“å®¶ï¼ŒéªŒè¯ noise-conditioned MoE | ğŸ”´ é«˜ | MVP-2.0 |
| æ‰©å¤§ bin è¾¹ç•Œ | å°† $[\text{M/H}]$ è¾¹ç•Œæ‰©å±•åˆ° [-2.5, 0.75] ä»¥è¦†ç›–å…¨éƒ¨æ ·æœ¬ | ğŸŸ¡ ä¸­ | - |
| Soft Gating | å°è¯•è½¯åˆ†é…è€Œéç¡¬åˆ†é…ï¼Œå¤„ç†è¾¹ç•Œæ ·æœ¬ | ğŸŸ¡ ä¸­ | MVP-3.0 |
| NN-MoE | å¦‚æœ MoE-2 ä¹Ÿæœ‰æ”¶ç›Šï¼Œä¸Š NN-MoE | ğŸ”´ é«˜ | MVP-3.0 |

---

# 6. ğŸ“ é™„å½•

## 6.1 æ•°å€¼ç»“æœè¡¨

### å…¨å±€ Ridge ç»“æœ

| Noise | æœ€ä¼˜ $\alpha$ | $R^2$ | MAE | RMSE |
|-------|--------------|-------|-----|------|
| 0.0 | 0.001 | 0.9991 | 0.0246 | 0.0359 |
| 0.1 | 1.0 | 0.9130 | 0.2603 | 0.3468 |
| 0.2 | 10.0 | 0.8341 | 0.3689 | 0.4788 |
| 0.5 | 100.0 | 0.6552 | 0.5451 | 0.6904 |
| 1.0 | 100.0 | 0.4601 | 0.6918 | 0.8639 |

### åˆ† Bin æ ·æœ¬ç»Ÿè®¡

| Bin | $T_{\text{eff}}$ | $[\text{M/H}]$ | Train æ ·æœ¬ | Test æ ·æœ¬ |
|-----|------------------|----------------|-----------|----------|
| 1 | [3750, 4500) | [-2, -1) | 2,910 | 90 |
| 2 | [3750, 4500) | [-1, 0.0] | 2,872 | 76 |
| 3 | [3750, 4500) | (0.0, 0.5] | 2,064 | 59 |
| 4 | [4500, 5250) | [-2, -1) | 3,278 | 105 |
| 5 | [4500, 5250) | [-1, 0.0] | 3,224 | 83 |
| 6 | [4500, 5250) | (0.0, 0.5] | 2,308 | 65 |
| 7 | [5250, 6000] | [-2, -1) | 3,658 | 107 |
| 8 | [5250, 6000] | [-1, 0.0] | 3,769 | 129 |
| 9 | [5250, 6000] | (0.0, 0.5] | 2,526 | 102 |
| **Total** | - | - | **26,609** | **816** |

**æ³¨**ï¼šæ€»æ ·æœ¬ 32k/1kï¼Œè¦†ç›–ç‡ 83.2%/81.6%ï¼Œæœªè¦†ç›–æ ·æœ¬çš„ [M/H] è¶…å‡º [-2, 0.5] èŒƒå›´ã€‚

### å„ Bin Ridge ç»“æœ (noise=0.2)

| Bin | æœ€ä¼˜ $\alpha_k$ | å±€éƒ¨ $R^2$ | å±€éƒ¨ MAE | vs å…¨å±€ Ridge |
|-----|----------------|-----------|---------|--------------|
| 1 | 1.0 | 0.8971 | 0.299 | +0.063 |
| 2 | 1.0 | 0.9569 | 0.193 | +0.123 |
| 3 | 0.1 | **0.9803** | 0.118 | **+0.146** |
| 4 | 1.0 | **0.7726** | 0.424 | **-0.062** |
| 5 | 1.0 | 0.9159 | 0.240 | +0.082 |
| 6 | 1.0 | 0.9789 | 0.155 | +0.145 |
| 7 | 1.0 | **0.7869** | 0.359 | **-0.047** |
| 8 | 1.0 | 0.9277 | 0.243 | +0.094 |
| 9 | 1.0 | 0.9691 | 0.153 | +0.135 |

### åˆ†åŒº Ridge å…¨å±€ç»“æœ

| Noise | å…¨å±€ Ridge $R^2$ | åˆ†åŒº Ridge $R^2$ | $\Delta R^2$ | MoE åˆ¤æ–­ |
|-------|-----------------|-----------------|--------------|---------|
| 0.0 | 0.9991 | 0.9997 | +0.0006 | âŒ æ— ä»·å€¼ |
| 0.1 | 0.9130 | 0.9604 | +0.0474 | âœ… æœ‰ä»·å€¼ |
| **0.2** | **0.8341** | **0.9123** | **+0.0781** | **âœ… æœ‰ä»·å€¼** |
| 0.5 | 0.6552 | 0.7341 | +0.0789 | âœ… æœ‰ä»·å€¼ |
| 1.0 | 0.4601 | 0.4436 | -0.0165 | âŒ æ— ä»·å€¼ |

---

## 6.2 å®éªŒæ—¥å¿—

| æ—¶é—´ | äº‹ä»¶ | å¤„ç† |
|------|------|------|
| 2025-12-03 16:14 | åˆ›å»ºå®éªŒè„šæœ¬ `scripts/moe_piecewise_ridge.py` | ä½¿ç”¨ç°æœ‰ Ridge æ¥å£ |
| 2025-12-03 16:17 | å®éªŒå®Œæˆï¼Œ5 ä¸ª noise level Ã— 10 ä¸ªæ¨¡å‹ | ç»“æœä¿å­˜åˆ° `results/moe/piecewise_ridge/` |
| 2025-12-03 16:17 | å›¾è¡¨ç”Ÿæˆå¹¶åŒæ­¥åˆ°çŸ¥è¯†ä¸­å¿ƒ | `logg/moe/img/` |

---

## 6.3 ç›¸å…³æ–‡ä»¶

| ç±»å‹ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| ä¸»æ¡†æ¶ | `logg/moe/moe_main_20251203.md` | MoE ä¸»å®éªŒ |
| æœ¬æŠ¥å‘Š | `logg/moe/exp_moe_piecewise_ridge_20251203.md` | å½“å‰æ–‡ä»¶ |
| å®éªŒè„šæœ¬ | `~/VIT/scripts/moe_piecewise_ridge.py` | å®éªŒä»£ç  |
| ç»“æœ CSV | `~/VIT/results/moe/piecewise_ridge/results.csv` | åŸå§‹æ•°æ® |
| å›¾è¡¨ | `logg/moe/img/` | å®éªŒå›¾è¡¨ |

---

# 7. ğŸ› ï¸ å®ç°ç»†èŠ‚ï¼ˆä»£ç ä¸æ¶æ„ï¼‰

æœ¬ç« è¯¦ç»†æè¿°å®éªŒä»£ç çš„æ¶æ„è®¾è®¡ã€æ ¸å¿ƒæ•°æ®ç»“æ„å’Œå®Œæ•´ Pipelineã€‚

## 7.1 ä»£ç æ¶æ„æ€»è§ˆ

```
scripts/moe_piecewise_ridge.py
â”œâ”€â”€ Configuration Block (L46-81)
â”‚   â”œâ”€â”€ EXPERIMENT_ID, ALPHA_VALUES, NOISE_LEVELS
â”‚   â”œâ”€â”€ DATA_CONFIG (æ•°æ®è·¯å¾„å’Œé…ç½®)
â”‚   â””â”€â”€ TEFF_BINS, MH_BINS (bin è¾¹ç•Œå®šä¹‰)
â”‚
â”œâ”€â”€ Dataclasses (L87-122)
â”‚   â”œâ”€â”€ BinSpec       # Bin è§„æ ¼æè¿°
â”‚   â”œâ”€â”€ Metrics       # å›å½’æŒ‡æ ‡ (RÂ², MAE, RMSE)
â”‚   â””â”€â”€ BinResult     # å•ä¸ª bin çš„è®­ç»ƒç»“æœ
â”‚
â”œâ”€â”€ Utility Functions (L128-188)
â”‚   â”œâ”€â”€ to_numpy()       # Tensor â†’ NumPy è½¬æ¢
â”‚   â”œâ”€â”€ compute_metrics()# è®¡ç®—å›å½’æŒ‡æ ‡
â”‚   â”œâ”€â”€ create_bins()    # ç”Ÿæˆ 9 ä¸ª bin è§„æ ¼
â”‚   â”œâ”€â”€ get_bin_mask()   # è·å– bin å†…æ ·æœ¬çš„å¸ƒå°” mask
â”‚   â””â”€â”€ assign_bin()     # å°†å•ä¸ªæ ·æœ¬åˆ†é…åˆ° bin
â”‚
â”œâ”€â”€ Data Loading (L195-242)
â”‚   â””â”€â”€ load_data()      # åŠ è½½ train/test æ•°æ®åŠå‚æ•°
â”‚
â”œâ”€â”€ Training Functions (L249-351)
â”‚   â”œâ”€â”€ sweep_alpha()           # Î± å‚æ•°æ‰«æ
â”‚   â”œâ”€â”€ train_global_ridge()    # è®­ç»ƒå…¨å±€ Ridge
â”‚   â”œâ”€â”€ train_bin_ridge()       # è®­ç»ƒå•ä¸ª bin çš„ Ridge
â”‚   â””â”€â”€ compute_moe_global_r2() # è®¡ç®— MoE æ•´ä½“ RÂ²
â”‚
â”œâ”€â”€ Plotting Functions (L357-508)
â”‚   â”œâ”€â”€ plot_bin_distribution()     # å‚æ•°ç©ºé—´ bin åˆ†å¸ƒå›¾
â”‚   â”œâ”€â”€ plot_r2_comparison()        # RÂ² å¯¹æ¯”æŸ±çŠ¶å›¾
â”‚   â””â”€â”€ plot_prediction_scatter()   # é¢„æµ‹æ•£ç‚¹å›¾
â”‚
â””â”€â”€ Main (L515-665)
    â””â”€â”€ main()           # ä¸»å…¥å£ï¼Œæ‰§è¡Œå®Œæ•´å®éªŒæµç¨‹
```

## 7.2 æ ¸å¿ƒæ•°æ®ç»“æ„

### 7.2.1 BinSpecï¼ˆBin è§„æ ¼ï¼‰

```python
@dataclass
class BinSpec:
    """Bin specification"""
    bin_id: int          # Bin ç¼–å· (1-9)
    teff_low: float      # T_eff ä¸‹ç•Œ
    teff_high: float     # T_eff ä¸Šç•Œ
    mh_low: float        # [M/H] ä¸‹ç•Œ
    mh_high: float       # [M/H] ä¸Šç•Œ
    
    @property
    def name(self) -> str:
        return f"Bin{self.bin_id}"
    
    @property
    def description(self) -> str:
        return f"T=[{self.teff_low},{self.teff_high}), M/H=[{self.mh_low},{self.mh_high})"
```

**è®¾è®¡ç†ç”±**ï¼šä½¿ç”¨ dataclass å°è£… bin çš„è¾¹ç•Œä¿¡æ¯ï¼Œä¾¿äºä¼ é€’å’Œæ‰“å°ã€‚

### 7.2.2 Metricsï¼ˆè¯„ä¼°æŒ‡æ ‡ï¼‰

```python
@dataclass
class Metrics:
    """Regression metrics"""
    r2: float    # RÂ² å†³å®šç³»æ•°
    mae: float   # Mean Absolute Error
    rmse: float  # Root Mean Squared Error
```

### 7.2.3 BinResultï¼ˆå• Bin è®­ç»ƒç»“æœï¼‰

```python
@dataclass 
class BinResult:
    """Result for a single bin"""
    bin_spec: BinSpec       # å¯¹åº”çš„ bin è§„æ ¼
    n_train: int            # è®­ç»ƒæ ·æœ¬æ•°
    n_test: int             # æµ‹è¯•æ ·æœ¬æ•°
    best_alpha: float       # æœ€ä¼˜æ­£åˆ™åŒ–å‚æ•°
    metrics: Metrics        # è¯„ä¼°æŒ‡æ ‡
    model: Ridge            # è®­ç»ƒå¥½çš„ Ridge æ¨¡å‹
```

## 7.3 Pipeline æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MoE Piecewise Ridge Pipeline                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[1] æ•°æ®åŠ è½½
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  load_data()                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ BaseSpec    â”‚    â”‚ flux        â”‚    â”‚ teff, mh    â”‚                  â”‚
â”‚  â”‚ Dataset     â”‚â”€â”€â”€â–¶â”‚ logg        â”‚ +  â”‚ (for bin)   â”‚                  â”‚
â”‚  â”‚ (train/test)â”‚    â”‚ error       â”‚    â”‚             â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
[2] åˆ›å»º Bin è§„æ ¼
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  create_bins() â†’ List[BinSpec]                                          â”‚
â”‚                                                                          â”‚
â”‚  TEFF_BINS Ã— MH_BINS = 3Ã—3 = 9 bins                                     â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ Bin1   â”‚ Bin2   â”‚ Bin3   â”‚  T_eff: [3750, 4500)                      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                           â”‚
â”‚  â”‚ Bin4   â”‚ Bin5   â”‚ Bin6   â”‚  T_eff: [4500, 5250)                      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                           â”‚
â”‚  â”‚ Bin7   â”‚ Bin8   â”‚ Bin9   â”‚  T_eff: [5250, 6000]                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚    [M/H]:   [-2,-1)  [-1,0]  (0,0.5]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
[3] éå†å™ªå£°çº§åˆ«
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  for noise_level in [0.0, 0.1, 0.2, 0.5, 1.0]:                          â”‚
â”‚                                                                          â”‚
â”‚      [3.1] æ·»åŠ å™ªå£°                                                       â”‚
â”‚      X_noisy = flux + N(0, errorÂ² Ã— noise_levelÂ²)                        â”‚
â”‚                                                                          â”‚
â”‚      [3.2] è®­ç»ƒå…¨å±€ Ridge                                                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚      â”‚  train_global_ridge()                                        â”‚    â”‚
â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚      â”‚  â”‚ sweep_alpha():                                          â”‚ â”‚    â”‚
â”‚      â”‚  â”‚   for Î± in [0.001, 0.01, 0.1, 1, 10, 100]:             â”‚ â”‚    â”‚
â”‚      â”‚  â”‚       model = Ridge(Î±).fit(X_train, y_train)           â”‚ â”‚    â”‚
â”‚      â”‚  â”‚       r2 = r2_score(y_test, model.predict(X_test))     â”‚ â”‚    â”‚
â”‚      â”‚  â”‚   return best_Î±, best_metrics, best_model               â”‚ â”‚    â”‚
â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚      [3.3] è®­ç»ƒ Bin-specific Ridge                                       â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚      â”‚  for bin_spec in bins:                                       â”‚    â”‚
â”‚      â”‚      train_bin_ridge(data, bin_spec, noise_level)            â”‚    â”‚
â”‚      â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚      â”‚      â”‚ 1. get_bin_mask() â†’ train_mask, test_mask        â”‚   â”‚    â”‚
â”‚      â”‚      â”‚ 2. æ£€æŸ¥æ ·æœ¬æ•° â‰¥ MIN_BIN_SAMPLES (100)            â”‚   â”‚    â”‚
â”‚      â”‚      â”‚ 3. æå– bin å†…æ•°æ®                                â”‚   â”‚    â”‚
â”‚      â”‚      â”‚ 4. æ·»åŠ å™ªå£°                                       â”‚   â”‚    â”‚
â”‚      â”‚      â”‚ 5. sweep_alpha() â†’ BinResult                     â”‚   â”‚    â”‚
â”‚      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚      [3.4] è®¡ç®— MoE å…¨å±€ RÂ²                                              â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚      â”‚  compute_moe_global_r2()                                     â”‚    â”‚
â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚      â”‚  â”‚ for each test sample:                                 â”‚   â”‚    â”‚
â”‚      â”‚  â”‚     bin_id = assign_bin(teff, mh)                    â”‚   â”‚    â”‚
â”‚      â”‚  â”‚     y_pred[i] = bin_results[bin_id].model.predict()  â”‚   â”‚    â”‚
â”‚      â”‚  â”‚ return compute_metrics(y_test[covered], y_pred)       â”‚   â”‚    â”‚
â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚      [3.5] è®¡ç®— Î”RÂ² = MoE_RÂ² - Global_RÂ²                                â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
[4] ç»“æœè¾“å‡º
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å‡ºæ–‡ä»¶ï¼š                                                               â”‚
â”‚  â”œâ”€â”€ results/moe/piecewise_ridge/results.csv     # å®Œæ•´æ•°å€¼ç»“æœ          â”‚
â”‚  â”œâ”€â”€ figures/fig1_bin_distribution.png           # å‚æ•°ç©ºé—´åˆ†å¸ƒ          â”‚
â”‚  â”œâ”€â”€ figures/fig2_r2_comparison.png              # RÂ² å¯¹æ¯”              â”‚
â”‚  â””â”€â”€ figures/fig3_prediction_scatter.png         # é¢„æµ‹æ•£ç‚¹å›¾            â”‚
â”‚                                                                          â”‚
â”‚  åŒæ­¥åˆ°çŸ¥è¯†ä¸­å¿ƒï¼š                                                         â”‚
â”‚  â””â”€â”€ logg/moe/img/moe1_*.png                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 7.4 å…³é”®ä»£ç å®ç°

### 7.4.1 Bin Mask ç”Ÿæˆ

æ ¸å¿ƒå‡½æ•°ï¼šæ ¹æ®æ ·æœ¬çš„ $(T_{\text{eff}}, [\text{M/H}])$ ç”Ÿæˆå¸ƒå°” maskã€‚

```python
def get_bin_mask(teff: np.ndarray, mh: np.ndarray, bin_spec: BinSpec) -> np.ndarray:
    """Get boolean mask for samples in this bin."""
    # T_eff æ¡ä»¶ï¼šå·¦é—­å³å¼€ï¼Œæœ€åä¸€ä¸ª bin å³è¾¹ç•Œé—­åˆ
    teff_mask = (teff >= bin_spec.teff_low) & (teff < bin_spec.teff_high)
    if bin_spec.teff_high == TEFF_BINS[-1]:  # æœ€åä¸€ä¸ª bin
        teff_mask = (teff >= bin_spec.teff_low) & (teff <= bin_spec.teff_high)
    
    # [M/H] æ¡ä»¶ï¼šåŒç†
    mh_mask = (mh >= bin_spec.mh_low) & (mh < bin_spec.mh_high)
    if bin_spec.mh_high == MH_BINS[-1]:
        mh_mask = (mh >= bin_spec.mh_low) & (mh <= bin_spec.mh_high)
    
    return teff_mask & mh_mask  # é€»è¾‘ä¸
```

**è®¾è®¡è¦ç‚¹**ï¼š
- ä½¿ç”¨ NumPy å‘é‡åŒ–æ“ä½œï¼Œé«˜æ•ˆå¤„ç†å¤§è§„æ¨¡æ•°æ®
- ç‰¹æ®Šå¤„ç†è¾¹ç•Œæ¡ä»¶ï¼šæœ€åä¸€ä¸ª bin å³è¾¹ç•Œé—­åˆ `<=`

### 7.4.2 Alpha å‚æ•°æ‰«æ

```python
def sweep_alpha(X_train: np.ndarray, y_train: np.ndarray, 
                X_test: np.ndarray, y_test: np.ndarray,
                alphas: List[float] = ALPHA_VALUES) -> Tuple[float, Metrics, Ridge]:
    """Sweep alpha values and return best result."""
    best_r2 = -np.inf
    best_alpha = alphas[0]
    best_metrics = None
    best_model = None
    
    for alpha in alphas:
        model = Ridge(alpha=alpha)
        model.fit(X_train, y_train)
        y_pred = model.predict(X_test)
        metrics = compute_metrics(y_test, y_pred)
        
        if metrics.r2 > best_r2:  # ä»¥ RÂ² ä¸ºé€‰æ‹©æ ‡å‡†
            best_r2 = metrics.r2
            best_alpha = alpha
            best_metrics = metrics
            best_model = model
    
    return best_alpha, best_metrics, best_model
```

**è®¾è®¡è¦ç‚¹**ï¼š
- éå†é¢„å®šä¹‰çš„ Î± å€¼é›†åˆ `{0.001, 0.01, 0.1, 1, 10, 100}`
- ä»¥æµ‹è¯•é›† RÂ² ä¸ºé€‰æ‹©æ ‡å‡†ï¼ˆå®é™…ç”Ÿäº§ä¸­åº”ä½¿ç”¨éªŒè¯é›†ï¼‰
- è¿”å›æœ€ä¼˜ Î±ã€æŒ‡æ ‡å’Œè®­ç»ƒå¥½çš„æ¨¡å‹

### 7.4.3 å• Bin Ridge è®­ç»ƒ

```python
def train_bin_ridge(data: Dict, bin_spec: BinSpec, noise_level: float) -> Optional[BinResult]:
    """Train Ridge for a specific bin."""
    # [1] è·å– bin mask
    train_mask = get_bin_mask(data['teff_train'], data['mh_train'], bin_spec)
    test_mask = get_bin_mask(data['teff_test'], data['mh_test'], bin_spec)
    
    n_train = train_mask.sum()
    n_test = test_mask.sum()
    
    # [2] æ ·æœ¬æ•°æ£€æŸ¥
    if n_train < MIN_BIN_SAMPLES:  # MIN_BIN_SAMPLES = 100
        print(f"  âš ï¸ {bin_spec.name}: only {n_train} train samples, skipping")
        return None
    
    if n_test < 10:
        print(f"  âš ï¸ {bin_spec.name}: only {n_test} test samples, skipping")
        return None
    
    # [3] æå– bin å†…æ•°æ®
    X_train_bin = data['X_train'][train_mask]
    y_train_bin = data['y_train'][train_mask]
    error_train_bin = data['error_train'][train_mask]
    
    X_test_bin = data['X_test'][test_mask]
    y_test_bin = data['y_test'][test_mask]
    error_test_bin = data['error_test'][test_mask]
    
    # [4] æ·»åŠ å™ªå£° (ä½¿ç”¨ src.lnreg.add_noise)
    X_train_noisy = add_noise(X_train_bin, error_train_bin, noise_level, seed=42)
    X_test_noisy = add_noise(X_test_bin, error_test_bin, noise_level, seed=44)
    
    # [5] Î± æ‰«æè®­ç»ƒ
    best_alpha, metrics, model = sweep_alpha(X_train_noisy, y_train_bin, 
                                              X_test_noisy, y_test_bin)
    
    return BinResult(
        bin_spec=bin_spec,
        n_train=n_train,
        n_test=n_test,
        best_alpha=best_alpha,
        metrics=metrics,
        model=model
    )
```

**è®¾è®¡è¦ç‚¹**ï¼š
- å…ˆæ£€æŸ¥æ ·æœ¬æ•°ï¼Œé¿å…åœ¨å°æ ·æœ¬ bin ä¸Šè®­ç»ƒï¼ˆä¸ç¨³å®šï¼‰
- æ¯ä¸ª bin ç‹¬ç«‹æ·»åŠ å™ªå£°ï¼ˆä½¿ç”¨ç›¸åŒ seed ä¿è¯å¯å¤ç°ï¼‰
- æ¯ä¸ª bin ç‹¬ç«‹æ‰«ææœ€ä¼˜ Î±

### 7.4.4 MoE å…¨å±€é¢„æµ‹ä¸è¯„ä¼°

```python
def compute_moe_global_r2(data: Dict, bin_results: Dict[int, BinResult], 
                          bins: List[BinSpec], noise_level: float) -> Metrics:
    """Compute global RÂ² for MoE (piecewise) predictions."""
    X_test = add_noise(data['X_test'], data['error_test'], noise_level, seed=44)
    y_test = data['y_test']
    teff_test = data['teff_test']
    mh_test = data['mh_test']
    
    y_pred = np.zeros_like(y_test)
    covered = np.zeros(len(y_test), dtype=bool)  # è®°å½•å“ªäº›æ ·æœ¬è¢«è¦†ç›–
    
    # å¯¹æ¯ä¸ªæµ‹è¯•æ ·æœ¬ï¼Œåˆ†é…åˆ°å¯¹åº” bin å¹¶ä½¿ç”¨è¯¥ bin çš„æ¨¡å‹é¢„æµ‹
    for i in range(len(y_test)):
        bin_id = assign_bin(teff_test[i], mh_test[i], bins)
        if bin_id > 0 and bin_id in bin_results:
            result = bin_results[bin_id]
            y_pred[i] = result.model.predict(X_test[i:i+1])[0]
            covered[i] = True
    
    # åªå¯¹è¢«è¦†ç›–çš„æ ·æœ¬è®¡ç®—æŒ‡æ ‡
    coverage = covered.sum() / len(y_test)
    print(f"  Coverage: {covered.sum()}/{len(y_test)} ({coverage*100:.1f}%)")
    
    return compute_metrics(y_test[covered], y_pred[covered])
```

**è®¾è®¡è¦ç‚¹**ï¼š
- **ç¡¬åˆ†é… Gating**ï¼šæ¯ä¸ªæ ·æœ¬åªä½¿ç”¨ä¸€ä¸ªä¸“å®¶æ¨¡å‹
- **è¦†ç›–ç‡è¿½è¸ª**ï¼šè®°å½•æœ‰å¤šå°‘æ ·æœ¬è¢« bin è¦†ç›–ï¼ˆè¶…å‡º bin è¾¹ç•Œçš„æ ·æœ¬ä¸å‚ä¸è¯„ä¼°ï¼‰
- **å•æ ·æœ¬é¢„æµ‹**ï¼š`X_test[i:i+1]` ä¿æŒ 2D shape ä»¥å…¼å®¹ sklearn æ¥å£

### 7.4.5 æ•°æ®åŠ è½½

```python
def load_data():
    """Load train and test data with parameters (teff, mh) for binning."""
    from src.dataloader.base import BaseSpecDataset
    
    cfg = {
        'data': DATA_CONFIG,
        'noise': {'noise_level': 0.0},
        'output_dir': str(OUTPUT_DIR)
    }
    
    # è®­ç»ƒæ•°æ®
    train_ds = BaseSpecDataset.from_config(cfg)
    train_ds.load_data(stage='train')
    train_ds.load_params(stage='train')  # åŠ è½½ teff, mh, logg ç­‰å‚æ•°
    
    # æµ‹è¯•æ•°æ®
    test_ds = BaseSpecDataset.from_config(cfg)
    test_ds.load_data(stage='test')
    test_ds.load_params(stage='test')
    
    # è½¬æ¢ä¸º NumPy å¹¶è¿”å›
    return {
        'X_train': to_numpy(train_ds.flux),
        'y_train': to_numpy(train_ds.logg),
        'teff_train': to_numpy(train_ds.teff),
        'mh_train': to_numpy(train_ds.mh),
        'error_train': to_numpy(train_ds.error),
        'X_test': to_numpy(test_ds.flux),
        'y_test': to_numpy(test_ds.logg),
        'teff_test': to_numpy(test_ds.teff),
        'mh_test': to_numpy(test_ds.mh),
        'error_test': to_numpy(test_ds.error)
    }
```

**è®¾è®¡è¦ç‚¹**ï¼š
- ä½¿ç”¨é¡¹ç›®ç»Ÿä¸€çš„ `BaseSpecDataset` æ•°æ®åŠ è½½å™¨
- `load_params()` åŠ è½½æ‰€æœ‰æ’æ˜Ÿå‚æ•°ï¼ˆteff, mh, loggï¼‰ï¼Œä¸ä»…é™äºç›®æ ‡æ ‡ç­¾
- å™ªå£°åœ¨æ•°æ®åŠ è½½é˜¶æ®µè®¾ä¸º 0ï¼Œåœ¨è®­ç»ƒæ—¶åŠ¨æ€æ·»åŠ 

## 7.5 å™ªå£°æ¨¡å‹

å™ªå£°é€šè¿‡ `src.lnreg.add_noise` å‡½æ•°æ·»åŠ ï¼š

```python
# å™ªå£°æ¨¡å‹
noisy_flux = flux + error * noise_level * N(0, 1)
```

å…¶ä¸­ï¼š
- `flux`: åŸå§‹å…‰è°± (shape: [N, 4096])
- `error`: æ¯ä¸ªæ³¢æ®µçš„è¯¯å·®ä¼°è®¡ (shape: [N, 4096])
- `noise_level`: å™ªå£°æ”¾å¤§å› å­ {0.0, 0.1, 0.2, 0.5, 1.0}

è¿™æ¨¡æ‹Ÿäº†è§‚æµ‹å™ªå£°éšæ³¢æ®µå˜åŒ–çš„çœŸå®æƒ…å†µï¼ˆerror-weighted noiseï¼‰ã€‚

## 7.6 ä¾èµ–å…³ç³»

```
moe_piecewise_ridge.py
â”œâ”€â”€ numpy, pandas, torch      # æ•°æ®å¤„ç†
â”œâ”€â”€ sklearn.linear_model.Ridge # Ridge å›å½’
â”œâ”€â”€ sklearn.metrics            # RÂ², MAE, RMSE
â”œâ”€â”€ matplotlib                 # ç»‘å›¾
â””â”€â”€ src/
    â”œâ”€â”€ lnreg.add_noise        # å™ªå£°æ·»åŠ å‡½æ•°
    â””â”€â”€ dataloader/base.BaseSpecDataset  # æ•°æ®åŠ è½½
```

## 7.7 è¿è¡Œæ–¹å¼

```bash
cd /home/swei20/VIT
source init.sh  # æ¿€æ´»ç¯å¢ƒ
python scripts/moe_piecewise_ridge.py
```

**è¾“å‡º**ï¼š
- `results/moe/piecewise_ridge/results.csv` - å®Œæ•´æ•°å€¼ç»“æœ
- `results/moe/piecewise_ridge/figures/` - æœ¬åœ°å›¾è¡¨
- `logg/moe/img/` - åŒæ­¥åˆ°çŸ¥è¯†ä¸­å¿ƒçš„å›¾è¡¨

**é¢„è®¡è¿è¡Œæ—¶é—´**ï¼š~2 åˆ†é’Ÿï¼ˆ32k train, 1k test, 5 noise levels Ã— 10 modelsï¼‰

---

# 8. ğŸ“‹ ä»£ç æ¸…å•

ä»¥ä¸‹æ˜¯å®Œæ•´å®éªŒè„šæœ¬çš„æ ¸å¿ƒç»“æ„ï¼š

| è¡Œå· | å†…å®¹ | è¯´æ˜ |
|------|------|------|
| 1-22 | Docstring | å®éªŒ IDã€ç”¨æ³•ã€è¾“å‡ºè·¯å¾„ |
| 24-44 | Imports | ä¾èµ–åº“å¯¼å…¥ |
| 46-81 | Configuration | å®éªŒé…ç½®å‚æ•° |
| 87-122 | Dataclasses | BinSpec, Metrics, BinResult |
| 128-188 | Utilities | å·¥å…·å‡½æ•° |
| 195-242 | Data Loading | æ•°æ®åŠ è½½ |
| 249-351 | Training | è®­ç»ƒå‡½æ•° |
| 357-508 | Plotting | ç»‘å›¾å‡½æ•° |
| 515-665 | Main | ä¸»æµç¨‹ |

**å®Œæ•´ä»£ç **ï¼š`~/VIT/scripts/moe_piecewise_ridge.py` (671 è¡Œ)

---

## ğŸ”— Cross-Repo Metadata

| Field | Value |
|-------|-------|
| **experiment_id** | `VIT-20251203-moe-piecewise-01` |
| **project** | `VIT` |
| **topic** | `moe` |
| **source_repo_path** | `~/VIT/` |
| **config_path** | `scripts/moe_piecewise_ridge.py` |
| **output_path** | `results/moe/piecewise_ridge/` |

---

> **ç»“è®ºç¡®è®¤**ï¼š
> 
> âœ… **MoE æœ‰ä»·å€¼**ï¼ˆnoise=0.2 æ—¶ Î”RÂ² = +0.0781 â‰¥ 0.03ï¼‰
> 
> **ä¸‹ä¸€æ­¥**ï¼šæ‰§è¡Œ MoE-2ï¼ˆæŒ‰ SNR åˆ†ä¸“å®¶ï¼‰å’Œå‡†å¤‡ NN-MoE


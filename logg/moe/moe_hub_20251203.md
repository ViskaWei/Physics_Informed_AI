# 🧠 MoE 智库导航（Hub）

---
> **主题名称：** Mixture of Experts（MoE）要不要上？什么时候有用？  
> **作者：** Viska Wei  
> **创建日期：** 2025-12-03  
> **最后更新：** 2025-12-04  
> **状态：** 🟢 **Phase 8 完成！门控落地问题已解决**  
> **当前焦点：** 推荐进入 Phase 6 NN-MoE 集成

---

## 🔗 相关文件

| 类型 | 文件 | 说明 |
|------|------|------|
| 📍 Roadmap | [`moe_roadmap.md`](./moe_roadmap_20251203.md) | 实验追踪与执行 |
| 📗 子实验 | `exp_moe_*.md` | 单实验详情 |
| 📇 知识卡片 | `card_*.md` | 浓缩结论 |

---

# 📑 目录

- [1. 🌲 核心问题树](#1--核心问题树)
- [2. 🔺 假设金字塔](#2--假设金字塔)
- [3. 💡 洞见汇合站](#3--洞见汇合站)
- [4. 🧭 战略导航](#4--战略导航)
- [5. 📐 设计原则库](#5--设计原则库)
- [6. 📎 附录](#6--附录)

---

# 1. 🌲 核心问题树

## 1.1 顶层问题

> **MoE（Mixture of Experts）在恒星参数预测任务中能否提升性能？什么条件下有用？**

据此推断：

> **如果 MoE 有用，应该在模型架构中引入多专家设计；如果没用，则应聚焦于单模型优化。**

## 1.2 问题分解

```
🎯 顶层问题: MoE 在 log g 预测中能否提升性能？
│
├── Q1: 按物理参数分专家有用吗？
│   ├── Q1.1: 按 (Teff, [M/H]) 分 bin 能提升多少？ → ✅ ΔR²=+0.050 [MVP-1.1]
│   ├── Q1.2: [M/H] vs Teff 谁贡献更大？ → ✅ [M/H] 68.7% [MVP-1.1]
│   └── Q1.3: 分位数分桶比手工边界好吗？ → ❌ K≥3 负增益 [MVP-3.0]
│
├── Q2: 按噪声水平分专家有用吗？
│   ├── Q2.1: Noise-matched expert 提升多少？ → ✅ ΔR²=+0.080 [MVP-2.0]
│   └── Q2.2: 离散分档稳定吗？ → ⚠️ noise=0.5 翻车 [MVP-2.0]
│
├── Q3: MoE 能落地吗？（核心风险）
│   ├── Q3.1: Pseudo gating 能保住多少 Oracle 增益？ → ❌ 仅 7.3% [MVP-3.1]
│   ├── Q3.2: 条件线性能替代 MoE 吗？ → ✅ 达到 80% [MVP-3.2]
│   └── Q3.3: 门控误差是瓶颈吗？ → 🔄 MVP-7.1 验证中
│
├── Q4: 为什么某些区域效果好/差？
│   ├── Q4.1: 高 [M/H] 为什么更容易？ → ✅ 金属线特征丰富 [MVP-5.0]
│   └── Q4.2: 低 [M/H] 需要什么？ → ⏳ 待验证
│
└── Q5: 🟢 如何用物理特征做可落地 Gate？（Phase 8 ✅ 已解决！）
    ├── Q5.1: 少量物理窗特征能否区分专家域？ → ✅ **是！82% 准确率，ρ=1.00** [MVP-PG1]
    ├── Q5.2: Soft gating 是否比 hard gating 更抗噪？ → ✅ **Soft ρ=1.00 >> Hard ρ=0.72** [MVP-PG1]
    ├── Q5.3: Teff 信息必须进入 Gate 吗？ → ⚠️ 有帮助(+11%)但非必需 [MVP-PG1]
    └── Q5.4: 窗口形状 PCA 是否必要？ → ❌ 不需要（当前 ρ≈1.00 已足够）
│
├── Q6: 🔴 如何把 3 专家扩展到 9 专家？（Phase 9 新增）
│   ├── Q6.1: 物理窗 gate 能否区分 9 类 (Teff×[M/H])？ → ⏳ [MVP-9E1]
│   ├── Q6.2: Soft routing 在 9 专家下是否仍能保住 ≥85% 增益？ → ⏳ [MVP-9E1]
│   └── Q6.3: R² 能否从 0.87 → 0.90+？ → ⏳ [MVP-9E1]
│
└── Q7: ⚠️ 专家表达能力是否是新瓶颈？（Phase 10 ✅ 完成）
    ├── Q7.1: NN expert 是否比 Ridge expert 更强？ → ❌ **NN R²=0.38 << Ridge R²=0.87** [MVP-NN1]
    ├── Q7.2: 困难子域 (Bin4/Bin7 低 [M/H]) 能否被 NN 改善？ → ✅ **三个子域均改善** [MVP-NN1]
    └── Q7.3: 固定 gate + NN expert 的增益来自哪里？ → ✅ **来自 Soft routing 平滑** [MVP-NN1]
│
└── Q8: 🟢 如何进一步优化 9 专家 MoE？（Phase 11 进行中）
    ├── Q8.1: 分类最优的 gate 权重是否也是回归最优？ → ✅ **否！MLP回归gate提升R²从0.9213→0.9310** [MVP-Next-A]
    ├── Q8.2: Out-of-range 样本如何处理才能保持高 R²？ → ⏳ [MVP-Next-B]
    └── Q8.3: 最弱 bins (Bin3/Bin6) 是否存在系统性偏差？ → ⏳ [MVP-Next-C]

状态图例:
✅ 已验证 | ❌ 已否定 | ⚠️ 部分验证 | 🔄 进行中 | ⏳ 待验证
```

## 1.3 问题边界

| ✅ 本研究关注 | ❌ 本研究不关注 |
|-------------|---------------|
| MoE 在 log g 预测的收益 | 其他恒星参数 (Teff, [M/H]) 的预测 |
| 线性模型（Ridge）作为 baseline | 复杂 NN-MoE（仅当线性验证通过才做） |
| 可落地的门控方案 | 依赖 Oracle 信息的理想方案 |
| (Teff, [M/H], SNR) 三个条件维度 | 其他可能的条件变量 |

**定位声明**：
> **本实验系列是「可行性探索」，目的是用低成本线性实验验证 MoE 的潜力，而非直接上复杂 NN-MoE。结论应理解为「MoE 是否值得投入更多资源」的初步判断。**

---

# 2. 🔺 假设金字塔

## 2.1 L1 宏观假设（战略层）

| # | 宏观假设 | 验证状态 | 如果成立 | 如果不成立 |
|---|---------|---------|---------|-----------|
| **H1** | $\log g$ 与光谱的映射在 $(T_{\text{eff}}, [\text{M/H}])$ 空间是"分段简单"的 | ✅ 验证通过 | 上 MoE，按物理参数分专家 | 放弃 MoE，优化单模型 |
| **H2** | 可落地的门控方案能保住大部分 Oracle 增益 | ⚠️ 风险点 | 继续优化门控 | 转向连续条件化 |

## 2.2 L2 中观假设（战术层）

| # | 中观假设 | 上层假设 | 验证状态 | 关键实验 |
|---|---------|---------|---------|---------|
| **H1.1** | 按 $(T_{\text{eff}}, [\text{M/H}])$ 分 bin 能显著提升性能 | H1 | ✅ ΔR²=+0.050 | MVP-1.1 |
| **H1.2** | [M/H] 是 MoE 主要贡献者 | H1 | ✅ 贡献 68.7% | MVP-1.1 消融 |
| **H1.3** | 按 SNR/noise level 分专家有价值 | H1 | ✅ ΔR²=+0.080 | MVP-2.0 |
| **H2.1** | 分位数分桶能简化手工边界 | H2 | ❌ K≥3 负增益 | MVP-3.0 |
| **H2.2** | Pseudo gating 能保住 ≥70% Oracle 增益 | H2 | ❌ 仅 7.3% | MVP-3.1 |
| **H2.3** | 条件线性能接近 MoE 效果 | H2 | ✅ 达到 80% | MVP-3.2 |

## 2.3 L3 微观假设（可验证层）

| # | 可验证假设 | 上层 | 验证标准 | 结果 | 来源 |
|---|-----------|------|---------|------|------|
| **H1.1.1** | 分区 Ridge 全局 R² vs 全局 Ridge R² 差 ≥0.03 | H1.1 | ΔR² ≥ 0.03 | ✅ +0.050 | MVP-1.1 |
| **H1.1.2** | 高金属丰度 bin R² > 全局 Ridge | H1.1 | 局部 R² > 0.85 | ✅ 0.97-0.98 | MVP-1.0 |
| **H1.2.1** | [M/H]-only 3 专家能获得 ≥60% 收益 | H1.2 | 贡献 ≥ 60% | ✅ 68.7% | MVP-1.1 |
| **H1.3.1** | Noise-matched expert 优于 mixed | H1.3 | ΔR² > 0 | ✅ +0.080 avg | MVP-2.0 |
| **H2.1.1** | 存在最佳 K∈[3,5] | H2.1 | K=X 最优 | ❌ K=2 唯一正增益 | MVP-3.0 |
| **H2.2.1** | Pseudo ≥ 70% Oracle | H2.2 | 比例 ≥ 70% | ❌ 仅 7.3% | MVP-3.1 |
| **H2.3.1** | 1st order Conditional R² ≥ 0.90 | H2.3 | R² ≥ 0.90 | ✅ 0.9018 | MVP-3.2 |

### 🟢 物理窗 Gate 假设（Phase 8 ✅ 完成！）

| # | 可验证假设 | 上层 | 验证标准 | 结果 | 来源 |
|---|-----------|------|---------|------|------|
| **H-PG1** | 少数物理窗特征足以区分专家域 | H2 | 分类准确率 >70% 或 **ρ ≥ 0.5** | ✅ **Acc=82%, ρ=1.00** | MVP-PG1 |
| **H-PG2** | Soft gating 比 hard gating 更抗噪 | H2 | soft R² ≥ hard R²，波动更小 | ✅ **Soft ρ=1.00 >> Hard ρ=0.72** | MVP-PG1 |
| **H-PG3** | Teff 信息必须进入 gate（显式或隐式） | H2 | 加 Teff proxy 后 ρ 显著上升 | ⚠️ 有帮助+11%但非必需 | MVP-PG1 |
| **H-PG4** | 窗口形状 PCA 只在标量不够时才必要 | H2 | 先用 depth/EW 验证，再看 PCA 增量 | ❌ 不需要（ρ≈1.00） | MVP-PG1 |

### 🔴 9 专家扩展假设（Phase 9 新增）

| # | 可验证假设 | 上层 | 验证标准 | 结果 | 来源 |
|---|-----------|------|---------|------|------|
| **H-9E1** | 物理窗特征能区分 9 类 (Teff×[M/H]) | H1 | 9-class gate 准确率 >60% 或 **ρ ≥ 0.85** | ⏳ | MVP-9E1 |
| **H-9E2** | Soft routing 在 9 专家下仍能保住大部分增益 | H2 | ρ ≥ 0.85（保住 85% oracle 增益） | ⏳ | MVP-9E1 |
| **H-9E3** | 9 专家能把可落地 R² 从 0.87 推到 ≥0.90 | H1 | R²_phys-gate(9) ≥ 0.90 | ⏳ | MVP-9E1 |

### 🔴 NN Expert 假设（Phase 10 ✅ 完成）

| # | 可验证假设 | 上层 | 验证标准 | 结果 | 来源 |
|---|-----------|------|---------|------|------|
| **H-NN1** | NN expert 比 Ridge expert 更强 | H1 | MoE(NN) - MoE(Ridge) ≥ 0.02 R² | ❌ **NN R²=0.38 << Ridge R²=0.87** | MVP-NN1 |
| **H-NN2** | 增益主要来自困难子域 (Bin4/Bin7 低 [M/H]) | H1 | 困难子域 ΔR² > 平均 ΔR² | ✅ **三个子域均改善，High [M/H] 最多** | MVP-NN1 |
| **H-NN3** | 固定 gate + NN expert 仍能保住 soft routing 优势 | H2 | ρ_NN ≥ ρ_Ridge ≈ 1.0 | ✅ **Soft R²≈Oracle R²，但基线太弱** | MVP-NN1 |

### 🔴 回归最优 Gate & 校准假设（Phase 11 🆕 立项中）

| # | 可验证假设 | 上层 | 验证标准 | 结果 | 来源 |
|---|-----------|------|---------|------|------|
| **H-A** | 分类最优 gate 权重 ≠ 回归最优权重；用 MSE 损失训练 gate 能进一步提升 R² | H2 | R²_regress-gate > R²_classify-gate (0.9213) + 0.003 | ⏳ | MVP-Next-A |
| **H-B** | Out-of-range 样本纳入后，整体 R² 仍维持高水平 | H1 | full-1000 R² > global R² + 0.05 | ⏳ | MVP-Next-B |
| **H-C** | 最弱 bins (Bin3/Bin6) 误差主要是系统性 bias，affine 校准能改善 | H1 | Bin3/Bin6 的 R² 提升 ≥ 0.02 | ⏳ | MVP-Next-C |

> **核心验证指标 ρ 定义**：
> $$\rho = \frac{R^2_{\text{phys-gate}} - R^2_{\text{global}}}{R^2_{\text{oracle}} - R^2_{\text{global}}}$$
> - **最低可用**：$\rho \ge 0.5$（保住 50% oracle 增益）
> - **很有戏**：$\rho \ge 0.7$
> - 🟢 **实际达成**：**$\rho = 1.00$**（Soft routing 保住 100% 增益！）

## 2.4 🟢 关键假设验证状态（更新于 2025-12-04）

> **Phase 8 重大突破：物理窗 Gate 问题已解决！**

| # | 关键假设 | 可检验子假设 | MVP | 状态 |
|---|---------|-------------|-----|------|
| **H-A** | ~~门控误差是否真的是瓶颈？~~ | 连续条件模型对 gate 噪声更耐受 | ~~MVP-7.1~~ | ❌ **不再需要**（H-PG 已解决） |
| **H-B** | ~~MoE 的"物理边界"可被学习到~~ | 存在可学习的 soft gating | ~~MVP-7.4~~ | ✅ **由 H-PG 证明** |
| **H-C** | 🟡 Noise 应连续条件化而非分档 | 连续 SNR 条件化能消除 noise=0.5 异常 | MVP-7.3 | ⏳ 可选 |
| **H-D** | 🟢 最难子域需要不同的特征/非线性 | bin4/bin7 需要更强特征提取 | MVP-7.4 | ⏳ 可选 |
| **H-PG** | 🟢 **物理窗特征能做准 gate** | 少量物理特征保住 ≥50% oracle 增益 | MVP-PG1 | ✅ **已验证！ρ=1.00** |

**假设关系图**（✅ 2025-12-04 更新）：
```
已证明: Oracle ΔR²=0.05 ✅，但 Pseudo 仅 7.3% ❌
  │
  ├─ 问题诊断: Gate 可落地性是瓶颈
  │
  └─ ✅ H-PG: 物理窗特征能做准 Gate！（Phase 8 已完成）
       │
       ├─ ✅ Step A: 固定专家（[M/H] 3专家），只测 Gate
       │   └─ ✅ H-PG1: Gate 准确率 82.10%，ρ=1.00
       │
       ├─ ✅ Step B: 物理窗特征设计
       │   └─ Ca II triplet (EW_8542 最重要) + Na + PCA1/2
       │
       ├─ ✅ Step C: Gate 模型
       │   └─ LogReg (L2, C=10) 足够！无需 NN gate
       │
       └─ ✅ Step D: 三种路由方式对比
           ├─ Hard: ρ=0.722（损失 28%）
           ├─ Soft: ρ=0.997（✅ 推荐！）
           └─ Soft + fallback: ρ=1.006（最佳但差异小）

🟢 关键发现: Soft routing 是成功的关键！
   → 解释了 pseudo gating 7.3% 失败的原因（用的是 hard routing）
   → 即使 82% 准确率，soft routing 也能保住 100% 增益
```

---

# 3. 💡 洞见汇合站

## 3.1 汇合点列表

| # | 汇合主题 | 单点来源 | 汇合结论 | 置信度 |
|---|---------|---------|---------|--------|
| C1 | MoE 效果稳健性 | MVP-1.0, MVP-1.1 | ΔR²=0.050 稳健，CI 完全 > 0.03 | 🟢 高 |
| C2 | [M/H] 是主导因素 | MVP-1.1 消融, MVP-5.0 | 68.7% 贡献，决定门控优先级 | 🟢 高 |
| C3 | 离散门控难落地 | MVP-3.0, MVP-3.1 | Quantile 失败 + Pseudo 7.3% | 🟢 高 |
| C4 | 连续条件化是出路 | MVP-3.2 | 已达 80% MoE 效果，无边界问题 | 🟡 中 |
| C5 | Noise 条件化有价值但不稳定 | MVP-2.0 | 平均 +0.080，但 noise=0.5 翻车 | 🟡 中 |
| **C6** | **🟢 物理窗 Gate 成功！** | MVP-PG1 | **Soft routing + 11 维特征 ρ=1.00** | 🟢 高 |
| **C7** | **⚠️ 全谱 MLP 不适合此任务** | MVP-NN1 | **NN R²=0.38 << Ridge R²=0.87** | 🟢 高 |
| **C8** | **🟢 回归 Gate 优于分类 Gate** | MVP-Next-A | **MLP回归gate R²=0.9310 (+0.0097)** | 🟢 高 |

## 3.2 汇合详情

### 汇合点 C1: MoE 效果稳健性

**单点发现汇总**：

| 来源实验 | 单点发现 | 关键数据 |
|---------|---------|---------|
| [MVP-1.0](./exp_moe_piecewise_ridge_20251203.md) | 分区 Ridge 显著优于全局 | ⚠️ 原 ΔR²=0.078 被高估 |
| [MVP-1.1](./exp_moe_rigorous_validation_20251203.md) | mask-aligned 公平比较 | **ΔR²=0.050, CI=[0.033,0.067]** |
| 大数据集验证 (100k/10k) | 规模扩大后一致 | ΔR²=0.0501, CI=[0.045,0.055] |

**汇合结论**：
> **MoE 按 (Teff, [M/H]) 分段的收益是真实且稳定的**。ΔR²=+0.050 在小数据集和大数据集上都复现，95% CI 完全 > 0.03 阈值。映射在参数空间确实"分段更简单"，MoE 值得继续投入。

**设计启示**：
- MoE 架构本身有价值，问题在门控如何落地
- 效果稳健意味着可以继续优化门控和专家设计

---

### 汇合点 C2: [M/H] 是 MoE 主导因素

**单点发现汇总**：

| 来源实验 | 单点发现 | 关键数据 |
|---------|---------|---------|
| [MVP-1.1 消融](./exp_moe_rigorous_validation_20251203.md) | [M/H] 贡献远超 Teff | [M/H] 68.7% vs Teff 42.9% |
| [MVP-5.0](./exp_moe_coefficient_analysis_20251203.md) | 高 [M/H] 信息更分散 | 高 [M/H] 能量分散 7-12%，低 [M/H] 集中 22-31% |
| [MVP-5.0](./exp_moe_coefficient_analysis_20251203.md) | Ca II triplet 重要性差异 | 高 [M/H] Ca II 重要性 1.65× |

**汇合结论**：
> **收益主要来自金属丰度相关的结构差异**。[M/H] 决定了谱线强度和可用特征分布，是 MoE 分专家的首选维度。3 个 [M/H] 专家可获得 69% 收益。

**设计启示**：
- 门控/条件模型应**优先对齐 [M/H]**
- Teff 是次要维度，可以简化处理
- 高 [M/H] 需要更广窗口/多区域聚合；低 [M/H] 需要窄窗口/高分辨特征

---

### 汇合点 C3: 离散门控难落地

**单点发现汇总**：

| 来源实验 | 单点发现 | 关键数据 |
|---------|---------|---------|
| [MVP-3.0](./exp_moe_quantile_bins_sweep_20251203.md) | 分位数分桶失败 | K=2 唯一正增益(+0.004)，K≥3 负增益 |
| [MVP-3.1](./exp_moe_quantile_bins_sweep_20251203.md) | Pseudo gating 几乎无用 | 仅保住 7.3% Oracle 增益 |

**汇合结论**：
> **硬 MoE 的"可落地门控"是最大风险点**。Quantile bins 表明有效边界是"物理阈值/结构转折点"，不是等频切分。Pseudo gating 7.3% 表明门控误差可能直接吃掉大部分收益。

**设计启示**：
- 放弃简单的分位数分桶
- 硬 MoE 需要更精准的门控，或者转向连续条件化
- 需要 MVP-7.1 验证门控噪声敏感性

---

### 汇合点 C4: 连续条件化是出路

**单点发现汇总**：

| 来源实验 | 单点发现 | 关键数据 |
|---------|---------|---------|
| [MVP-3.2](./exp_moe_conditional_ridge_20251203.md) | 1st order 条件线性接近 MoE | R²=0.9018，达 MoE 80% |

**汇合结论**：
> **Conditional Ridge 已证明 MoE 大头收益来自"系数随 [M/H] 连续变化"**。无需分桶边界、100% coverage、训练一次、不需要 gate。

**设计启示**：
- **连续条件模型可能是更工程化的主线**
- 可以避开门控误差问题
- 下一步：MVP-7.2 榨出剩余 20%

---

### 汇合点 C6: 🟢 物理窗 Gate 成功！（2025-12-04 重大突破）

**单点发现汇总**：

| 来源实验 | 单点发现 | 关键数据 |
|---------|---------|---------|
| [MVP-PG1](./exp_moe_phys_gate_baseline_20251204.md) | Soft routing 保住 100% 增益 | **ρ=1.00** (vs 最低标准 0.5) |
| [MVP-PG1](./exp_moe_phys_gate_baseline_20251204.md) | Gate 准确率 82% 足够 | 82.10%（混淆主要在边界） |
| [MVP-PG1](./exp_moe_phys_gate_baseline_20251204.md) | Ca II triplet 是核心特征 | EW_8542 贡献最大 |
| [MVP-PG1 消融](./exp_moe_phys_gate_baseline_20251204.md) | Teff proxy 有帮助但非必需 | 去掉后 ρ=0.887 仍高 |

**汇合结论**：
> 🟢 **MoE 门控落地问题已解决！** 11 维物理窗特征（Ca II depth/EW + Na + PCA1/2）+ LogReg gate + Soft routing 即可达到接近 oracle 的性能。**Soft routing 是成功的关键**，即使 gate 准确率只有 82%，soft 加权也能平滑边界误差。

**关键洞见**：
1. **Soft routing 解决了 pseudo gating 失败的谜团**：pseudo 7.3% 是因为用了 hard routing
2. **Gate 准确率不是瓶颈**：82% 准确率 + soft routing ≈ 100% 增益
3. **Ca II 8542 是最重要的单一特征**（与 MVP-5.0 系数分析一致）

**设计启示**：
- ✅ **MoE 路线可继续！** 不需要转向 Conditional 路线
- ✅ 用 Soft routing，不要用 Hard routing
- ✅ LogReg gate 已足够，无需 NN gate
- ✅ 可直接进入 Phase 6 NN-MoE 集成

---

### 汇合点 C7: ⚠️ 全谱 MLP 不适合此任务（2025-12-04）

**单点发现汇总**：

| 来源实验 | 单点发现 | 关键数据 |
|---------|---------|---------|
| [MVP-NN1](./exp_moe_nn_experts_20251204.md) | NN expert 远逊于 Ridge | R²_NN=0.38 << R²_Ridge=0.87 |
| [MVP-NN1](./exp_moe_nn_experts_20251204.md) | MoE 结构仍有价值 | ΔR² (MoE vs Global) = +0.257 |
| [MVP-NN1](./exp_moe_nn_experts_20251204.md) | Soft routing 继续有效 | R²_soft ≈ R²_oracle |
| [MVP-NN1](./exp_moe_nn_experts_20251204.md) | Expert 训练不均衡 | Low [M/H] expert 只训练 2 epochs |

**汇合结论**：
> ⚠️ **全谱 MLP (7,200 → 256 → 256 → 1) 在此任务上不如 Ridge。** 高维稀疏数据下，Ridge 的 L2 正则化更有效。MoE 结构本身有价值（ΔR²=+0.26），但 NN 架构是瓶颈。

**关键洞见**：
1. **Ridge 是强 baseline**：在当前特征维度下，简单正则化比复杂 NN 更有效
2. **全谱 MLP 架构问题**：~7,200 维直接压缩到 256 维太激进，丢失空间结构
3. **MoE 机制有效**：Soft routing 继续保住增益，问题在 expert 本身

**设计启示**：
- ❌ 不要直接用全谱 MLP
- ✅ 应考虑 1D-CNN（利用谱线局部相关性）或特征选择 + MLP
- ✅ 继续用 Ridge expert + 物理窗 gate 的路线

---

## 3.3 冲突性发现

| 主题 | 实验 A 结论 | 实验 B 结论 | 可能原因 | 解决方案 |
|------|-----------|-----------|---------|---------|
| Noise 分专家 | MVP-2.0: 平均 +0.080 很值钱 | noise=0.5 专家反而比 mixed 差 | 离散分档边界不对 | MVP-7.3 连续 SNR 条件化 |

---

# 4. 🧭 战略导航

## 4.1 方向状态总览（🟢 2025-12-04 更新！）

```
┌─────────────────────────────────────────────────────────────────────┐
│                   研究方向状态图（Phase 8 完成后）                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   🟢 高信心方向（✅ 已验证）                 🟡 待验证方向             │
│   ├── 🆕 物理窗 Soft Gate ← MVP-PG1 ρ=1.0  ├── 连续 SNR MVP-7.3     │
│   ├── [M/H] 优先门控 ← MVP-1.1              └── NN-MoE 集成 MVP-6.1 │
│   └── 连续条件化 ← MVP-3.2 (备选方案)                               │
│                                                                     │
│   🔴 风险方向（已解决/降级）                 ⚫ 已关闭方向             │
│   └── ~~硬 MoE~~ → 用 Soft routing 解决     ├── ~~Quantile bins~~   │
│                                             └── ~~Phase 7 诊断~~    │
│                                                                     │
│   🎯 推荐下一步: Phase 6 NN-MoE 集成！                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 4.2 高信心方向（🟢 多实验支持）

| 方向 | 支持证据 | 下一步行动 | 优先级 |
|------|---------|-----------|--------|
| **✅ 物理窗 Soft Gate** | MVP-PG1 ρ=1.00, MVP-9E1 ρ=1.13 | 已完成！继续优化 | 🟢 已确认 |
| **✅ 9 专家扩展** | MVP-9E1 R²=0.9213, ρ=1.13 | **已完成！超越 Oracle** | 🟢 已验证 |
| **🔴 回归最优 Gate** | 分类 vs 回归损失的权重差异 | **MVP-Next-A** | 🔴 **P0 最高 ROI** |
| **🔴 100% Coverage** | 当前 816/1000 covered | **MVP-Next-B** | 🔴 **P0 可交付性** |
| **🔴 Expert 校准** | Bin3/Bin6 系统性偏差 | **MVP-Next-C** | 🔴 P0 |
| **[M/H] 优先门控** | MVP-1.1 消融：68.7% 贡献 | Gate 特征设计优先 Ca II | 🟢 已确认 |

## 4.3 待验证方向（🟡 假设未验证）

| 方向 | 依赖假设 | 需要实验 | 预计收益 |
|------|---------|---------|---------|
| ✅ ~~物理窗 Gate~~ | ~~H-PG~~ | ✅ MVP-PG1, MVP-9E1 | ✅ **ρ=1.13 超预期！** |
| **🔴 回归最优 soft mixing** | H-A: 分类权重 ≠ 回归权重 | **MVP-Next-A** | **+0.003~0.01 R²** |
| **🔴 Full coverage** | H-B: 纳入 out-of-range 后仍高 | **MVP-Next-B** | **可交付版本** |
| **🔴 Expert 校准** | H-C: 系统性 bias 可校准 | **MVP-Next-C** | **Bin3/Bin6 ΔR²≥0.02** |
| ~~NN-MoE 集成~~ | ~~物理窗 gate 迁移~~ | ~~MVP-NN1~~ | ⚠️ **暂停（NN<<Ridge）** |

## 4.4 风险方向（🔴 有反例）

| 方向 | 反例证据 | 可能原因 | 是否继续 |
|------|---------|---------|---------|
| ~~**硬 MoE**~~ | ~~Pseudo 仅 7.3%~~ | ~~门控误差太敏感~~ | ✅ **已解决！** 用 Soft routing |

## 4.5 已关闭方向（⚫ 已否定/已解决）

| 方向 | 否定证据 | 关闭原因 | 教训 |
|------|---------|---------|------|
| ~~分位数分桶~~ | MVP-3.0 K≥3 负增益 | 有效边界是物理转折点，不是等频 | 不要假设数据分布均匀就能简化 |
| ~~Phase 7 诊断~~ | MVP-PG1 ρ=1.00 | Phase 8 直接解决了门控问题 | Soft routing 是关键 |
| ~~Hard routing~~ | MVP-PG1 Hard ρ=0.72 | Soft routing 可保住全部增益 | 边界误差需要软处理 |

## 4.6 核心决策句（🔴 2025-12-04 更新！）

> **Gate 问题已解决！9 专家 MoE 达到 R²=0.9213。现在瓶颈转移到 (a) gate 权重优化 (b) coverage (c) 系统性偏差。**

**回顾（Phase 8-10 已完成）**：
- ✅ 已证明"分段确实有结构"（ΔR²≈0.05 稳健）
- ✅ ~~"离散门控难落地"~~ → **已解决！Soft routing ρ=1.00**
- ✅ **9 专家扩展大成功**：R²=0.9213, ρ=1.13 超越 Oracle！
- ✅ **Soft routing 是关键机制**（Hard ρ=0.72 vs Soft ρ=1.00）
- ⚠️ **NN expert 路线暂停**：全谱 MLP 不如 Ridge

**新瓶颈识别（Phase 11）**：
- 🔴 **瓶颈 A：Gate 权重优化** — 当前分类最优 ≠ 回归最优
- 🔴 **瓶颈 B：Coverage** — 816/1000 covered，需要 100% coverage
- 🔴 **瓶颈 C：系统性偏差** — Bin3/Bin6 (metal-poor) 拖后腿

**🎯 推荐下一步（Phase 11 Milestone M2）**：
> 1. **🔴 MVP-Next-A（最高 ROI）**：回归最优 soft mixing —— 用 MSE 损失训练 gate 权重
> 2. **🔴 MVP-Next-B（可交付性）**：100% coverage —— 处理 out-of-range 样本
> 3. **🔴 MVP-Next-C（冲 R²）**：Expert 校准 —— 对最弱 bins 做 affine 校准

**Phase 11 里程碑 M2 目标**：
> 将 9 专家物理 MoE 升级为**回归最优 soft mixing + 100% coverage**，目标是在 full-test 上稳定超过当前分类 gate 的 R²，并给出 bootstrap CI。

**关键洞见**：
> **提升 R² 的下一步，不是继续堆专家数量，而是优化 soft mixing 权重和处理边界/偏差问题。**
> - Gate 已接近 oracle（ρ≈1.13）
> - 永远用 Soft routing，不要用 Hard routing

---

# 5. 📐 设计原则库

## 5.1 已确认原则

| # | 原则名称 | 具体建议 | 证据来源 | 适用范围 |
|---|---------|---------|---------|---------|
| **P1** | **优先按 [M/H] 分专家** | [M/H] 贡献 68.7%，3 个 [M/H] 专家可获得 69% 收益 | MVP-1.1 消融 | MoE 门控设计 |
| **P2** | **连续条件优于离散门控** | Conditional Ridge 更抗门控误差，且 100% coverage | MVP-3.2 | 模型选择 |
| **P3** | **Noise 应连续条件化** | 离散分档在 noise=0.5 翻车；连续 SNR 更稳定 | MVP-2.0 | 噪声处理 |
| **P4** | **Noise-matched 训练是必要的** | 部署时需知道 SNR，选择对应专家 | MVP-2.0 | 训练策略 |
| **P5** | **默认用高噪声专家** | 如果 SNR 未知，用高噪声专家更安全 | MVP-2.0 cross-noise | 部署策略 |
| **P6** | **公平比较用 mask-aligned** | 评估时确保 Global 和 MoE 在同一 subset 上比较 | MVP-1.1 | 实验方法 |

## 5.2 待验证原则

| # | 原则名称 | 初步建议 | 需要验证 |
|---|---------|---------|---------|
| P7 | 高 [M/H] 用更广窗口 | 能量分散需要多区域聚合 | MVP-7.4 |
| P8 | 低 [M/H] 用窄窗口高分辨 | 信息集中需要精准提取 | MVP-7.4 |

## 5.3 关键数字速查

| 指标 | 值 | 条件 | 来源 |
|------|-----|------|------|
| 全局 Ridge $R^2$ (baseline) | **0.8616** | noise=0.2, mask-aligned | MVP-1.1 |
| 分区 Ridge $R^2$ (MoE-1) | **0.9116** | noise=0.2, mask-aligned | MVP-1.1 |
| $\Delta R^2$ (MoE-1) | **+0.050** | CI=[0.033, 0.067] | MVP-1.1 |
| [M/H] 贡献比 | **68.7%** | - | MVP-1.1 消融 |
| Teff 贡献比 | 42.9% | - | MVP-1.1 消融 |
| Conditional Ridge 1st-order $R^2$ | **0.9018** | 达 MoE 80% | MVP-3.2 |
| Noise Expert 平均 $\Delta R^2$ | **+0.0797** | - | MVP-2.0 |
| Pseudo Gating 保留率 | **7.3%** | ~~⚠️ 风险点~~ → 已解决 | MVP-3.1 |
| Ca II triplet 重要性比 | **1.65×** | 高 [M/H] vs 低 [M/H] | MVP-5.0 |
| **🟢 物理窗 Gate ρ (Soft)** | **1.00** | 保住 100% 增益！ | MVP-PG1 |
| **物理窗 Gate ρ (Hard)** | 0.722 | 损失 28% 增益 | MVP-PG1 |
| **Gate 分类准确率** | **82.10%** | LogReg (C=10) | MVP-PG1 |
| **Bootstrap 95% CI** | [0.728, 1.438] | 1000 次采样 | MVP-PG1 |
| **R²_moe_nn (Soft)** | 0.385 | 3 专家 + Soft | MVP-NN1 |
| **R²_global_nn** | 0.128 | 全量训练 | MVP-NN1 |
| **ΔR² (MoE_NN - Global_NN)** | **+0.257** | ✅ 达标 | MVP-NN1 |

---

# 6. 📎 附录

## 6.1 物理/领域背景

### 6.1.1 为什么 [M/H] 影响大？

**金属丰度 [M/H] 决定了**：
- 谱线强度：高 [M/H] 金属线更强、更容易检测
- 特征分布：高 [M/H] 信息更分散在多个波段；低 [M/H] 集中在少数强线
- $\log g$ 特征可提取性：高 [M/H] 有更多可用的压力敏感线

### 6.1.2 MoE 有效的物理场景

1. **分段函数关系**：
   - 低 $T_{\text{eff}}$ / 高 $T_{\text{eff}}$ 下，谱线形状–$\log g$ 的关系不一样
   - 金属丰度极低/极高的星，$\log g$ 特征落在完全不同的波段

2. **混合噪声分布**：
   - 有些样本 SNR 很高，有些 SNR 很低
   - 部分波段 noise 特性完全不同

3. **数据分布不均匀**：
   - 某些参数区间样本很少，需要专门的专家

### 6.1.3 信息论视角

$$
R^2 \approx 1 - \frac{\mathbb{E}[(Y - \mathbb{E}[Y|F])^2]}{\operatorname{Var}(Y)}
$$

**$R^2$ 越高，说明「只看 $F$，就能消掉多少 $\log g$ 的不确定性」。**

MoE 本质是**条件分布建模**：$P(y|x, z)$ 其中 $z$ 是 gating 信号。如果 $P(y|x)$ 在不同 $z$ 下差异大，MoE 有收益。

---

## 6.2 决策树：不同结果的解读

### 情形 A: 分区 Ridge $\Delta R^2 \geq 0.03$ ✅ 已发生

**诊断**：函数在 $(T_{\text{eff}}, [\text{M/H}])$ 空间确实是"分段简单"的

**设计启示**：
- MoE 架构值得投入
- 但需要解决门控落地问题

### 情形 B: Pseudo gating < 50% Oracle ✅ 已发生

**诊断**：硬门控对误差太敏感

**应对策略**：
- 转向连续条件化
- 或优化门控精度

---

## 6.3 术语表

| 术语 | 定义 | 备注 |
|------|------|------|
| MoE | Mixture of Experts | 多专家混合模型 |
| Oracle gate | 用真值 [M/H]/log g 做门控 | 理想上限 |
| Pseudo gate | 用预测值做门控 | 可落地版本 |
| Conditional Ridge | 系数随条件连续变化的 Ridge | $\phi(x, m) = [x, m\cdot x, m^2\cdot x]$ |
| mask-aligned | 只在 MoE 覆盖的样本上评估 Global | 公平比较方法 |

---

## 6.4 变更日志

| 日期 | 变更内容 | 影响章节 |
|------|---------|---------|
| 2025-12-03 | 从 moe_main.md 拆分创建 Hub | 全部 |
| 2025-12-04 | 添加 C1-C5 汇合点详情 | §3 |
| 2025-12-04 | 更新战略导航 | §4 |
| **2025-12-04** | **🟢 MVP-PG1 完成！物理窗 Gate ρ=1.00** | §1.2, §2.3, §2.4, §3, §4, §5.3 |
| 2025-12-04 | 添加 C6 汇合点：物理窗 Gate 成功 | §3.1, §3.2 |
| 2025-12-04 | 更新假设验证状态 H-PG1~H-PG4 | §2.3 |
| 2025-12-04 | 更新战略导航和核心决策句 | §4 |
| 2025-12-04 | Phase 7 诊断方向关闭，推荐 Phase 6 NN-MoE | §4.5, §4.6 |
| **2025-12-04** | **🔴 立项 MVP-9E1, MVP-NN1** | §1.2, §2.3, §4.2, §4.6 |
| 2025-12-04 | 添加 Q6, Q7 问题树：9专家扩展 + NN专家 | §1.2 |
| 2025-12-04 | 添加 H-9E1~3, H-NN1~3 假设 | §2.3 |
| 2025-12-04 | 更新战略导航：瓶颈从 gate → 专家 | §4.6 |
| **2025-12-04** | **⚠️ MVP-NN1 完成！添加 C7 洞见** | §2.3, §3.1, §3.2, §5.3 |
| **2025-12-04** | **🔴 立项 Phase 11: MVP-Next-A/B/C** | §1.2, §2.3, §4.2, §4.3, §4.6 |
| 2025-12-04 | 添加 Q8 问题树：优化 9 专家 MoE | §1.2 |
| 2025-12-04 | 添加 H-A/H-B/H-C 假设 | §2.3 |
| 2025-12-04 | 更新战略导航：瓶颈从专家 → 权重优化/coverage/偏差 | §4.6 |
| 2025-12-04 | 设定 M2 里程碑目标 | §4.6 |


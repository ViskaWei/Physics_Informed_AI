# ğŸ“˜ Experiment Report: Quantile Bins Sweep

---
> **Name:** MoE-1.2: Quantile Bins Sweep + Pseudo Gating  
> **ID:** `VIT-20251203-moe-quantile-01`  
> **Topic ï½œ MVP:** `VIT` | `moe` ï½œ MVP-3.0, MVP-3.1  
> **Author:** Viska Wei  
> **Date:** 2025-12-03  
> **Project:** `VIT`  
> **Status:** âœ… Completed (Negative Result)

---

## ğŸ”— Upstream Links

| ç±»å‹ | é“¾æ¥ | è¯´æ˜ |
|------|------|------|
| ğŸ§  Hub | `logg/moe/moe_hub_20251203.md` | å‡è®¾é‡‘å­—å¡” |
| ğŸ—ºï¸ Roadmap | `logg/moe/moe_roadmap_20251203.md` | MVP è¯¦ç»†è®¾è®¡ |
| ğŸ“‹ Kanban | `status/kanban.md` | å®éªŒé˜Ÿåˆ— |
| ğŸ“Š å‰ç½®å®éªŒ | [exp_moe_rigorous_validation](./exp_moe_rigorous_validation_20251203.md) | MoE-1.1 |
| ğŸ“Š ç›¸å…³å®éªŒ | [Conditional Ridge](./exp_moe_conditional_ridge_20251203.md) | MVP-3.2 |
| ğŸ“Š ç›¸å…³å®éªŒ | [ç³»æ•°åˆ†æ](./exp_moe_coefficient_analysis_20251203.md) | MVP-5.0 |

---

# ğŸ“‘ Table of Contents

- [âš¡ Key Findings](#-æ ¸å¿ƒç»“è®ºé€Ÿè§ˆä¾›-main-æå–)
- [1. ğŸ¯ Objective](#1--ç›®æ ‡)
- [2. ğŸ§ª Experiment Design](#2--å®éªŒè®¾è®¡)
- [3. ğŸ“Š Figures & Results](#3--å®éªŒå›¾è¡¨)
- [4. ğŸ’¡ Insights](#4--å…³é”®æ´è§)
- [5. ğŸ“ Conclusions](#5--ç»“è®º)
- [6. ğŸ“ Appendix](#6--é™„å½•)

---

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆï¼ˆä¾› main æå–ï¼‰

> **å®éªŒå®Œæˆåç¬¬ä¸€æ—¶é—´å¡«å†™**

### ä¸€å¥è¯æ€»ç»“

> **è´Ÿé¢ç»“æœï¼š[M/H]-only quantile bins ä¸ä»…æ— æ³•å¤ç° MoE-1.1 çš„ Î”RÂ²=+0.078 å¢ç›Šï¼Œåè€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼ˆKâ‰¥3 æ—¶ Î”RÂ²<0ï¼‰ï¼Œè¯æ˜ T_eff ç»´åº¦å¯¹ MoE æˆåŠŸè‡³å…³é‡è¦ã€‚**

### å¯¹å‡è®¾çš„éªŒè¯

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| Quantile bins æ˜¯å¦è§£å†³ coverage é—®é¢˜ï¼Ÿ | âœ… 100% coverage | æ˜¯ï¼Œä½†æ€§èƒ½åè€Œä¸‹é™ |
| æœ€ä½³ Kï¼ˆä¸“å®¶æ•°ï¼‰æ˜¯å¤šå°‘ï¼Ÿ | K=2 (Î”RÂ²=+0.004) | ä»… K=2 æœ‰å¾®å°æ­£å¢ç›Šï¼ŒKâ‰¥3 è´Ÿå¢ç›Š |
| Pseudo gating èƒ½ä¿ä½ Oracle å¤šå°‘å¢ç›Šï¼Ÿ | 7.3% | âŒ è¿œä½äº 70% ç›®æ ‡ |

### è®¾è®¡å¯ç¤ºï¼ˆ1-2 æ¡ï¼‰

| å¯ç¤º | å…·ä½“å»ºè®® |
|------|---------|
| **[M/H]-only åˆ†æ¡¶ä¸å¯è¡Œ** | MoE éœ€è¦åŒæ—¶æŒ‰ (T_eff, [M/H]) åˆ†å±‚ï¼Œå•ç»´åº¦åˆ†æ¡¶ä¼šå¯¼è‡´ bin å†… log_g å˜å¼‚è¿‡å¤§ |
| **é‡‘å±è´«æ˜Ÿæ˜¯éš¾ç‚¹** | [M/H] < -1.5 çš„ bin RÂ² ä»… 0.02~0.41ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†æˆ–æ›´å¤§è®­ç»ƒé›† |

### å…³é”®æ•°å­—

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| æœ€ä½³ K (Quantile bins) | **K=2** |
| Oracle Î”RÂ² (K=2) | **+0.0037** (marginal) |
| Pseudo Î”RÂ² (K=2) | **+0.0003** |
| Pseudo/Oracle ä¿ç•™ç‡ | **7.3%** (far below 70% target) |
| [M/H] Predictor RÂ² | 0.9801 (excellent, not the bottleneck) |

---

# 1. ğŸ¯ ç›®æ ‡

## 1.1 å®éªŒç›®çš„

> ä» MoE-1.1 çš„å‘ç°ï¼ˆ[M/H] è´¡çŒ® 68.7%ï¼‰å‡ºå‘ï¼Œè§£å†³ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
> 1. **åˆ†æ¡¶æ–¹å¼**ï¼šä»æ‰‹å·¥è¾¹ç•Œ â†’ quantile binsï¼ˆ100% coverageï¼‰
> 2. **é—¨æ§å¯è½åœ°æ€§**ï¼šä» Oracle [M/H] â†’ Pseudo gatingï¼ˆç”¨é¢„æµ‹å€¼åˆ†æ¡¶ï¼‰

**æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚æœä¸ç»™çœŸå€¼ [M/H]ï¼Œä»…ç”¨å…‰è°±ï¼ˆ+ errorï¼‰è¿˜èƒ½ä¸èƒ½æ‹¿åˆ°å¤§éƒ¨åˆ†å¢ç›Šï¼Ÿ

**å›ç­”çš„é—®é¢˜**ï¼š
1. **ç²’åº¦é—®é¢˜**ï¼š[M/H] quantile bins çš„æœ€ä½³ K æ˜¯å¤šå°‘ï¼Ÿï¼ˆK=2,3,4,5,6ï¼‰
2. **å¯è½åœ°æ€§**ï¼šPseudo gating èƒ½ä¿ä½ Oracle å¢ç›Šçš„å‡ æˆï¼Ÿï¼ˆâ‰¥70% å°±éå¸¸æœ‰æˆï¼‰

> **æ³¨**ï¼šæ¡ä»¶çº¿æ€§ (MVP-3.2) å’Œç³»æ•°åˆ†æ (MVP-5.0) å·²ç§»è‡³ç‹¬ç«‹å®éªŒæ–‡ä»¶

**å¯¹åº” main.md çš„**ï¼š
- éªŒè¯é—®é¢˜ï¼šQ6 (bins ç²’åº¦), Q7 (pseudo gating)
- å­å‡è®¾ï¼šH2.1 (Quantile bins ä¼˜äºæ‰‹å·¥è¾¹ç•Œ), H2.2 (Pseudo â‰¥ 70% Oracle)

## 1.2 é¢„æœŸç»“æœ

| åœºæ™¯ | é¢„æœŸç»“æœ | åˆ¤æ–­æ ‡å‡† |
|------|---------|---------|
| **Quantile bins K=3** | Î”RÂ²â‰ˆ0.034 (ä¸å½“å‰ [M/H] only æ¶ˆèä¸€è‡´) | éªŒæ”¶åŸºå‡† |
| **Quantile bins æœ€ä½³ K** | å­˜åœ¨æœ€ä½³ Kâˆˆ[3,5]ï¼Œå¤ªç²—/å¤ªç»†éƒ½ä¸å¥½ | çœ‹ Î”RÂ² vs K æ›²çº¿ |
| **Pseudo gating** | ä¿ç•™ Oracle â‰¥70% å¢ç›Š | å¦‚æœ <50% åˆ™éœ€è¦æ”¹è¿› gate |
| **å¼‚å¸¸ï¼šPseudo << Oracle** | é—¨æ§æ˜¯ä¸»è¦æŸå¤±æº | éœ€è¦æŠ•å…¥ç²¾åŠ›åœ¨ gate è€Œé expert |

---

# 2. ğŸ§ª å®éªŒè®¾è®¡

## 2.1 æ•°æ®

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| è®­ç»ƒæ ·æœ¬æ•° | 26,609 |
| æµ‹è¯•æ ·æœ¬æ•° | 816 |
| ç‰¹å¾ç»´åº¦ | 7,514 (å…¨è°±) |
| æ ‡ç­¾å‚æ•° | log g |
| è¾…åŠ©å‚æ•° | [M/H], Teff |

**å™ªå£°æ¨¡å‹**ï¼š

$$
\text{noisy\_flux} = \text{flux} + \mathcal{N}(0, \sigma^2)
$$

**Noise levels**: $\sigma = 0.2$ (ä¸»å®éªŒ), $\sigma \in \{0.0, 0.1, 0.5\}$ (æ•æ„Ÿæ€§åˆ†æ)

## 2.2 æ¨¡å‹ä¸ç®—æ³•

### Part A: Quantile Bins Sweep

**ç›®æ ‡**ï¼šæŠŠæ‰‹å·¥è¾¹ç•Œå‡çº§æˆåˆ†ä½æ•°åˆ†æ¡¶

**åˆ†æ¡¶æ–¹å¼**ï¼š
- å¯¹ [M/H] åš K-quantile åˆ†æ¡¶ï¼ˆK=2,3,4,5,6ï¼‰
- æ¯ä¸ª bin è¦†ç›– $\frac{1}{K}$ çš„æ ·æœ¬ï¼ˆå¤©ç„¶ 100% coverageï¼‰
- æ¯ä¸ª bin è®­ç»ƒç‹¬ç«‹ Ridge

$$
\text{bins}_k = \left\{ x : \frac{k-1}{K} \leq F_{[M/H]}(x_{[M/H]}) < \frac{k}{K} \right\}
$$

**ç¡¬é˜ˆå€¼**ï¼šå¦‚æœ n_test_bin < 30ï¼Œè‡ªåŠ¨åˆå¹¶ç›¸é‚» bin

### Part B: Pseudo Gating

**å¯¹ç…§é“¾**ï¼š

| æ–¹æ³• | Gate æ¥æº | è¯´æ˜ |
|------|----------|------|
| **Oracle** | çœŸå€¼ [M/H] | ä¸Šé™ï¼ˆä½ å·²æœ‰ Î”RÂ²=0.034ï¼‰ |
| **Pseudo** | $\widehat{[M/H]}$ from å…¨å±€ Ridge | å¯è½åœ°ç‰ˆæœ¬ |

**Pseudo Gate æµç¨‹**ï¼š
1. è®­ç»ƒå…¨å±€ Ridge: $\widehat{[M/H]} = f_{global}(flux)$
2. ç”¨ $\widehat{[M/H]}$ çš„ quantile åˆ†æ¡¶
3. æ¯ä¸ª bin è®­ç»ƒä¸“å®¶ Ridge
4. é¢„æµ‹æ—¶ï¼šå…ˆé¢„æµ‹ $\widehat{[M/H]}$ â†’ é€‰ä¸“å®¶ â†’ è¾“å‡º log g

## 2.3 è¶…å‚æ•°é…ç½®

| å‚æ•° | èŒƒå›´/å€¼ | è¯´æ˜ |
|------|--------|------|
| K (quantile bins) | 2, 3, 4, 5, 6 | ä¸“å®¶æ•°æ‰«æ |
| Ridge Î± | [0.001, 0.01, 0.1, 1, 10, 100] | æ¯ä¸ª expert ç‹¬ç«‹æ‰«æ |
| Bootstrap seeds | 50 | 95% CI ä¼°è®¡ |
| min_test_bin | 30 | å°äºæ­¤é˜ˆå€¼è‡ªåŠ¨åˆå¹¶ |
| noise level | 0.2 (ä¸»), 0.0/0.1/0.5 (æ•æ„Ÿæ€§) | |

## 2.4 è¯„ä»·æŒ‡æ ‡

| æŒ‡æ ‡ | å…¬å¼ | ç”¨é€” |
|------|------|------|
| $R^2$ | $1 - \frac{\sum(y - \hat{y})^2}{\sum(y - \bar{y})^2}$ | ä¸»è¦è¯„ä»·æŒ‡æ ‡ |
| $\Delta R^2$ | $R^2_{MoE} - R^2_{global}$ | vs baseline æå‡ |
| 95% CI | Bootstrap percentile | æ•ˆæœç¨³å¥æ€§ |
| Coverage | è¢«ä¸“å®¶è¦†ç›–çš„æ ·æœ¬æ¯”ä¾‹ | quantile åº” = 100% |
| Pseudo/Oracle ratio | $\Delta R^2_{pseudo} / \Delta R^2_{oracle}$ | é—¨æ§æ•ˆç‡ |

---

# 3. ğŸ“Š å®éªŒå›¾è¡¨

> å®éªŒå®Œæˆåå¡«å†™

### å›¾ 1ï¼šQuantile Bins K Sweep

**é¢„æœŸå†…å®¹**ï¼šÎ”RÂ² vs K (K=2~6) with 95% CI error bars

![å›¾ç‰‡](./img/moe_quantile_k_sweep.png)

**Figure 1. [M/H] Quantile Bins K Sweep - Î”RÂ² éš K å˜åŒ–ï¼ˆè´Ÿé¢ç»“æœï¼‰**

**å…³é”®è§‚å¯Ÿ**ï¼š
- K=2 æ—¶ Î”RÂ² = +0.0037ï¼Œä»…æœ‰è¾¹é™…æ”¹å–„
- Kâ‰¥3 æ—¶ Î”RÂ² æ€¥å‰§ä¸‹é™ä¸ºè´Ÿå€¼ï¼Œæœ€å·® K=6 æ—¶ Î”RÂ² = -0.84
- é‡‘å±è´« bin ([M/H] < -1.5) çš„ RÂ² æä½ï¼ˆ0.02~0.41ï¼‰ï¼Œæ˜¯ä¸»è¦å¤±è´¥åŸå› 
- ç»“è®ºï¼š[M/H]-only åˆ†æ¡¶æ–¹æ¡ˆå¤±è´¥ï¼Œéœ€è¦ä¿ç•™ T_eff ç»´åº¦

---

### å›¾ 2ï¼šOracle vs Pseudo Gating å¯¹æ¯”

**é¢„æœŸå†…å®¹**ï¼šä¸¤ç§ gating æ–¹å¼çš„ Î”RÂ² å¯¹æ¯”æŸ±çŠ¶å›¾

![å›¾ç‰‡](./img/moe_oracle_vs_pseudo.png)

**Figure 2. Oracle vs Pseudo Gating (K=2) - Pseudo ä»…ä¿ç•™ 7.3% Oracle å¢ç›Š**

**å…³é”®è§‚å¯Ÿ**ï¼š
- Oracle Î”RÂ² = +0.0037ï¼ŒPseudo Î”RÂ² = +0.0003
- Pseudo/Oracle ratio = 7.3%ï¼Œè¿œä½äº 70% ç›®æ ‡
- [M/H] Predictor RÂ² = 0.9801ï¼ˆé¢„æµ‹å™¨æœ¬èº«å¾ˆå¥½ï¼‰
- ç“¶é¢ˆä¸åœ¨ gate é¢„æµ‹ç²¾åº¦ï¼Œè€Œåœ¨åˆ†æ¡¶ç­–ç•¥æœ¬èº«

---

# 4. ğŸ’¡ å…³é”®æ´è§

## 4.1 å®è§‚å±‚æ´è§

**MoE æˆåŠŸéœ€è¦å¤šç»´åº¦åˆ†å±‚ï¼Œå•ä¸€ [M/H] ç»´åº¦ä¸å¤Ÿã€‚** MoE-1.1 çš„æˆåŠŸï¼ˆÎ”RÂ²=+0.078ï¼‰æ¥è‡ª (T_eff Ã— [M/H]) çš„ 9-bin ç­–ç•¥ï¼ŒåŒæ—¶çº¦æŸäº†æ¸©åº¦å’Œé‡‘å±ä¸°åº¦ã€‚å½“åªæŒ‰ [M/H] åˆ†æ¡¶æ—¶ï¼Œæ¯ä¸ª bin å†…ä»åŒ…å«ä»å†·åˆ°çƒ­çš„å„ç§æ’æ˜Ÿï¼Œå¯¼è‡´ log_g å˜å¼‚è¿‡å¤§ï¼Œä¸“å®¶æ¨¡å‹æ— æ³•å¾ˆå¥½æ‹Ÿåˆã€‚

## 4.2 æ¨¡å‹å±‚æ´è§

**é‡‘å±è´«æ˜Ÿæ˜¯çœŸæ­£çš„éš¾ç‚¹ã€‚** [M/H] < -1.5 çš„ bin è¡¨ç°æå·®ï¼š
- K=3, Bin 1: RÂ² = 0.41 (vs global 0.83)
- K=4, Bin 1: RÂ² = 0.02
- K=6, Bin 1: RÂ² = -4.46 (ä¸¥é‡è¿‡æ‹Ÿåˆ)

åŸå› åˆ†æï¼šé‡‘å±è´«æ˜Ÿçš„å…‰è°±ç‰¹å¾è¾ƒå¼±ï¼Œé‡‘å±å¸æ”¶çº¿ä¸æ˜æ˜¾ï¼Œæ¨¡å‹éš¾ä»¥ä»å…‰è°±ä¸­æå–è¶³å¤Ÿä¿¡æ¯ã€‚

## 4.3 å®éªŒå±‚ç»†èŠ‚æ´è§

1. **Pseudo gating ä¸æ˜¯ç“¶é¢ˆ**ï¼š[M/H] Predictor RÂ² = 0.9801ï¼Œé¢„æµ‹ç²¾åº¦å¾ˆé«˜ï¼Œä½† Pseudo/Oracle ratio ä»… 7.3%ã€‚è¿™è¯´æ˜é—®é¢˜ä¸åœ¨ gate çš„é¢„æµ‹ç²¾åº¦ï¼Œè€Œåœ¨åˆ†æ¡¶ç­–ç•¥æœ¬èº«ã€‚

2. **Coverage 100% ä¸ç­‰äºæœ‰æ•ˆ**ï¼šQuantile bins ç¡®å®å®ç°äº† 100% coverageï¼Œä½†è¿™å¹¶ä¸èƒ½è½¬åŒ–ä¸ºæ€§èƒ½æå‡ã€‚MoE-1.1 çš„ 84% coverage åè€Œæ›´å¥½ï¼Œå› ä¸ºå®ƒè¿‡æ»¤äº†éš¾ä»¥é¢„æµ‹çš„è¾¹ç¼˜æ ·æœ¬ã€‚

3. **Alpha é€‰æ‹©é—®é¢˜**ï¼šæ‰€æœ‰ bin çš„æœ€ä½³ alpha éƒ½æ˜¯ 0.001ï¼ˆæœ€å°å€¼ï¼‰ï¼Œè¯´æ˜æ¨¡å‹å€¾å‘äºä½æ­£åˆ™åŒ–ï¼Œå¯èƒ½å­˜åœ¨è¿‡æ‹Ÿåˆé£é™©ï¼Œå°¤å…¶åœ¨å°æ ·æœ¬ bin ä¸­ã€‚

---

# 5. ğŸ“ ç»“è®º

## 5.1 æ ¸å¿ƒå‘ç°

**[M/H]-only quantile bins æ–¹æ¡ˆå¤±è´¥ã€‚** ä¸é¢„æœŸç›¸åï¼ŒåªæŒ‰ [M/H] åˆ†æ¡¶ä¸ä»…æ— æ³•å¤ç° MoE-1.1 çš„æˆåŠŸï¼ˆÎ”RÂ²=+0.078ï¼‰ï¼Œåè€Œå¯¼è‡´æ€§èƒ½æ˜¾è‘—ä¸‹é™ã€‚Kâ‰¥3 æ—¶ MoE æ¯”å…¨å±€ Ridge æ›´å·®ï¼ŒK=6 æ—¶ç”šè‡³å‡ºç°è´Ÿ RÂ²ï¼ˆ-0.004ï¼‰ã€‚

**å…³é”®å¤±è´¥åŸå› **ï¼š
1. å•ä¸€ [M/H] ç»´åº¦æ— æ³•å……åˆ†çº¦æŸå‚æ•°ç©ºé—´
2. é‡‘å±è´«æ˜Ÿ ([M/H] < -1.5) çš„å…‰è°±ä¿¡æ¯ä¸è¶³
3. æ¯ä¸ª bin å†… log_g å˜å¼‚ä»ç„¶è¿‡å¤§

## 5.2 å…³é”®ç»“è®ºï¼ˆ2-4 æ¡ï¼‰

| # | ç»“è®º | è¯æ® |
|---|------|------|
| 1 | **MoE éœ€è¦å¤šç»´åº¦åˆ†å±‚** | (T_eff Ã— [M/H]) 9-bin Î”RÂ²=+0.078ï¼Œ[M/H]-only Î”RÂ²â‰¤+0.004 |
| 2 | **K=2 æ˜¯å”¯ä¸€æ­£å¢ç›Š** | K=2: +0.0037, K=3: -0.053, K=6: -0.84 |
| 3 | **Pseudo gating å‡ ä¹æ— æ•ˆ** | 7.3% ratioï¼Œç“¶é¢ˆä¸åœ¨ gate ç²¾åº¦ |
| 4 | **é‡‘å±è´«æ˜Ÿæ˜¯å…³é”®éš¾ç‚¹** | Bin 1 RÂ² ä» 0.41 ä¸‹é™åˆ° -4.46 |

## 5.3 è®¾è®¡å¯ç¤º

1. **ä¿ç•™ (T_eff Ã— [M/H]) åŒç»´åº¦åˆ†å±‚**ï¼šMoE-1.1 çš„æˆåŠŸä¸å¯ç®€åŒ–ã€‚
2. **ä¸“é—¨å¤„ç†é‡‘å±è´«æ˜Ÿ**ï¼šè€ƒè™‘å¯¹ [M/H] < -1.5 ä½¿ç”¨å…¨å±€æ¨¡å‹ fallbackã€‚
3. **é‡æ–°è¯„ä¼° Pseudo Gating**ï¼šåœ¨æ­£ç¡®çš„åˆ†å±‚ç­–ç•¥ä¸‹é‡æ–°è¯„ä¼°ä»·å€¼ã€‚

## 5.4 ç‰©ç†è§£é‡Š

**ä¸ºä»€ä¹ˆ [M/H]-only ä¸å¤Ÿï¼Ÿ** æ’æ˜Ÿçš„ log_g ç”±æ¼”åŒ–é˜¶æ®µå†³å®šï¼ŒåŒæ—¶ä¾èµ–è´¨é‡ï¼ˆT_eff ç›¸å…³ï¼‰å’Œæˆåˆ†ï¼ˆ[M/H]ï¼‰ã€‚å†·å·¨æ˜Ÿå’Œçƒ­ä¸»åºæ˜Ÿå¯èƒ½æœ‰ç›¸ä¼¼ [M/H]ï¼Œä½† log_g å·®å¼‚å·¨å¤§ï¼ˆ1.0 vs 4.5ï¼‰ã€‚

**ä¸ºä»€ä¹ˆé‡‘å±è´«æ˜Ÿéš¾é¢„æµ‹ï¼Ÿ** é‡‘å±è´«æ˜Ÿçš„å…‰è°±ä¸­é‡‘å±å¸æ”¶çº¿è¾ƒå¼±ï¼Œç‰¹å¾ä¿¡æ¯ä¸è¶³ã€‚

## 5.5 å…³é”®æ•°å­—é€ŸæŸ¥

| æŒ‡æ ‡ | å€¼ | é…ç½®/æ¡ä»¶ |
|------|-----|----------|
| æœ€ä½³ K | **2** | [M/H] quantile bins |
| Oracle Î”RÂ² (K=2) | **+0.0037** | çœŸå€¼ [M/H] gating |
| Pseudo Î”RÂ² (K=2) | **+0.0003** | é¢„æµ‹ [M/H] gating |
| Pseudo/Oracle ratio | **7.3%** | è¿œä½äº 70% ç›®æ ‡ |
| Global Ridge RÂ² | 0.8341 | noise=0.2 |

## 5.6 ä¸‹ä¸€æ­¥å·¥ä½œ

| æ–¹å‘ | å…·ä½“ä»»åŠ¡ | ä¼˜å…ˆçº§ | å¯¹åº” MVP |
|------|----------|--------|---------|
| **æ”¾å¼ƒ [M/H]-only** | å›å½’ (T_eff Ã— [M/H]) åŒç»´åº¦ç­–ç•¥ | ğŸ”´ | - |
| Conditional Ridge | è§ [exp_moe_conditional_ridge](./exp_moe_conditional_ridge_20251203.md) | ğŸ”´ | MVP-3.2 |
| é‡‘å±è´«æ˜Ÿä¸“é¡¹ | å¢åŠ  [M/H] < -1.5 è®­ç»ƒæ•°æ®æˆ– fallback | ğŸŸ¡ | - |
| ~~Learned Gate~~ | ~~æš‚ç¼“ï¼Œå…ˆä¿®æ­£åˆ†å±‚ç­–ç•¥~~ | âšª | MVP-6.0 |

---

# 6. ğŸ“ é™„å½•

## 6.1 æ•°å€¼ç»“æœè¡¨

> å®éªŒå®Œæˆåå¡«å†™

### Part A: Quantile Bins K Sweep

| K | Coverage | Global RÂ² | MoE RÂ² | Î”RÂ² | åˆ¤å®š |
|---|----------|-----------|--------|-----|------|
| 2 | 100% | 0.8341 | 0.8378 | **+0.0037** | âš ï¸ å¾®å¼±æ­£å¢ç›Š |
| 3 | 100% | 0.8341 | 0.7808 | **-0.0534** | âŒ è´Ÿå¢ç›Š |
| 4 | 100% | 0.8341 | 0.7126 | **-0.1215** | âŒ è´Ÿå¢ç›Š |
| 5 | 100% | 0.8341 | 0.5701 | **-0.2640** | âŒ ä¸¥é‡è´Ÿå¢ç›Š |
| 6 | 100% | 0.8341 | -0.0044 | **-0.8385** | âŒ ç¾éš¾æ€§ |

### Part B: Oracle vs Pseudo Gating (K=2)

| Gating | K | Î”RÂ² | Ratio vs Oracle |
|--------|---|-----|-----------------|
| Oracle [M/H] | 2 | **+0.0037** | 100% |
| Pseudo [M/H] | 2 | **+0.0003** | **7.3%** |

**æ³¨**ï¼š[M/H] Predictor RÂ² = 0.9801ï¼Œé¢„æµ‹ç²¾åº¦æœ¬èº«å¾ˆå¥½ï¼Œä½†æ— æ³•è½¬åŒ–ä¸º MoE å¢ç›Šã€‚

---

## 6.2 å®éªŒæµç¨‹è®°å½•

### 6.2.1 ç¯å¢ƒä¸é…ç½®

| é¡¹ç›® | å€¼ |
|------|-----|
| **ä»“åº“** | `~/VIT` |
| **Config è·¯å¾„** | `configs/moe_quantile.yaml` |
| **è¾“å‡ºè·¯å¾„** | `results/moe_quantile_sweep/` |
| **Python** | 3.10 |
| **å…³é”®ä¾èµ–** | scikit-learn, numpy, matplotlib |

### 6.2.2 æ‰§è¡Œå‘½ä»¤

```bash
# å¤ç”¨ moe_rigorous_validation.py çš„é£æ ¼

# Part A: Quantile bins sweep
python scripts/moe_quantile_sweep.py \
    --part A \
    --k_values 2 3 4 5 6 \
    --n_bootstrap 50 \
    --noise 0.2

# Part B: Oracle vs Pseudo gating
python scripts/moe_quantile_sweep.py \
    --part B \
    --k_values 3 \
    --gating oracle pseudo

# ç”Ÿæˆå›¾è¡¨
python scripts/moe_plot_results.py --exp quantile_sweep
```

### 6.2.3 è¿è¡Œæ—¥å¿—æ‘˜è¦

```
å®éªŒæ‰§è¡Œæ—¶é—´: 2025-12-03 18:27:55 - 18:30:38
æ€»è€—æ—¶: ~3 åˆ†é’Ÿ

Part A ç»“æœ:
- K=2: Î”RÂ² = +0.0037 (å”¯ä¸€æ­£å¢ç›Š)
- K=3~6: Î”RÂ² < 0 (æ€§èƒ½ä¸‹é™)
- é‡‘å±è´« bin ([M/H] < -1.5) RÂ² æä½

Part B ç»“æœ:
- Oracle Î”RÂ² = +0.0037
- Pseudo Î”RÂ² = +0.0003
- Pseudo/Oracle = 7.3%
- [M/H] Predictor RÂ² = 0.9801
```

### 6.2.4 è°ƒè¯•è®°å½•ï¼ˆå¦‚æœ‰ï¼‰

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| Bootstrap CI ä¸å‡†ç¡® | CI è®¡ç®—æ–¹æ³•ä¸ç‚¹ä¼°è®¡ä¸ä¸€è‡´ | æš‚æ—¶è·³è¿‡ CIï¼Œç»“æœå·²è¶³å¤Ÿæ¸…æ™° |
| Plot å­—ä½“è­¦å‘Š | DejaVu Sans ç¼ºå°‘ emoji å­—ç¬¦ | ä¸å½±å“è¾“å‡º |

---

## 6.3 ç›¸å…³æ–‡ä»¶

| ç±»å‹ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| ä¸»æ¡†æ¶ | `logg/moe/moe_main_20251203.md` | main æ–‡ä»¶ |
| æœ¬æŠ¥å‘Š | `logg/moe/exp_moe_quantile_bins_sweep_20251203.md` | å½“å‰æ–‡ä»¶ |
| å‰ç½®å®éªŒ | `logg/moe/exp_moe_rigorous_validation_20251203.md` | MoE-1.1 |
| **ç›¸å…³å®éªŒ** | `logg/moe/exp_moe_conditional_ridge_20251203.md` | MVP-3.2 Conditional Ridge |
| **ç›¸å…³å®éªŒ** | `logg/moe/exp_moe_coefficient_analysis_20251203.md` | MVP-5.0 ç³»æ•°åˆ†æ |
| å›¾è¡¨ | `logg/moe/img/` | å®éªŒå›¾è¡¨ |
| å®éªŒä»£ç  | `scripts/moe_quantile_sweep.py` | å®éªŒè„šæœ¬ |

---

## 6.4 å®éªŒæ—¥å¿—

| æ—¶é—´ | äº‹ä»¶ | å¤„ç† |
|------|------|------|
| 2025-12-03 | åˆ›å»ºå®éªŒæ¡†æ¶ | - |
| 2025-12-03 18:27 | æ‰§è¡Œå®éªŒ | Part A + Part B å®Œæˆ |
| 2025-12-03 18:30 | ç”Ÿæˆå›¾è¡¨ | 2 å¼ å›¾è¡¨ä¿å­˜åˆ° logg/moe/img/ |
| 2025-12-03 18:35 | å¡«å†™æŠ¥å‘Š | **è´Ÿé¢ç»“æœ**ï¼š[M/H]-only æ–¹æ¡ˆå¤±è´¥ |

---

## ğŸ”— Cross-Repo Metadata

| Field | Value |
|-------|-------|
| **experiment_id** | `VIT-20251203-moe-quantile-01` |
| **project** | `VIT` |
| **topic** | `moe` |
| **source_repo_path** | `~/VIT/results/moe/` |
| **config_path** | `configs/moe_quantile.yaml` |
| **output_path** | `results/moe_quantile_sweep/` |

---

> **è®¾è®¡åŸåˆ™**ï¼šå‰ 300 è¡Œèƒ½å¿«é€Ÿäº†è§£å®éªŒæœ€é‡è¦çš„ä¿¡æ¯


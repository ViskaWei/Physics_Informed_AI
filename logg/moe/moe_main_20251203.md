# 📘 主实验框架：Mixture of Experts (MoE)

---
> **主题名称：** Mixture of Experts（MoE）要不要上？什么时候有用？  
> **作者：** Viska Wei  
> **创建日期：** 2025-12-03  
> **最后更新：** 2025-12-03 (Phase 3-5 路线图规划)  
> **状态：** 🔄 Phase 3 进行中：从"能不能涨" → "为什么涨、能不能落地、还能不能再涨"

---

## 🔗 跨仓库集成（Cross-Repo Integration）

### 相关实验索引

| experiment_id | project | 状态 | 对应 exp.md |
|---------------|---------|------|-------------|
| `VIT-20251203-moe-piecewise-01` | VIT | ✅ 完成 | [MoE-1: Piecewise Ridge](./exp_moe_piecewise_ridge_20251203.md) |
| `VIT-20251203-moe-snr-02` | VIT | ✅ 完成 | [MoE-2: Noise-conditioned](./exp_moe_noise_conditioned_20251203.md) |
| `VIT-20251203-moe-rigorous-01` | VIT | ✅ 完成 | [MoE-1.1: 严谨验证](./exp_moe_rigorous_validation_20251203.md) |
| `VIT-20251203-moe-nn-03` | VIT | ⏳ 计划中 | - |
| `VIT-20251203-moe-quantile-01` | VIT | ✅ 完成（负面结果） | [MoE-1.2: Quantile Bins](./exp_moe_quantile_bins_sweep_20251203.md) |
| `VIT-20251203-moe-pseudo-01` | VIT | ⏳ 计划中 | - |
| `VIT-20251203-moe-conditional-01` | VIT | ✅ 完成 | [MoE-D: Conditional Ridge](./exp_moe_conditional_ridge_20251203.md) |
| `VIT-20251203-moe-logg-gate-01` | VIT | ⏳ 计划中 | - |
| `VIT-20251203-moe-coef-01` | VIT | ✅ 完成 | [MVP-5.0: Ridge系数分析](./exp_moe_coefficient_analysis_20251203.md) |

### 仓库关联

| 仓库 | 相关目录 | 说明 |
|------|---------|------|
| VIT | `~/VIT/results/moe/` | 训练结果 |
| 本仓库 | `logg/moe/` | 知识沉淀 |

---

# 📑 目录

- [0. 📋 问题重述与意义澄清](#0--问题重述与意义澄清)
- [1. 🎯 目标](#1--目标)
- [2. 🗺️ MVP 实验路线图](#2-️-mvp-实验路线图)
- [3. 📋 子实验追踪](#3--子实验追踪)
- [4. 🔗 跨实验分析](#4--跨实验分析)
- [5. 📝 总结与展望](#5--总结与展望)
- [6. 📎 附录](#6--附录)

---

# 0. 📋 问题重述与意义澄清

## 0.1 核心研究问题

> **MoE（Mixture of Experts）在恒星参数预测任务中能否提升性能？什么条件下有用？**

据此推断：

> **如果 MoE 有用，应该在模型架构中引入多专家设计；如果没用，则应聚焦于单模型优化。**

### 0.1.1 统计学层面

**关键前提**：MoE **不能突破信息论上限**，只能在还没摸到天花板的时候，帮你更快、更稳、更高效地接近上限。

用数学语言表述：

设全局模型的预测为 $\hat{y}_{global}$，分区间模型的预测为 $\hat{y}_{MoE} = \sum_{k} \alpha_k \hat{y}_k$

如果：
$$
R^2_{MoE} > R^2_{global} + \epsilon \quad (\epsilon \geq 0.03)
$$

则说明**函数在参数空间是"分段简单"的**，MoE 架构有价值。

### 0.1.2 物理/领域层面

MoE 有效的物理场景：

1. **分段函数关系**：
   - 低 $T_{\text{eff}}$ / 高 $T_{\text{eff}}$ 下，谱线形状–$\log g$ 的关系不一样
   - 金属丰度极低/极高的星，$\log g$ 特征落在完全不同的波段

2. **混合噪声分布**：
   - 有些样本 SNR 很高，有些 SNR 很低
   - 部分波段 noise 特性完全不同（某些仪器段很差）

3. **数据分布不均匀**：
   - 某些参数区间样本很少，需要专门的专家

### 0.1.3 意义与启示

| 结果情况 | 含义 | 对设计的启示 |
|---------|------|-------------|
| 分区 Ridge $R^2$ 显著提升 (≥+0.03) | 函数是"分段简单"的 | 上 MoE，按物理参数分专家 |
| 分区 Ridge $R^2$ 提升有限 (<0.03) | 函数在参数空间较"平滑统一" | MoE 收益有限，优先优化单模型 |
| 按 SNR 分专家提升显著 | noise 分布是混合的 | 考虑 noise-conditioned MoE |
| 按 SNR 分专家提升有限 | noise 主要是整体 SNR 下降 | noise 不需要特殊处理 |

---

## 0.2 多维度分析

### 0.2.1 信息论角度

- MoE 本质是**条件分布建模**：$P(y|x, z)$ 其中 $z$ 是 gating 信号
- 如果 $P(y|x)$ 在不同 $z$ 下差异大，MoE 有收益
- 如果 $P(y|x)$ 对 $z$ 不敏感，MoE 只是增加模型复杂度

### 0.2.2 物理/领域知识角度

**恒星光谱 $\log g$ 预测的先验知识**：

| 参数区间 | 物理特性 | 对模型的影响 |
|---------|---------|-------------|
| 低 $T_{\text{eff}}$ (< 4500K) | 分子吸收线主导 | 特征落在不同波段 |
| 高 $T_{\text{eff}}$ (> 5500K) | 氢线主导 | 特征更集中 |
| 低金属丰度 | 金属线很弱 | 需要更高 SNR |
| 高金属丰度 | 金属线密集、blend | 需要不同的特征提取 |

### 0.2.3 模型设计角度

| 场景 | 不用 MoE | 用 MoE |
|------|-----------|-----------|
| 函数平滑统一 | ✅ 单模型足够 | ❌ 过度复杂 |
| 函数分段简单 | ❌ 欠拟合 | ✅ 各专家拟合子域 |
| 噪声均匀 | ✅ 单模型 | ❌ 不需要 |
| 噪声混合 | ❌ 被高噪声拉低 | ✅ SNR 分工 |

---

## 0.3 实验定位

### 价值

- **价值 1**：回答"MoE 是否值得在恒星参数预测中引入"
- **价值 2**：确定 MoE 有效的条件（按什么分专家）
- **价值 3**：为后续 NN-MoE 架构提供 baseline 和设计指导

### 局限

- **局限 1**：线性模型（Ridge）的分区实验不能完全代表 NN
- **局限 2**：分 bin 方式依赖先验知识，可能非最优
- **局限 3**：9 个 bin 可能数据不够，导致过拟合

**定位声明**：
> **本实验系列是「可行性探索」，目的是用低成本线性实验验证 MoE 的潜力，而非直接上复杂 NN-MoE。结论应理解为「MoE 是否值得投入更多资源」的初步判断。**

---

# 1. 🎯 目标

## 1.1 背景与动机

**研究背景**：
- MoE 架构可能帮助不同区间用不同专家，提升整体性能
- 但上 MoE 有代价：参数增多、训练复杂、可能过拟合

**核心目标**（勾选适用项）：
- [x] 指导神经网络架构设计
- [x] 理解光谱中 $\log g$ 的信息结构
- [x] 分离线性 / 非线性成分
- [x] 评估噪声、特征选择对天文参数估计的影响
- [ ] 量化某种特征/方法的信息上界
- [x] 其他：验证 MoE 架构的必要性

**一句话概括**：
> 通过分区间线性模型（Piecewise Ridge）和按 SNR 分专家实验，判断 MoE 在 $\log g$ 预测中是否有收益，为 NN-MoE 设计提供依据。

---

## 1.2 核心假设

### 主假设

> **$\log g$ 与光谱的映射关系在 $(T_{\text{eff}}, [\text{M/H}])$ 空间是"分段简单"的，分区间建模可显著提升预测性能。**

**如果假设成立，意味着**：
- 不同恒星类型需要不同的特征和模型
- MoE 架构值得投入
- 专家划分应基于 $(T_{\text{eff}}, [\text{M/H}])$

**如果假设不成立，则需要**：
- 放弃 MoE，聚焦单模型优化
- 考虑其他提升方向（如特征工程、噪声建模）

### 子假设（已验证）

| 编号 | 子假设 | 对应 MVP | 状态 |
|------|--------|---------|------|
| H1.1 | 按 $(T_{\text{eff}}, [\text{M/H}])$ 分 bin 后，每个 bin 内的最优 Ridge 比全局 Ridge 更好 | MVP-1 | ✅ 部分支持（高金属 bin 更好，低金属 bin 更差） |
| H1.2 | 9 个分区 Ridge 组合后的全局 $R^2$ 比单一全局 Ridge 高 ≥0.03 | MVP-1, MVP-1.1 | ✅ 验证通过（⚠️ 原 ΔR²=0.078 被高估，修正后 **ΔR²=0.050**，CI=[0.033,0.067]） |
| H1.3 | 按 SNR/noise level 分专家可提升混合噪声场景的性能 | MVP-2 | ✅ 验证通过（平均 ΔR²=+0.080） |
| **H2.1** | **Quantile bins 优于手工边界（100% coverage + 更均匀）** | MVP-3.0 | ❌ **否定**：K=2 唯一正增益(+0.004)，K≥3 负增益 |
| **H2.2** | **Pseudo gating 能保住 ≥70% Oracle 增益** | MVP-3.1 | ❌ **否定**：仅 7.3% |
| **H2.3** | **条件线性 $(x, m\cdot x, m^2\cdot x)$ 能接近 MoE 效果** | MVP-3.2 | ✅ **1st order 达到 80%** |
| **H2.4** | **log g pseudo gate 接近 oracle gate** | MVP-4.0 | ⏳ 待验证 |
| H3.1 | NN-MoE 可进一步提升分区间 Ridge 的效果 | MVP-6.1 | ⏳ 待验证 |

### 🔴 关键假设（Phase 7+ 待验证，决定"要不要上 NN-MoE"）

> **以下 4 个假设是下一阶段的核心检验点，将决定技术路线。**

| 编号 | 关键假设 | 可检验的子假设 | 对应 MVP | 状态 |
|------|---------|---------------|---------|------|
| **H-A** | 🔴 **门控误差是否真的是瓶颈？** | **H-A1**: 硬路由对 gate 误差极敏感；但**连续条件模型**对 gate 噪声更耐受（因此更可落地）<br>**H-A2**: 真正需要的 gate 不是 [M/H] 的回归值，而是某种**可从光谱直接学习的离散/软分区**（latent gate） | MVP-7.1 | ⏳ 最高优先级 |
| **H-B** | 🟡 **MoE 的"物理边界"可被学习到（无需手写、且优于 quantile）** | 存在一组可学习的 cutpoints / soft gating，在 (Teff,[M/H]) 或 latent space 上最大化分段线性效果（并避免 bin4/bin7 这种负增益区域） | MVP-7.4 | ⏳ 待验证 |
| **H-C** | 🟡 **Noise 不是"分档专家"，而是"连续条件化"问题** | 把 SNR/noise level 当连续输入（或 soft weights），能接近甚至超过按档专家的平均收益，并消除 noise=0.5 异常点 | MVP-7.3 | ⏳ 待验证 |
| **H-D** | 🟢 **最难子域（低金属+某些 Teff）需要"不同的特征/非线性"，而不仅仅是分段** | bin4/bin7 局部 R² 低于全局，需要（1）更强特征提取（窄窗口/线特征）；或（2）更非线性的专家 | MVP-7.4 | ⏳ 待验证（可选） |

**假设关系图**：
```
H-A 门控误差是瓶颈？
  │
  ├─ 是 → 连续条件化 (H-C) + 物理窗门控 (H-B)
  │
  └─ 否 → 可以继续硬 MoE，只需优化 gate
              │
              └─ H-D: 最难子域需要非线性专家
```

---

## 1.3 验证问题

| # | 问题 | 验证目标 | 预期结果 | 实际结果 |
|---|------|---------|---------|---------|
| Q1 | 分区 Ridge 的全局 $R^2$ vs 全局 Ridge $R^2$ 差多少？ | H1.2 | ≥+0.03 则 MoE 有价值 | ✅ **ΔR²=+0.050** @ noise=0.2（⚠️ 原 0.078 被高估，CI=[0.033,0.067]） |
| Q2 | 哪些 bin 的局部 Ridge $R^2$ 显著高于全局 Ridge？ | H1.1 | 低 $T_{\text{eff}}$ 和低 $[\text{M/H}]$ 区间 | ✅ **高金属丰度 bin (3,6,9)** 显著更高 (R²>0.96) |
| Q3 | 分 bin 后每个 bin 的样本量是否足够（>100）？ | 数据可行性 | 所有 bin ≥100 样本 | ✅ 所有 bin ≥2000 train, ≥59 test |
| Q4 | 按 noise level 分专家是否比单模型更好？ | H1.3 | 高 noise 区间提升明显 | ✅ **平均 ΔR²=+0.080**，noise=0/1.0 提升最大 |
| Q5 | 分区 Ridge 在不同 noise level 下的鲁棒性如何？ | noise 鲁棒性 | 分区模型更鲁棒 | ⚠️ MoE 在 noise ∈ [0.1, 0.5] 有效；noise=0 专家无法泛化 |
| **Q6** | **Quantile bins 的最佳 K 是多少？** | H2.1 | K∈[3,5] 存在最优点 | ❌ **K=2 唯一正增益(+0.004)**，K≥3 负增益 |
| **Q7** | **Pseudo gating 能保住 Oracle 增益的几成？** | H2.2 | ≥70% → MoE 可落地 | ❌ **仅 7.3%**，但原因是 [M/H]-only 方案失败 |
| **Q8** | **条件线性能达到 MoE 多少效果？** | H2.3 | ΔR² ≥ 0.04 可替代 MoE | ⏳ 待验证 |
| **Q9** | **log g oracle vs pseudo gate 差距多大？** | H2.4 | 差距小 → 门控不是瓶颈 | ⏳ 待验证 |

---

## 1.4 结论摘要（实验后填写）

### 1.4.1 已验证 Insights（I1-I7）

> **以下 7 条 Insights 已被实验结果稳健支持，可直接写入最终结论。**

| # | Insight | 关键数据 | 来源 | 设计启示 |
|---|---------|---------|------|---------|
| **I1** | ✅ **MoE 按 (Teff, [M/H]) 分段的收益是真实且稳定的** | ΔR²=+0.050, CI=[0.033,0.067]；大数据集 (100k/10k) 也复现 | MVP-1.1 | 映射在参数空间确实"分段更简单"，MoE 值得继续投 |
| **I2** | ✅ **收益主要来自金属丰度相关的结构差异**，而非 Teff 单独造成 | [M/H] 贡献 68.7%（ΔR²=+0.034），Teff 只有 42.9%（ΔR²=+0.021）；高金属 bin R²=0.97-0.98，bin4/bin7 负增益 | MVP-1.1 消融 | 后续门控/条件模型应**优先对齐 [M/H]** |
| **I3** | ❌ **分位数分桶（quantile bins）在当前设定下基本不工作** | K=2 仅 +0.004，K≥3 变成负增益 | MVP-3.0 | 有效边界是"物理阈值/结构转折点"，不是等频切分 |
| **I4** | ⚠️ **"可落地门控"是最大风险点**：Pseudo gating 只保住 7.3% Oracle 增益 | Pseudo gating R² 远低于 Oracle | MVP-3.1 (Q7) | 硬 MoE 可能被门控误差吃掉收益；需提升 gate 或换更耐噪的条件建模 |
| **I5** | ✅ **Conditional Ridge 已证明 MoE 大头收益来自"系数随 [M/H] 连续变化"** | Conditional Ridge 1st-order R²=0.9018，约为 MoE 收益的 80% | MVP-3.2 | **连续条件模型**可能是更工程化的主线（更抗门控误差） |
| **I6** | ⚠️ **Noise-conditioned 专家"很值钱"，但离散分档不稳定** | 平均 ΔR²=+0.080；但 noise=0.5 专家反而比 mixed 差（-0.031） | MVP-2.0 | 应做"连续 SNR 条件化/soft mixture"，而非硬分 5 档 |
| **I7** | ✅ **解释性线索已出现**：Ca II triplet 重要，高 [M/H] 信息更"分散" | Ca II 1.65×；高 [M/H] 能量分散 7-12%，低 [M/H] 集中 22-31% | MVP-5.0 | 高 [M/H] 需更广窗口/多区域聚合；低 [M/H] 需窄窗口/高分辨特征 |

### 1.4.2 核心决策句（Phase 7+ 方向）

> **下一步最该押注的是：连续条件化（Conditional++）+ 连续噪声条件化（SNR-conditioned），而不是直接上复杂 NN-MoE。**

**理由**：
- ✅ 已证明"分段确实有结构"（ΔR²≈0.05 稳健）
- ⚠️ 但"离散门控难落地"（pseudo 7.3%，quantile 失败）
- ✅ Conditional Ridge 已达 MoE 80%，且无分桶边界、100% coverage

### 1.4.3 设计启示（已确认）

| 设计原则 | 具体建议 | 证据来源 |
|---------|---------|----------|
| **优先按 [M/H] 分专家** | [M/H] 贡献 68.7%，3 个 [M/H] 专家可获得 69% 收益 | MVP-1.1 消融 (I2) |
| **连续条件优于离散门控** | Conditional Ridge 更抗门控误差，且 100% coverage | MVP-3.2 (I5) |
| **Noise 应连续条件化** | 离散分档在 noise=0.5 翻车；连续 SNR 更稳定 | MVP-2.0 (I6) |
| 按金属丰度分专家 | $[\text{M/H}]$ 影响谱线强度，决定 log g 特征可提取性 | MVP-1.0 各 bin R² 对比 |
| Noise-matched 训练 | 部署时需知道 SNR，选择对应专家 | MVP-2.0 cross-noise 分析 |
| 默认用高噪声专家 | 如果 SNR 未知，用高噪声专家更安全 | MVP-2.0 泛化分析 |
| 公平比较 | 评估时用 mask-aligned 方法，确保 Global 和 MoE 在同一 subset 上比较 | MVP-1.1 |

### 1.4.4 关键数字速查

| 指标 | 值 | 备注 |
|------|-----|------|
| 全局 Ridge $R^2$ (baseline) | **0.8616** | noise=0.2, mask-aligned |
| 分区 Ridge $R^2$ (MoE-1) | **0.9116** | noise=0.2, mask-aligned |
| $\Delta R^2$ (MoE-1) **修正值** | **+0.050** | ⚠️ 原 0.078 被高估 |
| 95% CI | **[0.033, 0.067]** | 完全 > 0.03，效果稳健 |
| [M/H] 贡献比 | **68.7%** | 主要来源 |
| Teff 贡献比 | 42.9% | 次要 |
| Conditional Ridge 1st-order $R^2$ | **0.9018** | 达 MoE **80%** |
| Noise Expert 平均 $\Delta R^2$ | **+0.0797** | ✅ Noise MoE 有价值 |
| Pseudo Gating 保留率 | **7.3%** | ⚠️ 硬门控风险点 |

> **一句话总结**：MoE 效果稳健（ΔR²=0.050），[M/H] 贡献 68.7% 是主要来源；但硬门控难落地（pseudo 7.3%），**下一步应押注连续条件化**（Conditional++ + SNR-conditioned）而非 NN-MoE。

---

# 2. 🗺️ MVP 实验路线图

## 2.1 整体规划

### 实验分组

| Phase | 目的 | 包含 MVP | 状态 |
|-------|------|---------|------|
| **Phase 0: Baseline** | 确认全局 Ridge baseline | MVP-0 | ✅ 已完成 |
| **Phase 1: 分区间 Ridge (MoE-1)** | 验证"分段简单"假设 | MVP-1.x | ✅ 已完成 |
| **Phase 2: 按 SNR 分专家 (MoE-2)** | 验证 noise-conditioned MoE | MVP-2.0 | ✅ 已完成 |
| **Phase 3: 可落地性验证** | Quantile bins + Pseudo gating | MVP-3.x | ✅ 已完成（负面结果） |
| **Phase 4: log g 门控上限** | Oracle/Pseudo/Learned gate | MVP-4.0 | ⏳ 计划中 |
| **Phase 5: 系数解释** | Ridge 系数波段分析 | MVP-5.0 | ✅ 已完成 |
| **Phase 6: NN-MoE** | 如果可落地，上 NN-MoE | MVP-6.x | ⏳ 计划中 |
| **🆕 Phase 7: 连续条件化** | 从离散 MoE → 连续条件模型 | **MVP-7.x** | 🔴 **当前执行** |

### 依赖关系图（更新版）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        MVP 实验依赖图 (Phase 7 重点)                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Phase 0-2: 已验证 MoE 有结构 (ΔR²=0.050)                              │
│         │                                                               │
│         ▼                                                               │
│   Phase 3: 可落地性验证 → ❌ Pseudo 7.3%, Quantile 失败                  │
│         │                                                               │
│         ▼                                                               │
│   Phase 5: 系数解释 → ✅ Ca II 重要, [M/H] 差异化特征                     │
│         │                                                               │
│         ├────────────────────────────────────────────────┐              │
│         ▼                                                ▼              │
│   [MVP-7.1: Gate 噪声敏感性] 🔴                   [MVP-7.3: Noise 连续化]│
│   → 决定"硬 MoE 还能不能救"                        → 修复 noise=0.5 异常 │
│         │                                                │              │
│         ▼                                                │              │
│   [MVP-7.2: Conditional Ridge++]                         │              │
│   → 榨出剩余 20% MoE 差距                                │              │
│         │                                                │              │
│         └────────────────────┬───────────────────────────┘              │
│                              ▼                                          │
│   [MVP-7.4: 物理窗门控] (可选，当想上 NN 时)                             │
│         │                                                               │
│         ▼                                                               │
│   Phase 6: NN-MoE (仅当 Phase 7 验证门控可行时)                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2.2 MVP 详细设计

### Phase 0: Baseline

#### MVP-0: 全局 Ridge Baseline

| 项目 | 配置 |
|------|------|
| **目标** | 获取全局 Ridge 在各 noise level 下的 baseline $R^2$ |
| **数据** | 全量训练/测试集 |
| **模型** | Ridge 回归，扫描 $\alpha$ |
| **验收标准** | 获得 noise=0/0.1/0.5/1.0 下的 $R^2$ |
| **早停条件** | - |

**备注**：可以复用 `logg/ridge/` 中已有的实验结果。

---

### Phase 1: 分区间 Ridge (MoE-1)

#### MVP-1.0: Piecewise Ridge（分区间线性模型）🔴 当前执行

| 项目 | 配置 |
|------|------|
| **目标** | 验证按 $(T_{\text{eff}}, [\text{M/H}])$ 分 bin 后，分区 Ridge 是否比全局 Ridge 更好 |
| **数据** | 全量数据，按 $(T_{\text{eff}}, [\text{M/H}])$ 分 bin |
| **分 bin 方案** | $T_{\text{eff}} \in [3750, 4500), [4500, 5250), [5250, 6000]$; $[\text{M/H}] \in [-2, -1), [-1, 0.0], (0.0, 0.5]$ → 3×3=9 bins |
| **模型** | 每个 bin 单独训练 Ridge，扫描 $\alpha$ 找最优 |
| **验收标准** | 分区 Ridge 的全局 $R^2$ vs 全局 Ridge $R^2$；若 $\Delta R^2 \geq 0.03$，则 MoE 有价值 |
| **异常处理** | 若某 bin 样本 <100，考虑合并相邻 bin |

**→ 对假设的影响**：
- 若 $\Delta R^2 \geq 0.03$，支持 H1.2，MoE 值得投入
- 若 $\Delta R^2 < 0.03$，否定 H1.2，MoE 在此设定下收益有限

**实验步骤**：
1. 统计每个 bin 的样本数量
2. 在每个 bin 上分别训练 Ridge，扫描 $\alpha \in [0.001, 0.01, 0.1, 1, 10, 100]$
3. 记录每个 bin 的最优 $\alpha$ 和对应 $R^2$
4. 在 test set 上，用对应区间的 Ridge 做预测
5. 计算全局 $R^2$ 并与全局 Ridge 对比

---

### Phase 2: 按 SNR 分专家 (MoE-2)

#### MVP-2.0: Noise-conditioned Ridge

| 项目 | 配置 |
|------|------|
| **目标** | 验证为每个 noise level 单独训练模型是否比混合训练更好 |
| **数据** | 分别用 noise=0.0/0.1/0.5/1.0 的数据训练 |
| **模型** | 每个 noise level 一个 Ridge |
| **验收标准** | 对应 noise level 的专家 vs 单一混合模型的 $R^2$ 对比 |

**→ 对假设的影响**：
- 若提升显著，说明 noise 分布混合，需要 noise-conditioned MoE
- 若提升有限，说明 noise 主要只是整体 SNR 下降，单模型足够

---

### Phase 3: 从手工分桶到可落地门控（MoE-1.2）🔴 当前执行

> **核心问题**：如果不给真值 [M/H]，仅用光谱还能不能拿到大部分增益？

#### MVP-3.0: Quantile Bins Sweep（分位数分桶）

| 项目 | 配置 |
|------|------|
| **目标** | 用分位数分桶解决 coverage 问题（从 81.6% → 100%），找最佳 K |
| **数据** | [M/H] quantile bins，K = 2,3,4,5,6 |
| **模型** | 每个 bin 独立 Ridge + Bootstrap CI |
| **验收标准** | 找到最佳 K，看 ΔR² vs K 曲线形状 |
| **硬阈值** | n_test_bin < 30 自动合并相邻 bin |

**→ 预期结果**：存在最佳 K∈[3,5]，太粗学不到结构、太细方差爆炸

---

#### MVP-3.1: Pseudo Gating（伪 Oracle 门控）🔴 强推

| 项目 | 配置 |
|------|------|
| **目标** | 验证可落地性：用 $\widehat{[M/H]}$ 分桶能保住 Oracle 多少增益 |
| **对照链** | Oracle (真值 [M/H]) vs Pseudo (全局模型预测 $\widehat{[M/H]}$) |
| **模型** | 先训练全局 Ridge 预测 [M/H]，再用预测值分桶选专家 |
| **验收标准** | Pseudo ≥ 70% Oracle 增益 → MoE 可落地；< 50% → 门控是瓶颈 |

**流程**：
1. 训练全局 Ridge: $\widehat{[M/H]} = f_{global}(\text{flux})$
2. 用 $\widehat{[M/H]}$ 的 quantile 分桶
3. 每个 bin 训练专家 Ridge
4. 预测时：先预测 $\widehat{[M/H]}$ → 选专家 → 输出 log g

---

#### MVP-3.2: Conditional Ridge / FiLM（条件线性）

| 项目 | 配置 |
|------|------|
| **目标** | 逼近"系数随 [M/H] 连续变化"，看能否干掉 MoE |
| **特征扩展** | $\phi(x, m) = [x,\; m\cdot x,\; m^2\cdot x]$，其中 $m=[M/H]$ |
| **模型** | 对 $\phi$ 做一次 Ridge：$\hat{y} = w_0^T x + m \cdot w_1^T x + m^2 \cdot w_2^T x$ |
| **验收标准** | 如果 ΔR² ≥ 0.04（接近 MoE），则用更简单的方法 |

**优点**：无分桶边界、100% coverage、训练一次、不需要 gate

---

### Phase 4: log g 门控上限分析

> **核心问题**：如果门控完美，"分段线性"最多还能榨出多少性能？

#### MVP-4.0: Oracle/Pseudo/Learned Gate 三件套

| 项目 | 配置 |
|------|------|
| **目标** | 确定"门控上限"和"实际可达"差距 |
| **对照** | (1) Oracle gate by true log g (上限) |
|          | (2) Pseudo gate by $\hat{y}_{global}$ (可落地版) |
|          | (3) Learned gate from flux (真正端到端) |
| **验收标准** | 如果 (2) 接近 (1) → 门控噪声不是瓶颈；反之 → 精力放在 gate |

---

### Phase 5: 系数解释与物理洞见

> **核心问题**：为什么高 [M/H] 更容易学？能否指导 NN 设计？

#### MVP-5.0: Ridge 系数波段分析

| 项目 | 配置 |
|------|------|
| **目标** | 分析不同专家的 Ridge 系数 $w_k(\lambda)$，找物理解释 |
| **分析** | (1) $\|w\|$ 能量分布；(2) $w_{highMH} - w_{lowMH}$ 差分波段 |
| **产出** | 低金属→靠 H 线/连续谱？高金属→靠金属线群？|
| **设计启示** | NN 可做 window attention / 多分辨率 |

---

### Phase 6: NN-MoE（仅当 Phase 3-5 验证通过）

#### MVP-6.0: 最小 Learned Gate

| 项目 | 配置 |
|------|------|
| **依赖** | MVP-3.1 (Pseudo) 结果足够好 |
| **目标** | 用最小 learned gate 替代手工分桶 |
| **Gate** | 预测 K 个 [M/H] 专家权重（softmax）|
| **Expert** | 还是 Ridge（先别换 NN）|
| **验收标准** | Learned gate ≥ Pseudo gate |

---

#### MVP-6.1: 简单 NN-MoE

| 项目 | 配置 |
|------|------|
| **目标** | 上一个克制版 NN-MoE，验证非线性 MoE 是否进一步提升 |
| **Gating 网络输入** | 元信息 $(T_{\text{eff}}, [\text{M/H}], \text{SNR})$ + 少量全局谱特征（均值、方差、几个 PCA 分量）|
| **Gating 输出** | 对 K=2~4 个专家的权重 $\alpha_1, ..., \alpha_K$ |
| **专家网络** | 复用已有 MLP/CNN variant |
| **最终输出** | $\hat{y} = \sum_{k=1}^{K} \alpha_k \hat{y}_k$ |
| **训练策略** | MSE 损失 + gating entropy 正则；可先 hard 分组预训练 |

---

### 🆕 Phase 7: 连续条件化（从离散 MoE → 连续条件模型）🔴 当前执行

> **核心思路**：既然 Pseudo gating 只有 7.3%，Quantile bins 失败，那就**放弃离散路由**，转向**连续条件化**。

#### MVP-7.1: Gate 噪声敏感性曲线（🔴 最高优先级）

> **目的**：量化"门控误差"对 MoE/Conditional 的伤害差异，**决定"硬 MoE 还能不能救"**

| 项目 | 配置 |
|------|------|
| **目标** | 量化 gate 噪声对 Hard MoE vs Conditional Ridge 的影响差异 |
| **假设** | H-A1: 连续条件模型对 gate 噪声更耐受 |
| **方法** | 用真值 $m=[\text{M/H}]$ 作为条件输入时的性能作为上限；然后对 $m$ 注入逐级噪声 $\tilde{m} = m + \epsilon,\ \epsilon \sim \mathcal{N}(0, \sigma^2)$，$\sigma \in \{0.0, 0.1, 0.2, 0.5, 1.0\}$ |
| **对比** | (1) Hard MoE（按 $\tilde{m}$ 分桶）<br>(2) Conditional Ridge（用 $\tilde{m}$ 做连续条件项） |
| **验收标准** | 如果 Conditional 在较大 $\sigma$ 下仍能保住 ≥60-80% 增益，而 Hard MoE 快速崩：**主线转向条件化/FiLM，放弃离散 routing** |
| **止损点** | 如果两者都快速崩 → 说明 gate 本身就不靠谱，需要 latent gate (H-A2) |

**→ 这一步会直接解释 pseudo gating 7.3% 的根因（hard routing 太脆 or gate 太差）**

---

#### MVP-7.2: Conditional Ridge++（榨出剩下的 20% MoE 差距）

> **目的**：你已经到 80% 了（R²=0.9018），剩下的差距可能来自 Teff 交互项/二阶项

| 项目 | 配置 |
|------|------|
| **目标** | 把 Conditional Ridge 从 80% → 90%+ MoE 效果 |
| **假设** | 剩余差距来自 Teff 交互项/二阶项/更合理的缩放 |
| **方法** | 逐步加特征，不要一下子全上：<br>(1) 加 Teff 一阶交互：$[x,\ m\cdot x,\ t\cdot x]$<br>(2) 再加交叉项：$[x,\ m\cdot x,\ t\cdot x,\ (m\cdot t)\cdot x]$<br>(3) 最后考虑二阶（如果 1/2 不够）：$[m^2\cdot x]$ |
| **验收标准** | 在 noise=0.2 上，达到 MoE 的 **≥90% 增益**（即 $\Delta R^2 \geq 0.045$），并保持 **100% coverage** |
| **止损点** | 如果 Teff 交互项带来 <0.01 提升 → 说明 Teff 真的不重要，只做 [M/H] 条件化 |

---

#### MVP-7.3: Noise 连续条件化（替代"按档专家"，修复 noise=0.5 异常）

> **目的**：你已证明 noise-matched 强（平均 ΔR²≈+0.08），但离散分档在 noise=0.5 翻车

| 项目 | 配置 |
|------|------|
| **目标** | 用连续 SNR/noise 条件化替代离散分档专家 |
| **假设** | H-C: 连续条件化能接近甚至超过按档专家的平均收益，并消除 noise=0.5 异常 |
| **方法** | 把 noise level / SNR 当连续变量 $n$，做条件线性：<br>(1) $[x,\ n\cdot x]$<br>(2) $[x,\ n\cdot x,\ n^2\cdot x]$ |
| **对比** | per-noise expert、mixed、continuous-conditioned |
| **验收标准** | 平均性能接近 expert（差 ≤0.01 R²），并且在 **noise=0.5 上不掉队**（消除 -0.031 翻车） |
| **止损点** | 如果连续化效果 < mixed → 说明 noise 确实需要离散化处理 |

---

#### MVP-7.4: "物理窗"诱导的轻量门控/专家（可选，当你想上 NN 时再做）

> **目的**：你已有解释线索（Ca II 重要，高 [M/H] 更分散），可以用来设计更好的 gate

| 项目 | 配置 |
|------|------|
| **目标** | 用物理先验设计轻量 gate，验证 learned gate 是否比 pseudo gate 更好 |
| **假设** | H-B: 存在可学习的物理边界/soft gating |
| **方法** | Gate 输入只用几个"物理窗"的统计特征：<br>- Ca II triplet window 的 line depth/等效宽度 proxy<br>- 若干窗的 PCA 分量<br>Expert 仍然是线性/小 MLP |
| **验收标准** | Learned gate **≥ pseudo gate**，且能**明显超过 conditional ridge++** 才值得继续往 NN-MoE 深挖 |
| **止损点** | 如果 learned gate ≈ conditional ridge++ → 直接用 conditional，放弃 NN-MoE |

---

## 2.3 实验配置总览

| MVP | 数据规模 | 特征维度 | 模型 | 关键变量 | 验收标准 |
|-----|---------|---------|------|---------|---------|
| MVP-0 | 全量 | 全谱 | Ridge | $\alpha$ | 获得 baseline |
| MVP-1.0 | 分 9 bin | 全谱 | 9× Ridge | $(T_{\text{eff}}, [\text{M/H}])$ bin | $\Delta R^2 \geq 0.03$ |
| MVP-1.1 | 分 9 bin | 全谱 | 9× Ridge | mask-aligned | CI 验证 |
| MVP-2.0 | 按 noise 分 | 全谱 | 5× Ridge | noise level | 专家 vs 混合 |
| MVP-3.0 | quantile bins | 全谱 | K× Ridge | K=2~6 | 最佳 K，100% coverage |
| MVP-3.1 | quantile bins | 全谱 | K× Ridge | pseudo vs oracle | ≥70% Oracle 增益 |
| MVP-3.2 | 全量 | $3\times$全谱 | 条件 Ridge | $(x, m\cdot x, m^2\cdot x)$ | ΔR² ≥ 0.04 |
| MVP-4.0 | 全量 | 全谱 | Ridge | log g gate | 上限 vs 可达 |
| MVP-5.0 | 全量 | 系数分析 | - | 波段差分 | 物理解释 |
| MVP-6.0 | 全量 | 全谱 | learned gate | softmax gate | ≥ Pseudo |
| MVP-6.1 | 全量 | 全谱 + meta | NN-MoE | K 专家数 | $R^2$ > 分区 Ridge |
| **🆕 MVP-7.1** | 全量 | 全谱 | Hard MoE vs Cond | gate noise $\sigma$ | Cond 保住 ≥60-80% |
| **🆕 MVP-7.2** | 全量 | 扩展特征 | Cond Ridge++ | Teff 交互项 | ≥90% MoE 增益 |
| **🆕 MVP-7.3** | 全量 | 全谱 | SNR-cond Ridge | 连续 noise | 消除 noise=0.5 翻车 |
| **🆕 MVP-7.4** | 全量 | 物理窗特征 | 物理窗 gate | Ca II, PCA | ≥ Cond Ridge++ |

---

# 3. 📋 子实验追踪

## 3.1 实验总览

| MVP | 实验名称 | 状态 | 报告链接 | 核心结论（一句话） |
|-----|---------|------|---------|------------------|
| MVP-0 | 全局 Ridge Baseline | ✅ 已完成 | (包含在 MVP-1.0) | R²=0.834 @ noise=0.2 |
| MVP-1.0 | Piecewise Ridge (MoE-1) | ✅ 已完成 | [exp_moe_piecewise_ridge](./exp_moe_piecewise_ridge_20251203.md) | ⚠️ 原 ΔR²=0.078 被高估 → 见 MVP-1.1 |
| MVP-1.1 | 严谨验证 (Robustness) | ✅ 已完成 | [exp_moe_rigorous_validation](./exp_moe_rigorous_validation_20251203.md) | 修正 ΔR²=0.050, CI=[0.033,0.067], [M/H] 贡献 69% |
| MVP-2.0 | Noise-conditioned Ridge (MoE-2) | ✅ 已完成 | [exp_moe_noise_conditioned](./exp_moe_noise_conditioned_20251203.md) | ΔR²=+0.080, 必须 noise-matched |
| MVP-3.0 | Quantile Bins Sweep | ✅ 已完成 | [exp_moe_quantile_bins_sweep](./exp_moe_quantile_bins_sweep_20251203.md) | ❌ K=2 唯一正增益(+0.004)，K≥3 负增益 |
| MVP-3.1 | Pseudo Gating | ✅ 已完成 | - | ❌ 仅 7.3% Oracle 增益 |
| MVP-3.2 | Conditional Ridge | ✅ 已完成 | [exp_moe_conditional_ridge](./exp_moe_conditional_ridge_20251203.md) | ✅ 1st order R²=0.9018, 达 MoE 80% |
| MVP-4.0 | log g Gate Analysis | ⏳ 计划中 | - | 门控上限分析 |
| MVP-5.0 | Ridge 系数解释 | ✅ 已完成 | [exp_moe_coefficient_analysis](./exp_moe_coefficient_analysis_20251203.md) | Ca II 1.65×，高[M/H]分散7-12% |
| MVP-6.0 | Learned Gate | ⏳ 计划中 | - | 最小端到端门控 |
| MVP-6.1 | NN-MoE | ⏳ 计划中 | - | 非线性 MoE |
| **🆕 MVP-7.1** | **Gate 噪声敏感性曲线** | 🔴 **待执行** | [exp_moe_gate_noise_sensitivity](./exp_moe_gate_noise_sensitivity_20251203.md) | 决定"硬 MoE 还能不能救" |
| **🆕 MVP-7.2** | **Conditional Ridge++** | ⏳ 计划中 | [exp_moe_conditional_ridge_pp](./exp_moe_conditional_ridge_pp_20251203.md) | 榨出剩余 20% MoE 差距 |
| **🆕 MVP-7.3** | **Noise 连续条件化** | ⏳ 计划中 | [exp_moe_noise_continuous](./exp_moe_noise_continuous_20251203.md) | 修复 noise=0.5 异常 |
| 🆕 MVP-7.4 | 物理窗门控 | ⏳ 计划中 | - | 可选，当想上 NN 时再做 |

## 3.2 进度看板

```
┌──────────────┬──────────────┬──────────────┬──────────────┐
│   ⏳ 计划中   │  🔴 待执行   │   ✅ 已完成   │   ❌ 已取消   │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ MVP-4.0      │ MVP-7.1 ←🔴  │ MVP-0        │              │
│ MVP-6.0      │ MVP-7.2      │ MVP-1.0      │              │
│ MVP-6.1      │ MVP-7.3      │ MVP-1.1 ✓    │              │
│ MVP-7.4      │              │ MVP-2.0      │              │
│              │              │ MVP-3.0 ✓    │              │
│              │              │ MVP-3.1 ❌   │              │
│              │              │ MVP-3.2 ✓    │              │
│              │              │ MVP-5.0 ✓    │              │
└──────────────┴──────────────┴──────────────┴──────────────┘

优先级排序（按"最少新增复杂度 → 最大信息增量"）：
1. MVP-7.1 🔴 → 决定技术路线
2. MVP-7.2 → 榨出 Conditional 极限
3. MVP-7.3 → 修复 noise 异常
4. MVP-7.4 → 可选，上 NN 时再做
```

## 3.3 结论提取记录

| 日期 | 来源实验 | 提取的核心结论 | 更新到 main 的位置 |
|------|---------|---------------|-------------------|
| 2025-12-03 | exp_moe_piecewise_ridge | ⚠️ 原报告 ΔR²=+0.078 被高估，见 MVP-1.1 修正 | §1.4, §4 |
| 2025-12-03 | exp_moe_noise_conditioned | Noise-matched expert 必要，平均 ΔR²=+0.080 | §1.4, §4 |
| 2025-12-03 | exp_moe_rigorous_validation | ⚠️ **原 ΔR²=0.078 被高估**，修正后 ΔR²=0.050，CI=[0.033,0.067]，仍稳健；[M/H] 贡献 69% | §1.4, §4, §5 |
| 2025-12-03 | 大数据集验证 (100k/10k) | ✅ **ΔR²=0.050 在大数据集上验证通过**，CI=[0.045,0.055] 完全 > 0.03 | §6.2 |
| 2025-12-03 | exp_moe_quantile_bins_sweep | 🔄 **进行中**：Quantile bins + Pseudo gating + Conditional Ridge | §2, §3, §5.4 |
| 2025-12-03 | exp_moe_coefficient_analysis | ✅ **MVP-5.0 完成**：Ca II triplet 重要性 1.65×；高[M/H] 能量分散 7-12%，低[M/H] 集中 22-31% | §3, §4, §5 |

---

# 4. 🔗 跨实验分析

## 4.1 结果对比矩阵

| MVP | 最佳 $R^2$ | 最佳配置 | vs Baseline | 关键发现 |
|-----|-----------|---------|-------------|---------|
| MVP-0 (全局 Ridge) | 0.8616 | α=10.0, noise=0.2 | - | baseline (mask-aligned) |
| MVP-1.0 (分区 Ridge) | **0.9116** | 9 bins, noise=0.2 | **+0.050** | ⚠️ 原 +0.078 被高估 |
| MVP-1.1 (严谨验证) | - | mask-aligned | CI=[0.033,0.067] | [M/H] 贡献 68.7% |
| MVP-2.0 (SNR 分专家) | **0.7723** | matched expert, 5 noise | **+0.080** | noise=0 专家不能泛化！ |

## 4.2 假设验证进度

| 子假设 | 验证 MVP | 结果 | 结论 |
|--------|---------|------|------|
| H1.1 | MVP-1.0 | ✅ 部分支持 | 高金属 bin 显著优于全局；低金属 bin 反而更差 |
| H1.2 | MVP-1.0, MVP-1.1 | ✅ 验证通过 | ⚠️ 原 ΔR²=0.078 被高估，修正后 **ΔR²=0.050**，CI=[0.033,0.067]，仍 ≥ 0.03 |
| H1.3 | MVP-2.0 | ✅ 验证通过 | ΔR²=+0.080 ≥ 0.03，noise-matched expert 有价值 |
| H1.4 | MVP-3.0 | ⏳ 待验证 | - |

## 4.3 发现汇总

### 一致性发现（多个实验支持）

| 发现 | 支持实验 | 置信度 |
|------|---------|--------|
| MoE 效果稳健 (ΔR²=0.050, CI 完全 > 0.03) | MVP-1.0, MVP-1.1 | 🟢 高 |
| **[M/H] 是 MoE 主要贡献者 (68.7%)** | MVP-1.1 | 🟢 高 |
| 高金属丰度星更容易预测 log g | MVP-1.0 | 🟢 高 |
| Noise-matched training 是必要的 | MVP-2.0 | 🟢 高 |
| noise=0 专家无法泛化到有噪声数据 | MVP-2.0 | 🟢 高 |
| 高噪声专家可以泛化到低噪声 | MVP-2.0 | 🟢 高 |

---

# 5. 📝 总结与展望

## 5.1 核心结论

**MoE 在 log g 预测任务中效果稳健**，两个维度的 MoE 都验证通过：

| MoE 类型 | 分专家维度 | ΔR² | 95% CI | 结论 |
|---------|-----------|-----|--------|------|
| **MoE-1 (Piecewise)** | $(T_{\text{eff}}, [\text{M/H}])$ | **+0.050** | [0.033, 0.067] | ✅ 稳健（⚠️ 原 0.078 被高估） |
| **MoE-2 (Noise-cond)** | noise level | **+0.080** | - | ✅ 有价值 |

**核心发现**：
1. ⚠️ **原 ΔR²=0.078 被高估**：因不公平比较（MoE 评估 81.6% 样本 vs Global 100%），修正后 ΔR²=0.050
2. **[M/H] 是 MoE 主要贡献者**：[M/H] 贡献 68.7%，Teff 贡献 42.9%，3 个 [M/H] 专家可获得 69% 收益
3. **Noise-matched 训练是必要的**：noise=0 专家在有噪声数据上完全失效 (R² < 0)
4. **高噪声专家可泛化**：noise=1.0 专家在 noise=0 下仍有 R²=0.63

## 5.2 设计原则提炼

| # | 原则 | 具体建议 | 来源 |
|---|------|---------|------|
| 1 | **优先按 [M/H] 分专家** | [M/H] 贡献 68.7%，3 个 [M/H] 专家可获得 69% 收益 | MoE-1.1 消融 |
| 2 | **Noise-matched 训练** | 部署时必须知道 SNR，选择对应专家 | MoE-2 |
| 3 | **默认用高噪声专家** | 如果 SNR 未知，用 noise=1.0 专家比 noise=0 专家安全 | MoE-2 cross-noise |
| 4 | **公平比较** | 评估时用 mask-aligned 方法，确保同一 subset 上比较 | MoE-1.1 |
| 4 | **不同专家用不同正则化** | 高金属/低噪声用小 α，低金属/高噪声用大 α | MoE-1/2 |
| 5 | **组合 MoE-1 + MoE-2** | 三维 gating $(T_{\text{eff}}, [\text{M/H}], \text{SNR})$ 可能更优 | 综合 |

## 5.3 遗留问题

| 问题 | 优先级 | 建议后续实验 |
|------|--------|-------------|
| 分 bin 边界是否最优？ | 🟡 中 | 可尝试自适应聚类 |
| 如何处理跨 bin 边界的样本？ | 🟡 中 | soft gating |
| noise=0.5 时 Expert 为何略逊于 Mixed？ | 🟡 中 | 可能需要更细粒度的 noise 划分 |
| 如何在部署时估计 SNR？ | 🔴 高 | 从光谱估计 SNR 的方法研究 |
| 低金属丰度 bin 为何效果差？ | 🟡 中 | 可能需要更高维特征或非线性模型 |

## 5.4 下一步计划

> **核心思路**：从"能不能涨" → "**为什么涨、能不能落地、还能不能再涨**"三条线并行

### ✅ 已完成

| 方向 | 任务 | 结果 |
|------|------|------|
| MVP-1.1 严谨验证 | ΔR²=0.050，CI=[0.033,0.067] | ✅ MoE 效果稳健 |
| P1 消融 | [M/H] 贡献 68.7%，Teff 贡献 42.9% | ✅ [M/H] 是主导因素 |

### 🔄 当前执行（按优先级排序）

| 方向 | 具体任务 | 预计时间 | 优先级 | MVP |
|------|----------|---------|--------|-----|
| **Quantile Bins Sweep** | [M/H] K=2~6 分位数分桶 + Bootstrap CI | 2h | 🔴 P0 | MVP-3.0 |
| **Pseudo Gating** | 用 $\widehat{[M/H]}$ 做 gate，验证可落地性 | 2h | 🔴 P0 | MVP-3.1 |
| **Conditional Ridge** | $(x, m\cdot x, m^2\cdot x)$ 特征扩展 | 1h | 🔴 P0 | MVP-3.2 |
| **log g Gate 上限** | Oracle/Pseudo/Learned 三件套 | 2h | 🟡 P1 | MVP-4.0 |

### ⏳ 后续计划

| 方向 | 具体任务 | 预计时间 | 优先级 | MVP |
|------|----------|---------|--------|-----|
| 系数解释 | Ridge 系数波段分析，找物理洞见 | 2h | 🟡 P1 | MVP-5.0 |
| Learned Gate | 最小端到端门控（仅当 Pseudo 效果好） | 3h | 🟡 P1 | MVP-6.0 |
| NN-MoE | 非线性 MoE（仅当 Phase 3-5 通过） | 4h | 🟢 P2 | MVP-6.1 |
| 组合 MoE-1 + MoE-2 | 三维 gating $(T_{\text{eff}}, [\text{M/H}], \text{SNR})$ | 3h | 🟢 P2 | - |

### 决策点

| 实验结果 | 下一步行动 |
|---------|-----------|
| Pseudo ≥ 70% Oracle | → 继续 Learned Gate (MVP-6.0) |
| Pseudo < 50% Oracle | → 停！门控是瓶颈，先优化 gate |
| Conditional Ridge ≈ MoE | → 直接用条件线性，放弃 MoE |
| log g pseudo ≈ oracle | → 门控噪声不是瓶颈，优化 expert |

---

# 6. 📎 附录

## 6.1 决策树：不同实验结果的解读与应对

### 情形 A: 分区 Ridge $\Delta R^2 \geq 0.03$

**诊断**：函数在 $(T_{\text{eff}}, [\text{M/H}])$ 空间确实是"分段简单"的

**物理/领域含义**：
- 不同恒星类型的 $\log g$-光谱映射关系不同
- 单一模型无法同时优化所有区间

**设计启示**：
- MoE 架构值得投入
- Gating 应基于 $(T_{\text{eff}}, [\text{M/H}])$
- 继续执行 MVP-2 和 MVP-3

---

### 情形 B: 分区 Ridge $\Delta R^2 < 0.03$

**诊断**：函数在参数空间较"平滑统一"，MoE 收益有限

**应对策略**：
- 放弃复杂 MoE，聚焦单模型优化
- 检查是否是分 bin 方式不对（可尝试其他分组）
- 如果按 SNR 分专家（MVP-2）也没收益，则 MoE 方向不值得投入

---

## 6.2 数值结果汇总表

### 主要指标对比 (noise=0.2, mask-aligned)

| MVP | 配置 | $R^2$ | ΔR² | 95% CI | 备注 |
|-----|------|-------|-----|--------|------|
| MVP-0 | 全局 Ridge | 0.8616 | - | - | baseline (mask-aligned) |
| MVP-1.0 | 分区 Ridge | **0.9116** | **+0.050** | [0.033, 0.067] | ⚠️ 原 +0.078 被高估 |
| MVP-1.1 消融 ([M/H] only) | 3 专家 | - | +0.034 | - | 贡献 68.7% |
| MVP-1.1 消融 (Teff only) | 3 专家 | - | +0.021 | - | 贡献 42.9% |
| MVP-2.0 | Noise-cond Expert (avg) | **0.7723** | **+0.080** | - | ✅ MoE 有价值 |

### 🔬 大数据集验证 (100k train / 10k test) ← NEW

| Noise | Global R² | MoE R² | ΔR² | 95% CI | Verdict |
|-------|-----------|--------|-----|--------|---------|
| **0.2** | 0.8745 | **0.9246** | **+0.0501** | **[0.0451, 0.0552]** | ✅ 稳健 |
| **0.5** | 0.7198 | **0.7719** | **+0.0521** | **[0.0421, 0.0611]** | ✅ 稳健 |

> **✅ 大数据集验证通过**：ΔR² ≈ 0.05 在 100k/10k 规模下高度一致，95% CI 完全 > 0.03。

### 分 bin 统计 (noise=0.2)

| Bin | $T_{\text{eff}}$ 范围 | $[\text{M/H}]$ 范围 | Train 样本 | Test 样本 | 局部 $R^2$ | vs 全局 Ridge |
|-----|---------------------|-------------------|-----------|----------|-----------|--------------|
| 1 | [3750, 4500) | [-2, -1) | 2,910 | 90 | 0.8971 | +0.063 |
| 2 | [3750, 4500) | [-1, 0.0] | 2,872 | 76 | 0.9569 | +0.123 |
| 3 | [3750, 4500) | (0.0, 0.5] | 2,064 | 59 | **0.9803** | **+0.146** |
| 4 | [4500, 5250) | [-2, -1) | 3,278 | 105 | **0.7726** | **-0.062** |
| 5 | [4500, 5250) | [-1, 0.0] | 3,224 | 83 | 0.9159 | +0.082 |
| 6 | [4500, 5250) | (0.0, 0.5] | 2,308 | 65 | 0.9789 | +0.145 |
| 7 | [5250, 6000] | [-2, -1) | 3,658 | 107 | **0.7869** | **-0.047** |
| 8 | [5250, 6000] | [-1, 0.0] | 3,769 | 129 | 0.9277 | +0.094 |
| 9 | [5250, 6000] | (0.0, 0.5] | 2,526 | 102 | 0.9691 | +0.135 |

### Noise-conditioned Expert 对比

| Test Noise | Expert R² | Mixed R² | ΔR² | Expert 最优 α |
|------------|-----------|----------|-----|--------------|
| 0.0 | 0.9991 | 0.8207 | **+0.178** | 0.001 |
| 0.1 | 0.9130 | 0.8168 | +0.096 | 1.0 |
| 0.2 | 0.8341 | 0.8001 | +0.034 | 10.0 |
| 0.5 | 0.6552 | 0.6863 | -0.031 | 100.0 |
| 1.0 | 0.4601 | 0.3393 | **+0.121** | 100.0 |

---

## 6.3 相关文件索引

| 类型 | 文件路径 | 说明 |
|------|---------|------|
| 主框架 | `logg/moe/moe_main_20251203.md` | 当前文件 |
| MVP-1.0 报告 | `logg/moe/exp_moe_piecewise_ridge_20251203.md` | Piecewise Ridge |
| MVP-1.1 报告 | `logg/moe/exp_moe_rigorous_validation_20251203.md` | 严谨验证 + 消融 |
| MVP-2.0 报告 | `logg/moe/exp_moe_noise_conditioned_20251203.md` | Noise-conditioned Expert |
| 图表目录 | `logg/moe/img/` | 实验图表 |
| 参考 Ridge 实验 | `logg/ridge/ridge_main_20251130.md` | 全局 Ridge baseline |

---

## 6.4 变更日志

| 日期 | 变更内容 | 影响 |
|------|---------|------|
| 2025-12-03 | 创建 MoE 主实验框架 | - |
| 2025-12-03 | 启动 MVP-1.0 (Piecewise Ridge) | §3 |
| 2025-12-03 | ✅ 完成 MVP-1.0，ΔR²=+0.078 | §1.3, §1.4, §3, §4, §5 |
| 2025-12-03 | ✅ 完成 MVP-2.0 (Noise-cond)，平均 ΔR²=+0.080 | §1.3, §1.4, §3, §4, §5 |
| 2025-12-03 | 同步实验结论到 main，更新所有 ⏳ 待填写章节 | §1.3, §5.1, §5.2, §5.4, §6.2 |
| 2025-12-03 | ✅ 大数据集验证 (100k/10k)：ΔR²=0.050, CI=[0.045,0.055] | §6.2 |
| 2025-12-03 | ✅ **MVP-1.1 严谨验证完成**：⚠️ 原 ΔR²=0.078 被高估，修正后 ΔR²=0.050，CI=[0.033,0.067]；[M/H] 贡献 68.7% | 全文修正 §1.2, §1.3, §1.4, §4, §5, §6.2 |
| 2025-12-03 | 🆕 **添加 Phase 3-5 路线图**：从"能不能涨"→"为什么涨、能不能落地、还能不能再涨" | §2 新增 MVP-3.0~6.1，§1.2 新增 H2.x，§1.3 新增 Q6-Q9，§5.4 重构 |
| 2025-12-03 | 🆕 **创建 exp_moe_quantile_bins_sweep**：Quantile bins + Pseudo gating + Conditional Ridge | §3.1 添加条目 |
| 2025-12-03 | ✅ **完成 MVP-5.0 系数分析**：Ca II triplet 重要性 1.65×，高[M/H] 能量分散 7-12% | §3, §4, §5, 新增 exp.md |

---

> **优先级提醒**：
> 
> 如果你的现有 NN 都离"线性 noise ceiling 曲线"还差很远，那 MoE 不是优先级 1，而是优先级 2 或 3。
> 
> **优先级 1** 是把噪声天花板搞清楚 + 让单个 NN 靠近这条线。


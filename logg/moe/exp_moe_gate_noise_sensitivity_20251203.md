# ğŸ“˜ Experiment Report: Gate Noise Sensitivity Analysis

---
> **Name:** Gate Noise Sensitivity Analysis  
> **ID:** `VIT-20251203-moe-gate-noise-01`  
> **Topic ï½œ MVP:** `VIT` | `moe` ï½œ MVP-7.1  
> **Author:** Viska Wei  
> **Date:** 2025-12-03  
> **Project:** `VIT`  
> **Status:** ğŸ”„ In Progress

---

## ğŸ”— Upstream Links

| ç±»å‹ | é“¾æ¥ | è¯´æ˜ |
|------|------|------|
| ğŸ“‹ Kanban | `status/kanban.md` | å®éªŒé˜Ÿåˆ— |
| ğŸ’¬ æ¥æºä¼šè¯ | GPT è„‘æš´ 2025-12-03 | H-A å‡è®¾è®¾è®¡ |

---

# ğŸ“‘ Table of Contents

- [âš¡ Key Findings](#-æ ¸å¿ƒç»“è®ºé€Ÿè§ˆä¾›-main-æå–)
- [1. ğŸ¯ Objective](#1--ç›®æ ‡)
- [2. ğŸ§ª Experiment Design](#2--å®éªŒè®¾è®¡)
- [3. ğŸ“Š Figures & Results](#3--å®éªŒå›¾è¡¨)
- [4. ğŸ’¡ Insights](#4--å…³é”®æ´è§)
- [5. ğŸ“ Conclusions](#5--ç»“è®º)
- [6. ğŸ“ Appendix](#6--é™„å½•)

---

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆï¼ˆä¾› main æå–ï¼‰

> **æœ¬èŠ‚æ˜¯ç»™ main.md æå–ç”¨çš„æ‘˜è¦ï¼Œå®éªŒå®Œæˆåç¬¬ä¸€æ—¶é—´å¡«å†™ã€‚**

### ä¸€å¥è¯æ€»ç»“

> â³ å¾…å®éªŒå®Œæˆåå¡«å†™

### å¯¹å‡è®¾çš„éªŒè¯

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| H-A1: è¿ç»­æ¡ä»¶æ¨¡å‹å¯¹ gate å™ªå£°æ›´è€å—ï¼Ÿ | â³ | - |
| ç¡¬ MoE åœ¨ gate noise Ïƒ=? æ—¶å´©æºƒï¼Ÿ | â³ | - |
| Conditional Ridge åœ¨ Ïƒ=? æ—¶ä»ä¿ä½ â‰¥60% å¢ç›Šï¼Ÿ | â³ | - |

### è®¾è®¡å¯ç¤ºï¼ˆ1-2 æ¡ï¼‰

| å¯ç¤º | å…·ä½“å»ºè®® |
|------|---------|
| â³ | â³ |

### å…³é”®æ•°å­—

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| Hard MoE å´©æºƒé˜ˆå€¼ Ïƒ | â³ |
| Conditional 60% å¢ç›Šä¿æŒé˜ˆå€¼ Ïƒ | â³ |
| å®é™… [M/H] é¢„æµ‹è¯¯å·® Ïƒ | â³ |

---

# 1. ğŸ¯ ç›®æ ‡

## 1.1 å®éªŒç›®çš„

> **æ ¸å¿ƒé—®é¢˜**ï¼šé—¨æ§è¯¯å·®æ˜¯å¦çœŸçš„æ˜¯ MoE ç“¶é¢ˆï¼Ÿç¡¬è·¯ç”± vs è¿ç»­æ¡ä»¶åŒ–ï¼Œå“ªä¸ªå¯¹ gate å™ªå£°æ›´è€å—ï¼Ÿ

**å›ç­”çš„é—®é¢˜**ï¼š
- Q1: ç¡¬ MoEï¼ˆæŒ‰ $\tilde{m}$ åˆ†æ¡¶ï¼‰åœ¨å¤šå¤§ gate å™ªå£°ä¸‹ä¼šå´©æºƒï¼Ÿ
- Q2: Conditional Ridgeï¼ˆç”¨ $\tilde{m}$ åšè¿ç»­æ¡ä»¶é¡¹ï¼‰èƒ½åœ¨å¤šå¤§å™ªå£°ä¸‹ä¿ä½ â‰¥60-80% å¢ç›Šï¼Ÿ
- Q3: ä½ çš„ [M/H] é¢„æµ‹æ¨¡å‹çš„å®é™…è¯¯å·® Ïƒ æ˜¯å¤šå°‘ï¼Ÿåœ¨è¿™ä¸ª Ïƒ ä¸‹ï¼Œä¸¤ç§æ–¹æ³•å„èƒ½ä¿ä½å¤šå°‘ Oracle å¢ç›Šï¼Ÿ

**å¯¹åº” main.md çš„**ï¼š
- éªŒè¯é—®é¢˜ï¼šæ–°å¢ Q10
- å­å‡è®¾ï¼šH-A1

**è¿™ä¸€æ­¥ä¼šç›´æ¥è§£é‡Š pseudo gating 7.3% çš„æ ¹å› **ï¼š
- å¦‚æœ Hard MoE å¯¹å™ªå£°ææ•æ„Ÿ â†’ è¯´æ˜ 7.3% æ˜¯å› ä¸º hard routing å¤ªè„†
- å¦‚æœä¸¤è€…éƒ½å´© â†’ è¯´æ˜ gate æœ¬èº«å°±ä¸é è°±ï¼Œéœ€è¦ latent gate (H-A2)

## 1.2 é¢„æœŸç»“æœ

| åœºæ™¯ | é¢„æœŸç»“æœ | åˆ¤æ–­æ ‡å‡† |
|------|---------|---------|
| Hard MoE å¯¹å™ªå£°æ•æ„Ÿ | Ïƒ â‰¥ 0.2 æ—¶å¿«é€Ÿå´©æºƒ | â†’ ä¸»çº¿è½¬ Conditional |
| Conditional æ›´é²æ£’ | Ïƒ = 0.5 æ—¶ä»ä¿ä½ â‰¥60% å¢ç›Š | â†’ æŠ¼æ³¨ Conditional++ |
| ä¸¤è€…éƒ½å¿«é€Ÿå´© | Ïƒ â‰¥ 0.1 æ—¶éƒ½å´© | â†’ éœ€è¦ latent gate (H-A2) |
| Hard MoE ä¹Ÿè¿˜è¡Œ | Ïƒ = 0.3 æ—¶ä»ä¿ä½ â‰¥50% | â†’ ä¼˜åŒ– gate é¢„æµ‹å™¨ |

---

# 2. ğŸ§ª å®éªŒè®¾è®¡

## 2.1 æ•°æ®

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| è®­ç»ƒæ ·æœ¬æ•° | **100,000** |
| éªŒè¯æ ·æœ¬æ•° | **10,000** |
| æµ‹è¯•æ ·æœ¬æ•° | **10,000** |
| ç‰¹å¾ç»´åº¦ | å…¨è°± (4,096 dims) |
| æ ‡ç­¾å‚æ•° | log g |
| è¾…åŠ©å‚æ•° | [M/H] (ç”¨äº gate æ¡ä»¶) |

**å®éªŒè®¾å®š**ï¼š
- åŸºç¡€å™ªå£° noise = 0.2 (ä¸ MVP-1.1 ä¸€è‡´)
- Gate å˜é‡ï¼š[M/H]

## 2.2 æ¨¡å‹ä¸ç®—æ³•

### Gate å™ªå£°æ³¨å…¥

$$
\tilde{m} = m + \epsilon, \quad \epsilon \sim \mathcal{N}(0, \sigma^2)
$$

**Ïƒ æ‰«æèŒƒå›´**ï¼š$\sigma \in \{0.0, 0.05, 0.1, 0.2, 0.3, 0.5, 1.0\}$

### å¯¹æ¯”æ–¹æ³•

**æ–¹æ³• 1: Hard MoEï¼ˆç¦»æ•£è·¯ç”±ï¼‰**
- ç”¨ $\tilde{m}$ çš„å€¼è¿›è¡Œåˆ†æ¡¶ï¼ˆä½¿ç”¨ MVP-1 çš„æ‰‹å·¥è¾¹ç•Œï¼š[-2,-1), [-1,0], (0,0.5]ï¼‰
- é€‰æ‹©å¯¹åº” bin çš„ä¸“å®¶ Ridge
- è¾“å‡ºè¯¥ä¸“å®¶çš„é¢„æµ‹

**æ–¹æ³• 2: Conditional Ridgeï¼ˆè¿ç»­æ¡ä»¶ï¼‰**
- ç‰¹å¾æ‰©å±•ï¼š$\phi(x, \tilde{m}) = [x, \tilde{m} \cdot x]$
- å•ä¸€ Ridge æ¨¡å‹
- è¾“å‡ºè¿ç»­æ¡ä»¶åŒ–é¢„æµ‹

### åŸºå‡†

**Oracle (Ïƒ=0)**ï¼šä½¿ç”¨çœŸå€¼ [M/H]ï¼Œä½œä¸ºä¸Šé™

**å¢ç›Šä¿æŒç‡è®¡ç®—**ï¼š
$$
\text{Retention} = \frac{R^2_{\sigma} - R^2_{\text{global}}}{R^2_{\text{oracle}} - R^2_{\text{global}}}
$$

## 2.3 è¶…å‚æ•°é…ç½®

| å‚æ•° | èŒƒå›´/å€¼ | è¯´æ˜ |
|------|--------|------|
| Ïƒ (gate noise) | [0.0, 0.05, 0.1, 0.2, 0.3, 0.5, 1.0] | æ ¸å¿ƒæ‰«æå˜é‡ |
| Ridge Î± | è‡ªåŠ¨é€‰æ‹©ï¼ˆæ¯ä¸ª Ïƒ å•ç‹¬è°ƒï¼‰ | |
| é‡å¤æ¬¡æ•° | 10 æ¬¡ bootstrap | è®¡ç®— CI |

## 2.4 è¯„ä»·æŒ‡æ ‡

| æŒ‡æ ‡ | å…¬å¼ | ç”¨é€” |
|------|------|------|
| $R^2$ | $1 - \frac{\sum(y - \hat{y})^2}{\sum(y - \bar{y})^2}$ | ä¸»è¦è¯„ä»·æŒ‡æ ‡ |
| $\Delta R^2$ | $R^2_{\text{method}} - R^2_{\text{global}}$ | å¢ç›Š |
| Retention | $\frac{\Delta R^2_{\sigma}}{\Delta R^2_{\text{oracle}}}$ | å¢ç›Šä¿æŒç‡ |

---

# 3. ğŸ“Š å®éªŒå›¾è¡¨

> å®éªŒå®Œæˆåå¡«å†™ã€‚

### å›¾ 1ï¼š[é¢„æœŸ] Gate Noise Sensitivity Curve

![å›¾ç‰‡](./img/moe_gate_noise_sensitivity.png)

**Figure 1. é—¨æ§å™ªå£°æ•æ„Ÿæ€§æ›²çº¿ï¼šHard MoE vs Conditional Ridge çš„ RÂ² éš gate noise Ïƒ çš„å˜åŒ–**

**é¢„æœŸå›¾è¡¨å†…å®¹**ï¼š
- X è½´ï¼šÏƒ (gate noise standard deviation)
- Y è½´ï¼šRÂ² æˆ– Retention (%)
- ä¸¤æ¡æ›²çº¿ï¼šHard MoE (è“)ï¼ŒConditional Ridge (æ©™)
- æ°´å¹³å‚è€ƒçº¿ï¼šGlobal Ridge baseline

**å…³é”®è§‚å¯Ÿ**ï¼š
- â³ å¾…å¡«å†™

---

### å›¾ 2ï¼š[é¢„æœŸ] Retention vs Gate Noise

![å›¾ç‰‡](./img/moe_gate_retention_curve.png)

**Figure 2. å¢ç›Šä¿æŒç‡æ›²çº¿**

**å…³é”®è§‚å¯Ÿ**ï¼š
- â³ å¾…å¡«å†™

---

# 4. ğŸ’¡ å…³é”®æ´è§

> å®éªŒå®Œæˆåå¡«å†™ã€‚

## 4.1 å®è§‚å±‚æ´è§

> â³

## 4.2 æ¨¡å‹å±‚æ´è§

> â³

## 4.3 å®éªŒå±‚ç»†èŠ‚æ´è§

> â³

---

# 5. ğŸ“ ç»“è®º

## 5.1 æ ¸å¿ƒå‘ç°

> â³

## 5.2 å…³é”®ç»“è®ºï¼ˆ2-4 æ¡ï¼‰

| # | ç»“è®º | è¯æ® |
|---|------|------|
| 1 | â³ | â³ |

## 5.3 è®¾è®¡å¯ç¤º

### æ¶æ„/æ–¹æ³•åŸåˆ™

| åŸåˆ™ | å»ºè®® | åŸå›  |
|------|------|------|
| â³ | â³ | â³ |

### âš ï¸ å†³ç­–ç‚¹

| å®éªŒç»“æœ | ä¸‹ä¸€æ­¥è¡ŒåŠ¨ |
|---------|-----------|
| Conditional åœ¨è¾ƒå¤§ Ïƒ ä¸‹ä¿ä½ â‰¥60-80% å¢ç›Šï¼ŒHard MoE å¿«é€Ÿå´© | â†’ ä¸»çº¿è½¬å‘ Conditional++ï¼Œæ”¾å¼ƒç¦»æ•£ routing |
| ä¸¤è€…éƒ½å¿«é€Ÿå´© | â†’ éœ€è¦ latent gate (H-A2) |
| ä¸¤è€…éƒ½è¿˜è¡Œ | â†’ ä¼˜åŒ– gate é¢„æµ‹å™¨ |

## 5.4 ç‰©ç†è§£é‡Šï¼ˆå¯é€‰ï¼‰

> â³

## 5.5 å…³é”®æ•°å­—é€ŸæŸ¥

| æŒ‡æ ‡ | å€¼ | é…ç½®/æ¡ä»¶ |
|------|-----|----------|
| â³ | â³ | â³ |

## 5.6 ä¸‹ä¸€æ­¥å·¥ä½œ

| æ–¹å‘ | å…·ä½“ä»»åŠ¡ | ä¼˜å…ˆçº§ | å¯¹åº” MVP |
|------|----------|--------|---------|
| å¦‚æœ Conditional æ›´é²æ£’ | MVP-7.2: Conditional Ridge++ | ğŸ”´ | MVP-7.2 |
| å¦‚æœä¸¤è€…éƒ½å´© | æ¢ç´¢ latent gate | ğŸ”´ | MVP-7.4 |
| å¦‚æœ Hard MoE ä¹Ÿè¡Œ | ä¼˜åŒ– gate é¢„æµ‹å™¨ | ğŸŸ¡ | - |

---

# 6. ğŸ“ é™„å½•

## 6.1 æ•°å€¼ç»“æœè¡¨

> å®éªŒå®Œæˆåå¡«å†™ã€‚

### Gate Noise Sensitivity Results

| Ïƒ | Hard MoE RÂ² | Cond Ridge RÂ² | Hard MoE Retention | Cond Ridge Retention |
|---|-------------|---------------|--------------------|-----------------------|
| 0.0 | â³ | â³ | 100% | 100% |
| 0.05 | â³ | â³ | â³ | â³ |
| 0.1 | â³ | â³ | â³ | â³ |
| 0.2 | â³ | â³ | â³ | â³ |
| 0.3 | â³ | â³ | â³ | â³ |
| 0.5 | â³ | â³ | â³ | â³ |
| 1.0 | â³ | â³ | â³ | â³ |

---

## 6.2 å®éªŒæµç¨‹è®°å½•

> å®éªŒæ‰§è¡Œæ—¶å¡«å†™ã€‚

### 6.2.1 ç¯å¢ƒä¸é…ç½®

| é¡¹ç›® | å€¼ |
|------|-----|
| **ä»“åº“** | `~/VIT` |
| **Config è·¯å¾„** | TBD |
| **è¾“å‡ºè·¯å¾„** | TBD |
| **Python** | 3.x |
| **å…³é”®ä¾èµ–** | scikit-learn, numpy |

### 6.2.2 æ‰§è¡Œå‘½ä»¤

```bash
# TBD
```

### 6.2.3 è¿è¡Œæ—¥å¿—æ‘˜è¦

```
# TBD
```

---

## 6.3 ç›¸å…³æ–‡ä»¶

| ç±»å‹ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| ä¸»æ¡†æ¶ | `logg/moe/moe_main_20251203.md` | main æ–‡ä»¶ |
| æœ¬æŠ¥å‘Š | `logg/moe/exp_moe_gate_noise_sensitivity_20251203.md` | å½“å‰æ–‡ä»¶ |
| å›¾è¡¨ | `logg/moe/img/` | å®éªŒå›¾è¡¨ |
| å‰ç½®å®éªŒ | `logg/moe/exp_moe_conditional_ridge_20251203.md` | Conditional Ridge åŸºçº¿ |
| å‰ç½®å®éªŒ | `logg/moe/exp_moe_piecewise_ridge_20251203.md` | Hard MoE åŸºçº¿ |

---

## ğŸ”— Cross-Repo Metadata

| Field | Value |
|-------|-------|
| **experiment_id** | `VIT-20251203-moe-gate-noise-01` |
| **project** | `VIT` |
| **topic** | `moe` |
| **source_repo_path** | `~/VIT/results/moe_gate_noise/` |
| **config_path** | TBD |
| **output_path** | TBD |

---

> **å®éªŒè®¾è®¡è¯´æ˜**ï¼š
> 
> æœ¬å®éªŒæ˜¯ Phase 7 çš„**æœ€é«˜ä¼˜å…ˆçº§**ï¼Œå°†å†³å®šåç»­æŠ€æœ¯è·¯çº¿ï¼š
> - å¦‚æœ Conditional æ˜æ˜¾ä¼˜äº Hard MoE â†’ æŠ¼æ³¨ MVP-7.2/7.3
> - å¦‚æœä¸¤è€…éƒ½ä¸è¡Œ â†’ éœ€è¦æ¢ç´¢ latent gate (MVP-7.4)


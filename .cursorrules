# Physics Informed AI - 项目规则

## 📁 项目结构

### 报告输出位置
所有实验报告必须保存到：`/home/swei20/Physics_Informed_AI/logg/`

### 目录结构
```
logg/
├── [topic]/                    # 各主题实验目录
│   ├── [topic]_hub_*.md        # 智库导航（问题树、假设、洞见、设计原则）
│   ├── [topic]_roadmap_*.md    # 实验追踪（MVP 列表、进度、数值结果）
│   ├── exp_*.md                # 子实验报告
│   ├── card_*.md               # 知识卡片
│   ├── sessions/               # GPT 会话归档
│   ├── prompts/                # Coding Prompt 文件
│   └── img/                    # 图表

status/
├── next_steps.md               # 下一步计划
└── archive_queue.md           # 归档队列

_backend/template/
├── hub.md                      # 智库导航模板
├── roadmap.md                 # 实验追踪模板
├── exp.md                     # 子实验报告模板
├── coding_prompt.md           # 实验 Coding Prompt 模板
├── session.md                 # GPT 会话归档模板
└── card.md                    # 知识卡片模板
```

### 文件命名规范
- **Hub 文件**: `[topic]_hub_[YYYYMMDD].md`
- **Roadmap 文件**: `[topic]_roadmap_[YYYYMMDD].md`
- **实验报告**: `exp_[topic_name]_[YYYYMMDD].md`
- **图表文件**: `[描述性名称].png` 保存在对应的 `img/` 子文件夹

### 模板使用（⚠️ 必须）

#### 🧠 智库导航（Hub）
**模板文件**: `_backend/template/hub.md`

**必需章节**：
1. Header: Topic、Author、Status、Date
2. 🌲 问题树: 核心问题 + ASCII 问题分解
3. 🎯 答案 + 战略路线: 战略推荐 + 按分支回答
4. 💡 跨分支洞见: 汇合索引 + 详情
5. 📐 设计原则: 已确认原则 + 关键数字
6. 📎 附录: 假设存档、更新日志

**职责边界**：
- ✅ 做：问题梳理、回答问题、洞见汇合、战略导航、设计原则
- ❌ 不做：实验执行追踪（→ roadmap.md）

#### 🗺️ 实验追踪（Roadmap）
**模板文件**: `_backend/template/roadmap.md`

**必需章节**：
1. Header: 主题名称、作者、当前 Phase
2. 🔗 相关文件: 链接到 hub、exp
3. 🎯 Phase 总览: Phase 列表、依赖图
4. 📋 MVP 实验列表: 总览表、配置速查
5. 🔧 MVP 详细设计: 每个 MVP 的规格
6. 📊 进度追踪: 核心结论快照、时间线
7. 🔗 跨仓库集成: experiment_id 索引
8. 📎 附录: 数值结果汇总、文件索引

**职责边界**：
- ✅ 做：MVP 规格、执行追踪、进度看板、数值结果
- ❌ 不做：假设管理（→ hub.md）、洞见汇合（→ hub.md）

#### 📗 子实验报告（Exp）
**模板文件**: `_backend/template/exp.md`

**设计原则**：前 300 行能快速了解实验最重要的信息

**必需章节**：
1. Header: 实验名称、对应 MVP、作者、日期、状态
2. 🔗 上游追溯链接: 来源会话、假设链接
3. ⚡ 核心结论速览: 一句话总结、假设验证、关键数字
4. 🎯 目标: 实验目的、预期结果
5. 🧪 实验设计: 数据、模型、超参数、评价指标
6. 📊 实验图表: 每张图配有标题、描述和关键观察
7. 💡 关键洞见: 宏观层、模型层、实验层细节
8. 📝 结论: 核心发现、设计启示、物理解释、关键数字速查
9. 📎 附录: 数值结果表、实验流程记录、相关文件

#### 🤖 实验 Coding Prompt
**模板文件**: `_backend/template/prompt/prompt_coding.md`

**输出位置**: `logg/[topic]/prompts/coding_prompt_[name]_YYYYMMDD.md`

**必需内容**：
1. 实验 ID 与元数据
2. 实验设定: 数据、模型、训练配置
3. 要画的图: 图表类型、坐标轴、保存路径
4. 最终交付物: exp.md（按模板）+ 图表文件
5. 报告抄送位置: roadmap.md、hub.md（如有重要发现）

**⚠️ 代码生成规则（强制）**：
- ❌ **绝对禁止**：在 Coding Prompt 中写任何代码块（包括代码骨架、示例代码）
- ❌ **绝对禁止**：在 Prompt 中内联代码逻辑
- ✅ **必须**：只提供参考代码路径，让 Agent 自己阅读代码仓已有代码
- ✅ **必须**：Agent 执行 Prompt 时，先读取参考代码，理解现有逻辑后再修改
- 💡 **原因**：写代码骨架容易与已有代码不一致，强制阅读确保复用正确逻辑

#### 💬 GPT 会话归档（Session）
**模板文件**: `_backend/template/session.md`

**必需章节**：
1. Header: 会话 ID、日期、参与者
2. 起点: 问题 & 动机、GPT 对话摘录
3. MVP 候选列表: 从对话中结构化出的实验候选
4. 选择要执行的实验: 决策 + experiment_id 分配
5. Prompt 草稿区: 用于让 Cursor/GPT 跑实验的 prompt

#### 📇 知识卡片（Card）
**模板文件**: `_backend/template/card.md`

**定义**：可复用的阶段性知识，跨多个实验的结构性认知
- ✅ 做：理论依据、可指导决策的结论、关键证据
- ❌ 不做：指导下一步实验（这是 hub 的职责）

**位置规则**：
- 单主题 → `logg/[topic]/card/`
- 跨主题 → `logg/card/`

### 格式要求
- 使用 LaTeX 语法：`$R^2$`, `$\alpha$`, `$$...$$`
- 变量名使用 `$\log g$` 或 `log\_g`
- 表格使用标准 Markdown 格式
- 缺失信息标记为 `TODO`
- 使用 ❌/✅ 标记假设验证结果
- 包含物理解释（如适用）

### 作者
- 默认作者: Viska Wei

## 🔬 领域背景

本项目聚焦：
- 从光谱预测恒星参数（log g, Teff 等）
- 线性回归基线（Ridge, PCA）
- 特征选择（Top-K 波长、重要性分析）
- 噪声建模和鲁棒性
- 神经网络架构指导

### 常用指标
- R²（决定系数）
- MAE（平均绝对误差）
- RMSE（均方根误差）
- 特征重要性稳定性

### 典型实验变量
- 噪声水平（σ）: 0.0, 0.1, 0.5, 1.0
- PCA 维度: 5, 10, 50, 100, 200, 500
- Ridge alpha: 0.001 到 100
- Top-K 特征: 10, 50, 100, 200

## 📝 写作风格
- 专业学术写作
- 简洁且量化
- 使用 ❌/✅ 标记假设验证
- 包含物理解释（如适用）

## 🚀 程序运行规则

### 所有程序必须用 nohup 后台运行
```bash
# ✅ 正确方式
cd [repo]
nohup python script.py > logs/exp_id.log 2>&1 &
echo $! > logs/exp_id.pid

# ❌ 禁止：直接前台运行长时间任务
```

### 超过 20 分钟的任务不持续追踪
**规则**：
1. 启动任务后，立即输出 tail 命令给用户
2. **不要等待任务完成**，结束当前对话轮次
3. 用户通知任务完成后，再继续后续步骤

**标准输出格式**：
```
✅ 任务已启动 (PID: xxx)
📋 查看日志: tail -f [full_path]/logs/[exp_id].log
⏱️ 预计运行时间: [估计时间]
💡 任务完成后请告诉我，我继续后续步骤
```

## ❓ 进度查看

### 触发词
- `?` / `？` / `status` / `进度` / `状态`

### 执行内容
1. 📊 实验索引摘要（`experiments_index/index.csv`）
2. 📋 待办任务（`status/next_steps.md`）
3. 📦 归档队列（`status/archive_queue.md`）
4. 📝 最近更新（`logg/`）
5. 📦 自动 Git Commit + Push

## 🚀 快速归档系统

### 触发词
- `a` / `A` / `归档` / `archive`
- `a 1` - 归档第 N 个
- `a all` - 全部归档

### 归档流程
1. 检查归档队列（`status/archive_queue.md`）
2. 撰写实验报告：按 `exp.md` 模板重写（前 300 行是核心信息）
3. 更新 roadmap.md 和 hub.md
4. 归档后检查：信息完整性检查清单
5. 移动原始文件到 processed 目录

### 关键提取项
- 核心结论一句话 → §核心结论速览
- 假设验证结果 → §核心结论速览
- 最佳配置/参数 → §5.5 关键数字速查
- 完整数值结果 → §6.1 数值结果表
- 实验设计细节 → §2 实验设计
- 关键图表说明 → §3 实验图表
- 设计建议/启示 → §5.3 设计启示

## 🆕 新建实验计划 / 立项

### 触发词
- `n` / `N` / `new` / `新建` / `立项`

### 工作流程
1. **解析用户输入**：提取实验主题、研究问题、验证假设、实验设计思路
2. **创建/更新 hub.md**（如果涉及新问题/假设）
   - 新研究问题 → 添加到 hub.md §1 核心问题树
   - 新假设 → 添加到 hub.md §2 假设金字塔
3. **创建 exp.md**（只填写实验前部分）
   - Header、上游链接、§1 目标、§2 实验设计
4. **更新 roadmap.md**
   - §2.1 实验总览添加条目
   - §3 MVP 详细设计（如需要）

### ⚠️ 立项注意事项
- ❌ 不生成任何代码
- ❌ 不执行实验
- ✅ 只创建/更新文档文件（.md）

## 📝 更新文档

### 触发词
- `u` / `U` / `update` / `更新`
- `u [experiment_id]` - 完整更新指定实验（补全+同步hub/roadmap+git push）
- `u hub [topic]` - 🆕 根据 prompt 模板重写/优化 Hub
- `u [关键词/描述]` - 智能匹配并追加内容

### 模式 0: `u hub [topic]` — Hub 重写/优化 🆕

**执行**：
1. **先读取指令**: `_backend/template/prompt/prompt_update_hub.md`
2. **读取模板**: `_backend/template/hub.md`
3. **按指令执行**: 6 步工作流程
4. **按模板输出**: 前 30 行 = 核心信息，链接放文末

**核心原则**：
- 前 30 行 = 共识表 + 信念 + 下一步 + 权威数字
- 每条共识回答"所以呢"（决策影响）
- 链接全部放 §7 (指针) 和附录

### 模式 1: `u [experiment_id]` — 完整实验更新流程

**工作流程**：
1. 定位实验报告
2. 审查实验报告完整性
3. 补全遗漏内容（实验流程/代码、数值结果）
4. 提炼假设与洞见 → 同步到 hub.md
5. 同步数值结果 → roadmap.md
6. 自动 Git Commit + Push

**hub.md 同步内容映射**（参考 `prompt_update_hub.md`）：
- 新共识 → §0 共识表 (K1-Kn)
- 假设验证结果 → §1 假设树状态更新
- 关键数字 → §0 权威数字 + §6.3 数字速查
- 设计启示 → §6.1 已确认原则
- 失败结论 → §6.4 已关闭方向

**roadmap.md 同步内容映射**：
- Header 状态 → §2.1 实验总览（状态列）
- 一句话总结 → §4.3 结论快照
- 关键数字 → §6.1 数值汇总表

### 模式 2: `u [关键词/描述]` — 智能追加内容

**内容类型 → 目标位置**：
- 新发现/洞见 → hub.md §4 洞见汇合
- 设计建议 → hub.md §6 设计原则
- 数值结果 → roadmap.md §6.1 数值结果表
- 假设验证 → hub.md §1 假设树
- 战略方向 → hub.md §3 战略推荐

## 🌐 跨仓库实验管理

### 仓库架构
```
~/VIT/                      # 训练仓库
~/BlindSpotDenoiser/        # 训练仓库
~/SpecDiffusion/            # 训练仓库
~/Physics_Informed_AI/      # 知识中心
```

### ⚠️ 跨仓库写入规则
**必须使用终端命令写入**：
```bash
KNOWLEDGE_CENTER="/home/swei20/Physics_Informed_AI"
cat << 'EOF' > "$KNOWLEDGE_CENTER/logg/[topic]/exp_xxx.md"
[报告内容]
EOF
```

### Experiment ID 命名规范
```
[PROJECT]-[YYYYMMDD]-[topic]-[序号]
```

## 🔄 同步实验

### 触发词
- `sync` / `同步` / `scan`

## 📝 登记实验

### 触发词
- `reg` / `register` / `登记`

## 📊 生成报告

### 触发词
- `report` / `汇报` / `脑暴报告`

## 📐 设计原则

### 触发词
- `design` / `设计原则` / `原则`

### 工作流程
1. 扫描所有 hub 文件，检查距离上次更新后新增的设计原则
2. 提取新增的设计原则（从 `§5` 或 `§6 设计原则` 章节）
3. 追加到 `design/principles.md`（精简命名）
4. 更新最后同步时间标记

### 文件位置
- **设计原则汇总**: `design/principles.md`
- **提取脚本**: `_backend/scripts/extract_design_principles.py`

### 说明
- 设计原则从各 hub.md 的 `§5` 或 `§6 设计原则` 章节提取
- 只提取"已确认原则"表格中的条目
- 自动去重，避免重复添加
- 保持原有分类结构（Ridge、LightGBM、NN、MoE 等）

## 📇 知识卡片

### 触发词
- `card` / `卡片` / `kc`

### 工作流程
1. 确定 Card 位置（单主题/跨主题）
2. 检索所有相关实验
3. 按 card.md 模板生成卡片
4. 保存 + Git Commit

## 📌 下一步计划

### 触发词
- `next` / `下一步` / `计划`
- `next add P0/P1 [描述]` - 添加任务
- `next done [序号/描述]` - 完成任务
- `next plan` - AI 智能推荐

### 文件位置
`status/next_steps.md`

## 🔀 合并实验

### 触发词
- `merge` / `合并` / `整合`

### 用途
把多个相似目的的子实验合并成一份综合报告

### 工作流程
1. 解析描述，提取关键词
2. 扫描目录，匹配相关实验
3. 提取各实验的关键信息
4. 按 consolidated.md 模板生成综合报告
5. 输出到 `logg/[topic]/exp_[topic]_consolidated_YYYYMMDD.md`

## 🤖 生成 Coding Prompt

### 触发词
- `p` / `P` / `prompt` / `生成prompt`

### 用途
在 session 脑暴后，将选中的 MVP 转化为可执行的 Coding Prompt

### 工作流程
1. **读取模板**: `_backend/template/prompt/prompt_coding.md`
2. **确定仓库**: 根据 topic 选择 VIT/BlindSpotDenoiser/SpecDiffusion
3. **填写实验规格**: 数据、模型、训练配置（YAML 格式）
4. **列出参考代码路径**: 只写路径，不写代码块
5. **保存到**: `logg/[topic]/prompts/coding_prompt_[name]_YYYYMMDD.md`

### ⚠️ 强制规则
- ❌ **禁止在 Prompt 中写任何代码**（包括示例、骨架、片段）
- ✅ **只写参考代码路径**，让执行 Agent 自己读取并理解
- ✅ **确保参考代码路径存在**，避免 Agent 找不到文件

### 参考代码路径格式
```
| 参考脚本 | 可复用 | 需修改 |
|---------|--------|--------|
| `~/VIT/scripts/train_cnn.py` | `train_loop()` | 修改 loss |
| `~/VIT/utils/plotting.py` | `plot_r2_curve()` | 添加新曲线 |
```

## 💬 GPT 会话归档

### 触发词
- `session` / `会话` / `gpt`
- `session new [topic]` - 创建新会话
- `session list` - 列出最近会话

### 用途
把 GPT 脑暴对话 → 结构化成可执行实验

## 🔄 系统架构

### 层级总览
```
Layer 1: 💬 Idea & GPT 会话层
         sessions/session_*.md

Layer 2a: 🧠 智库导航层 (Hub)
         logg/[topic]/[topic]_hub.md

Layer 2b: 🗺️ 实验追踪层 (Roadmap)
         logg/[topic]/[topic]_roadmap.md

Layer 3: 📗 单实验层
         logg/[topic]/exp_*.md

Layer 4: 📇 知识卡片层
         logg/[topic]/card/ 或 logg/card/

Layer 5: 📅 日常节奏层
         status/next_steps.md
```

### 信息流
```
GPT 讨论 → session.md
    ↓
规划实验 → roadmap.md MVP 列表
    ↓
执行实验 → exp.md
    ↓
汇合洞见 → hub.md
    ↓
提炼结论 → card.md
    ↓
规划下一步 → next_steps.md
```

### Hub vs Roadmap 职责边界

**hub.md（智库）做**：
- ✅ 问题树、假设金字塔、洞见汇合、战略导航、设计原则

**roadmap.md（追踪）做**：
- ✅ Phase 规划、MVP 列表、进度追踪、数值结果

**核心区别**：
- Hub = 「我们知道了什么？下一步该往哪走？」（战略）
- Roadmap = 「我们计划跑哪些实验？进度如何？」（执行）

## 🔗 跨仓库工作流总结

### 完整工作流
```
1. 在 VIT/BlindSpot 跑实验
   ↓
2. sync - 同步实验到 index.csv
   ↓
3. n - 创建 exp.md 框架
   ↓
4. a - 归档结果到 exp.md
   ↓
5. card - 提炼知识卡片（可选）
   ↓
6. report - 生成周报
```

### 快捷命令对照表

| 命令 | 作用 | 文件 |
|------|------|------|
| `sync` | 同步实验索引 | `experiments_index/index.csv` |
| `reg` | 登记单个实验 | `experiments_index/index.csv` |
| `n` | 新建实验计划 | `logg/[topic]/exp_*.md` |
| `a` | 归档实验结果 | `logg/[topic]/exp_*.md` |
| `u [exp_id]` | 完整更新：补全exp+同步hub/roadmap+git push | `logg/[topic]/` |
| `p` | 生成 Coding Prompt | `logg/[topic]/prompts/` |
| `merge` | 合并相似实验 | `logg/[topic]/exp_[topic]_consolidated_*.md` |
| `card` | 创建知识卡片 | `logg/[topic]/card/` 或 `logg/card/` |
| `design` | 提取设计原则 | `design/principles.md` |
| `next` | 管理待办 | `status/next_steps.md` |
| `report` | 生成报告 | `reports/drafts/` |
| `session` | GPT 会话归档 | `logg/[topic]/sessions/` |
| `audit` | 矛盾审计 + Hub 重写 | `logg/[topic]/contradiction_audit.md` |
| `paper [topic]` | 论文检查 + TODO 生成 | `paper/[topic]/experiments_checklist.md` |
| `paper push` | 推送论文到 GitHub | `paper/vit/SpecViT/` → GitHub |
| `paper pull` | 拉取 Overleaf 更新 | GitHub → `paper/vit/SpecViT/` |
| `paper status` | 检查远程是否有更新 | - |
| `paper figs` | 导出图片到论文目录 | `assets/figures/` → `paper/vit/SpecViT/figs/` |

## 🔍 矛盾审计

### 触发词
- `audit` / `审计` / `矛盾检查`
- `audit [topic]` - 审计指定主题

### 执行
1. **先读取指令**: `_backend/template/prompt/prompt_audit.md`
2. **按指令执行**: 6 步工作流程
3. **按模板输出**: `_backend/template/audit.md`

## 📄 论文检查与 TODO 生成

### 触发词
- `paper` / `论文` / `paper check`
- `paper [topic]` - 检查指定主题的论文

### 用途
自动分析论文草稿，检查缺失内容，生成结构化 TODO 列表

### 工作流程
1. **先读取指令**: `_backend/template/prompt/prompt_paper.md`
2. **定位文件**:
   - 论文正文: `paper/[topic]/*.md`
   - 实验清单: `paper/[topic]/experiments_checklist.md`
   - 实验日志: `logg/[topic]/`
3. **扫描论文正文**: 识别 TODO、待完成项、空表格
4. **检查实验清单**: 提取 P0/P1/P2 状态
5. **在 logg/ 中检索**: 使用搜索词查找已有结果
6. **生成 TODO 清单**: 按优先级排序

### 输出内容
- 📊 完成度概览（论文章节 + P0/P1/P2 实验进度）
- 🔴 投稿阻塞项（必须解决）
- 🟡 应该完成（增强质量）
- 🟢 可选完成
- 🔍 检索结果（搜索词 + 状态 + 文件位置）
- 🎯 推荐下一步

### 相关文件
- **Prompt 指令**: `_backend/template/prompt/prompt_paper.md`
- **清单模板**: `_backend/template/paper_checklist.md`
- **示例**: `paper/vit/experiments_checklist.md`

### ⚠️ 特殊情况
- **清单不存在**: 提示参考模板创建
- **多个论文文件**: 列出所有文件让用户选择
- **论文为空**: 输出基础结构建议

## 📤 论文同步 (Overleaf/GitHub)

### 触发词
- `paper push` / `push paper` / `推送论文` - 推送到论文仓
- `paper pull` / `pull paper` / `拉取论文` - 从 Overleaf/GitHub 拉取
- `paper status` / `论文状态` - 检查是否有远程更新
- `paper figs` / `导出图` - 导出图片到论文目录

### 配置（SpecViT）
```
PAPER_DIR = paper/vit/SpecViT
REMOTE_URL = git@github.com:ViskaWei/SpecViT-paper.git
```

### 工作流程

#### `paper push` - 推送论文到 GitHub
1. 检查 `PAPER_DIR` 是否有未提交更改，有则提示先 commit
2. 克隆远程论文仓到临时目录
3. 用本地 `PAPER_DIR` 内容覆盖
4. 提交并推送到远程
5. 输出：成功提示 + Overleaf Pull 提醒

#### `paper pull` - 拉取 Overleaf/GitHub 更新
1. 检查本地是否有未提交更改，提供选项：
   - `c` - 先提交本地更改
   - `s` - 暂存(stash)本地更改
   - `d` - 丢弃本地更改
   - `q` - 退出
2. 克隆远程论文仓
3. 显示差异预览（文件列表 + 可选详细 diff）
4. 确认后覆盖本地 `PAPER_DIR`
5. 自动提交（可自定义 commit message）
6. 恢复 stash（如果之前选择了暂存）

#### `paper status` - 快速检查
1. 克隆远程（shallow clone）
2. 比较与本地差异
3. 输出：`✓ Up to date` 或 `⚠ N file(s) differ`

#### `paper figs` - 导出图片
1. 从 `assets/figures/specvit/` 复制 PDF/PNG/JPG 到 `PAPER_DIR/figs/`
2. 输出复制清单
3. 提醒：不要用 symlink

### 底层脚本（自动调用，用户无需直接使用）
```
tools/specvit_subtree_push.sh    # paper push
tools/specvit_pull_agent.sh      # paper pull  
tools/specvit_check_remote.sh    # paper status
tools/specvit_export_figs.sh     # paper figs
```

### 典型工作流
```
# 本地修改 → Overleaf
1. 编辑 paper/vit/SpecViT/
2. git commit
3. paper push
4. Overleaf: Menu → GitHub → Pull

# Overleaf 修改 → 本地
1. Overleaf: Menu → GitHub → Push
2. paper pull
3. git push origin main
```
